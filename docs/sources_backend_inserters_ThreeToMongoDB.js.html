<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>Itee-Plugin-Three Source: sources/backend/inserters/ThreeToMongoDB.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.dark.css">

	<link type="text/css" rel="stylesheet" href="styles/site.cyborg.css">

</head>

<body>

<div class="navbar navbar-default navbar-fixed-top ">
<div class="container">
	<div class="navbar-header">
		<a class="navbar-brand" href="index.html">Itee-Plugin-Three</a>
		<button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#topNavigation">
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
        </button>
	</div>
	<div class="navbar-collapse collapse" id="topNavigation">
		<ul class="nav navbar-nav">
			
			<li class="dropdown">
				<a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b class="caret"></b></a>
				<ul class="dropdown-menu inline">
					<li><a href="module-Controllers_CameraControls.html">Controllers/CameraControls</a></li><li><a href="module-Controllers_CameraPathController.html">Controllers/CameraPathController</a></li><li><a href="module-Controllers_ClippingController.html">Controllers/ClippingController</a></li><li><a href="module-Converters_AscToThree.html">Converters/AscToThree</a></li><li><a href="module-Converters_ColladaToThree.html">Converters/ColladaToThree</a></li><li><a href="module-Converters_DbfToThree.html">Converters/DbfToThree</a></li><li><a href="module-Converters_FbxToThree.html">Converters/FbxToThree</a></li><li><a href="module-Converters_JsonToThree.html">Converters/JsonToThree</a></li><li><a href="module-Converters_LasToThree.html">Converters/LasToThree</a></li><li><a href="module-Converters_MtlToThree.html">Converters/MtlToThree</a></li><li><a href="module-Converters_Obj2ToThree.html">Converters/Obj2ToThree</a></li><li><a href="module-Converters_ObjToThree.html">Converters/ObjToThree</a></li><li><a href="module-Converters_ShpToThree.html">Converters/ShpToThree</a></li><li><a href="module-Converters_StlToThree.html">Converters/StlToThree</a></li><li><a href="module-Converters_TdsToThree.html">Converters/TdsToThree</a></li><li><a href="module-Inserters_ThreeToMongoDB.html">Inserters/ThreeToMongoDB</a></li><li><a href="module-Loader_ASCLoader.html">Loader/ASCLoader</a></li><li><a href="module-Loader_DBFLoader.html">Loader/DBFLoader</a></li><li><a href="module-Loader_LASLoader.html">Loader/LASLoader</a></li><li><a href="module-Loader_SHPLoader.html">Loader/SHPLoader</a></li><li><a href="module-Managers_CurvesManager.html">Managers/CurvesManager</a></li><li><a href="module-Managers_GeometriesManager.html">Managers/GeometriesManager</a></li><li><a href="module-Managers_MaterialsManager.html">Managers/MaterialsManager</a></li><li><a href="module-Managers_ObjectsManager.html">Managers/ObjectsManager</a></li><li><a href="module-Managers_TexturesManager.html">Managers/TexturesManager</a></li><li><a href="module-MongoDBThreePlugin.html">MongoDBThreePlugin</a></li><li><a href="module-Objects3D_OrbitControlsHelper.html">Objects3D/OrbitControlsHelper</a></li><li><a href="module-Schemas_Animation_AnimationAction.html">Schemas/Animation/AnimationAction</a></li><li><a href="module-Schemas_Animation_AnimationClip.html">Schemas/Animation/AnimationClip</a></li><li><a href="module-Schemas_Animation_AnimationClipCreator.html">Schemas/Animation/AnimationClipCreator</a></li><li><a href="module-Schemas_Animation_AnimationMixer.html">Schemas/Animation/AnimationMixer</a></li><li><a href="module-Schemas_Animation_AnimationObjectGroup.html">Schemas/Animation/AnimationObjectGroup</a></li><li><a href="module-Schemas_Animation_Tracks_BooleanKeyframeTrack.html">Schemas/Animation/Tracks/BooleanKeyframeTrack</a></li><li><a href="module-Schemas_Animation_Tracks_ColorKeyframeTrack.html">Schemas/Animation/Tracks/ColorKeyframeTrack</a></li><li><a href="module-Schemas_Animation_Tracks_KeyframeTrack.html">Schemas/Animation/Tracks/KeyframeTrack</a></li><li><a href="module-Schemas_Animation_Tracks_NumberKeyframeTrack.html">Schemas/Animation/Tracks/NumberKeyframeTrack</a></li><li><a href="module-Schemas_Animation_Tracks_QuaternionKeyframeTrack.html">Schemas/Animation/Tracks/QuaternionKeyframeTrack</a></li><li><a href="module-Schemas_Animation_Tracks_StringKeyframeTrack.html">Schemas/Animation/Tracks/StringKeyframeTrack</a></li><li><a href="module-Schemas_Animation_Tracks_VectorKeyframeTrack.html">Schemas/Animation/Tracks/VectorKeyframeTrack</a></li><li><a href="module-Schemas_Audio_Audio.html">Schemas/Audio/Audio</a></li><li><a href="module-Schemas_Audio_AudioAnalyser.html">Schemas/Audio/AudioAnalyser</a></li><li><a href="module-Schemas_Audio_AudioContext.html">Schemas/Audio/AudioContext</a></li><li><a href="module-Schemas_Audio_AudioListener.html">Schemas/Audio/AudioListener</a></li><li><a href="module-Schemas_Audio_PositionalAudio.html">Schemas/Audio/PositionalAudio</a></li><li><a href="module-Schemas_Audio_VolumeSlice.html">Schemas/Audio/VolumeSlice</a></li><li><a href="module-Schemas_Camera_ArrayCamera.html">Schemas/Camera/ArrayCamera</a></li><li><a href="module-Schemas_Camera_Camera.html">Schemas/Camera/Camera</a></li><li><a href="module-Schemas_Camera_CinematiqueCamera.html">Schemas/Camera/CinematiqueCamera</a></li><li><a href="module-Schemas_Camera_CubeCamera.html">Schemas/Camera/CubeCamera</a></li><li><a href="module-Schemas_Camera_OrthographicCamera.html">Schemas/Camera/OrthographicCamera</a></li><li><a href="module-Schemas_Camera_PerspectiveCamera.html">Schemas/Camera/PerspectiveCamera</a></li><li><a href="module-Schemas_Camera_StereoCamera.html">Schemas/Camera/StereoCamera</a></li><li><a href="module-Schemas_Core_BufferAttribute.html">Schemas/Core/BufferAttribute</a></li><li><a href="module-Schemas_Core_BufferGeometry.html">Schemas/Core/BufferGeometry</a></li><li><a href="module-Schemas_Core_Clock.html">Schemas/Core/Clock</a></li><li><a href="module-Schemas_Core_CurvePath.html">Schemas/Core/CurvePath</a></li><li><a href="module-Schemas_Core_DirectGeometry.html">Schemas/Core/DirectGeometry</a></li><li><a href="module-Schemas_Core_EventDispatcher.html">Schemas/Core/EventDispatcher</a></li><li><a href="module-Schemas_Core_Face3.html">Schemas/Core/Face3</a></li><li><a href="module-Schemas_Core_Font.html">Schemas/Core/Font</a></li><li><a href="module-Schemas_Core_Geometry.html">Schemas/Core/Geometry</a></li><li><a href="module-Schemas_Core_InstancedBufferAttribute.html">Schemas/Core/InstancedBufferAttribute</a></li><li><a href="module-Schemas_Core_InstancedBufferGeometry.html">Schemas/Core/InstancedBufferGeometry</a></li><li><a href="module-Schemas_Core_InstancedInterleavedBuffer.html">Schemas/Core/InstancedInterleavedBuffer</a></li><li><a href="module-Schemas_Core_InterleavedBuffer.html">Schemas/Core/InterleavedBuffer</a></li><li><a href="module-Schemas_Core_InterleavedBufferAttribute.html">Schemas/Core/InterleavedBufferAttribute</a></li><li><a href="module-Schemas_Core_Interpolations.html">Schemas/Core/Interpolations</a></li><li><a href="module-Schemas_Core_Layers.html">Schemas/Core/Layers</a></li><li><a href="module-Schemas_Core_Path.html">Schemas/Core/Path</a></li><li><a href="module-Schemas_Core_Raycaster.html">Schemas/Core/Raycaster</a></li><li><a href="module-Schemas_Core_Shape.html">Schemas/Core/Shape</a></li><li><a href="module-Schemas_Core_ShapePath.html">Schemas/Core/ShapePath</a></li><li><a href="module-Schemas_Core_Uniform.html">Schemas/Core/Uniform</a></li><li><a href="module-Schemas_Curves_ArcCurve.html">Schemas/Curves/ArcCurve</a></li><li><a href="module-Schemas_Curves_CatmullRomCurve3.html">Schemas/Curves/CatmullRomCurve3</a></li><li><a href="module-Schemas_Curves_CubicBezierCurve.html">Schemas/Curves/CubicBezierCurve</a></li><li><a href="module-Schemas_Curves_CubicBezierCurve3.html">Schemas/Curves/CubicBezierCurve3</a></li><li><a href="module-Schemas_Curves_Curve.html">Schemas/Curves/Curve</a></li><li><a href="module-Schemas_Curves_CurveExtras.html">Schemas/Curves/CurveExtras</a></li><li><a href="module-Schemas_Curves_EllipseCurve.html">Schemas/Curves/EllipseCurve</a></li><li><a href="module-Schemas_Curves_LineCurve.html">Schemas/Curves/LineCurve</a></li><li><a href="module-Schemas_Curves_LineCurve3.html">Schemas/Curves/LineCurve3</a></li><li><a href="module-Schemas_Curves_NURBSCurve.html">Schemas/Curves/NURBSCurve</a></li><li><a href="module-Schemas_Curves_NURBSSurface.html">Schemas/Curves/NURBSSurface</a></li><li><a href="module-Schemas_Curves_QuadraticBezierCurve.html">Schemas/Curves/QuadraticBezierCurve</a></li><li><a href="module-Schemas_Curves_QuadraticBezierCurve3.html">Schemas/Curves/QuadraticBezierCurve3</a></li><li><a href="module-Schemas_Curves_SplineCurve.html">Schemas/Curves/SplineCurve</a></li><li><a href="module-Schemas_Geometries_BoxBufferGeometry.html">Schemas/Geometries/BoxBufferGeometry</a></li><li><a href="module-Schemas_Geometries_BoxGeometry.html">Schemas/Geometries/BoxGeometry</a></li><li><a href="module-Schemas_Geometries_CircleBufferGeometry.html">Schemas/Geometries/CircleBufferGeometry</a></li><li><a href="module-Schemas_Geometries_CircleGeometry.html">Schemas/Geometries/CircleGeometry</a></li><li><a href="module-Schemas_Geometries_ConeBufferGeometry.html">Schemas/Geometries/ConeBufferGeometry</a></li><li><a href="module-Schemas_Geometries_ConeGeometry.html">Schemas/Geometries/ConeGeometry</a></li><li><a href="module-Schemas_Geometries_ConvexGeometry.html">Schemas/Geometries/ConvexGeometry</a></li><li><a href="module-Schemas_Geometries_CylinderBufferGeometry.html">Schemas/Geometries/CylinderBufferGeometry</a></li><li><a href="module-Schemas_Geometries_CylinderGeometry.html">Schemas/Geometries/CylinderGeometry</a></li><li><a href="module-Schemas_Geometries_DecalGeometry.html">Schemas/Geometries/DecalGeometry</a></li><li><a href="module-Schemas_Geometries_DodecahedronGeometry.html">Schemas/Geometries/DodecahedronGeometry</a></li><li><a href="module-Schemas_Geometries_EdgesGeometry.html">Schemas/Geometries/EdgesGeometry</a></li><li><a href="module-Schemas_Geometries_ExtrudeBufferGeometry.html">Schemas/Geometries/ExtrudeBufferGeometry</a></li><li><a href="module-Schemas_Geometries_ExtrudeGeometry.html">Schemas/Geometries/ExtrudeGeometry</a></li><li><a href="module-Schemas_Geometries_IcosahedronBufferGeometry.html">Schemas/Geometries/IcosahedronBufferGeometry</a></li><li><a href="module-Schemas_Geometries_IcosahedronGeometry.html">Schemas/Geometries/IcosahedronGeometry</a></li><li><a href="module-Schemas_Geometries_InstancedBufferGeometry.html">Schemas/Geometries/InstancedBufferGeometry</a></li><li><a href="module-Schemas_Geometries_LatheBufferGeometry.html">Schemas/Geometries/LatheBufferGeometry</a></li><li><a href="module-Schemas_Geometries_LatheGeometry.html">Schemas/Geometries/LatheGeometry</a></li><li><a href="module-Schemas_Geometries_OctahedronBufferGeometry.html">Schemas/Geometries/OctahedronBufferGeometry</a></li><li><a href="module-Schemas_Geometries_OctahedronGeometry.html">Schemas/Geometries/OctahedronGeometry</a></li><li><a href="module-Schemas_Geometries_ParametricBufferGeometry.html">Schemas/Geometries/ParametricBufferGeometry</a></li><li><a href="module-Schemas_Geometries_ParametricGeometry.html">Schemas/Geometries/ParametricGeometry</a></li><li><a href="module-Schemas_Geometries_PlaneBufferGeometry.html">Schemas/Geometries/PlaneBufferGeometry</a></li><li><a href="module-Schemas_Geometries_PlaneGeometry.html">Schemas/Geometries/PlaneGeometry</a></li><li><a href="module-Schemas_Geometries_PolyhedronBufferGeometry.html">Schemas/Geometries/PolyhedronBufferGeometry</a></li><li><a href="module-Schemas_Geometries_PolyhedronGeometry.html">Schemas/Geometries/PolyhedronGeometry</a></li><li><a href="module-Schemas_Geometries_RingBufferGeometry.html">Schemas/Geometries/RingBufferGeometry</a></li><li><a href="module-Schemas_Geometries_RingGeometry.html">Schemas/Geometries/RingGeometry</a></li><li><a href="module-Schemas_Geometries_ShapeBufferGeometry.html">Schemas/Geometries/ShapeBufferGeometry</a></li><li><a href="module-Schemas_Geometries_ShapeGeometry.html">Schemas/Geometries/ShapeGeometry</a></li><li><a href="module-Schemas_Geometries_SphereBufferGeometry.html">Schemas/Geometries/SphereBufferGeometry</a></li><li><a href="module-Schemas_Geometries_SphereGeometry.html">Schemas/Geometries/SphereGeometry</a></li><li><a href="module-Schemas_Geometries_TeapotBufferGeometry.html">Schemas/Geometries/TeapotBufferGeometry</a></li><li><a href="module-Schemas_Geometries_TetrahedronBufferGeometry.html">Schemas/Geometries/TetrahedronBufferGeometry</a></li><li><a href="module-Schemas_Geometries_TetrahedronGeometry.html">Schemas/Geometries/TetrahedronGeometry</a></li><li><a href="module-Schemas_Geometries_TextBufferGeometry.html">Schemas/Geometries/TextBufferGeometry</a></li><li><a href="module-Schemas_Geometries_TextGeometry.html">Schemas/Geometries/TextGeometry</a></li><li><a href="module-Schemas_Geometries_TorusBufferGeometry.html">Schemas/Geometries/TorusBufferGeometry</a></li><li><a href="module-Schemas_Geometries_TorusGeometry.html">Schemas/Geometries/TorusGeometry</a></li><li><a href="module-Schemas_Geometries_TorusKnotBufferGeometry.html">Schemas/Geometries/TorusKnotBufferGeometry</a></li><li><a href="module-Schemas_Geometries_TorusKnotGeometry.html">Schemas/Geometries/TorusKnotGeometry</a></li><li><a href="module-Schemas_Geometries_TubeBufferGeometry.html">Schemas/Geometries/TubeBufferGeometry</a></li><li><a href="module-Schemas_Geometries_TubeGeometry.html">Schemas/Geometries/TubeGeometry</a></li><li><a href="module-Schemas_Geometries_WireframeGeometry.html">Schemas/Geometries/WireframeGeometry</a></li><li><a href="module-Schemas_Helpers_ArrowHelper.html">Schemas/Helpers/ArrowHelper</a></li><li><a href="module-Schemas_Helpers_AxesHelper.html">Schemas/Helpers/AxesHelper</a></li><li><a href="module-Schemas_Helpers_Box3Helper.html">Schemas/Helpers/Box3Helper</a></li><li><a href="module-Schemas_Helpers_BoxHelper.html">Schemas/Helpers/BoxHelper</a></li><li><a href="module-Schemas_Helpers_CameraHelper.html">Schemas/Helpers/CameraHelper</a></li><li><a href="module-Schemas_Helpers_DirectionalLightHelper.html">Schemas/Helpers/DirectionalLightHelper</a></li><li><a href="module-Schemas_Helpers_FaceNormalsHelper.html">Schemas/Helpers/FaceNormalsHelper</a></li><li><a href="module-Schemas_Helpers_GridHelper.html">Schemas/Helpers/GridHelper</a></li><li><a href="module-Schemas_Helpers_HemisphereLightHelper.html">Schemas/Helpers/HemisphereLightHelper</a></li><li><a href="module-Schemas_Helpers_PlaneHelper.html">Schemas/Helpers/PlaneHelper</a></li><li><a href="module-Schemas_Helpers_PointLightHelper.html">Schemas/Helpers/PointLightHelper</a></li><li><a href="module-Schemas_Helpers_PolarGridHelper.html">Schemas/Helpers/PolarGridHelper</a></li><li><a href="module-Schemas_Helpers_RectAreaLightHelper.html">Schemas/Helpers/RectAreaLightHelper</a></li><li><a href="module-Schemas_Helpers_SkeletonHelper.html">Schemas/Helpers/SkeletonHelper</a></li><li><a href="module-Schemas_Helpers_SpotLightHelper.html">Schemas/Helpers/SpotLightHelper</a></li><li><a href="module-Schemas_Helpers_VertexNormalsHelper.html">Schemas/Helpers/VertexNormalsHelper</a></li><li><a href="module-Schemas_Lights_AmbientLight.html">Schemas/Lights/AmbientLight</a></li><li><a href="module-Schemas_Lights_DirectionalLight.html">Schemas/Lights/DirectionalLight</a></li><li><a href="module-Schemas_Lights_DirectionalLightShadow.html">Schemas/Lights/DirectionalLightShadow</a></li><li><a href="module-Schemas_Lights_HemisphereLight.html">Schemas/Lights/HemisphereLight</a></li><li><a href="module-Schemas_Lights_Light.html">Schemas/Lights/Light</a></li><li><a href="module-Schemas_Lights_LightShadow.html">Schemas/Lights/LightShadow</a></li><li><a href="module-Schemas_Lights_PointLight.html">Schemas/Lights/PointLight</a></li><li><a href="module-Schemas_Lights_RectAreaLight.html">Schemas/Lights/RectAreaLight</a></li><li><a href="module-Schemas_Lights_SpotLight.html">Schemas/Lights/SpotLight</a></li><li><a href="module-Schemas_Lights_SpotLightShadow.html">Schemas/Lights/SpotLightShadow</a></li><li><a href="module-Schemas_Materials_LineBasicMaterial.html">Schemas/Materials/LineBasicMaterial</a></li><li><a href="module-Schemas_Materials_LineDashedMaterial.html">Schemas/Materials/LineDashedMaterial</a></li><li><a href="module-Schemas_Materials_Material.html">Schemas/Materials/Material</a></li><li><a href="module-Schemas_Materials_MeshBasicMaterial.html">Schemas/Materials/MeshBasicMaterial</a></li><li><a href="module-Schemas_Materials_MeshDepthMaterial.html">Schemas/Materials/MeshDepthMaterial</a></li><li><a href="module-Schemas_Materials_MeshLambertMaterial.html">Schemas/Materials/MeshLambertMaterial</a></li><li><a href="module-Schemas_Materials_MeshNormalMaterial.html">Schemas/Materials/MeshNormalMaterial</a></li><li><a href="module-Schemas_Materials_MeshPhongMaterial.html">Schemas/Materials/MeshPhongMaterial</a></li><li><a href="module-Schemas_Materials_MeshPhysicalMaterial.html">Schemas/Materials/MeshPhysicalMaterial</a></li><li><a href="module-Schemas_Materials_MeshStandardMaterial.html">Schemas/Materials/MeshStandardMaterial</a></li><li><a href="module-Schemas_Materials_MeshToonMaterial.html">Schemas/Materials/MeshToonMaterial</a></li><li><a href="module-Schemas_Materials_PointsMaterial.html">Schemas/Materials/PointsMaterial</a></li><li><a href="module-Schemas_Materials_RawShaderMaterial.html">Schemas/Materials/RawShaderMaterial</a></li><li><a href="module-Schemas_Materials_ShaderMaterial.html">Schemas/Materials/ShaderMaterial</a></li><li><a href="module-Schemas_Materials_ShadowMaterial.html">Schemas/Materials/ShadowMaterial</a></li><li><a href="module-Schemas_Materials_SpriteMaterial.html">Schemas/Materials/SpriteMaterial</a></li><li><a href="module-Schemas_Math_Box2.html">Schemas/Math/Box2</a></li><li><a href="module-Schemas_Math_Box3.html">Schemas/Math/Box3</a></li><li><a href="module-Schemas_Math_Line3.html">Schemas/Math/Line3</a></li><li><a href="module-Schemas_Math_Plane.html">Schemas/Math/Plane</a></li><li><a href="module-Schemas_Math_Ray.html">Schemas/Math/Ray</a></li><li><a href="module-Schemas_Math_Sphere.html">Schemas/Math/Sphere</a></li><li><a href="module-Schemas_Math_Spherical.html">Schemas/Math/Spherical</a></li><li><a href="module-Schemas_Math_Triangle.html">Schemas/Math/Triangle</a></li><li><a href="module-Schemas_Maths_ColorConverter.html">Schemas/Maths/ColorConverter</a></li><li><a href="module-Schemas_Maths_Cylindrical.html">Schemas/Maths/Cylindrical</a></li><li><a href="module-Schemas_Maths_Frustum.html">Schemas/Maths/Frustum</a></li><li><a href="module-Schemas_Maths_Interpolant.html">Schemas/Maths/Interpolant</a></li><li><a href="module-Schemas_Maths_Lut.html">Schemas/Maths/Lut</a></li><li><a href="module-Schemas_Maths_Math.html">Schemas/Maths/Math</a></li><li><a href="module-Schemas_Object3D.html">Schemas/Object3D</a></li><li><a href="module-Schemas_Objects_Bone.html">Schemas/Objects/Bone</a></li><li><a href="module-Schemas_Objects_Car.html">Schemas/Objects/Car</a></li><li><a href="module-Schemas_Objects_GPUParticleSystem.html">Schemas/Objects/GPUParticleSystem</a></li><li><a href="module-Schemas_Objects_Group.html">Schemas/Objects/Group</a></li><li><a href="module-Schemas_Objects_Gyroscope.html">Schemas/Objects/Gyroscope</a></li><li><a href="module-Schemas_Objects_ImmediateRenderObject.html">Schemas/Objects/ImmediateRenderObject</a></li><li><a href="module-Schemas_Objects_LOD.html">Schemas/Objects/LOD</a></li><li><a href="module-Schemas_Objects_LensFlare.html">Schemas/Objects/LensFlare</a></li><li><a href="module-Schemas_Objects_Line.html">Schemas/Objects/Line</a></li><li><a href="module-Schemas_Objects_LineLoop.html">Schemas/Objects/LineLoop</a></li><li><a href="module-Schemas_Objects_LineSegments.html">Schemas/Objects/LineSegments</a></li><li><a href="module-Schemas_Objects_MD2Character.html">Schemas/Objects/MD2Character</a></li><li><a href="module-Schemas_Objects_MD2CharacterComplex.html">Schemas/Objects/MD2CharacterComplex</a></li><li><a href="module-Schemas_Objects_MarchingCubes.html">Schemas/Objects/MarchingCubes</a></li><li><a href="module-Schemas_Objects_Mesh.html">Schemas/Objects/Mesh</a></li><li><a href="module-Schemas_Objects_MorphAnimMesh.html">Schemas/Objects/MorphAnimMesh</a></li><li><a href="module-Schemas_Objects_MorphBlendMesh.html">Schemas/Objects/MorphBlendMesh</a></li><li><a href="module-Schemas_Objects_Ocean.html">Schemas/Objects/Ocean</a></li><li><a href="module-Schemas_Objects_Points.html">Schemas/Objects/Points</a></li><li><a href="module-Schemas_Objects_Reflector.html">Schemas/Objects/Reflector</a></li><li><a href="module-Schemas_Objects_ReflectorRTT.html">Schemas/Objects/ReflectorRTT</a></li><li><a href="module-Schemas_Objects_Refractor.html">Schemas/Objects/Refractor</a></li><li><a href="module-Schemas_Objects_RollerCoaster.html">Schemas/Objects/RollerCoaster</a></li><li><a href="module-Schemas_Objects_ShadowMesh.html">Schemas/Objects/ShadowMesh</a></li><li><a href="module-Schemas_Objects_Skeleton.html">Schemas/Objects/Skeleton</a></li><li><a href="module-Schemas_Objects_SkinnedMesh.html">Schemas/Objects/SkinnedMesh</a></li><li><a href="module-Schemas_Objects_Sky.html">Schemas/Objects/Sky</a></li><li><a href="module-Schemas_Objects_Sprite.html">Schemas/Objects/Sprite</a></li><li><a href="module-Schemas_Objects_UCSCharacter.html">Schemas/Objects/UCSCharacter</a></li><li><a href="module-Schemas_Objects_Water.html">Schemas/Objects/Water</a></li><li><a href="module-Schemas_Objects_Water2.html">Schemas/Objects/Water2</a></li><li><a href="module-Schemas_Scenes_Fog.html">Schemas/Scenes/Fog</a></li><li><a href="module-Schemas_Scenes_FogExp2.html">Schemas/Scenes/FogExp2</a></li><li><a href="module-Schemas_Textures_CanvasTexture.html">Schemas/Textures/CanvasTexture</a></li><li><a href="module-Schemas_Textures_CompressedTexture.html">Schemas/Textures/CompressedTexture</a></li><li><a href="module-Schemas_Textures_CubeTexture.html">Schemas/Textures/CubeTexture</a></li><li><a href="module-Schemas_Textures_DataTexture.html">Schemas/Textures/DataTexture</a></li><li><a href="module-Schemas_Textures_DepthTexture.html">Schemas/Textures/DepthTexture</a></li><li><a href="module-Schemas_Textures_Texture.html">Schemas/Textures/Texture</a></li><li><a href="module-Schemas_Textures_VideoTexture.html">Schemas/Textures/VideoTexture</a></li><li><a href="module-Types_Color.html">Types/Color</a></li><li><a href="module-Types_Euler.html">Types/Euler</a></li><li><a href="module-Types_Matrix3.html">Types/Matrix3</a></li><li><a href="module-Types_Matrix4.html">Types/Matrix4</a></li><li><a href="module-Types_Quaternion.html">Types/Quaternion</a></li><li><a href="module-Types_Vector2.html">Types/Vector2</a></li><li><a href="module-Types_Vector3.html">Types/Vector3</a></li><li><a href="module-Types_Vector4.html">Types/Vector4</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b class="caret"></b></a>
				<ul class="dropdown-menu inline">
					<li><a href="AbstractMongooseModel.html">AbstractMongooseModel</a></li><li><a href="BitManager.html">BitManager</a></li><li><a href="module-Controllers_CameraControls-CameraControls.html">Controllers/CameraControls~CameraControls</a></li><li><a href="module-Controllers_CameraPathController-CameraPathController.html">Controllers/CameraPathController~CameraPathController</a></li><li><a href="module-Converters_AscToThree-AscToThree.html">Converters/AscToThree~AscToThree</a></li><li><a href="module-Converters_ColladaToThree-ColladaToThree.html">Converters/ColladaToThree~ColladaToThree</a></li><li><a href="module-Converters_DbfToThree-DbfToThree.html">Converters/DbfToThree~DbfToThree</a></li><li><a href="module-Converters_FbxToThree-FbxToThree.html">Converters/FbxToThree~FbxToThree</a></li><li><a href="module-Converters_JsonToThree-JsonToThree.html">Converters/JsonToThree~JsonToThree</a></li><li><a href="module-Converters_LasToThree-LasToThree.html">Converters/LasToThree~LasToThree</a></li><li><a href="module-Converters_MtlToThree-MtlToThree.html">Converters/MtlToThree~MtlToThree</a></li><li><a href="module-Converters_Obj2ToThree-Obj2ToThree.html">Converters/Obj2ToThree~Obj2ToThree</a></li><li><a href="module-Converters_ObjToThree-ObjToThree.html">Converters/ObjToThree~ObjToThree</a></li><li><a href="module-Converters_ShpToThree-ShpToThree.html">Converters/ShpToThree~ShpToThree</a></li><li><a href="module-Converters_StlToThree-StlToThree.html">Converters/StlToThree~StlToThree</a></li><li><a href="module-Converters_TdsToThree-TdsToThree.html">Converters/TdsToThree~TdsToThree</a></li><li><a href="module-Inserters_ThreeToMongoDB-ThreeToMongoDB.html">Inserters/ThreeToMongoDB~ThreeToMongoDB</a></li><li><a href="module-Loader_ASCLoader-ASCLoader.html">Loader/ASCLoader~ASCLoader</a></li><li><a href="module-Loader_DBFLoader-DBFLoader.html">Loader/DBFLoader~DBFLoader</a></li><li><a href="module-Loader_LASLoader-LASLoader.html">Loader/LASLoader~LASLoader</a></li><li><a href="module-Loader_SHPLoader-SHPLoader.html">Loader/SHPLoader~SHPLoader</a></li><li><a href="module-Managers_GeometriesManager-GeometriesManager.html">Managers/GeometriesManager~GeometriesManager</a></li><li><a href="module-Managers_MaterialsManager-MaterialsManager.html">Managers/MaterialsManager~MaterialsManager</a></li><li><a href="module-Managers_ObjectsManager-ObjectsManager.html">Managers/ObjectsManager~ObjectsManager</a></li><li><a href="module-Managers_TexturesManager-TexturesManager.html">Managers/TexturesManager~TexturesManager</a></li><li><a href="module-Objects3D_OrbitControlsHelper-OrbitControlsHelper.html">Objects3D/OrbitControlsHelper~OrbitControlsHelper</a></li><li><a href="module-Types_Color-Color.html">Types/Color~Color</a></li><li><a href="module-Types_Euler-Euler.html">Types/Euler~Euler</a></li><li><a href="module-Types_Matrix3-Matrix3.html">Types/Matrix3~Matrix3</a></li><li><a href="module-Types_Matrix4-Matrix4.html">Types/Matrix4~Matrix4</a></li><li><a href="module-Types_Quaternion-Quaternion.html">Types/Quaternion~Quaternion</a></li><li><a href="module-Types_Vector2-Vector2.html">Types/Vector2~Vector2</a></li><li><a href="module-Types_Vector3-Vector3.html">Types/Vector3~Vector3</a></li><li><a href="module-Types_Vector4-Vector4.html">Types/Vector4~Vector4</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="events.list.html" class="dropdown-toggle" data-toggle="dropdown">Events<b class="caret"></b></a>
				<ul class="dropdown-menu inline">
					<li><a href="module-Controllers_CameraControls-CameraControls.html#event:change">Controllers/CameraControls~CameraControls#event:change</a></li><li><a href="module-Controllers_CameraControls-CameraControls.html#event:move">Controllers/CameraControls~CameraControls#event:move</a></li><li><a href="module-Controllers_CameraControls-CameraControls.html#event:rotate">Controllers/CameraControls~CameraControls#event:rotate</a></li><li><a href="module-Controllers_CameraControls-CameraControls.html#event:scale">Controllers/CameraControls~CameraControls#event:scale</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="interfaces.list.html" class="dropdown-toggle" data-toggle="dropdown">Interfaces<b class="caret"></b></a>
				<ul class="dropdown-menu inline">
					<li><a href="Enum.html">Enum</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Global<b class="caret"></b></a>
				<ul class="dropdown-menu inline">
					<li><a href="global.html#Left_Down_Back">Left_Down_Back</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="externals.list.html" class="dropdown-toggle" data-toggle="dropdown">Externals<b class="caret"></b></a>
				<ul class="dropdown-menu inline">
					<li><a href="external-_Itee.Client_.html">Itee.Client</a></li><li><a href="external-_Itee.Database_.html">Itee.Database</a></li><li><a href="external-_Itee.MongoDB_.html">Itee.MongoDB</a></li><li><a href="external-_Itee.Utils_.html">Itee.Utils</a></li><li><a href="external-_Itee.Validators_.html">Itee.Validators</a></li><li><a href="external-_Three%2520Full_.html">Three Full</a></li><li><a href="external-_mongodb_js-bson_.html">mongodb/js-bson</a></li><li><a href="external-Mongoose.html">Mongoose</a></li><li><a href="external-THREE.html">THREE</a></li>
				</ul>
			</li>
			
		</ul>
        
            <div class="col-sm-3 col-md-3">
                <form class="navbar-form" role="search">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search" name="q" id="search-input">
                        <div class="input-group-btn">
                            <button class="btn btn-default" id="search-submit"><i class="glyphicon glyphicon-search"></i></button>
                        </div>
                    </div>
                </form>
            </div>
        
	</div>

</div>
</div>


<div class="container" id="toc-content">
<div class="row">

	
	<div class="col-md-12">
	
		<div id="main">
			

		<h1 class="page-title">Source: sources/backend/inserters/ThreeToMongoDB.js</h1>
    
<section>
    <article>
        <pre
            class="sunlight-highlight-javascript linenums">/**
 * @module Inserters/ThreeToMongoDB
 * @desc Export ThreeToMongoDB mongodb inserter class.
 *
 * @requires {@link https://github.com/Itee/itee-client itee-client}
 * @requires {@link https://github.com/Itee/itee-database itee-database}
 * @requires {@link https://github.com/Itee/itee-validators itee-validators}
 *
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 */

import { DefaultLogger }         from 'itee-core'
import { TAbstractDataInserter } from 'itee-database'
import { toArray }               from 'itee-utils'
import {
    isDefined,
    isEmptyArray,
    isNotDefined,
    isNull
}                                from 'itee-validators'

/**
 * This class allow to insert ThreeJs stuff in MongoDB database.
 *
 * @class
 * @augments TAbstractDataInserter
 */
class ThreeToMongoDB extends TAbstractDataInserter {

    /**
     * @constructor
     * @param {Object} [parameters={}] - An object containing all parameters to pass through the inheritance chain and for initialize this instance
     * @param {TLogger} [parameters.logger=Itee.Core.DefaultLogger]
     */
    constructor( parameters = {} ) {

        const _parameters = {
            ...{
                logger: DefaultLogger
            }, ...parameters
        }
        super( _parameters )

        this.logger        = _parameters.logger
        this.mergeStrategy = 'add'

        this._cache = {}

        // Addition
        // Update
        // Deletion

        // Add objects from file if missing in database
        // Remove objects from database if missing in file
        // Update objects in database if existing in file

    }
    // Utils
    static _toLog( object ) {

        return JSON.stringify( {
            type: object.type || 'undefined',
            name: object.name || 'undefined',
            uuid: object.uuid || 'undefined',
            id:   object._id || 'undefined'
        } )

    }
    /**
     * Main entry point to insert data into database; It apply merge strategy over data to insert.
     *
     * @param {Object} data - The ThreeJs data to insert
     * @param {Object} parameters - A parameters map that contain parsing options
     * @param {String} [parameters.mergeStrategy=add] - The merging strategy to apply during insert process
     * @param {callback} onSuccess - A callback that will handle the parsed result
     * @param {callback} onProgress - A callback that will handle the parsing progress
     * @param {callback} onError - A callback that will handle the parsing errors
     * @returns {Promise&lt;void>}
     * @private
     */
    async _save( data, parameters, onSuccess, onProgress, onError ) {

        const dataToParse = toArray( data )
        if ( isEmptyArray( dataToParse ) ) {
            onError( 'No data to save in database. Abort insert !' )
            return
        }

        const names = dataToParse.map( _data => _data.name )
        this.logger.log( `ThreeToMongoDB: Saving ${ names }` )

        // Check startegy
        if ( parameters.mergeStrategy ) {
            this.mergeStrategy = parameters.mergeStrategy
        }

        try {

            // Check if parent is required
            const parentId  = parameters.parentId
            let children    = null
            let childrenIds = null
            if ( isDefined( parentId ) ) {

                const parentDocument = await this._readDocument( 'Objects3D', { _id: parentId } )
                if ( isNull( parentDocument ) ) {
                    onError( `Unable to retrieve parent with id (${ parameters.parentId }). Abort insert !` )
                    return
                }

                // then update it
                if ( this.mergeStrategy === 'add' ) {

                    // If parent exist let create children
                    children    = await this._parseObjects( dataToParse, parentId )
                    childrenIds = ( isDefined( children ) ) ? children.filter( child => child ).map( child => child._id ) : []

                    // Add children to given parent
                    await this._updateDocument( parentDocument, {
                        $addToSet: {
                            children: childrenIds
                        }
                    } )

                } else if ( this.mergeStrategy === 'replace' ) {

                    // Merge children into parent
                    //// Clean up current dbObject dependencies
                    // Children create and update will be perform on children iteration but remove need to be checked here !
                    const dbChildren         = await this._readDocuments( 'Objects3D', { parent: parentId } )
                    const childrenUuids      = dataToParse.map( child => child.uuid )
                    const dbChildrenToRemove = dbChildren.filter( dbChild => !childrenUuids.includes( dbChild.uuid ) )

                    await this._removeChildrenDocuments( dbChildrenToRemove )

                    // If parent exist let create children
                    children    = await this._parseObjects( dataToParse, parentId )
                    childrenIds = ( isDefined( children ) ) ? children.filter( child => child ).map( child => child._id ) : []

                    await this._updateDocument( parentDocument, {
                        $set: {
                            children: childrenIds
                        }
                    } )

                }

            } else {

                // If not required just create children as root objects
                children    = await this._parseObjects( dataToParse, null )
                childrenIds = ( isDefined( children ) ) ? children.filter( child => child ).map( child => child._id ) : []

            }

            this.logger.log( `ThreeToMongoDB: Saved ${ childrenIds }` )
            onSuccess()

        } catch ( error ) {
            onError( error )
        } finally {
            this._cache = {}
        }

    }

    /**
     * Allow to parse multiple objects on parallel.
     * In case objects is not an array it will be converted to it before any processing.
     * If the given array is empty it return null.
     *
     * @param {Object|Array&lt;Object>} [objects=[]] - The objects to parse
     * @param {String} [parentId=null] - The mongodb parent id to apply to current objects
     * @returns {Promise&lt;Array&lt;Mongoose.Query|null>>|null}
     * @private
     */
    async _parseObjects( objects = [], parentId = null ) {
        this.logger.debug( `_parseObjects(...)` )

        const _objects = toArray( objects )
        if ( isEmptyArray( _objects ) ) {
            return null
        }

        const documents = []
        for ( let index = 0, numberOfObjects = _objects.length ; index &lt; numberOfObjects ; index++ ) {
            documents.push( this._parseObject( _objects[ index ], parentId ) )
        }

        return Promise.all( documents )

    }

    /**
     * Allow to parse one object. In function of the mergingStrategy it will perform any database CRUD operation.
     *
     * @param {Object} objects - The object to parse
     * @param {String} [parentId=null] - The mongodb parent id to apply to current object
     * @returns {Promise&lt;Mongoose.Query|null>|null}
     * @private
     */
    async _parseObject( object, parentId = null ) {
        this.logger.debug( `_parseObject(${ ThreeToMongoDB._toLog( object ) }, ${ parentId })` )

        if ( isNotDefined( object ) ) {
            return null
        }

        // Preprocess objects here to save geometry, materials and related before to save the object itself
        const objectType      = object.type
        const objectName      = object.name
        const objectGeometry  = object.geometry
        const objectChildren  = toArray( object.children )
        const objectMaterials = toArray( object.material )

        // If it is a terminal object ( No children ) with an empty geometry
        if ( isDefined( objectGeometry ) &amp;&amp; isEmptyArray( objectChildren ) ) {

            if ( objectGeometry.isGeometry ) {

                const vertices = objectGeometry.vertices
                if ( isNotDefined( vertices ) || isEmptyArray( vertices ) ) {
                    this.logger.error( `Leaf object ${ objectName } have a geometry that doesn't contain vertices ! Skip it.` )
                    return null
                }

            } else if ( objectGeometry.isBufferGeometry ) {

                const attributes = objectGeometry.attributes
                if ( isNotDefined( attributes ) ) {
                    this.logger.error( `Buffer geometry of ${ objectName } doesn't contain attributes ! Skip it.` )
                    return null
                }

                const positions = attributes.position
                if ( isNotDefined( positions ) || positions.count === 0 ) {
                    this.logger.error( `Leaf object ${ objectName } have a buffer geometry that doesn't contain position attribute ! Skip it.` )
                    return null
                }

            } else {
                this.logger.error( `Object ${ objectName } contain an unknown/unmanaged geometry of type ${ objectGeometry.type } ! Skip it.` )
                return null
            }

        }

        let availableMaterialTypes = null

        if ( ThreeToMongoDB.AvailableLineTypes.includes( objectType ) ) {

            if ( isNotDefined( objectGeometry ) ) {
                this.logger.error( `Missing geometry for object ${ object.name } of type ${ objectType }. Only Sprite can contains material without geometry ! Skip it.` )
                return null
            }

            availableMaterialTypes = ThreeToMongoDB.AvailableLineMaterialTypes

        } else if ( ThreeToMongoDB.AvailablePointTypes.includes( objectType ) ) {

            if ( isNotDefined( objectGeometry ) ) {
                this.logger.error( `Missing geometry for object ${ object.name } of type ${ objectType }. Only Sprite can contains material without geometry ! Skip it.` )
                return null
            }

            availableMaterialTypes = ThreeToMongoDB.AvailablePointMaterialTypes

        } else if ( ThreeToMongoDB.AvailableSpriteTypes.includes( objectType ) ) {

            availableMaterialTypes = ThreeToMongoDB.AvailableSpriteMaterialTypes

        }

        if ( availableMaterialTypes ) {

            for ( let materialIndex = 0, numberOfMaterials = objectMaterials.length ; materialIndex &lt; numberOfMaterials ; materialIndex++ ) {

                const material     = objectMaterials[ materialIndex ]
                const materialType = material.type
                if ( !availableMaterialTypes.includes( materialType ) ) {
                    this.logger.error( `Object ${ objectName } of type ${ objectType }, contain an invalid material of type ${ materialType } ! Skip it.` )
                    return null
                }

            }

        }

        const geometry   = await this._getOrCreateDocuments( objectGeometry )
        const geometryId = ( isDefined( geometry ) ) ? geometry.filter( geometry => geometry ).map( geometry => geometry._id ).pop() : null

        const materials    = await this._getOrCreateDocuments( objectMaterials )
        const materialsIds = ( isDefined( materials ) ) ? materials.filter( material => material ).map( material => material._id ) : []

        // Check if object already exist
        // We could use getOrCreateDocument here only if children/geometry/materials cleanup is perform on schema database side
        let document = await this._readDocument( objectType, {
            uuid:   object.uuid,
            parent: parentId
        } )

        // Todo if document.parent != parentId warn id collision !n m
        if ( isDefined( document ) ) {

            // Check merge strategie
            // If add, only update existing and create new objects
            // else if replace, remove missings children from new data, update existing and create new
            if ( this.mergeStrategy === 'add' ) {

                const children    = await this._parseObjects( objectChildren, document._id )
                const childrenIds = ( isDefined( children ) ) ? children.filter( child => child ).map( child => child._id ) : []

                await this._updateDocument( document, {
                    $addToSet: {
                        children: childrenIds // geometry: geometryId, // Geometry is not an array !!
                        // material: materialsIds // Should check which material still exist !!!
                    }
                } )

            } else if ( this.mergeStrategy === 'replace' ) {

                //// Clean up current dbObject dependencies
                // Children create and update will be perform on children iteration but remove need to be checked here !
                const dbChildren         = await this._readDocuments( 'Objects3D', { parent: document._id } )
                const childrenUuids      = objectChildren.map( child => child.uuid )
                const dbChildrenToRemove = dbChildren.filter( dbChild => !childrenUuids.includes( dbChild.uuid ) )

                await this._removeChildrenDocuments( dbChildrenToRemove )

                const children    = await this._parseObjects( objectChildren, document._id )
                const childrenIds = ( isDefined( children ) ) ? children.filter( child => child ).map( child => child._id ) : []

                await this._updateDocument( document, {
                    $set: {
                        children: childrenIds,
                        geometry: geometryId,
                        material: materialsIds
                    }
                } )

            } else {
                this.logger.error( `Unknown/Unmanaged merge srategy ${ this.mergeStrategy }` )
            }

        } else {

            object.parent   = parentId
            object.children = []
            object.geometry = geometryId
            object.material = materialsIds
            document        = await this._createDocument( object )

            const children    = await this._parseObjects( objectChildren, document._id )
            const childrenIds = ( isDefined( children ) ) ? children.filter( child => child ).map( child => child._id ) : []

            await this._updateDocument( document, {
                $set: {
                    children: childrenIds,
                    geometry: geometryId,
                    material: materialsIds
                }
            } )

        }

        return document

    }

    /**
     * Allow to update or create multiple objects on parallel. It create object only if it does not exist in database, else it perform an update based on given data.
     * In case objects parameter is not an array it will be converted to it before any processing.
     * If the given array is empty it return null.
     *
     * @param {Object|Array&lt;Object>} [objects=[]] - The objects to updates or creates if not exist
     * @returns {Promise&lt;Array&lt;Mongoose.Document|null>>|null}
     * @private
     */
    async _getOrCreateDocuments( objects = [] ) {
        this.logger.debug( `_getOrCreateDocuments(...)` )

        const _objects = toArray( objects )
        if ( isEmptyArray( _objects ) ) {
            return null
        }

        const documents = []
        for ( let index = 0, numberOfObjects = _objects.length ; index &lt; numberOfObjects ; index++ ) {
            documents.push( this._getOrCreateDocument( _objects[ index ] ) )
        }

        return Promise.all( documents )

    }

    // Todo: Rename to _updateOrCreateDocument
    /**
     * Update or create an object. It create object only if it does not exist in database, else it perform an update based on given data.
     * If the given data is null or undefined it return null.
     *
     * @param {Object} data - The data to update or create if not exist
     * @returns {Promise&lt;Mongoose.Document|null>|null}
     * @private
     */
    async _getOrCreateDocument( data ) {
        this.logger.debug( `_getOrCreateDocument(${ ThreeToMongoDB._toLog( data ) })` )

        if ( isNotDefined( data ) ) {
            return null
        }

        let document = await this._readDocument( data.type, { uuid: data.uuid } )
        if ( isDefined( document ) ) {
            document = await this._updateDocument( document, data )
        } else {
            document = await this._createDocument( data )
        }

        return document

    }

    /**
     * Create new database entries based on given datas.
     * In case datas parameter is not an array it will be converted to it before any processing.
     * If the given array is empty it return null.
     *
     * @param {Object|Array&lt;Object>} [datas=[]] - The objects to creates
     * @returns {Promise&lt;Array&lt;Mongoose.Document|null>>|null}
     * @private
     */
    async _createDocuments( datas = [] ) {
        this.logger.debug( `_createDocuments(...)` )

        const _datas = toArray( datas )
        if ( isEmptyArray( _datas ) ) {
            return null
        }

        const documents = []
        for ( let index = 0, numberOfDocuments = _datas.length ; index &lt; numberOfDocuments ; index++ ) {
            documents.push( this._createDocument( _datas[ index ] ) )
        }

        return Promise.all( documents )

    }

    /**
     * Create new database entry based on given data.
     * If the given data is null or undefined it return null.
     *
     * @param {Object} data - The object to create
     * @returns {Promise&lt;Mongoose.Document|null>|null}
     * @private
     */
    async _createDocument( data ) {
        this.logger.debug( `_createDocument(${ ThreeToMongoDB._toLog( data ) })` )

        if ( isNotDefined( data ) ) {
            return null
        }

        const model = await this._driver
                                .model( data.type )( data )
                                .save()

        //        const model         = this._driver.model( data.type )
        //        const savedModel = await model( data ).save()

        const savedDocument = ( isDefined( model ) ) ? model._doc : null
        if ( savedDocument ) {
            this._cache[ savedDocument.uuid ] = savedDocument
        }

        return savedDocument

    }

    /**
     * Read all document based on a model type, and a object query that match.
     * If the given type or query are null or undefined it return null.
     *
     * @param {String} type - The Mongoose Model type on which read query must be perform
     * @param {Object} query - The find conditions to match document
     * @returns {Promise&lt;Array&lt;Mongoose.Document|null>>|null}
     * @private
     */
    async _readDocuments( type, query ) {
        this.logger.debug( `_readDocuments(...)` )

        if ( isNotDefined( type ) || isNotDefined( query ) ) {
            return null
        }

        let models = await this._driver
                               .model( type )
                               .find( query )
                               .exec()

        return models.map( model => model._doc )
    }

    /**
     * Read one document based on a model type, and a object query that match.
     * If the given type or query are null or undefined it return null.
     *
     * @param {String} type - The Mongoose Model type on which read query must be perform
     * @param {Object} query - The find conditions to match document
     * @returns {Promise&lt;Mongoose.Document|null>|null}
     * @private
     */
    async _readDocument( type, query ) {
        this.logger.debug( `_readDocument(${ type }, ${ JSON.stringify( query ) })` )

        if ( isNotDefined( type ) || isNotDefined( query ) ) {
            return null
        }

        const cachedDocument = this._cache[ query.uuid ]
        if ( cachedDocument ) {
            return cachedDocument
        }

        const model = await this._driver
                                .model( type )
                                .findOne( query )
                                .exec()

        const readDocument = ( isDefined( model ) ) ? model._doc : null
        if ( readDocument ) {
            this._cache[ readDocument.uuid ] = readDocument
        }

        return readDocument
    }

    /**
     * Update database entries based on given datas.
     * In case documents parameter is not an array it will be converted to it before any processing.
     * If the given array is empty it return null.
     *
     * @param {Array&lt;Mongoose.Document>|Mongoose.Document} documents - The documents to updates
     * @param {Object} updateQuery - @see {@link https://mongoosejs.com/docs/api/model.html#model_Model.findByIdAndUpdate}
     * @param {Object} queryOptions - @see {@link https://mongoosejs.com/docs/api/model.html#model_Model.findByIdAndUpdate}
     * @returns {Promise&lt;Array&lt;Mongoose.Document|null>>|null}
     * @private
     */
    async _updateDocuments( documents = [], updateQuery, queryOptions ) {
        this.logger.debug( `_updateDocuments(...)` )

        const _documents = toArray( documents )
        if ( isEmptyArray( _documents ) ) {
            return null
        }

        const updates = []
        for ( let index = 0, numberOfDocuments = _documents.length ; index &lt; numberOfDocuments ; index++ ) {
            updates.push( this._updateDocument( _documents[ index ], updateQuery, queryOptions ) )
        }

        return Promise.all( updates )

    }

    /**
     * Update a database document based on given updateQuery and queryOptions.
     * If the given document is null or undefined it return null.
     *
     * @param {Mongoose.Document} document - The document to update
     * @param {Object} updateQuery - @see {@link https://mongoosejs.com/docs/api/model.html#model_Model.findByIdAndUpdate}
     * @param {Object} queryOptions - @see {@link https://mongoosejs.com/docs/api/model.html#model_Model.findByIdAndUpdate}
     * @returns {Promise&lt;Mongoose.Document|null>|null}
     * @private
     */
    async _updateDocument( document, updateQuery, queryOptions = { new: true } ) {
        this.logger.debug( `_updateDocument(${ ThreeToMongoDB._toLog( document ) }, ${ JSON.stringify( updateQuery ) }, ${ JSON.stringify( queryOptions ) })` )

        if ( isNotDefined( document ) ) {
            return null
        }

        const model = await this._driver
                                .model( document.type )
                                .findByIdAndUpdate( document._id, updateQuery, queryOptions )
                                .exec()

        const updatedDocument = ( isDefined( model ) ) ? model._doc : null
        if ( updatedDocument ) {
            this._cache[ updatedDocument.uuid ] = updatedDocument
        }

        return updatedDocument
    }

    /**
     * Delete database entries based on given documents.
     * In case documents parameter is not an array it will be converted to it before any processing.
     * If the given array is empty it return null.
     *
     * @param {Array&lt;Mongoose.Document>|Mongoose.Document} documents - The documents to deletes
     * @returns {Promise&lt;Array&lt;Mongoose.Document|null>>|null}
     * @private
     */
    async _deleteDocuments( documents = [] ) {
        this.logger.debug( `_deleteDocuments(...)` )

        const _documents = toArray( documents )
        if ( isEmptyArray( _documents ) ) {
            return null
        }

        const deletes = []
        for ( let index = 0, numberOfDocuments = _documents.length ; index &lt; numberOfDocuments ; index++ ) {
            deletes.push( this._deleteDocument( _documents[ index ] ) )
        }

        return Promise.all( deletes )

    }

    /**
     * Update a database document based on given updateQuery and queryOptions.
     * If the given document is null or undefined it return null.
     *
     * @param {Mongoose.Document} document - The document to delete
     * @returns {Promise&lt;Mongoose.Document|null>|null}
     * @private
     */
    async _deleteDocument( document ) {
        this.logger.debug( `_deleteDocument(${ ThreeToMongoDB._toLog( document ) })` )

        if ( isNotDefined( document ) ) {
            return null
        }

        const model = await this._driver
                                .model( document.type )
                                .findByIdAndDelete( document._id )
                                .exec()

        const deletedDocument = ( isDefined( model ) ) ? model._doc : null
        if ( deletedDocument ) {
            delete this._cache[ deletedDocument.uuid ]
        }

        return deletedDocument
    }

    ///
    /**
     * Remove documents in safe and recursive way over children, and others referenced objects.
     *
     * @param {Array&lt;Mongoose.Document>} documents - The documents to deletes
     * @returns {Promise&lt;Array&lt;void>>}
     * @private
     */
    async _removeChildrenDocuments( documents ) {
        this.logger.debug( `_removeChildrenDocuments(...)` )

        let removed = []
        for ( let childIndex = documents.length - 1 ; childIndex >= 0 ; childIndex-- ) {
            removed.push( this._removeChildDocument( documents[ childIndex ] ) )
        }
        return Promise.all( removed )

    }

    /**
     * Remove a document from database after remove his children and other related stuff like geometry, materials etc...
     *
     * @param {Mongoose.Document} document - The document to delete
     * @returns {Promise&lt;void>}
     * @private
     */
    async _removeChildDocument( document ) {
        this.logger.debug( `_removeChildDocument(${ ThreeToMongoDB._toLog( document ) })` )

        // Remove children recursively
        const children = await this._readDocuments( 'Objects3D', { parent: document._id } )
        await this._removeChildrenDocuments( children )

        // Remove geometry only if current object is the last that reference it
        await this._removeOrphanGeometryWithId( document.geometry )

        // Remove material only if current object is the last that reference it
        await this._removeOrphanMaterialsWithIds( document.material || [] )

        // finally remove the incriminated document
        await this._deleteDocument( document )

    }

    /**
     * Remove geometry only in case it is orphan and no object still reference it.
     *
     * @param {Mongoose.ObjectId|String} geometryId - The geometry id to match for deletion
     * @returns {Promise&lt;void>}
     * @private
     */
    async _removeOrphanGeometryWithId( geometryId ) {
        this.logger.debug( `_removeOrphanGeometryWithId(${ geometryId })` )

        if ( isNotDefined( geometryId ) ) { return }

        const referencingObjects = await this._readDocuments( 'Objects3D', { geometry: geometryId } )
        if ( referencingObjects.length > 1 ) { return }

        const geometryDocument = await this._readDocument( 'Geometries', { _id: geometryId } )
        await this._deleteDocument( geometryDocument )

    }

    // Remove only orphan materials
    /**
     * Remove materials only in case they are orphan and no objects still reference them.
     *
     * @param {Array&lt;Mongoose.ObjectId|String>} materialsIds - The materials ids to match for deletion
     * @returns {Promise&lt;Array&lt;void>>}
     * @private
     */
    async _removeOrphanMaterialsWithIds( materialsIds ) {
        this.logger.debug( `_removeOrphanMaterialsWithIds(...)` )

        const removed = []
        for ( let index = 0, numberOfMaterials = materialsIds.length ; index &lt; numberOfMaterials ; index++ ) {
            removed.push( this._removeOrphanMaterialWithId( materialsIds[ index ] ) )
        }

        return Promise.all( removed )

    }

    /**
     * Remove material only in case it is orphan and no object still reference it.
     *
     * @param {Mongoose.ObjectId|String} materialsIds - The material id to match for deletion
     * @returns {Promise&lt;void>}
     * @private
     */
    async _removeOrphanMaterialWithId( materialId ) {
        this.logger.debug( `_removeOrphanMaterialWithId(${ materialId })` )

        const referencingObjects = await this._readDocuments( 'Objects3D', { material: materialId } )
        if ( referencingObjects.length > 1 ) { return }

        const materialDocument = await this._readDocument( 'Materials', { _id: materialId } )
        await this._deleteDocument( materialDocument )

    }

}

/**
 * Allow to check if Materials correspond to expected Mesh type
 * @type {string[]}
 */
// Todo: Find a way to validate this on schema
ThreeToMongoDB.AvailableCurveTypes = [
    'Curve',
    'ArcCurve',
    'CatmullRomCurve3',
    'CubicBezierCurve',
    'CubicBezierCurve3',
    'EllipseCurve',
    'LineCurve',
    'LineCurve3',
    'QuadraticBezierCurve',
    'QuadraticBezierCurve3',
    'SplineCurve',
    'CurvePath',
    'Path',
    'Shape'
]
ThreeToMongoDB.AvailableLineTypes           = [ 'Line', 'LineLoop', 'LineSegments' ]
ThreeToMongoDB.AvailableLineMaterialTypes   = [ 'LineBasicMaterial', 'LineDashedMaterial' ]
ThreeToMongoDB.AvailablePointTypes          = [ 'Points' ]
ThreeToMongoDB.AvailablePointMaterialTypes  = [ 'PointsMaterial' ]
ThreeToMongoDB.AvailableSpriteTypes         = [ 'Sprite' ]
ThreeToMongoDB.AvailableSpriteMaterialTypes = [ 'SpriteMaterial' ]

export { ThreeToMongoDB }
</pre>
    </article>
</section>





		</div>
	</div>

	<div class="clearfix"></div>

	

</div>
</div>


    <div class="modal fade" id="searchResults">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">Search results</h4>
          </div>
          <div class="modal-body"></div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div>


<footer>


	<span class="copyright">
	Copyright 2015-Present <a href="https://github.com/Itee">Itee</a> (Tristan Valcke)
	</span>

<span class="jsdoc-message">
	Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a>
	
	using the <a href="https://github.com/docstrap/docstrap">DocStrap template</a>.
</span>
</footer>

<script src="scripts/docstrap.lib.js"></script>
<script src="scripts/toc.js"></script>

    <script type="text/javascript" src="scripts/fulltext-search-ui.js"></script>


<script>
$( function () {
	$( "[id*='$']" ).each( function () {
		var $this = $( this );

		$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
	} );

	$( ".tutorial-section pre, .readme-section pre, pre.prettyprint.source" ).each( function () {
		var $this = $( this );

		var example = $this.find( "code" );
		exampleText = example.html();
		var lang = /{@lang (.*?)}/.exec( exampleText );
		if ( lang && lang[1] ) {
			exampleText = exampleText.replace( lang[0], "" );
			example.html( exampleText );
			lang = lang[1];
		} else {
			var langClassMatch = example.parent()[0].className.match(/lang\-(\S+)/);
			lang = langClassMatch ? langClassMatch[1] : "javascript";
		}

		if ( lang ) {

			$this
			.addClass( "sunlight-highlight-" + lang )
			.addClass( "linenums" )
			.html( example.html() );

		}
	} );

	Sunlight.highlightAll( {
		lineNumbers : true,
		showMenu : true,
		enableDoclinks : true
	} );

	$.catchAnchorLinks( {
        navbarOffset: 10
	} );
	$( "#toc" ).toc( {
		anchorName  : function ( i, heading, prefix ) {
			return $( heading ).attr( "id" ) || ( prefix + i );
		},
		selectors   : "#toc-content h1,#toc-content h2,#toc-content h3,#toc-content h4",
		showAndHide : false,
		smoothScrolling: true
	} );

	$( "#main span[id^='toc']" ).addClass( "toc-shim" );
	$( '.dropdown-toggle' ).dropdown();

    $( "table" ).each( function () {
      var $this = $( this );
      $this.addClass('table');
    } );

} );
</script>



<!--Navigation and Symbol Display-->


<!--Google Analytics-->



    <script type="text/javascript">
        $(document).ready(function() {
            SearcherDisplay.init();
        });
    </script>


</body>
</html>
