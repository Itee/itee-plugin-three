import{DefaultLogger as e}from"itee-core";import{DefaultLoadingManager as t,Box3 as i,FileLoader as r,Group as s,BufferGeometry as n,BufferAttribute as a,PointsMaterial as o,Points as h,Vector3 as l,Shape as c,EventDispatcher as d,Object3D as p,Vector2 as u,Spherical as _,LineBasicMaterial as g,MeshBasicMaterial as m,DoubleSide as f,Mesh as b,OctahedronBufferGeometry as w,Quaternion as y,EdgesGeometry as v,LineSegments as x,Float32BufferAttribute as E,Line as P,ArrowHelper as M,CylinderBufferGeometry as F,BoxBufferGeometry as S,PlaneBufferGeometry as A,ConeBufferGeometry as O,Plane as D,Raycaster as T,Euler as I,SplineCurve as B,QuadraticBezierCurve3 as C,QuadraticBezierCurve as U,Path as k,LineCurve3 as R,LineCurve as L,EllipseCurve as z,CurvePath as G,Curve as H,CubicBezierCurve3 as N,CubicBezierCurve as j,CatmullRomCurve3 as Y,ArcCurve as X,WireframeGeometry as Z,SphereGeometry as V,TubeGeometry as W,TorusKnotGeometry as K,TorusGeometry as $,TextGeometry as q,TetrahedronGeometry as Q,ShapeGeometry as J,RingGeometry as ee,PolyhedronGeometry as te,PlaneGeometry as ie,ParametricGeometry as re,OctahedronGeometry as se,LatheGeometry as ne,IcosahedronGeometry as ae,Geometry as oe,ExtrudeGeometry as he,DodecahedronGeometry as le,ConeGeometry as ce,CylinderGeometry as de,CircleGeometry as pe,BoxGeometry as ue,Face3 as _e,InstancedBufferGeometry as ge,SphereBufferGeometry as me,TubeBufferGeometry as fe,TorusKnotBufferGeometry as be,TorusBufferGeometry as we,TextBufferGeometry as ye,TetrahedronBufferGeometry as ve,RingBufferGeometry as xe,PolyhedronBufferGeometry as Ee,ParametricBufferGeometry as Pe,LatheBufferGeometry as Me,IcosahedronBufferGeometry as Fe,ExtrudeBufferGeometry as Se,DodecahedronBufferGeometry as Ae,CircleBufferGeometry as Oe,TextureLoader as De,MeshLambertMaterial as Te,MeshPhongMaterial as Ie,Color as Be,ImageLoader as Ce,LinearFilter as Ue,Sprite as ke,LineLoop as Re,LOD as Le,SkinnedMesh as ze,HemisphereLight as Ge,SpotLight as He,RectAreaLight as Ne,PointLight as je,DirectionalLight as Ye,AmbientLight as Xe,OrthographicCamera as Ze,PerspectiveCamera as Ve,Scene as We,Fog as Ke,FogExp2 as $e,VertexColors as qe}from"three-full";import{TBinaryReader as Qe,Endianness as Je,Byte as et,Keys as tt,Mouse as it,TDataBaseManager as rt}from"itee-client";import{toEnum as st,ringClockwise as nt,ringContainsSome as at,degreesToRadians as ot}from"itee-utils";import{isDefined as ht,isNull as lt,isUndefined as ct,isNotBoolean as dt,isEmptyArray as pt,isNotDefined as ut,isNotArray as _t,isArray as gt,isObject as mt,isNotString as ft,isEmptyString as bt,isBlankString as wt,isString as yt,isNotEmptyString as vt,isNotEmptyArray as xt}from"itee-validators";
/**
 * @module Loader/ASCLoader
 * @desc A loader for ASC cloud point files.
 *
 * @requires {@link https://github.com/Itee/itee-client itee-client}
 * @requires {@link https://github.com/Itee/three-full three-full}
 *
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 * @example
 *
 * import { ASCLoader } from 'itee-plugin-three'
 *
 * const loader = new ASCLoader();
 *
 * // If the ASC file need to be offseted, it can be set before loading file.
 * loader.setOffset( {
 *      x: 1.0,
 *      y: 52.0,
 *      z: -5.0
 * } );
 *
 * // Then load the file and get the threejs Point Geometry
 * loader.load('/path/to/file.asc', function (geometry) {
 *
 *      scene.add( new Mesh( geometry ) );
 *
 * } );
 *
 */class Et{constructor(r=t,s=e){this.manager=r,this.logger=s,this._boundingBox=new i,this._points=[],this._numberOfPoints=0,this._coloredPoints=!1,this._autoOffset=!1,this._offset={x:0,y:0,z:0},this._positions=null,this._bufferIndex=0,this._positionsC=null,this._bufferIndexC=0,this.wrongPoints=0}load(e,t,i,n,a){const o=new r(this.manager);o.setResponseType("blob"),o.load(e,function(e){const r=new s;this._parse(e,r,t,i,n,a),t(r)}.bind(this),i,n)}setOffset(e){this._offset=e,this._autoOffset=!1}_parse(e,t,i,r,s,n){const a=this,o=n||100,h=new FileReader,l=134217728;let c=0;function d(){if(c>=e.size)return;const t=e.slice(c,c+l,"text/plain");h.readAsText(t)}h.onabort=e=>{this.logger.log("abortEvent:"),this.logger.log(e)},h.onerror=e=>{this.logger.log("errorEvent:"),this.logger.log(e),s&&s(e)},h.onloadstart=e=>{this.logger.log("loadStartEvent:"),this.logger.log(e)},h.onprogress=e=>{this.logger.log("progressEvent:"),this.logger.log(e),r&&r(e)},h.onload=e=>{this.logger.log("loadEvent:"),this.logger.log(e);const t=e.target.result.split("\n"),i=t.length;c-=t[i-1].length;const r=Math.round(100/o);for(let e=0;e<i-1;e++)e%r===0&&a._parseLine(t[e])},h.onloadend=i=>{this.logger.log("loadEndEvent"),this.logger.log(i),(this._points.length>1e6||c+l>=e.size)&&(this._offsetPoints(),this._createSubCloudPoint(t)),c+=l,d()},d()}_parseLine(e){const t=e.split(/\s/g).filter(Boolean),i=t.length;3===i?this._points.push({x:parseFloat(t[0]),y:parseFloat(t[1]),z:parseFloat(t[2])}):4===i?(this._pointsHaveIntensity=!0,this._points.push({x:parseFloat(t[0]),y:parseFloat(t[1]),z:parseFloat(t[2]),i:parseFloat(t[3])})):6===i?(this._pointsHaveColor=!0,this._points.push({x:parseFloat(t[0]),y:parseFloat(t[1]),z:parseFloat(t[2]),r:parseFloat(t[3]),g:parseFloat(t[4]),b:parseFloat(t[5])})):7===i?(this._pointsHaveIntensity=!0,this._pointsHaveColor=!0,this._points.push({x:parseFloat(t[0]),y:parseFloat(t[1]),z:parseFloat(t[2]),i:parseFloat(t[3]),r:parseFloat(t[4]),g:parseFloat(t[5]),b:parseFloat(t[6])})):9===i?(this._pointsHaveColor=!0,this._pointsHaveNormals=!0,this._points.push({x:parseFloat(t[0]),y:parseFloat(t[1]),z:parseFloat(t[2]),r:parseFloat(t[3]),g:parseFloat(t[4]),b:parseFloat(t[5]),nx:parseFloat(t[6]),ny:parseFloat(t[7]),nz:parseFloat(t[8])})):10===i?(this._pointsHaveIntensity=!0,this._pointsHaveColor=!0,this._pointsHaveNormals=!0,this._points.push({x:parseFloat(t[0]),y:parseFloat(t[1]),z:parseFloat(t[2]),i:parseFloat(t[3]),r:parseFloat(t[4]),g:parseFloat(t[5]),b:parseFloat(t[6]),nx:parseFloat(t[7]),ny:parseFloat(t[8]),nz:parseFloat(t[9])})):this.logger.error(`Invalid data line: ${e}`)}_parseLines(e){const t=e[0].split(/\s/g).filter(Boolean).length;3===t?this._parseLinesAsXYZ(e):4===t?this._parseLinesAsXYZI(e):6===t?this._parseLinesAsXYZRGB(e):7===t?this._parseLinesAsXYZIRGB(e):9===t?this._parseLinesAsXYZRGBnXnYnZ(e):10===t?this._parseLinesAsXYZIRGBnXnYnZ(e):this.logger.error(`Invalid data line: ${e}`)}_parseLinesAsXYZ(e){let t=[];for(let i=0,r=e.length;i<r;i++)t=e[i].split(/\s/g).filter(Boolean),this._points.push({x:parseFloat(t[0]),y:parseFloat(t[1]),z:parseFloat(t[2])})}_parseLinesAsXYZI(e){this._pointsHaveIntensity=!0;let t=[];for(let i=0,r=e.length;i<r;i++)t=e[i].split(/\s/g).filter(Boolean),this._points.push({x:parseFloat(t[0]),y:parseFloat(t[1]),z:parseFloat(t[2]),i:parseFloat(t[3])})}_parseLinesAsXYZRGB(e){this._pointsHaveColor=!0;let t=[];for(let i=0,r=e.length;i<r;i++)t=e[i].split(/\s/g).filter(Boolean),this._points.push({x:parseFloat(t[0]),y:parseFloat(t[1]),z:parseFloat(t[2]),r:parseFloat(t[3]),g:parseFloat(t[4]),b:parseFloat(t[5])})}_parseLinesAsXYZnXnYnZ(e){let t=[];for(let i=0,r=e.length;i<r;i++)t=e[i].split(/\s/g).filter(Boolean),this._points.push({x:parseFloat(t[0]),y:parseFloat(t[1]),z:parseFloat(t[2]),nx:parseFloat(t[7]),ny:parseFloat(t[8]),nz:parseFloat(t[9])})}_parseLinesAsXYZIRGB(e){this._pointsHaveIntensity=!0,this._pointsHaveColor=!0;let t=[];for(let i=0,r=e.length;i<r;i++)t=e[i].split(/\s/g).filter(Boolean),this._points.push({x:parseFloat(t[0]),y:parseFloat(t[1]),z:parseFloat(t[2]),i:parseFloat(t[3]),r:parseFloat(t[4]),g:parseFloat(t[5]),b:parseFloat(t[6])})}_parseLinesAsXYZInXnYnZ(e){let t=[];for(let i=0,r=e.length;i<r;i++)t=e[i].split(/\s/g).filter(Boolean),this._points.push({x:parseFloat(t[0]),y:parseFloat(t[1]),z:parseFloat(t[2]),i:parseFloat(t[3]),nx:parseFloat(t[7]),ny:parseFloat(t[8]),nz:parseFloat(t[9])})}_parseLinesAsXYZRGBnXnYnZ(e){this._pointsHaveColor=!0,this._pointsHaveNormals=!0;let t=[];for(let i=0,r=e.length;i<r;i++)t=e[i].split(/\s/g).filter(Boolean),this._points.push({x:parseFloat(t[0]),y:parseFloat(t[1]),z:parseFloat(t[2]),r:parseFloat(t[3]),g:parseFloat(t[4]),b:parseFloat(t[5]),nx:parseFloat(t[6]),ny:parseFloat(t[7]),nz:parseFloat(t[8])})}_parseLinesAsXYZIRGBnXnYnZ(e){this._pointsHaveIntensity=!0,this._pointsHaveColor=!0,this._pointsHaveNormals=!0;let t=[];for(let i=0,r=e.length;i<r;i++)t=e[i].split(/\s/g).filter(Boolean),this._points.push({x:parseFloat(t[0]),y:parseFloat(t[1]),z:parseFloat(t[2]),i:parseFloat(t[3]),r:parseFloat(t[4]),g:parseFloat(t[5]),b:parseFloat(t[6]),nx:parseFloat(t[7]),ny:parseFloat(t[8]),nz:parseFloat(t[9])})}_parseLineB(e){const t=e.split(/\s/g).filter(Boolean),i=t.length,r=this._bufferIndex;3===i&&(this._positions[r]=parseFloat(t[0]),this._positions[r+1]=parseFloat(t[1]),this._positions[r+2]=parseFloat(t[2]),this._bufferIndex+=3)}_parseLineC(e){const t=e.split(/\s/g).filter(Boolean),i=t.length,r=this._bufferIndexC;3===i&&(this._positionsC[r]=Number.parseFloat(t[0]),this._positionsC[r+1]=Number.parseFloat(t[1]),this._positionsC[r+2]=Number.parseFloat(t[2]),this._bufferIndexC+=3)}_offsetPoints(){this._autoOffset&&(this._boundingBox.setFromPoints(this._points),this.setOffset(this._boundingBox.getCenter()));const e=this._offset.x,t=this._offset.y,i=this._offset.z;let r=null;for(let s=0,n=this._points.length;s<n;++s)r=this._points[s],r.x-=e,r.y-=t,r.z-=i}_createCloudPoint(e){const t=1e6,i=this._points.length,r=Math.ceil(i/t);let s=null,l=0,c=null;for(let i=0;i<r;++i){s=this._points.splice(0,t),l=s.length;const i=new n,r=new Float32Array(3*l),d=new Float32Array(3*l);let p=0,u=null;for(let e=0;e<l;++e)u=s[e],r[p]=u.x,r[p+1]=u.y,r[p+2]=u.z,this._pointsHaveColor?(d[p]=u.r/255,d[p+1]=u.g/255,d[p+2]=u.b/255):(d[p]=.1,d[p+1]=.2,d[p+2]=.5),p+=3;i.setAttribute("position",new a(r,3)),i.setAttribute("color",new a(d,3));const _=new o({size:.01,vertexColors:!0});c=new h(i,_),e.children.push(c)}}_createSubCloudPoint(e){const t=this._points.length,i=new n,r=new Float32Array(3*t),s=new Float32Array(3*t);let l=0,c=null;for(let e=0;e<t;++e)c=this._points[e],r[l]=c.x,r[l+1]=c.y,r[l+2]=c.z,this._pointsHaveColor?(s[l]=c.r/255,s[l+1]=c.g/255,s[l+2]=c.b/255):(s[l]=.1,s[l+1]=.2,s[l+2]=.5),l+=3;i.setAttribute("position",new a(r,3)),i.setAttribute("color",new a(s,3));const d=new o({size:.005,vertexColors:!0}),p=new h(i,d);p.rotation.x-=Math.PI/2,e.children.push(p),this._points=[]}}
/**
 * @module Loader/DBFLoader
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 *
 * From:
 * https://www.clicketyclick.dk/databases/xbase/format/db2_dbf.html#DBII_DBF_STRUCT
 * http://web.archive.org/web/20150323061445/http://ulisse.elettra.trieste.it/services/doc/dbase/DBFstruct.htm
 * http://www.dbase.com/Knowledgebase/INT/db7_file_fmt.htm
 *
 *
 */const Pt=st({FoxPro:48,FoxPro_Autoincrement:49,dBASE_II:2,FoxPro_Var:50,dBASE_III_plus:3,dBASE_III_plus_memo:131,dBASE_IV_SQL_table:67,dBASE_IV_SQL_system:99,dBASE_IV_memo:139,dBASE_IV_memo_SQL_table:203,FoxBase:251,dBase_v_7:4,FoxPro_2_x:245,HiPerSix_memo:229}),Mt=st({Binary:"B",Character:"C",Date:"D",Numeric:"N",Logical:"L",Memo:"M",Timestamp:"@",Long:"I",Autoincrement:"+",Float:"F",Double:"O",OLE:"G"});class Ft{constructor(i={}){const r={manager:t,logger:e,reader:new Qe,...i};this.manager=r.manager,this.logger=r.logger,this.reader=r.reader}get manager(){return this._manager}set manager(e){this._manager=e}get logger(){return this._logger}set logger(e){this._logger=e}get reader(){return this._reader}set reader(e){this._reader=e}setManager(e){return this.manager=e,this}setLogger(e){return this.logger=e,this}setReader(e){return this.reader=e,this}load(e,t,i,s){const n=this,a=new r(n.manager);a.setResponseType("arraybuffer"),a.load(e,e=>{t(n.parse(e))},i,s)}parse(e){this.reader.setEndianess(Je.Big).setBuffer(e);const t=this.reader.getInt8();if(!this._isValidVersion(t))return this.logger.error(`DBFLoader: Invalid version number: ${t}`),null;const i=this._parseHeader(t);return{header:i,datas:this._parseDatas(t,i)}}_isValidVersion(e){return Pt.includes(e)}_parseHeader(e){let t={};switch(e){case Pt.FoxPro:case Pt.FoxPro_Autoincrement:case Pt.FoxPro_Var:case Pt.dBASE_II:t=this._parseHeaderV2();break;case Pt.dBASE_III_plus:case Pt.dBASE_III_plus_memo:t=this._parseHeaderV2_5();break;case Pt.dBASE_IV_memo:case Pt.dBASE_IV_memo_SQL_table:case Pt.dBASE_IV_SQL_system:case Pt.dBASE_IV_SQL_table:t=this._parseHeaderV3();break;case Pt.dBase_v_7:case Pt.FoxPro_2_x:case Pt.HiPerSix_memo:t=this._parseHeaderV4();break;default:throw new RangeError(`Invalid version parameter: ${e}`)}return this.reader.getUint8()!==Ft.Terminator&&this.logger.error("DBFLoader: Invalid terminator after field descriptors !!!"),t}_parseHeaderV2(){const e=this.reader.getInt16(),t=this.reader.getInt8()+Ft.YearOffset,i=this.reader.getInt8(),r=this.reader.getInt8(),s=this.reader.getInt16();let n,a,o,h,l,c=[];for(let t=0;t<e;t++)n=this.reader.getString(11),a=this.reader.getChar(),o=this.reader.getUint8(),h=this.reader.getInt16(),l=this.reader.getInt8(),c.push({name:n,type:a,length:o,memoryAddress:h,decimalCount:l});return{numberOfRecords:e,year:t,month:i,day:r,lengthOfEachRecords:s,fields:c}}_parseHeaderV2_5(){const e=this.reader.getInt8()+Ft.YearOffset,t=this.reader.getInt8(),i=this.reader.getInt8();this.reader.setEndianess(Je.Little);const r=this.reader.getInt32(),s=this.reader.getInt16(),n=this.reader.getInt16();this.reader.setEndianess(Je.Big),this.reader.skipOffsetOf(20);let a,o,h,l,c,d,p,u=[];for(let e=0;e<r;e++)a=this.reader.getString(11),o=this.reader.getChar(),l=this.reader.getInt32(),h=this.reader.getUint8(),c=this.reader.getUint8(),this.reader.skipOffsetOf(2),d=this.reader.getInt8(),this.reader.skipOffsetOf(2),p=this.reader.getInt8(),this.reader.skipOffsetOf(1),u.push({name:a,type:o,length:h,memoryAddress:l,decimalCount:c,workAreaId:d,MDXFlag:p});return{year:e,month:t,day:i,numberOfRecords:r,numberOfByteInHeader:s,numberOfByteInRecord:n,fields:u}}_parseHeaderV3(){const e=this.reader.getInt8()+Ft.YearOffset,t=this.reader.getInt8(),i=this.reader.getInt8();this.reader.setEndianess(Je.Little);const r=this.reader.getInt32(),s=this.reader.getInt16(),n=this.reader.getInt16();this.reader.setEndianess(Je.Big),this.reader.skipOffsetOf(2);const a=this.reader.getInt8(),o=this.reader.getInt8();this.reader.skipOffsetOf(12);const h=this.reader.getInt8(),l=this.reader.getInt8();this.reader.skipOffsetOf(2);let c,d,p,u,_,g,m=[];for(;this.reader.getOffset()<s-1;)c=this.reader.getString(11),d=this.reader.getChar(),this.reader.skipOffsetOf(4),p=this.reader.getUint8(),u=this.reader.getUint8(),this.reader.skipOffsetOf(2),_=this.reader.getInt8(),this.reader.skipOffsetOf(10),g=this.reader.getInt8(),m.push({name:c,type:d,length:p,decimalCount:u,workAreaId:_,MDXFieldFlag:g});return{year:e,month:t,day:i,numberOfRecords:r,numberOfByteInHeader:s,numberOfByteInRecord:n,incompleteTransactionFlag:a,encryptionFlag:o,MDXFlag:h,languageDriverId:l,fields:m}}_parseHeaderV4(){const e=this.reader.getInt8()+Ft.YearOffset,t=this.reader.getInt8(),i=this.reader.getInt8();this.reader.setEndianess(Je.Little);const r=this.reader.getInt32(),s=this.reader.getInt16(),n=this.reader.getInt16();this.reader.setEndianess(Je.Big),this.reader.skipOffsetOf(2);const a=this.reader.getInt8(),o=this.reader.getInt8();this.reader.skipOffsetOf(12);const h=this.reader.getInt8(),l=this.reader.getInt8();this.reader.skipOffsetOf(2);const c=this.reader.getString(32);this.reader.skipOffsetOf(4);let d,p,u,_,g,m,f=[];for(let e=0;e<r;e++)d=this.reader.getString(32),p=this.reader.getChar(),u=this.reader.getUint8(),_=this.reader.getUint8(),this.reader.skipOffsetOf(2),g=this.reader.getInt8(),this.reader.skipOffsetOf(2),m=this.reader.getInt32(),this.reader.skipOffsetOf(4),f.push({name:d,type:p,length:u,decimalCount:_,MDXFieldFlag:g,nextAutoincrementValue:m});return{year:e,month:t,day:i,numberOfRecords:r,numberOfByteInHeader:s,numberOfByteInRecord:n,incompleteTransactionFlag:a,encryptionFlag:o,MDXFlag:h,languageDriverId:l,languageDriverName:c,fields:f}}_parseDatas(e,t){const i=t.numberOfRecords,r=t.fields;let s=[],n=null,a=null;for(let e=0;e<i;e++){n={},n.deleted=this.reader.getUint8()===Ft.DeletedRecord;for(let e=0,t=r.length;e<t;e++)switch(a=r[e],a.type){case Mt.Binary:{const e=this.reader.getString(a.length);n[a.name]=parseInt(e)}break;case Mt.Numeric:{const e=this.reader.getString(a.length);n[a.name]=parseInt(e)}break;case Mt.Character:case Mt.Date:n[a.name]=this.reader.getString(a.length);break;case Mt.Logical:{const e=this.reader.getChar().toLowerCase();n[a.name]="t"===e||"y"===e||"f"!==e&&"n"!==e&&null}break;case Mt.Memo:n[a.name]=this.reader.getString(a.length);break;case Mt.Timestamp:break;case Mt.Long:case Mt.Autoincrement:n[a.name]=this.reader.getInt32();break;case Mt.Float:{const e=this.reader.getString(a.length);n[a.name]=parseInt(e)}break;case Mt.Double:n[a.name]=this.reader.getFloat64();break;case Mt.OLE:n[a.name]=this.reader.getString(a.length);break;default:throw new RangeError(`Invalid data type parameter: ${a.type}`)}s.push(n)}return s}_parseFieldProperties(){const e=this.reader.getInt16(),t=this.reader.getInt16(),i=this.reader.getInt16(),r=this.reader.getInt16(),s=this.reader.getInt16(),n=this.reader.getInt16(),a=this.reader.getInt16(),o=this.reader.getInt16();let h=[];for(let t=0;t<e;t++)h.push(this._getStandardProperties());let l=[];for(let e=0;e<i;e++)l.push(this._getCustomProperties());let c=[];for(let e=0;e<s;e++)c.push(this._getReferentialIntegrityProperties());return{numberOfStandardProperties:e,startOfStandardPropertiesDescriptor:t,numberOfCustomProperties:i,startOfCustomPropertiesDescriptor:r,numberOfReferentialIntegrityProperties:s,startOfReferentialIntegrityDescriptor:n,startOfData:a,sizeOfPropertiesStructure:o,standardProperties:h,customProperties:l,referentialIntegrityProperties:c}}_getStandardProperties(){const e=this.reader.getInt16(),t=this.reader.getInt16(),i=this.reader.getInt8(),r=this.reader.getInt8(),s=this.reader.getInt8();this.reader.skipOffsetOf(4);return{generationalNumber:e,tableFieldOffset:t,propertyDescribed:i,type:r,isConstraint:s,offsetFromStart:this.reader.getInt16(),widthOfDatabaseField:this.reader.getInt16()}}_getCustomProperties(){const e=this.reader.getInt16(),t=this.reader.getInt16(),i=this.reader.getInt8();this.reader.skipOffsetOf(1);return{generationalNumber:e,tableFieldOffset:t,type:i,offsetFromStartOfName:this.reader.getInt16(),lengthOfName:this.reader.getInt16(),offsetFromStartOfData:this.reader.getInt16(),lengthOfData:this.reader.getInt16()}}_getReferentialIntegrityProperties(){return{databaseState:this.reader.getInt8(),sequentialNumberRule:this.reader.getInt16(),offsetOfTheRIRuleName:this.reader.getInt16(),sizeOfTheRIRuleName:this.reader.getInt16(),offsetOfNameOfForeignTable:this.reader.getInt16(),sizeOfNameOfForeignTable:this.reader.getInt16(),stateBehaviour:this.reader.getInt8(),numberOfFieldsInLinkingKey:this.reader.getInt16(),offsetOfLocalTableTagName:this.reader.getInt16(),sizeOfTheLocalTableTagName:this.reader.getInt16(),offsetOfForeignTableTagName:this.reader.getInt16(),sizeOfTheForeignTableTagName:this.reader.getInt16()}}}Ft.Terminator=13,Ft.DeletedRecord=26,Ft.YearOffset=1900;
/**
 * @module Loader/LASLoader
 * @desc A loader for ASC cloud point files.
 *
 * @requires {@link https://github.com/Itee/itee-client itee-client}
 * @requires {@link https://github.com/Itee/three-full three-full}
 *
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 * @example
 *
 * import { LASLoader } from 'itee-plugin-three'
 *
 * const loader = new LASLoader();
 *
 * // If the ASC file need to be offseted, it can be set before loading file.
 * loader.setOffset( {
 *      x: 1.0,
 *      y: 52.0,
 *      z: -5.0
 * } );
 *
 * // Then load the file and get the threejs Point Geometry
 * loader.load('/path/to/file.asc', function (geometry) {
 *
 *      scene.add( new Mesh( geometry ) );
 *
 * } );
 *
 */
const St=new RegExp("\0","g"),At=st({Created:0,Unclassified:1,Ground:2,LowVegetation:3,MediumVegetation:4,HighVegetation:5,Building:6,LowPoint:7,ModelKeyPoint:8,Water:9,OverlapPoints:12});class Ot{constructor(r=t,s=e){this.manager=r,this.logger=s,this._reader=new Qe,this._fullVersion="",this._boundingBox=new i,this._points=[],this._numberOfPoints=0,this._coloredPoints=!1,this._autoOffset=!1,this._offset={x:0,y:0,z:0},this.colorForPointClass={Created:{r:255,g:255,b:255},Unclassified:{r:60,g:60,b:60},Ground:{r:125,g:95,b:5},LowVegetation:{r:153,g:212,b:36},MediumVegetation:{r:52,g:148,b:25},HighVegetation:{r:27,g:77,b:13},Building:{r:153,g:138,b:95},LowPoint:{r:200,g:200,b:200},ModelKeyPoint:{r:237,g:31,b:31},Water:{r:31,g:186,b:237},OverlapPoints:{r:0,g:0,b:0}}}load(e,t,i,s,n){const a=new r(this.manager);a.setResponseType("arraybuffer"),a.load(e,e=>{this.parse(e,t,i,s,n)},i,s)}setOffset(e){this._offset=e,this._autoOffset=!1}parse(e,t,i,r){try{this._reader.buffer=e;if("LASF"!==this._reader.getString(4,!1))throw new Error("Invalid las file signature. Abort parsing !");this._reader.skipOffsetOf(24);const s=this._reader.getUint8(),n=this._reader.getUint8();this._reader.skipOffsetTo(0);const a=`${s}.${n}`,o=this._parseHeader(a),h=this._parseVariableLengthRecords(o),l=this._parsePointDataRecords(o,i);this.convert({Header:o,VariableLengthRecords:h,PointDataRecords:l},t,i,r)}catch(e){r(e)}}_parseHeader(e){switch(e){case"1.0":return this._parseHeader_1_0();case"1.1":return this._parseHeader_1_1();case"1.2":return this._parseHeader_1_2();case"1.3":return this._parseHeader_1_3();case"1.4":return this._parseHeader_1_4();default:throw new Error(`Insupported LAS file version: ${e}. Abort parsing !`)}}_parseHeader_1_0(){return{FileSignature:this._reader.getString(4),Reserved:this._reader.skipOffsetOf(et.Four),GUID_1:this._reader.getUint32(),GUID_2:this._reader.getUint16(),GUID_3:this._reader.getUint16(),GUID_4:this._reader.getUint8Array(8),VersionMajor:this._reader.getUint8(),VersionMinor:this._reader.getUint8(),SystemIdentifier:this._reader.getString(32).replace(St,""),GeneratingSoftware:this._reader.getString(32).replace(St,""),FlightDateJulian:this._reader.getUint16(),Year:this._reader.getUint16(),HeaderSize:this._reader.getUint16(),OffsetToPointData:this._reader.getUint32(),NumberOfVariableLengthRecords:this._reader.getUint32(),PointDataFormatID:this._reader.getUint8(),PointDataRecordLength:this._reader.getUint16(),NumberOfPointRecords:this._reader.getUint32(),NumberOfPointsByReturn:this._reader.getUint32Array(5),XScaleFactor:this._reader.getFloat64(),YScaleFactor:this._reader.getFloat64(),ZScaleFactor:this._reader.getFloat64(),XOffset:this._reader.getFloat64(),YOffset:this._reader.getFloat64(),ZOffset:this._reader.getFloat64(),MaxX:this._reader.getFloat64(),MinX:this._reader.getFloat64(),MaxY:this._reader.getFloat64(),MinY:this._reader.getFloat64(),MaxZ:this._reader.getFloat64(),MinZ:this._reader.getFloat64()}}_parseHeader_1_1(){return{FileSignature:this._reader.getString(4),FileSourceId:this._reader.getUint16(),Reserved:this._reader.skipOffsetOf(et.Two)&&null,GUID_1:this._reader.getUint32(),GUID_2:this._reader.getUint16(),GUID_3:this._reader.getUint16(),GUID_4:this._reader.getUint8Array(8),VersionMajor:this._reader.getUint8(),VersionMinor:this._reader.getUint8(),SystemIdentifier:this._reader.getString(32).replace(St,""),GeneratingSoftware:this._reader.getString(32).replace(St,""),FileCreationDayOfYear:this._reader.getUint16(),FileCreationYear:this._reader.getUint16(),HeaderSize:this._reader.getUint16(),OffsetToPointData:this._reader.getUint32(),NumberOfVariableLengthRecords:this._reader.getUint32(),PointDataFormatID:this._reader.getUint8(),PointDataRecordLength:this._reader.getUint16(),NumberOfPointRecords:this._reader.getUint32(),NumberOfPointsByReturn:this._reader.getUint32Array(5),XScaleFactor:this._reader.getFloat64(),YScaleFactor:this._reader.getFloat64(),ZScaleFactor:this._reader.getFloat64(),XOffset:this._reader.getFloat64(),YOffset:this._reader.getFloat64(),ZOffset:this._reader.getFloat64(),MaxX:this._reader.getFloat64(),MinX:this._reader.getFloat64(),MaxY:this._reader.getFloat64(),MinY:this._reader.getFloat64(),MaxZ:this._reader.getFloat64(),MinZ:this._reader.getFloat64()}}_parseHeader_1_2(){return{FileSignature:this._reader.getString(4),FileSourceId:this._reader.getUint16(),GlobalEncoding:{GPSTimeType:this._reader.getBit16()?"AdjustedStandardGPSTime":"GPSWeekTime",Reserved:this._reader.skipBitOffsetOf(15)},GUID_1:this._reader.getUint32(),GUID_2:this._reader.getUint16(),GUID_3:this._reader.getUint16(),GUID_4:this._reader.getUint8Array(8),VersionMajor:this._reader.getUint8(),VersionMinor:this._reader.getUint8(),SystemIdentifier:this._reader.getString(32).replace(St,""),GeneratingSoftware:this._reader.getString(32).replace(St,""),FileCreationDayOfYear:this._reader.getUint16(),FileCreationYear:this._reader.getUint16(),HeaderSize:this._reader.getUint16(),OffsetToPointData:this._reader.getUint32(),NumberOfVariableLengthRecords:this._reader.getUint32(),PointDataFormatID:this._reader.getUint8(),PointDataRecordLength:this._reader.getUint16(),NumberOfPointRecords:this._reader.getUint32(),NumberOfPointsByReturn:this._reader.getUint32Array(5),XScaleFactor:this._reader.getFloat64(),YScaleFactor:this._reader.getFloat64(),ZScaleFactor:this._reader.getFloat64(),XOffset:this._reader.getFloat64(),YOffset:this._reader.getFloat64(),ZOffset:this._reader.getFloat64(),MaxX:this._reader.getFloat64(),MinX:this._reader.getFloat64(),MaxY:this._reader.getFloat64(),MinY:this._reader.getFloat64(),MaxZ:this._reader.getFloat64(),MinZ:this._reader.getFloat64()}}_parseHeader_1_3(){return{FileSignature:this._reader.getString(4),FileSourceId:this._reader.getUint16(),GlobalEncoding:{GPSTimeType:this._reader.getBit16()?"AdjustedStandardGPSTime":"GPSWeekTime",WaveformDataPacketsInternal:this._reader.getBit16(),WaveformDataPacketsExternal:this._reader.getBit16(),ReturnNumbersHaveBeenSyntheticallyGenerated:this._reader.getBit16(),Reserved:this._reader.skipBitOffsetOf(12)},GUID_1:this._reader.getUint32(),GUID_2:this._reader.getUint16(),GUID_3:this._reader.getUint16(),GUID_4:this._reader.getUint8Array(8),VersionMajor:this._reader.getUint8(),VersionMinor:this._reader.getUint8(),SystemIdentifier:this._reader.getString(32).replace(St,""),GeneratingSoftware:this._reader.getString(32).replace(St,""),FileCreationDayOfYear:this._reader.getUint16(),FileCreationYear:this._reader.getUint16(),HeaderSize:this._reader.getUint16(),OffsetToPointData:this._reader.getUint32(),NumberOfVariableLengthRecords:this._reader.getUint32(),PointDataFormatID:this._reader.getUint8(),PointDataRecordLength:this._reader.getUint16(),NumberOfPointRecords:this._reader.getUint32(),NumberOfPointsByReturn:this._reader.getUint32Array(5),XScaleFactor:this._reader.getFloat64(),YScaleFactor:this._reader.getFloat64(),ZScaleFactor:this._reader.getFloat64(),XOffset:this._reader.getFloat64(),YOffset:this._reader.getFloat64(),ZOffset:this._reader.getFloat64(),MaxX:this._reader.getFloat64(),MinX:this._reader.getFloat64(),MaxY:this._reader.getFloat64(),MinY:this._reader.getFloat64(),MaxZ:this._reader.getFloat64(),MinZ:this._reader.getFloat64(),StartOfWaveformDataPacketRecord:this._reader.getUint64()}}_parseHeader_1_4(){return{FileSignature:this._reader.getString(4),FileSourceId:this._reader.getUint16(),GlobalEncoding:{GPSTimeType:this._reader.getBit16()?"AdjustedStandardGPSTime":"GPSWeekTime",WaveformDataPacketsInternal:this._reader.getBit16(),WaveformDataPacketsExternal:this._reader.getBit16(),ReturnNumbersHaveBeenSyntheticallyGenerated:this._reader.getBit16(),WKT:this._reader.getBit16()?"WKT":"GeoTIFF",Reserved:this._reader.skipBitOffsetOf(11)},GUID_1:this._reader.getUint32(),GUID_2:this._reader.getUint16(),GUID_3:this._reader.getUint16(),GUID_4:this._reader.getUint8Array(8),VersionMajor:this._reader.getUint8(),VersionMinor:this._reader.getUint8(),SystemIdentifier:this._reader.getString(32).replace(St,""),GeneratingSoftware:this._reader.getString(32).replace(St,""),FileCreationDayOfYear:this._reader.getUint16(),FileCreationYear:this._reader.getUint16(),HeaderSize:this._reader.getUint16(),OffsetToPointData:this._reader.getUint32(),NumberOfVariableLengthRecords:this._reader.getUint32(),PointDataRecordFormat:this._reader.getUint8(),PointDataRecordLength:this._reader.getUint16(),LegacyNumberOfPointRecords:this._reader.getUint32(),LegacyNumberOfPointsByReturn:this._reader.getUint32Array(5),XScaleFactor:this._reader.getFloat64(),YScaleFactor:this._reader.getFloat64(),ZScaleFactor:this._reader.getFloat64(),XOffset:this._reader.getFloat64(),YOffset:this._reader.getFloat64(),ZOffset:this._reader.getFloat64(),MaxX:this._reader.getFloat64(),MinX:this._reader.getFloat64(),MaxY:this._reader.getFloat64(),MinY:this._reader.getFloat64(),MaxZ:this._reader.getFloat64(),MinZ:this._reader.getFloat64(),StartOfWaveformDataPacketRecord:this._reader.getUint64(),StartOfFirstExtendedVariableLengthRecord:this._reader.getUint64(),NumberOfExtendedVariableLengthRecords:this._reader.getUint32(),NumberOfPointRecords:this._reader.getUint64(),NumberOfPointsByReturn:this._reader.getUint64Array(15)}}_parseVariableLengthRecords(e){const t=`${e.VersionMajor}.${e.VersionMinor}`,i=[];for(let r=0;r<e.NumberOfVariableLengthRecords;r++){const e=this._parseVariableLengthRecordHeader();
//!\ Legacy => RecordSignature = Reserved since las v1.1
if("1.0"===t&&43707!==e.Reserved)throw new Error("Invalid variable length record header signature... Abort parsing !");const r=e.UserID,s=e.RecordID,n=e.RecordLengthAfterHeader,a=this._parseVariableLengthRecordContent(r,s,n);i.push({Header:e,Content:a})}return i}_parseVariableLengthRecordHeader(){return{Reserved:this._reader.getUint16(),UserID:this._reader.getString(16).replace(St,""),RecordID:this._reader.getUint16(),RecordLengthAfterHeader:this._reader.getUint16(),Description:this._reader.getString(32).replace(St,"")}}_parseVariableLengthRecordContent(e,t,i){switch(e){case"LASF_Projection":return this._parseProjectionRecord(t,i);case"LASF_Spec":return this._parseSpecRecord();default:return this._parseCustomRecord(i)}}_parseProjectionRecord(e,t){switch(e){case 2111:return this._parseOGCMathTransformWKT();case 2112:return this._parseOGCCoordinateTransformWKT();case 34735:return this._parseGeoKeyDirectoryTag();case 34736:return this._parseGeoDoubleParamsTag(t);case 34737:return this._parseGeoASCIIParamsTag(t);default:console.error("Unable to determine LASF_Projection underlying type ! Skip current record."),this._reader.skipOffsetOf(t)}}_parseOGCMathTransformWKT(){}_parseOGCCoordinateTransformWKT(){}_parseGeoKeyDirectoryTag(){const e={wKeyDirectoryVersion:this._reader.getUint16(),wKeyRevision:this._reader.getUint16(),wMinorRevision:this._reader.getUint16(),wNumberOfKeys:this._reader.getUint16(),sKeyEntry:[]};for(let t=0;t<e.wNumberOfKeys;t++)e.sKeyEntry.push({wKeyID:this._reader.getUint16(),wTIFFTagLocation:this._reader.getUint16(),wCount:this._reader.getUint16(),wValue_Offset:this._reader.getUint16()});return e}_parseGeoDoubleParamsTag(e){const t=e/et.Height,i=[];for(let e=0;e<t;e++)i[e]=this._reader.getFloat64();return i}_parseGeoASCIIParamsTag(e){return this._reader.getString(e).replace(St,"")}_parseSpecRecord(e){if(!(e<100)){if(e>=100&&e<355)return this._parseWaveformPacketDesciptor();if(65535===e)return this._parseWaveformDataPacket();throw new RangeError(`Invalid spec record id: ${e}`)}switch(e){case 0:return this._parseClassificationLookupRecord();case 1:return this._parseHeaderLookupForFlightLinesRecord();case 2:return this._parseHistogramRecord();case 3:return this._parseTextAreaDescriptionRecord();case 4:return this._parseExtraBytesRecord();case 7:return this._parseSupersededRecord();default:throw new RangeError(`Invalid spec record id: ${e}`)}}_parseClassificationLookupRecord(){const e=[];for(let t=0;t<256;t++)e.push({ClassNumber:this._reader.getUint8(),Description:this._reader.getString(15).replace(St,"")});return e}_parseHeaderLookupForFlightLinesRecord(){return{FileMarkerNumber:this._reader.getUint8(),Filename:this._reader.getString(256).replace(St,"")}}_parseHistogramRecord(){}_parseTextAreaDescriptionRecord(){}_parseExtraBytesRecord(){}_parseSupersededRecord(){}_parseWaveformPacketDesciptor(){}_parseWaveformDataPacket(){}_parseCustomRecord(e){const t=new Uint8Array(e);for(let i=0;i<e;i++)t[i]=this._reader.getUint8();return t}_parsePointDataRecords(e,t){const i=e.OffsetToPointData;this._reader.offset!==i&&(console.error("The current reader offset does not match the header offset to point data ! Defaulting to header value."),this._reader.skipOffsetTo(i));const r=e.VersionMinor<4?e.PointDataFormatID:e.PointDataRecordFormat,s=this._getPointDataRecordFormat(r),n=e.VersionMinor<4?e.NumberOfPointRecords:e.LegacyNumberOfPointRecords,a=new Array(n);for(let e=0;e<n;e++)a[e]=s(),e%1e5==0&&t(new ProgressEvent("ParsePointDataRecords",{lengthComputable:!0,loaded:e,total:n}));return a}_getPointDataRecordFormat(e){switch(e){case 0:return this._parsePointDataRecordFormat_0.bind(this);case 1:return this._parsePointDataRecordFormat_1.bind(this);case 2:return this._parsePointDataRecordFormat_2.bind(this);case 3:return this._parsePointDataRecordFormat_3.bind(this);case 4:return this._parsePointDataRecordFormat_4.bind(this);case 5:return this._parsePointDataRecordFormat_5.bind(this);case 6:return this._parsePointDataRecordFormat_6.bind(this);case 7:return this._parsePointDataRecordFormat_7.bind(this);case 8:return this._parsePointDataRecordFormat_8.bind(this);case 9:return this._parsePointDataRecordFormat_9.bind(this);case 10:return this._parsePointDataRecordFormat_10.bind(this);default:throw new RangeError(`Invalid PointDataRecordFormat parameter: ${e}`)}}_parsePointDataRecordFormat_0(){return{X:this._reader.getInt32(),Y:this._reader.getInt32(),Z:this._reader.getInt32(),Intensity:this._reader.getUint16(),ReturnNumber:this._reader.getBits8(3),NumberOfReturns:this._reader.getBits8(3),ScanDirectionFlag:this._reader.getBit8(),EdgeOfFlightLine:this._reader.getBit8(),Classification:{Class:this._reader.getBits8(5),Synthetic:this._reader.getBit8(),KeyPoint:this._reader.getBit8(),Withheld:this._reader.getBit8()},ScanAngleRank:this._reader.getInt8(),UserData:this._reader.getUint8(),PointSourceId:this._reader.getUint16()}}_parsePointDataRecordFormat_1(){return{X:this._reader.getInt32(),Y:this._reader.getInt32(),Z:this._reader.getInt32(),Intensity:this._reader.getUint16(),ReturnNumber:this._reader.getBits8(3),NumberOfReturns:this._reader.getBits8(3),ScanDirectionFlag:this._reader.getBit8(),EdgeOfFlightLine:this._reader.getBit8(),Classification:{Class:this._reader.getBits8(5),Synthetic:this._reader.getBit8(),KeyPoint:this._reader.getBit8(),Withheld:this._reader.getBit8()},ScanAngleRank:this._reader.getInt8(),UserData:this._reader.getUint8(),PointSourceId:this._reader.getUint16(),GPSTime:this._reader.getFloat64()}}_parsePointDataRecordFormat_2(){return{X:this._reader.getInt32(),Y:this._reader.getInt32(),Z:this._reader.getInt32(),Intensity:this._reader.getUint16(),ReturnNumber:this._reader.getBits8(3),NumberOfReturns:this._reader.getBits8(3),ScanDirectionFlag:this._reader.getBit8(),EdgeOfFlightLine:this._reader.getBit8(),Classification:{Class:this._reader.getBits8(5),Synthetic:this._reader.getBit8(),KeyPoint:this._reader.getBit8(),Withheld:this._reader.getBit8()},ScanAngleRank:this._reader.getInt8(),UserData:this._reader.getUint8(),PointSourceId:this._reader.getUint16(),R:this._reader.getUint16(),G:this._reader.getUint16(),B:this._reader.getUint16()}}_parsePointDataRecordFormat_3(){return{X:this._reader.getInt32(),Y:this._reader.getInt32(),Z:this._reader.getInt32(),Intensity:this._reader.getUint16(),ReturnNumber:this._reader.getBits8(3),NumberOfReturns:this._reader.getBits8(3),ScanDirectionFlag:this._reader.getBit8(),EdgeOfFlightLine:this._reader.getBit8(),Classification:{Class:this._reader.getBits8(5),Synthetic:this._reader.getBit8(),KeyPoint:this._reader.getBit8(),Withheld:this._reader.getBit8()},ScanAngleRank:this._reader.getInt8(),UserData:this._reader.getUint8(),PointSourceId:this._reader.getUint16(),GPSTime:this._reader.getFloat64(),R:this._reader.getUint16(),G:this._reader.getUint16(),B:this._reader.getUint16()}}_parsePointDataRecordFormat_4(){return{X:this._reader.getInt32(),Y:this._reader.getInt32(),Z:this._reader.getInt32(),Intensity:this._reader.getUint16(),ReturnNumber:this._reader.getBits8(3),NumberOfReturns:this._reader.getBits8(3),ScanDirectionFlag:this._reader.getBit8(),EdgeOfFlightLine:this._reader.getBit8(),Classification:{Class:this._reader.getBits8(5),Synthetic:this._reader.getBit8(),KeyPoint:this._reader.getBit8(),Withheld:this._reader.getBit8()},ScanAngleRank:this._reader.getInt8(),UserData:this._reader.getUint8(),PointSourceId:this._reader.getUint16(),GPSTime:this._reader.getFloat64(),WavePacketDescriptorIndex:this._reader.getUint8(),ByteOffsetToWaveformData:this._reader.getUint64(),WaveformPacketSizeInBytes:this._reader.getUint32(),ReturnPointWaveformLocation:this._reader.getFloat32(),Xt:this._reader.getFloat32(),Yt:this._reader.getFloat32(),Zt:this._reader.getFloat32()}}_parsePointDataRecordFormat_5(){return{X:this._reader.getInt32(),Y:this._reader.getInt32(),Z:this._reader.getInt32(),Intensity:this._reader.getUint16(),ReturnNumber:this._reader.getBits8(3),NumberOfReturns:this._reader.getBits8(3),ScanDirectionFlag:this._reader.getBit8(),EdgeOfFlightLine:this._reader.getBit8(),Classification:{Class:this._reader.getBits8(5),Synthetic:this._reader.getBit8(),KeyPoint:this._reader.getBit8(),Withheld:this._reader.getBit8()},ScanAngleRank:this._reader.getInt8(),UserData:this._reader.getUint8(),PointSourceId:this._reader.getUint16(),GPSTime:this._reader.getFloat64(),R:this._reader.getUint16(),G:this._reader.getUint16(),B:this._reader.getUint16(),WavePacketDescriptorIndex:this._reader.getUint8(),ByteOffsetToWaveformData:this._reader.getUint64(),WaveformPacketSizeInBytes:this._reader.getUint32(),ReturnPointWaveformLocation:this._reader.getFloat32(),Xt:this._reader.getFloat32(),Yt:this._reader.getFloat32(),Zt:this._reader.getFloat32()}}_parsePointDataRecordFormat_6(){return{X:this._reader.getInt32(),Y:this._reader.getInt32(),Z:this._reader.getInt32(),Intensity:this._reader.getUint16(),ReturnNumber:this._reader.getBits16(4),NumberOfReturns:this._reader.getBits16(4),ClassificationFlags:this._reader.getBits16(4),ScannerChannel:this._reader.getBits16(2),ScanDirectionFlag:this._reader.getBit16(),EdgeOfFlightLine:this._reader.getBit16(),Classification:{Class:this._reader.getBits8(5),Synthetic:this._reader.getBit8(),KeyPoint:this._reader.getBit8(),Withheld:this._reader.getBit8()},UserData:this._reader.getUint8(),ScanAngle:this._reader.getInt16(),PointSourceId:this._reader.getUint16(),GPSTime:this._reader.getFloat64()}}_parsePointDataRecordFormat_7(){return{X:this._reader.getInt32(),Y:this._reader.getInt32(),Z:this._reader.getInt32(),Intensity:this._reader.getUint16(),ReturnNumber:this._reader.getBits16(4),NumberOfReturns:this._reader.getBits16(4),ClassificationFlags:this._reader.getBits16(4),ScannerChannel:this._reader.getBits16(2),ScanDirectionFlag:this._reader.getBit16(),EdgeOfFlightLine:this._reader.getBit16(),Classification:{Class:this._reader.getBits8(5),Synthetic:this._reader.getBit8(),KeyPoint:this._reader.getBit8(),Withheld:this._reader.getBit8()},UserData:this._reader.getUint8(),ScanAngle:this._reader.getInt16(),PointSourceId:this._reader.getUint16(),GPSTime:this._reader.getFloat64(),R:this._reader.getUint16(),G:this._reader.getUint16(),B:this._reader.getUint16()}}_parsePointDataRecordFormat_8(){return{X:this._reader.getInt32(),Y:this._reader.getInt32(),Z:this._reader.getInt32(),Intensity:this._reader.getUint16(),ReturnNumber:this._reader.getBits16(4),NumberOfReturns:this._reader.getBits16(4),ClassificationFlags:this._reader.getBits16(4),ScannerChannel:this._reader.getBits16(2),ScanDirectionFlag:this._reader.getBit16(),EdgeOfFlightLine:this._reader.getBit16(),Classification:{Class:this._reader.getBits8(5),Synthetic:this._reader.getBit8(),KeyPoint:this._reader.getBit8(),Withheld:this._reader.getBit8()},UserData:this._reader.getUint8(),ScanAngle:this._reader.getInt16(),PointSourceId:this._reader.getUint16(),GPSTime:this._reader.getFloat64(),R:this._reader.getUint16(),G:this._reader.getUint16(),B:this._reader.getUint16(),NIR:this._reader.getUint16()}}_parsePointDataRecordFormat_9(){return{X:this._reader.getInt32(),Y:this._reader.getInt32(),Z:this._reader.getInt32(),Intensity:this._reader.getUint16(),ReturnNumber:this._reader.getBits16(4),NumberOfReturns:this._reader.getBits16(4),ClassificationFlags:this._reader.getBits16(4),ScannerChannel:this._reader.getBits16(2),ScanDirectionFlag:this._reader.getBit16(),EdgeOfFlightLine:this._reader.getBit16(),Classification:{Class:this._reader.getBits8(5),Synthetic:this._reader.getBit8(),KeyPoint:this._reader.getBit8(),Withheld:this._reader.getBit8()},UserData:this._reader.getUint8(),ScanAngle:this._reader.getInt16(),PointSourceId:this._reader.getUint16(),GPSTime:this._reader.getFloat64(),WavePacketDescriptorIndex:this._reader.getUint8(),ByteOffsetToWaveformData:this._reader.getUint64(),WaveformPacketSizeInBytes:this._reader.getUint32(),ReturnPointWaveformLocation:this._reader.getFloat32(),Xt:this._reader.getFloat32(),Yt:this._reader.getFloat32(),Zt:this._reader.getFloat32()}}_parsePointDataRecordFormat_10(){return{X:this._reader.getInt32(),Y:this._reader.getInt32(),Z:this._reader.getInt32(),Intensity:this._reader.getUint16(),ReturnNumber:this._reader.getBits16(4),NumberOfReturns:this._reader.getBits16(4),ClassificationFlags:this._reader.getBits16(4),ScannerChannel:this._reader.getBits16(2),ScanDirectionFlag:this._reader.getBit16(),EdgeOfFlightLine:this._reader.getBit16(),Classification:{Class:this._reader.getBits8(5),Synthetic:this._reader.getBit8(),KeyPoint:this._reader.getBit8(),Withheld:this._reader.getBit8()},UserData:this._reader.getUint8(),ScanAngle:this._reader.getInt16(),PointSourceId:this._reader.getUint16(),GPSTime:this._reader.getFloat64(),R:this._reader.getUint16(),G:this._reader.getUint16(),B:this._reader.getUint16(),NIR:this._reader.getUint16(),WavePacketDescriptorIndex:this._reader.getUint8(),ByteOffsetToWaveformData:this._reader.getUint64(),WaveformPacketSizeInBytes:this._reader.getUint32(),ReturnPointWaveformLocation:this._reader.getFloat32(),Xt:this._reader.getFloat32(),Yt:this._reader.getFloat32(),Zt:this._reader.getFloat32()}}convert(e,t,i,r){try{const r=new s;r.name="Cloud",r.matrixAutoUpdate=!1,r.position.x=e.Header.XOffset,r.position.y=e.Header.YOffset,r.position.z=e.Header.ZOffset,r.userData={header:e.Header,records:e.VariableLengthRecords},this._createCloudPoints(r,e,i),t(r)}catch(e){r(e)}}_offsetPoints(){this._autoOffset&&(this._boundingBox.setFromPoints(this._points),this.setOffset(this._boundingBox.getCenter()));const e=this._offset.x,t=this._offset.y,i=this._offset.z;let r=null;for(let s=0,n=this._points.length;s<n;++s)r=this._points[s],r.x-=e,r.y-=t,r.z-=i}_createCloudPoints(e,t,i){const r={0:"Created",1:"Unclassified",2:"Ground",3:"LowVegetation",4:"MediumVegetation",5:"HighVegetation",6:"Building",7:"LowPoint",8:"ModelKeyPoint",9:"Water",12:"OverlapPoints"};let s=-1/0;for(let e of t.PointDataRecords){const t=e.Intensity;t>s&&(s=t)}const l=t.Header.XScaleFactor,c=t.Header.YScaleFactor,d=t.Header.ZScaleFactor,p=1e6,u=t.PointDataRecords.length,_=Math.ceil(u/p),g=t.Header.VersionMinor<4?t.Header.PointDataFormatID:t.Header.PointDataRecordFormat,m=![0,1,4,6,9].includes(g),f=new o({size:.01,vertexColors:!0});let b=0,w=null,y=null;for(let o=0;o<_;++o){w=t.PointDataRecords.splice(0,p),b=w.length;const _=new n,g=new Float32Array(3*b),v=new Float32Array(3*b);let x=0,E=null;for(let e=0;e<b;++e){const t=e+o*p;if(t%1e5==0&&i(new ProgressEvent("ConvertPointDataRecords",{lengthComputable:!0,loaded:t,total:u})),E=w[e],g[x]=E.X*l,g[x+1]=E.Y*c,g[x+2]=E.Z*d,m)v[x]=E.R/65535,v[x+1]=E.G/65535,v[x+2]=E.B/65535;else{const e=this.colorForPointClass[r[E.Classification.Class]];if(ht(e))v[x]=e.r/255,v[x+1]=e.g/255,v[x+2]=e.b/255;else{const e=E.Intensity;v[x]=e/s,v[x+1]=e/s,v[x+2]=e/s}}x+=3}_.setAttribute("position",new a(g,3)),_.setAttribute("color",new a(v,3)),y=new h(_,f),e.add(y)}}_createSubCloudPoint(e){const t=this._points.length,i=new n,r=new Float32Array(3*t),s=new Float32Array(3*t);let l=0,c=null;for(let e=0;e<t;++e)c=this._points[e],r[l]=c.x,r[l+1]=c.y,r[l+2]=c.z,this._pointsHaveColor?(s[l]=c.r/255,s[l+1]=c.g/255,s[l+2]=c.b/255):(s[l]=.1,s[l+1]=.2,s[l+2]=.5),l+=3;i.setAttribute("position",new a(r,3)),i.setAttribute("color",new a(s,3));const d=new o({size:.005,vertexColors:!0}),p=new h(i,d);p.rotation.x-=Math.PI/2,e.children.push(p),this._points=[]}}
/**
 * @module Loader/SHPLoader
 * @desc Export SHPLoader to load .shp files
 *
 * @requires {@link https://github.com/Itee/itee-client itee-client}
 * @requires {@link https://github.com/Itee/itee-utils itee-utils}
 * @requires {@link https://github.com/Itee/three-full three-full}
 *
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 * @example Todo...
 *
 */const Dt=st({NullShape:0,Point:1,Polyline:3,Polygon:5,MultiPoint:8,PointZ:11,PolyLineZ:13,PolygonZ:15,MultiPointZ:18,PointM:21,PolylineM:23,PolygonM:25,MultiPointM:28,MultiPatch:31});class Tt{constructor(i={}){const r={manager:t,logger:e,reader:new Qe,globalOffset:new l(0,0,0),worldAxis:{from:"zUp",to:"zForward"},...i};this.manager=r.manager,this.logger=r.logger,this.reader=r.reader,this.globalOffset=r.globalOffset,this.worldAxis=r.worldAxis}get globalOffset(){return this._globalOffset}set globalOffset(e){this._globalOffset=e}get worldAxis(){return this._worldAxis}set worldAxis(e){this._worldAxis=e}get manager(){return this._manager}set manager(e){this._manager=e}get logger(){return this._logger}set logger(e){this._logger=e}get reader(){return this._reader}set reader(e){this._reader=e}setGlobalOffset(e){return this.globalOffset=e,this}setWorldAxis(e){return this.worldAxis=e,this}setManager(e){return this.manager=e,this}setLogger(e){return this.logger=e,this}setReader(e){return this.reader=e,this}load(e,t,i,s){const n=this,a=new r(n.manager);a.setResponseType("arraybuffer"),a.load(e,e=>{t(n.parse(e))},i,s)}parse(e){this._reader.setEndianess(Je.Big).setBuffer(e);const t=this._parseHeader();if(t.fileCode!==Tt.FileCode)return this.logger.error("SHPLoader: Invalide Shape file code !"),null;if(t.fileLength<Tt.MinFileLength)return this.logger.error("SHPLoader: Shape file have an incorrect length !"),null;if(!Object.values(Dt).includes(t.shapeType))return this.logger.error("SHPLoader: Shape file have an incorrect shape type !"),null;t.version<Tt.MinVersion&&this.logger.warn("SHPLoader: Version of shape file below than 1000 could be incorrectly parsed !");const i=this._parseDatas(t);return this._convertToObjects(i)}_parseHeader(){const e=this._reader.getInt32();this._reader.skipOffsetOf(20);const t=this._reader.getInt32();this._reader.setEndianess(Je.Little);const i=this._reader.getInt32(),r=this._reader.getInt32(),s=this._reader.getInt32(),n=this._reader.getInt32();return{fileCode:e,fileLength:t,version:i,shapeType:r,boundingBox:{xMin:s,xMax:this._reader.getInt32(),yMin:n,yMax:this._reader.getInt32(),zMin:this._reader.getInt32(),zMax:this._reader.getInt32(),mMin:this._reader.getInt32(),mMax:this._reader.getInt32()}}}_parseDatas(e){this._reader.skipOffsetTo(100);let t,i,r,s=[];for(;!this._reader.isEndOfFile();)switch(t=this._parseRecordHeader(),i=this._reader.getOffset()+2*t.contentLength,this._reader.setEndianess(Je.Little),e.shapeType){case Dt.NullShape:this._reader.skipOffsetTo(i);break;case Dt.Point:case Dt.PointZ:case Dt.PointM:for(;this._reader.getOffset()<i;)r=this._parsePoint(),r&&s.push(r);break;case Dt.Polyline:case Dt.PolyLineZ:case Dt.PolylineM:for(;this._reader.getOffset()<i;)r=this._parsePolyLine(),r&&s.push(r);break;case Dt.Polygon:case Dt.PolygonZ:case Dt.PolygonM:for(;this._reader.getOffset()<i;)r=this._parsePolyLine(),r&&s.push(r);break;case Dt.MultiPoint:case Dt.MultiPointZ:case Dt.MultiPointM:for(;this._reader.getOffset()<i;)r=this._parseMultiPoint(),r&&s.push(r);break;case Dt.MultiPatch:for(;this._reader.getOffset()<i;)r=this._parseMultiPatch(),r&&s.push(r);break;default:this.logger.error(`SHPLoader: Invalid switch parameter: ${e.shapeType}`)}return s}_parseRecordHeader(){this._reader.setEndianess(Je.Big);return{recordNumber:this._reader.getInt32(),contentLength:this._reader.getInt32()}}_parseNull(){return this._reader.getInt32(),null}_parsePoint(){const e=this._reader.getInt32();if(e===Dt.NullShape)return null;return{shapeType:e,x:this._reader.getFloat64(),y:this._reader.getFloat64()}}_parsePolyLine(){const e=this._reader.getInt32();if(e===Dt.NullShape)return null;const t={xMin:this._reader.getFloat64(),yMin:this._reader.getFloat64(),xMax:this._reader.getFloat64(),yMax:this._reader.getFloat64()},i=this._reader.getInt32(),r=this._reader.getInt32(),s=new Array(i);for(let e=0;e<i;e++)s[e]=this._reader.getInt32();const n=new Array(r);for(let e=0;e<r;e++)n[e]={x:this._reader.getFloat64(),y:this._reader.getFloat64()};return{shapeType:e,boundingBox:t,numberOfParts:i,numberOfPoints:r,parts:s,points:n}}_parsePolygon(){const e=this._reader.getInt32();if(e===Dt.NullShape)return null;const t={xMin:this._reader.getFloat64(),yMin:this._reader.getFloat64(),xMax:this._reader.getFloat64(),yMax:this._reader.getFloat64()},i=this._reader.getInt32(),r=this._reader.getInt32();let s=new Array(i);for(let e=0;e<i;e++)s[e]=this._reader.getInt32();let n=new Array(r);for(let e=0;e<r;e++)n[e]={x:this._reader.getFloat64(),y:this._reader.getFloat64()};const a=[],o=[];return s.forEach((e,t)=>{const i=n.slice(e,s[t+1]);nt(i)?a.push(i):o.push(i)}),o.forEach(e=>{a.some(t=>{if(at(t[0],e))return t.push(e),!0})||a.push([e])}),{shapeType:e,boundingBox:t,numberOfParts:i,numberOfPoints:r,parts:s,polygons:a}}_parseMultiPoint(){const e=this._reader.getInt32();if(e===Dt.NullShape)return null;const t={xMin:this._reader.getFloat64(),xMax:this._reader.getFloat64(),yMin:this._reader.getFloat64(),yMax:this._reader.getFloat64()},i=this._reader.getInt32(),r=new Array(i);for(let e=0;e<i;e++)r.push([this._reader.getFloat64(),this._reader.getFloat64()]);return{shapeType:e,boundingBox:t,numberOfPoints:i,points:r}}_parseMultiPatch(){const e=this._reader.getInt32();return e===Dt.NullShape?null:{shapeType:e}}_convertToObjects(e){let t=[];for(let t=0,s=e.length;t<s;t++){let s=e[t];s.shapeType!==Dt.Polygon&&s.shapeType!==Dt.PolygonZ&&s.shapeType!==Dt.PolygonM||(s.points&&Array.isArray(s.points[0])?i(s.points):r(s.points))}function i(e){for(let t=0,s=e.length;t<s;t++){let s=e[t];s?Array.isArray(s[0])?i(s):r(s):this.logger.log("no array, oups !")}}function r(e){t.push(new c(e))}return t}}Tt.FileCode=9994,Tt.MinFileLength=100,Tt.MinVersion=1e3;class It{constructor(e,t){if(this.m_bits=new Array,t&&t.length)for(let e=0;e<t.length;e++)this.m_bits.push(t[e]?It._ON:It._OFF);else isNaN(t)||(this.m_bits=It.shred(t).m_bits);if(e&&this.m_bits.length!==e)if(this.m_bits.length<e)for(let t=this.m_bits.length;t<e;t++)this.m_bits.push(It._OFF);else for(let t=e;t>this.m_bits.length;t--)this.m_bits.pop()}static _intersect(e,t){return e===It._ON&&t===It._ON?It._ON:It._OFF}static _union(e,t){return e===It._ON||t===It._ON?It._ON:It._OFF}static _difference(e,t){return e===It._ON&&t!==It._ON?It._ON:It._OFF}static _getLen(e,t,i){var r=e.getLength(),s=t.getLength();return i?s:r}static getUnion(e,t){for(var i=It._getLen(e,t,!0),r=new It(i),s=0;s<i;s++)r.setAt(s,It._union(e.getAt(s),t.getAt(s)));return r}static getIntersection(e,t){for(var i=It._getLen(e,t,!0),r=new It(i),s=0;s<i;s++)r.setAt(s,It._intersect(e.getAt(s),t.getAt(s)));return r}static getDifference(e,t){for(var i=It._getLen(e,t,!0),r=new It(i),s=0;s<i;s++)r.setAt(s,It._difference(e.getAt(s),t.getAt(s)));return r}static shred(e){var t=new Array,i=e;do{t.push(i%2),i=Math.floor(i/2)}while(i>0);return new It(t.length,t.reverse())}getLength(){return this.m_bits.length}getAt(e){return e<this.m_bits.length?this.m_bits[e]:null}setAt(e,t){e<this.m_bits.length&&(this.m_bits[e]=t?It._ON:It._OFF)}resize(e){for(var t=new Array,i=0;i<e;i++)i<this.m_bits.length?t.push(this.m_bits[i]):t.push(It._OFF);this.m_bits=t}getCompliment(){for(var e=new It(this.m_bits.length),t=0;t<this.m_bits.length;t++)e.setAt(t,this.m_bits[t]?It._OFF:It._ON);return e}toString(){for(var e=new String,t=0;t<this.m_bits.length;t++)e=e.concat(this.m_bits[t]===It._ON?"1":"0");return e}toNumber(){for(var e=0,t=0,i=this.m_bits.length-1;i>=0;i--)this.m_bits[i]===It._ON&&(t+=Math.pow(2,e)),e++;return t}}It._ON=1,It._OFF=0;class Bt{static getBit(e,t){return e&1<<t?1:0}static setBit(e,t){return e|1<<t}static clearBit(e,t){return e&~(1<<t)}static updateBit(e,t,i){return e&~(1<<t)|(i?1:0)<<t}static getBits(e,t){let i=0;for(let r of t)Bt.getBit(e,r)&&(i=Bt.setBit(i,r));return i}}
/**
 * @module Controllers/CameraControls
 * @desc This module export CameraControls class and CameraControlMode enum values.
 *
 * @requires {@link module: [itee-client]{@link https://github.com/Itee/itee-client}}
 * @requires {@link module: [itee-utils]{@link https://github.com/Itee/itee-utils}}
 * @requires {@link module: [itee-validators]{@link https://github.com/Itee/itee-validators}}
 * @requires {@link module: [three-full]{@link https://github.com/Itee/three-full}}
 *
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 *
 * @example
 *
 * import { CameraControls, CameraControlMode } from 'itee-plugin-three'
 *
 */const Ct=new l(0,0,-1),Ut=new l(0,0,1),kt=new l(0,1,0),Rt=new l(0,-1,0),Lt=new l(1,0,0),zt=new l(-1,0,0),Gt=st({None:0,Rotating:1,Panning:2,Rolling:3,Zooming:4,Moving:5}),Ht=st({FirstPerson:1,Orbit:2,Fly:3,Path:4});class Nt extends d{constructor(t={}){const i={logger:e,camera:null,target:new p,mode:Ht.Orbit,domElement:"function"==typeof importScripts?null:window,...t};super(),this._handlers={onMouseEnter:this._onMouseEnter.bind(this),onMouseLeave:this._onMouseLeave.bind(this),onMouseDown:this._onMouseDown.bind(this),onMouseMove:this._onMouseMove.bind(this),onMouseWheel:this._onMouseWheel.bind(this),onMouseUp:this._onMouseUp.bind(this),onDblClick:this._onDblClick.bind(this),onTouchStart:this._onTouchStart.bind(this),onTouchEnd:this._onTouchEnd.bind(this),onTouchCancel:this._onTouchCancel.bind(this),onTouchLeave:this._onTouchLeave.bind(this),onTouchMove:this._onTouchMove.bind(this),onKeyDown:this._onKeyDown.bind(this),onKeyUp:this._onKeyUp.bind(this)},this.logger=i.logger,this.camera=i.camera,this.target=i.target,this.mode=i.mode,this.domElement=i.domElement,this.enabled=!0,this._paths=[],this._trackPath=!1,this._cameraJump=.1,this._currentPathPosition=null,this._currentPathOffset=0,this._currentPathIndex=0,this._currentPath=null,this._maxJump=1,this._lockedTarget=!0,this.previousTouches=[],this.canMove=!0,this.moveSpeed=1,this.canFront=!0,this.frontMinimum=-1/0,this.frontMaximum=-1/0,this.frontMinSpeed=0,this.frontSpeed=1,this.frontMaxSpeed=1/0,this.frontAcceleration=1,this.canBack=!0,this.backMinimum=-1/0,this.backMaximum=-1/0,this.backMinSpeed=0,this.backSpeed=1,this.backMaxSpeed=1/0,this.backAcceleration=1,this.canUp=!0,this.upMinimum=-1/0,this.upMaximum=-1/0,this.upMinSpeed=0,this.upSpeed=1,this.upMaxSpeed=1/0,this.upAcceleration=1,this.canDown=!0,this.downMinimum=-1/0,this.downMaximum=-1/0,this.downMinSpeed=0,this.downSpeed=1,this.downMaxSpeed=1/0,this.downAcceleration=1,this.canLeft=!0,this.leftMinimum=-1/0,this.leftMaximum=-1/0,this.leftMinSpeed=0,this.leftSpeed=1,this.leftMaxSpeed=1/0,this.leftAcceleration=1,this.canRight=!0,this.rightMinimum=-1/0,this.rightMaximum=-1/0,this.rightMinSpeed=0,this.rightSpeed=1,this.rightMaxSpeed=1/0,this.rightAcceleration=1,this.canRotate=!0,this.minPolarAngle=.001,this.maxPolarAngle=Math.PI-.001,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.rotateMinSpeed=0,this.rotateSpeed=1,this.rotateMaxSpeed=1/0,this.rotateAcceleration=1,this.canPan=!0,this.panMinimum=-1/0,this.panMaximum=-1/0,this.panMinSpeed=0,this.panSpeed=.001,this.panMaxSpeed=1/0,this.panAcceleration=1,this.canRoll=!0,this.rollMinimum=-1/0,this.rollMaximum=-1/0,this.rollMinSpeed=0,this.rollSpeed=.1,this.rollMaxSpeed=1/0,this.rollAcceleration=1,this.canZoom=!0,this.zoomMinimum=0,this.zoomMaximum=1/0,this.zoomMinSpeed=0,this.zoomSpeed=.001,this.zoomMaxSpeed=1/0,this.zoomAcceleration=1,this.canLookAt=!0,this.actionsMap={front:[tt.Z.value,tt.UP_ARROW.value],back:[tt.S.value,tt.DOWN_ARROW.value],up:[tt.A.value,tt.PAGE_UP.value],down:[tt.E.value,tt.PAGE_DOWN.value],left:[tt.Q.value,tt.LEFT_ARROW.value],right:[tt.D.value,tt.RIGHT_ARROW.value],rotate:[it.Left.value],pan:[it.Middle.value],roll:{left:[tt.R.value],right:[tt.T.value]},zoom:[it.Wheel.value],lookAtFront:[tt.NUMPAD_2.value],lookAtFrontLeft:[tt.NUMPAD_3.value],lookAtFrontRight:[tt.NUMPAD_1.value],lookAtBack:[tt.NUMPAD_8.value],lookAtBackLeft:[tt.NUMPAD_9.value],lookAtBackRight:[tt.NUMPAD_7.value],lookAtUp:[tt.NUMPAD_5.value],lookAtDown:[tt.NUMPAD_0.value],lookAtLeft:[tt.NUMPAD_6.value],lookAtRight:[tt.NUMPAD_4.value]},this._state=Gt.None}get camera(){return this._camera}set camera(e){if(lt(e))throw new Error("Camera cannot be null ! Expect an instance of Camera");if(ct(e))throw new Error("Camera cannot be undefined ! Expect an instance of Camera");if(!e.isCamera)throw new Error(`Camera cannot be an instance of ${e.constructor.name}. Expect an instance of Camera.`);this._camera=e}get target(){return this._target}set target(e){if(lt(e))throw new Error("Target cannot be null ! Expect an instance of Object3D.");if(ct(e))throw new Error("Target cannot be undefined ! Expect an instance of Object3D.");if(!e.isObject3D)throw new Error(`Target cannot be an instance of ${e.constructor.name}. Expect an instance of Object3D.`);this._target=e}get mode(){return this._mode}set mode(e){if(lt(e))throw new Error("Mode cannot be null ! Expect a value from CameraControlMode enum.");if(ct(e))throw new Error("Mode cannot be undefined ! Expect a value from CameraControlMode enum.");if(!Ht.includes(e))throw new Error(`Mode cannot be an instance of ${e.constructor.name}. Expect a value from TCameraControlMode enum.`);this._mode=e,this._trackPath&&this._initPathDisplacement()}get paths(){return this._paths}set paths(e){this._paths=e}get trackPath(){return this._trackPath}set trackPath(e){if(dt(e))throw new Error(`Track path cannot be an instance of ${e.constructor.name}. Expect a boolean.`);this._trackPath=e,this._trackPath&&this._initPathDisplacement()}get domElement(){return this._domElement}set domElement(e){if(lt(e))throw new Error("DomElement cannot be null ! Expect an instance of HTMLDocument.");if(ct(e))throw new Error("DomElement cannot be undefined ! Expect an instance of HTMLDocument.");if(!["Window","HTMLDocument","HTMLDivElement","HTMLCanvasElement","OffscreenCanvas"].includes(e.constructor.name))throw new Error(`DomElement cannot be an instance of ${e.constructor.name}. Expect an instance of Window, HTMLDocument or HTMLDivElement.`);this._domElement&&(this._domElement.removeEventListener("mouseenter",this._handlers.onMouseEnter,!1),this._domElement.removeEventListener("mouseleave",this._handlers.onMouseLeave,!1),this.dispose()),this._domElement=e,this._domElement.addEventListener("mouseenter",this._handlers.onMouseEnter,!1),this._domElement.addEventListener("mouseleave",this._handlers.onMouseLeave,!1),this.impose()}get handlers(){return this._handlers}setCamera(e){return this.camera=e,this}setTarget(e){return this.target=e,this}setMode(e){return this.mode=e,this}setPaths(e){return this.paths=e,this}addPath(e){return this._paths.push(e),this}setTrackPath(e){return this.trackPath=e,this}setDomElement(e){return this.domElement=e,this}impose(){this._domElement.addEventListener("keydown",this._handlers.onKeyDown,!1),this._domElement.addEventListener("keyup",this._handlers.onKeyUp,!1),this._domElement.addEventListener("dblclick",this._handlers.onDblClick,!1),this._domElement.addEventListener("mousedown",this._handlers.onMouseDown,!1),this._domElement.addEventListener("mousemove",this._handlers.onMouseMove,!1),this._domElement.addEventListener("mouseup",this._handlers.onMouseUp,!1),this._domElement.addEventListener("wheel",this._handlers.onMouseWheel,{capture:!0,once:!1,passive:!1}),this._domElement.addEventListener("touchcancel",this._handlers.onTouchCancel,!1),this._domElement.addEventListener("touchend",this._handlers.onTouchEnd,!1),this._domElement.addEventListener("touchleave",this._handlers.onTouchLeave,!1),this._domElement.addEventListener("touchmove",this._handlers.onTouchMove,{capture:!0,once:!1,passive:!1}),this._domElement.addEventListener("touchstart",this._handlers.onTouchStart,{capture:!0,once:!1,passive:!1}),this.dispatchEvent({type:"impose"})}dispose(){this._domElement.removeEventListener("keydown",this._handlers.onKeyDown,!1),this._domElement.removeEventListener("keyup",this._handlers.onKeyUp,!1),this._domElement.removeEventListener("dblclick",this._handlers.onDblClick,!1),this._domElement.removeEventListener("mousedown",this._handlers.onMouseDown,!1),this._domElement.removeEventListener("mousemove",this._handlers.onMouseMove,!1),this._domElement.removeEventListener("mouseup",this._handlers.onMouseUp,!1),this._domElement.removeEventListener("wheel",this._handlers.onMouseWheel,{capture:!0,once:!1,passive:!1}),this._domElement.removeEventListener("touchcancel",this._handlers.onTouchCancel,!1),this._domElement.removeEventListener("touchend",this._handlers.onTouchEnd,!1),this._domElement.removeEventListener("touchleave",this._handlers.onTouchLeave,!1),this._domElement.removeEventListener("touchmove",this._handlers.onTouchMove,{capture:!0,once:!1,passive:!1}),this._domElement.removeEventListener("touchstart",this._handlers.onTouchStart,{capture:!0,once:!1,passive:!1}),this.dispatchEvent({type:"dispose"})}update(){}setCameraPosition(e){return this._camera.position.copy(e),this._camera.lookAt(this._target.position),this}setTargetPosition(e){return this._target.position.copy(e),this._camera.lookAt(this._target.position),this}_preventEvent(e){e.preventDefault&&e.preventDefault()}_consumeEvent(e){e.cancelable&&e.stopImmediatePropagation&&e.stopImmediatePropagation()}_onKeyDown(e){if(!this.enabled)return;this._preventEvent(e);const t=this.actionsMap,i=e.keyCode;t.front.includes(i)?(this._front(),this._consumeEvent(e)):t.back.includes(i)?(this._back(),this._consumeEvent(e)):t.up.includes(i)?(this._up(),this._consumeEvent(e)):t.down.includes(i)?(this._down(),this._consumeEvent(e)):t.left.includes(i)?(this._left(),this._consumeEvent(e)):t.right.includes(i)?(this._right(),this._consumeEvent(e)):t.rotate.includes(i)?this._rotate(1):t.pan.includes(i)?(this._pan(1),this._consumeEvent(e)):t.roll.left.includes(i)?(this._roll(1),this._consumeEvent(e)):t.roll.right.includes(i)?(this._roll(-1),this._consumeEvent(e)):t.zoom.includes(i)?(this._zoom(1),this._consumeEvent(e)):t.lookAtFront.includes(i)?(this._lookAt(Ct),this._consumeEvent(e)):t.lookAtFrontLeft.includes(i)?(this._lookAt(new l(-1,0,-1).normalize()),this._consumeEvent(e)):t.lookAtFrontRight.includes(i)?(this._lookAt(new l(1,0,-1).normalize()),this._consumeEvent(e)):t.lookAtBack.includes(i)?(this._lookAt(Ut),this._consumeEvent(e)):t.lookAtBackLeft.includes(i)?(this._lookAt(new l(-1,0,1).normalize()),this._consumeEvent(e)):t.lookAtBackRight.includes(i)?(this._lookAt(new l(1,0,1).normalize()),this._consumeEvent(e)):t.lookAtUp.includes(i)?(this._lookAt(kt),this._consumeEvent(e)):t.lookAtDown.includes(i)?(this._lookAt(Rt),this._consumeEvent(e)):t.lookAtLeft.includes(i)?(this._lookAt(zt),this._consumeEvent(e)):t.lookAtRight.includes(i)&&(this._lookAt(Lt),this._consumeEvent(e))}_onKeyUp(e){this.enabled&&this._preventEvent(e)}_onTouchStart(e){this.enabled&&(this._preventEvent(e),this.previousTouches=e.touches)}_onTouchEnd(e){this.enabled&&(this._preventEvent(e),this.previousTouches=[],this._state=Gt.None)}_onTouchCancel(e){this.enabled&&(this._preventEvent(e),this.previousTouches=[],this._state=Gt.None)}_onTouchLeave(e){this.enabled&&(this._preventEvent(e),this.previousTouches=[],this._state=Gt.None)}_onTouchMove(e){if(!this.enabled)return;this._preventEvent(e);const t=this.previousTouches,i=e.changedTouches,r=t.length,s=i.length;if(2===r&&2===s){const r=new u(t[0].clientX,t[0].clientY),s=new u(t[1].clientX,t[1].clientY),n=r.distanceTo(s),a=(new u).addVectors(r,s).divideScalar(2),o=(new u).subVectors(r,s).normalize(),h=new u(i[0].clientX,i[0].clientY),l=new u(i[1].clientX,i[1].clientY),c=h.distanceTo(l),d=(new u).addVectors(h,l).divideScalar(2),p=(new u).subVectors(r,s).normalize(),_=(new u).subVectors(d,a),g=c-n,m=p.dot(o);this._pan(_),this._zoom(g),this._roll(m),this._consumeEvent(e)}else if(1===r&&1===s){const r=new u(i[0].clientX-t[0].clientX,i[0].clientY-t[0].clientY).divideScalar(10);this._rotate(r),this._consumeEvent(e)}else this.logger.warn("Ignoring inconsistent touches event.");this.previousTouches=i}_onMouseEnter(e){this.enabled&&(this._preventEvent(e),this.impose(),e.target.constructor!==HTMLDocument&&this._domElement.focus())}_onMouseLeave(e){this.enabled&&(this._preventEvent(e),e.target.constructor!==HTMLDocument&&this._domElement.blur(),this.dispose(),this._state=Gt.None)}_onMouseDown(e){if(!this.enabled)return;this._preventEvent(e);const t=this.actionsMap,i=e.button;t.front.includes(i)?(this._state=Gt.Moving,this._front(),this._consumeEvent(e)):t.back.includes(i)?(this._state=Gt.Moving,this._back(),this._consumeEvent(e)):t.up.includes(i)?(this._state=Gt.Moving,this._up(),this._consumeEvent(e)):t.down.includes(i)?(this._state=Gt.Moving,this._down(),this._consumeEvent(e)):t.left.includes(i)?(this._state=Gt.Moving,this._left(),this._consumeEvent(e)):t.right.includes(i)?(this._state=Gt.Moving,this._right(),this._consumeEvent(e)):t.rotate.includes(i)?(this._state=Gt.Rotating,this._consumeEvent(e)):t.pan.includes(i)?(this._state=Gt.Panning,this._consumeEvent(e)):t.roll.left.includes(i)||t.roll.right.includes(i)?(this._state=Gt.Rolling,this._consumeEvent(e)):t.zoom.includes(i)?(this._state=Gt.Zooming,this._consumeEvent(e)):this._state=Gt.None}_onMouseMove(e){if(!this.enabled||this._state===Gt.None)return;this._preventEvent(e);const t=this._state,i={x:e.movementX||e.mozMovementX||e.webkitMovementX||0,y:e.movementY||e.mozMovementY||e.webkitMovementY||0};switch(t){case Gt.Moving:break;case Gt.Rotating:this._rotate(i),this._consumeEvent(e);break;case Gt.Panning:this._pan(i),this._consumeEvent(e);break;case Gt.Rolling:this._roll(i),this._consumeEvent(e);break;case Gt.Zooming:this._zoom(i),this._consumeEvent(e);break;default:throw new RangeError(`Unknown state: ${t}`)}}_onMouseWheel(e){if(!this.enabled)return;this._preventEvent(e);const t=e.wheelDelta||e.deltaY;this._zoom(t),this._consumeEvent(e)}_onMouseUp(e){this.enabled&&(this._preventEvent(e),this._state=Gt.None,this._consumeEvent(e))}_onDblClick(e){this.enabled&&(this._preventEvent(e),this.logger.warn("CameraControls: Double click events is not implemented yet, sorry for the disagreement."))}_front(){if(this.canMove&&this.canFront){if(this._camera.isPerspectiveCamera){const e=Ct.clone().applyQuaternion(this._camera.quaternion),t=this._trackPath?this._getPathDisplacement(e):e.multiplyScalar(this.frontSpeed);this._camera.position.add(t),this._target.position.add(t)}else if(this._camera.isOrthographicCamera){const e=Ct.clone().applyQuaternion(this._camera.quaternion),t=this._trackPath?this._getPathDisplacement(e):e.multiplyScalar(this.frontSpeed);this._camera.position.add(t),this._target.position.add(t);const i=this.frontSpeed*this.zoomSpeed;this._camera.zoom+=i,this._camera.updateProjectionMatrix()}else this.logger.error(`Unmanaged displacement for camera of type ${this._camera.type}`);this.dispatchEvent({type:"move"}),this.dispatchEvent({type:"change"})}}_back(){if(this.canMove&&this.canBack){if(this._camera.isPerspectiveCamera){const e=Ut.clone().applyQuaternion(this._camera.quaternion),t=this._trackPath?this._getPathDisplacement(e):e.multiplyScalar(this.backSpeed);this._camera.position.add(t),this._target.position.add(t)}else if(this._camera.isOrthographicCamera){const e=Ut.clone().applyQuaternion(this._camera.quaternion),t=this._trackPath?this._getPathDisplacement(e):e.multiplyScalar(this.backSpeed);this._camera.position.add(t),this._target.position.add(t);const i=this.backSpeed*this.zoomSpeed;this._camera.zoom-i<=0?this._camera.zoom=.01:this._camera.zoom-=i,this._camera.updateProjectionMatrix()}else this.logger.error(`Unmanaged displacement for camera of type ${this._camera.type}`);this.dispatchEvent({type:"move"}),this.dispatchEvent({type:"change"})}}_up(){if(this.canMove&&this.canUp){if(this._camera.isPerspectiveCamera||this._camera.isOrthographicCamera){const e=kt.clone().applyQuaternion(this._camera.quaternion).multiplyScalar(this.upSpeed);this._camera.position.add(e),this._target.position.add(e)}else this.logger.error(`Unmanaged displacement for camera of type ${this._camera.type}`);this.dispatchEvent({type:"move"}),this.dispatchEvent({type:"change"})}}_down(){if(this.canMove&&this.canDown){if(this._camera.isPerspectiveCamera||this._camera.isOrthographicCamera){const e=Rt.clone().applyQuaternion(this._camera.quaternion).multiplyScalar(this.downSpeed);this._camera.position.add(e),this._target.position.add(e)}else this.logger.error(`Unmanaged displacement for camera of type ${this._camera.type}`);this.dispatchEvent({type:"move"}),this.dispatchEvent({type:"change"})}}_left(){if(this.canMove&&this.canLeft){if(this._camera.isPerspectiveCamera||this._camera.isOrthographicCamera){const e=zt.clone().applyQuaternion(this._camera.quaternion).multiplyScalar(this.leftSpeed);this._camera.position.add(e),this._target.position.add(e)}else this.logger.error(`Unmanaged displacement for camera of type ${this._camera.type}`);this.dispatchEvent({type:"move"}),this.dispatchEvent({type:"change"})}}_right(){if(this.canMove&&this.canRight){if(this._camera.isPerspectiveCamera||this._camera.isOrthographicCamera){const e=Lt.clone().applyQuaternion(this._camera.quaternion).multiplyScalar(this.rightSpeed);this._camera.position.add(e),this._target.position.add(e)}this.dispatchEvent({type:"move"}),this.dispatchEvent({type:"change"})}}_rotate(e){if(this.canRotate){if(this._camera.isPerspectiveCamera||this._camera.isOrthographicCamera){const t=this._camera.position,i=this._target.position,r=t.distanceTo(i),s=(new l).subVectors(t,i).normalize(),n=this.rotateSpeed;switch(this._mode){case Ht.FirstPerson:{const r=e.x,s=e.y,a=new l(-r,s,0).applyQuaternion(this._camera.quaternion).multiplyScalar(n).add(i),o=(new l).subVectors(a,t).normalize(),h=kt.clone().dot(o),c=Lt.clone().dot(o),d=.97;if(h<-d||h>d||c<-2||c>2)return;const p=o.multiplyScalar(1).add(t);this.setTargetPosition(p)}break;case Ht.Orbit:{const t=(new _).setFromVector3(s),a=t.theta+ot(-e.x)*n,o=t.phi+ot(-e.y)*n;t.theta=Math.max(this.minAzimuthAngle,Math.min(this.maxAzimuthAngle,a)),t.phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,o));const h=(new l).setFromSpherical(t).multiplyScalar(r).add(i);this.setCameraPosition(h)}break;default:throw new RangeError(`Unamanaged rotation for camera mode ${this._mode}`)}}this.dispatchEvent({type:"rotate"}),this.dispatchEvent({type:"change"})}}_pan(e){if(this.canPan){if(this._camera.isPerspectiveCamera||this._camera.isOrthographicCamera){const t=this._camera.position,i=this._target.position,r=t.distanceTo(i),s=new l(-e.x,e.y,0).applyQuaternion(this._camera.quaternion).multiplyScalar(this.panSpeed*r);this._camera.position.add(s),this._target.position.add(s)}this.dispatchEvent({type:"pan"}),this.dispatchEvent({type:"change"})}}_roll(e){if(this.canRoll){if(this._camera.isPerspectiveCamera||this._camera.isOrthographicCamera){const t=this._camera.position,i=this._target.position,r=(new l).subVectors(t,i).normalize(),s=e*this.rollSpeed;this._camera.up.applyAxisAngle(r,s),this._camera.lookAt(i)}this.dispatchEvent({type:"roll"}),this.dispatchEvent({type:"change"})}}_zoom(e){if(this.canZoom){if(this._camera.isPerspectiveCamera)switch(this._mode){case Ht.FirstPerson:e>0?this._camera.fov--:this._camera.fov++,this._camera.updateProjectionMatrix();break;case Ht.Orbit:{const t=this._camera.position,i=this._target.position,r=t.distanceTo(i),s=Ct.clone().applyQuaternion(this._camera.quaternion).multiplyScalar(e*this.zoomSpeed*r);let n=t.clone().add(s);const a=(new l).subVectors(n,t).normalize(),o=(new l).subVectors(t,i).normalize(),h=(new l).subVectors(n,i).normalize(),c=a.dot(o),d=a.dot(h),p=n.distanceToSquared(i);c<0&&(p<this.zoomMinimum*this.zoomMinimum||d>0)&&(n=o.clone().multiplyScalar(this.zoomMinimum).add(i)),this._camera.position.copy(n)}break;default:throw new RangeError(`Invalid camera control mode parameter: ${this._mode}`)}else if(this._camera.isOrthographicCamera){const t=this.domElement.offsetWidth/this.domElement.offsetHeight,i=this._camera.position,r=this._target.position,s=i.distanceTo(r),n=(e>0?Ct.clone():Ut.clone()).applyQuaternion(this._camera.quaternion).normalize().multiplyScalar(this.zoomSpeed*s);i.add(n);const a=i.distanceTo(r),o=a/2,h=a*t/2;this._camera.top=o,this._camera.bottom=-o,this._camera.right=h,this._camera.left=-h,this._camera.updateProjectionMatrix()}this.dispatchEvent({type:"zoom"}),this.dispatchEvent({type:"change"})}}_lookAt(e){if(this.canLookAt){if(this._camera.isPerspectiveCamera||this._camera.isOrthographicCamera){const t=e.clone(),i=this._camera.position,r=this._target.position,s=i.distanceTo(r);switch(this.mode){case Ht.FirstPerson:{t.y=-t.y;const e=t.multiplyScalar(s).add(i);this.setTargetPosition(e)}break;case Ht.Orbit:{const e=t.multiplyScalar(s).add(r);this.setCameraPosition(e)}break;default:throw new RangeError(`Invalid camera control mode parameter: ${this._mode}`)}}this.dispatchEvent({type:"lookAt"}),this.dispatchEvent({type:"change"})}}_initPathDisplacement(){if(pt(this._paths))this.logger.warn("Try to init path displacement without any paths");else switch(ut(this._currentPath)&&(this._currentPathIndex=0,this._currentPathOffset=0,this._currentPath=this._paths[0]),this._currentPathPosition=this._currentPath.getPointAt(this._currentPathOffset),this._mode){case Ht.FirstPerson:if(this._lockedTarget){const e=(new l).subVectors(this._currentPathPosition,this.camera.position);this._camera.position.add(e),this._target.position.add(e)}else this.setCameraPosition(this._currentPathPosition);break;case Ht.Orbit:if(this._lockedTarget){const e=(new l).subVectors(this._currentPathPosition,this.target.position);this._camera.position.add(e),this._target.position.add(e)}else this.setTargetPosition(this._currentPathPosition);break;default:throw new RangeError(`Invalid camera control _mode parameter: ${this._mode}`)}}_getPathDisplacement(e){let t=null;const i=this._currentPathPosition,r=this._currentPathOffset+this._cameraJump,s=r<1?r:1,n=this._currentPath.getPointAt(s),a=(new l).subVectors(n,i),o=a.clone().normalize(),h=e.dot(o),c=this._currentPathOffset-this._cameraJump,d=c>0?c:0,p=this._currentPath.getPointAt(d),u=(new l).subVectors(p,i),_=u.clone().normalize(),g=e.dot(_);if(0===h&&g<0){const i=this._getDirectionsMap();let r,s,n,a=-1;i.forEach(t=>{const i=t.index,o=t.startDisplacement;if(o){const t=o.clone().normalize(),h=e.dot(t);h>a&&(r=i,s=o,a=h,n=!0)}const h=t.endDisplacement;if(h){const t=h.clone().normalize(),o=e.dot(t);o>a&&(r=i,s=h,a=o,n=!1)}}),void 0!==r?(this._currentPathIndex=r,this._currentPath=this._paths[this._currentPathIndex],this._currentPathOffset=n?this._cameraJump:1-this._cameraJump,this._currentPathPosition=this._currentPath.getPointAt(this._currentPathOffset),t=s):(this.logger.warn("Reach path end."),t=new l)}else if(h>0&&g<=0)t=a,this._currentPathOffset=s,this._currentPathPosition=n;else if(h<=0&&g>0)t=u,this._currentPathOffset=d,this._currentPathPosition=p;else if(h<0&&0===g){const i=this._getDirectionsMap();let r,s,n,a=-1;i.forEach(t=>{const i=t.index,o=t.startDisplacement;if(o){const t=o.clone().normalize(),h=e.dot(t);h>a&&(r=i,s=o,a=h,n=!0)}const h=t.endDisplacement;if(h){const t=h.clone().normalize(),o=e.dot(t);o>a&&(r=i,s=h,a=o,n=!1)}}),void 0!==r?(this._currentPathIndex=r,this._currentPath=this._paths[this._currentPathIndex],this._currentPathOffset=n?this._cameraJump:1-this._cameraJump,this._currentPathPosition=this._currentPath.getPointAt(this._currentPathOffset),t=s):(this.logger.warn("Reach path start."),t=new l)}else h<0&&g<0||h>0&&g>0?h>g?(t=a,this._currentPathOffset=s,this._currentPathPosition=n):(t=u,this._currentPathOffset=d,this._currentPathPosition=p):(this.logger.warn("Unable to find correct next path position."),t=new l);return t}_getDirectionsMap(){const e=this._currentPathPosition,t=this._currentPathIndex,i=this._cameraJump,r=this._maxJump;return this._paths.reduce((s,n,a)=>{if(a===t)return s;const o=n.getPointAt(0);let h;e.distanceToSquared(o)<r&&(h=(new l).subVectors(n.getPointAt(i),o));const c=n.getPointAt(1);let d;return e.distanceToSquared(c)<r&&(d=(new l).subVectors(n.getPointAt(1-i),c)),(h||d)&&s.push({index:a,startDisplacement:h,endDisplacement:d}),s},[])}}
/**
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 */class jt extends g{constructor(e){super(e),this.isHighlightableMaterial=!0,this.depthTest=!1,this.depthWrite=!1,this.fog=!1,this.transparent=!0,this.linewidth=1,this.oldColor=this.color.clone()}highlight(e){if(e){const e=.35,t=this.color.r,i=this.color.g,r=this.color.b,s=Math.min(Math.max(0,t+t*e),1),n=Math.min(Math.max(0,i+i*e),1),a=Math.min(Math.max(0,r+r*e),1);this.color.setRGB(s,n,a)}else this.color.copy(this.oldColor)}}
/**
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 */class Yt extends m{constructor(e){super(e),this.isHighlightableMaterial=!0,this.depthTest=!1,this.depthWrite=!1,this.fog=!1,this.side=f,this.transparent=!0,this.oldColor=this.color.clone()}highlight(e){if(e){const e=.35,t=this.color.r,i=this.color.g,r=this.color.b,s=Math.min(Math.max(0,t+t*e),1),n=Math.min(Math.max(0,i+i*e),1),a=Math.min(Math.max(0,r+r*e),1);this.color.setRGB(s,n,a)}else this.color.copy(this.oldColor)}}
/**
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 */class Xt extends b{constructor(e={}){const t={geometry:new n,material:new m({visible:!1,depthTest:!1,depthWrite:!1,fog:!1,side:f,color:6636321}),...e};super(t.geometry,t.material),this.isHitbox=!0,this.type="Hitbox",this.matrixAutoUpdate=!1}}
/**
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 */class Zt extends Xt{constructor(e={}){super({geometry:new w(1.2,0),...e}),this.isOctahedricalHitbox=!0,this.type="OctahedricalHitbox"}}
/**
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 */class Vt extends p{constructor(e={}){const t={debug:!1,color:16777215,hitbox:null,...e};super(t),this.isHandle=!0,this.type="Handle",this.matrixAutoUpdate=!0,this.debug=t.debug,this.color=t.color,this.hitbox=t.hitbox,this.baseQuaternion=new y}get color(){return this.line.material.color.clone()}set color(e){if(lt(e))throw new Error("Color cannot be null ! Expect an instance of Color.");if(ct(e))throw new Error("Color cannot be undefined ! Expect an instance of Color.");this.traverse(t=>{let i=t.material;i&&i.color.setHex(e)})}get hitbox(){return this._hitbox}set hitbox(e){this._hitbox=e,this.add(e)}setColor(e){return this.color=e,this}setHitbox(e){return this.hitbox=e,this}setScale(e,t,i){return this.scale.set(e,t,i),this}setPosition(e,t,i){return this.position.set(e,t,i),this}highlight(e){for(let t=0,i=this.children.length;t<i;t++){const i=this.children[t];if(i.isHitbox)continue;const r=i.material;!ct(r)&&r.isHighlightableMaterial&&r.highlight(e)}}raycast(e,t){const i=e.intersectObject(this._hitbox,!1);i.length>0&&t.push({distance:i[0].distance,object:this})}setRotationFromAxisAndAngle(e,t){return this.quaternion.setFromAxisAngle(e,t),this.baseQuaternion.copy(this.quaternion),this}update(e){}}
/**
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 */class Wt extends Vt{constructor(e={}){const t={color:16777215,hitbox:new Zt,...e};super(t),this.isOmnidirectionalHandle=!0,this.type="OmnidirectionalHandle";const i=new w(.1,0),r=new Yt({color:t.color,transparent:!0,opacity:.55}),s=new b(i,r);s.matrixAutoUpdate=!1,this.add(s);const n=new v(i),a=new jt({color:t.color,linewidth:4}),o=new x(n,a);o.matrixAutoUpdate=!1,this.add(o)}update(e){super.update(e),this.updateMatrix(),this.hitbox.updateMatrix()}}
/**
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 */class Kt extends Xt{constructor(e={}){const t=e.centered?[-.6,-.6,0,.6,-.6,0,.6,.6,0,-.6,.6,0]:[0,0,0,1.1,0,0,1.1,1.1,0,0,1.1,0],i=new n;i.setAttribute("position",new E(t,3)),i.setIndex([0,1,2,2,3,0]);super({geometry:i,...e}),this.isPlanarHitbox=!0,this.type="PlanarHitbox"}}
/**
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 */class $t extends Vt{constructor(e={}){const t={showEdges:!1,centered:!1,color:16777215,hitbox:new Kt({centered:e.centered||!1}),direction:new l(0,1,0),...e};if(super(t),this.isPlaneHandle=!0,this.type="PlaneHandle",t.showEdges){const e=new n;e.setAttribute("position",new E([.75,1,0,1,1,0,1,.75,0],3));const i=new jt({color:t.color}),r=new P(e,i);r.matrixAutoUpdate=!1,this.add(r)}const i=t.centered?[-.5,-.5,0,.5,-.5,0,.5,.5,0,-.5,.5,0]:[.1,.1,0,1,.1,0,1,1,0,.1,1,0],r=new n;r.setAttribute("position",new E(i,3)),r.setIndex([0,1,2,2,3,0]);const s=new Yt({color:t.color,transparent:!0,opacity:.35}),a=new b(r,s);if(a.matrixAutoUpdate=!1,this.add(a),this.xAxis=new l(1,0,0),this.yAxis=new l(0,1,0),this.zAxis=new l(0,0,1),this.xDirection=new l(t.direction.x,0,0),this.yDirection=new l(0,t.direction.y,0),this.zDirection=new l(0,0,t.direction.z),this.direction=t.direction,this.debug){const e=new l(0,0,0),i=t.direction,r=new M(i,e,1,1193046);this.add(r)}}get direction(){return this._direction}set direction(e){if(lt(e))throw new Error("Direction cannot be null ! Expect an instance of Color.");if(ct(e))throw new Error("Direction cannot be undefined ! Expect an instance of Color.");if(!(e instanceof l))throw new Error(`Direction cannot be an instance of ${e.constructor.name}. Expect an instance of Vector3.`);this._direction=e}update(e){super.update(e);const t=new l(this._direction.x,0,0),i=new l(0,this._direction.y,0),r=new l(0,0,this._direction.z),s=t.dot(e),n=i.dot(e),a=r.dot(e);this.quaternion.copy(this.baseQuaternion),s>0&&n>0&&0===a?(this.rotateOnAxis(this.zAxis,ot(180)),this.xDirection.setX(-1),this.yDirection.setY(-1),this.zDirection.setZ(0)):s>0&&n<0&&0===a?(this.rotateOnAxis(this.zAxis,ot(90)),this.xDirection.setX(-1),this.yDirection.setY(1),this.zDirection.setZ(0)):s<0&&n>0&&0===a?(this.rotateOnAxis(this.zAxis,ot(270)),this.xDirection.setX(1),this.yDirection.setY(-1),this.zDirection.setZ(0)):s<0&&n<0&&0===a?(this.rotateOnAxis(this.zAxis,ot(0)),this.xDirection.setX(1),this.yDirection.setY(1),this.zDirection.setZ(0)):s>0&&0===n&&a>0?(this.rotateOnAxis(this.zAxis,ot(180)),this.xDirection.setX(-1),this.yDirection.setY(0),this.zDirection.setZ(-1)):s>0&&0===n&&a<0?(this.rotateOnAxis(this.zAxis,ot(90)),this.xDirection.setX(-1),this.yDirection.setY(0),this.zDirection.setZ(1)):s<0&&0===n&&a>0?(this.rotateOnAxis(this.zAxis,ot(270)),this.xDirection.setX(1),this.yDirection.setY(0),this.zDirection.setZ(-1)):s<0&&0===n&&a<0?(this.rotateOnAxis(this.zAxis,ot(0)),this.xDirection.setX(1),this.yDirection.setY(0),this.zDirection.setZ(1)):0===s&&n>0&&a>0?(this.rotateOnAxis(this.zAxis,ot(180)),this.xDirection.setX(0),this.yDirection.setY(-1),this.zDirection.setZ(-1)):0===s&&n>0&&a<0?(this.rotateOnAxis(this.zAxis,ot(270)),this.xDirection.setX(0),this.yDirection.setY(-1),this.zDirection.setZ(1)):0===s&&n<0&&a>0?(this.rotateOnAxis(this.zAxis,ot(90)),this.xDirection.setX(0),this.yDirection.setY(1),this.zDirection.setZ(-1)):0===s&&n<0&&a<0&&(this.rotateOnAxis(this.zAxis,ot(0)),this.xDirection.setX(0),this.yDirection.setY(1),this.zDirection.setZ(1)),this.updateMatrix(),this.hitbox.updateMatrix()}setDirection(e){return this.direction=e,this}flipXDirection(){this.xDirection.setX(-this.xDirection.x)}flipYDirection(){this.yDirection.setY(-this.yDirection.y)}flipZDirection(){this.zDirection.setZ(-this.zDirection.z)}}
/**
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 */class qt extends n{constructor(e=new l(0,0,0),t=new l(1,0,0)){super(),this.type="LineGeometry",this.setAttribute("position",new E([e.x,e.y,e.z,t.x,t.y,t.z],3))}}
/**
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 */class Qt extends Xt{constructor(e={}){const t=new F(.2,0,1,4,1,!1);t.translate(0,.5,0);super({geometry:t,...e}),this.isCylindricaHitbox=!0,this.type="CylindricaHitbox"}}
/**
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 */class Jt extends Vt{constructor(e={}){const t={color:16777215,hitbox:new Qt,direction:new l(0,1,0),...e};super(t),this.isScaleHandle=!0,this.type="ScaleHandle";const i=new qt(new l(0,0,0),new l(0,.88,0)),r=new jt({color:t.color}),s=new P(i,r);s.matrixAutoUpdate=!1,this.add(s);const n=new S(.12,.12,.12);n.translate(0,.94,0);const a=new Yt({color:t.color}),o=new b(n,a);o.matrixAutoUpdate=!1,this.add(o),this.direction=t.direction}get direction(){return this._direction}set direction(e){if(lt(e))throw new Error("Direction cannot be null ! Expect an instance of Color.");if(ct(e))throw new Error("Direction cannot be undefined ! Expect an instance of Color.");if(!(e instanceof l))throw new Error(`Direction cannot be an instance of ${e.constructor.name}. Expect an instance of Vector3.`);if(this._direction=e,e.y>.99999)this.quaternion.set(0,0,0,1);else if(e.y<-.99999)this.quaternion.set(1,0,0,0);else{const t=new l(e.z,0,-e.x).normalize(),i=Math.acos(e.y);this.quaternion.setFromAxisAngle(t,i)}}update(e){super.update(e);this._direction.dot(e)>=0&&this.flipDirection(),this.updateMatrix(),this.hitbox.updateMatrix()}setDirection(e){return this.direction=e,this}flipDirection(){this.direction=this._direction.negate()}}
/**
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 */class ei extends p{constructor(e={}){const t={debug:!1,planeSize:50,...e};super(t),this.isGizmo=!0,this.type="AbstractGizmo",this.matrixAutoUpdate=!0,this.debug=t.debug;const i=new A(t.planeSize,t.planeSize,2,2),r=new m({side:f,visible:this.debug,transparent:!0,opacity:.33,color:1193046});this.intersectPlane=new b(i,r),this.intersectPlane.name="IntersectPlane",this.intersectPlane.matrixAutoUpdate=!0,this.intersectPlane.visible=!0,this.add(this.intersectPlane)}_setupHandles(e){const t=this;for(let i in e){const r=e[i];if(_t(r))r.name=i,r.renderOrder=1/0,r.updateMatrix(),t.add(r);else for(let s=r.length;s--;){const r=e[i][s][0],n=e[i][s][1],a=e[i][s][2],o=e[i][s][3],h=e[i][s][4];r.name=i,r.tag=h,r.renderOrder=1/0,n&&r.position.set(n[0],n[1],n[2]),a&&r.rotation.set(a[0],a[1],a[2]),o&&r.scale.set(o[0],o[1],o[2]),r.updateMatrix();const l=r.geometry.clone();l.applyMatrix4(r.matrix),r.geometry=l,r.position.set(0,0,0),r.rotation.set(0,0,0),r.scale.set(1,1,1),t.add(r)}}}highlight(e){for(let e in this.handleGizmos)this.handleGizmos[e].highlight(!1);const t=this.handleGizmos[e];t&&t.highlight(!0)}update(e,t){this.traverse(e=>{e.isHandle&&e.update(t)}),this.updateIntersectPlane(e)}updateIntersectPlane(e){this.intersectPlane.lookAt(e),this.intersectPlane.updateMatrix()}}
/**
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 */class ti extends ei{constructor(){super(),this.isScaleGizmo=!0,this.type="ScaleGizmo",this.handleGizmos={XYZ:new Wt({color:11184810}).setScale(.15,.15,.15),XY:new $t({color:11184640,direction:new l(1,1,0)}).setScale(.33,.33,1),YZ:new $t({color:43690,direction:new l(0,1,1)}).setScale(.33,.33,1).setRotationFromAxisAndAngle(new l(0,1,0),ot(-90)),XZ:new $t({color:11141290,direction:new l(1,0,1)}).setScale(.33,.33,1).setRotationFromAxisAndAngle(new l(1,0,0),ot(90)),X:new Jt({color:11141120,direction:new l(1,0,0)}),Y:new Jt({color:43520,direction:new l(0,1,0)}),Z:new Jt({color:170,direction:new l(0,0,1)})},this._setupHandles(this.handleGizmos)}raycast(e,t){if(e.intersectObject(this.intersectPlane,!0).length>0)for(let i of this.children)i.name!==this.intersectPlane.name&&i.raycast(e,t)}}
/**
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 */class ii extends Xt{constructor(e={}){const t=new E([0,0,0,.85,0,0,1.1,1.1,0,0,.85,0],3),i=new n;i.setAttribute("position",t),i.setIndex([0,1,2,2,3,0]);super({geometry:i,...e}),this.isPlanarHitbox=!0,this.type="PlanarHitbox"}}
/**
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 */class ri extends Vt{constructor(e={}){const t={color:16777215,hitbox:new ii,direction:new l(1,1,0),...e};super(t),this.isPlaneHandle=!0,this.type="PlaneHandle";const i=new n;i.setAttribute("position",new E([.1,.75,0,1,1,0,.75,.1,0],3));const r=new jt({color:t.color}),s=new P(i,r);s.matrixAutoUpdate=!1,this.add(s);const a=new n;a.setAttribute("position",new E([.1,.1,0,.75,.1,0,1,1,0,.1,.75,0],3)),a.setIndex([0,1,2,2,3,0]);const o=new Yt({color:t.color,transparent:!0,opacity:.35}),h=new b(a,o);h.matrixAutoUpdate=!1,this.add(h),this.direction=t.direction,this.xDirection=new l(t.direction.x,0,0),this.yDirection=new l(0,t.direction.y,0),this.zDirection=new l(0,0,t.direction.z),this.xAxis=new l(1,0,0),this.yAxis=new l(0,1,0),this.zAxis=new l(0,0,1)}get direction(){return this._direction}set direction(e){if(lt(e))throw new Error("Direction cannot be null ! Expect an instance of Color.");if(ct(e))throw new Error("Direction cannot be undefined ! Expect an instance of Color.");if(!(e instanceof l))throw new Error(`Direction cannot be an instance of ${e.constructor.name}. Expect an instance of Vector3.`);this._direction=e}update(e){super.update(e);const t=this.xDirection.dot(e),i=this.yDirection.dot(e),r=this.zDirection.dot(e);this.quaternion.copy(this.baseQuaternion),t>0&&i>0&&0===r?this.rotateOnAxis(this.zAxis,ot(180)):t>0&&i<0&&0===r?this.rotateOnAxis(this.zAxis,ot(90)):t<0&&i>0&&0===r?this.rotateOnAxis(this.zAxis,ot(270)):t<0&&i<0&&0===r?this.rotateOnAxis(this.zAxis,ot(0)):t>0&&0===i&&r>0?this.rotateOnAxis(this.zAxis,ot(180)):t>0&&0===i&&r<0?this.rotateOnAxis(this.zAxis,ot(90)):t<0&&0===i&&r>0?this.rotateOnAxis(this.zAxis,ot(270)):t<0&&0===i&&r<0?this.rotateOnAxis(this.zAxis,ot(0)):0===t&&i>0&&r>0?this.rotateOnAxis(this.zAxis,ot(180)):0===t&&i>0&&r<0?this.rotateOnAxis(this.zAxis,ot(270)):0===t&&i<0&&r>0?this.rotateOnAxis(this.zAxis,ot(90)):0===t&&i<0&&r<0&&this.rotateOnAxis(this.zAxis,ot(0)),this.updateMatrix(),this.hitbox.updateMatrix()}setDirection(e){return this.direction=e,this}flipXAxis(){const e=this._direction.clone();e.x=-e.x,this.direction=e}flipYAxis(){const e=this._direction.clone();e.y=-e.y,this.direction=e}flipZAxis(){const e=this._direction.clone();e.z=-e.z,this.direction=e}}
/**
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 */class si extends Vt{constructor(e={}){const t={color:16777215,hitbox:new Qt,direction:new l(0,1,0),...e};super(t),this.isTranslateHandle=!0,this.type="TranslateHandle";const i=new qt(new l(0,0,0),new l(0,.8,0)),r=new jt({color:t.color}),s=new P(i,r);s.matrixAutoUpdate=!1,this.add(s);const n=new O(.05,.2,12,1,!1);n.translate(0,.9,0);const a=new Yt({color:t.color}),o=new b(n,a);o.matrixAutoUpdate=!1,this.add(o),this.direction=t.direction}get direction(){return this._direction}set direction(e){if(lt(e))throw new Error("Direction cannot be null ! Expect an instance of Color.");if(ct(e))throw new Error("Direction cannot be undefined ! Expect an instance of Color.");if(!(e instanceof l))throw new Error(`Direction cannot be an instance of ${e.constructor.name}. Expect an instance of Vector3.`);if(this._direction=e,e.y>.99999)this.quaternion.set(0,0,0,1);else if(e.y<-.99999)this.quaternion.set(1,0,0,0);else{const t=new l(e.z,0,-e.x).normalize(),i=Math.acos(e.y);this.quaternion.setFromAxisAngle(t,i)}}update(e){super.update(e);this._direction.dot(e)>=0&&this.flipDirection(),this.updateMatrix(),this.hitbox.updateMatrix()}setDirection(e){return this.direction=e,this}flipDirection(){this.direction=this._direction.negate()}}
/**
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 */class ni extends ei{constructor(){super(),this.isTranslateGizmo=!0,this.type="TranslateGizmo",this.handleGizmos={X:new si({color:11141120,direction:new l(1,0,0)}),Y:new si({color:43520,direction:new l(0,1,0)}),Z:new si({color:170,direction:new l(0,0,1)}),XY:new ri({color:11184640,direction:new l(1,1,0)}).setScale(.33,.33,1),YZ:new ri({color:43690,direction:new l(0,1,1)}).setScale(.33,.33,1).setRotationFromAxisAndAngle(new l(0,1,0),ot(-90)),XZ:new ri({color:11141290,direction:new l(1,0,1)}).setScale(.33,.33,1).setRotationFromAxisAndAngle(new l(1,0,0),ot(90)),XYZ:new Wt({color:11184810}).setScale(.15,.15,.15)},this._setupHandles(this.handleGizmos)}raycast(e,t){if(e.intersectObject(this.intersectPlane,!0).length>0)for(let i of this.children)i.name!==this.intersectPlane.name&&i.raycast(e,t)}}
/**
 * @module Controllers/ClippingController
 *
 * @author [Ahmed DCHAR]{@link https://github.com/Dragoneel}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 *
 * @example Todo
 *
 */class ai extends x{constructor(){super(),this.margin=.01,this.geometry=new v(new S(2,2,2)),this.material=new g({color:16777215}),this.matrixAutoUpdate=!1,this.normalPlanes={normalRightSide:new l(-1,0,0),normalLeftSide:new l(1,0,0),normalFrontSide:new l(0,-1,0),normalBackSide:new l(0,1,0),normalTopSide:new l(0,0,-1),normalBottomSide:new l(0,0,1)},this.planes={rightSidePlane:new D(this.normalPlanes.normalRightSide.clone(),0),leftSidePlane:new D(this.normalPlanes.normalLeftSide.clone(),0),frontSidePlane:new D(this.normalPlanes.normalFrontSide.clone(),0),backSidePlane:new D(this.normalPlanes.normalBackSide.clone(),0),topSidePlane:new D(this.normalPlanes.normalTopSide.clone(),0),bottomSidePlane:new D(this.normalPlanes.normalBottomSide.clone(),0)},this._boundingBox=new i}getBoundingSphere(){return this.geometry.computeBoundingSphere(),this.geometry.boundingSphere.applyMatrix4(this.matrixWorld),this.geometry.boundingSphere}setColor(e){this.material.color.set(e)}applyClippingTo(e,t){if(ut(t))return;let i=[];for(let e in this.planes)i.push(this.planes[e]);t.traverse(t=>{if(ut(t))return;if(ut(t.geometry))return;if(ut(t.material))return;const r=gt(t.material)?t.material:[t.material];for(let t=0,s=r.length;t<s;t++){let s=r[t];s.clippingPlanes||(s.clippingPlanes=[]),s.clippingPlanes=e?i:[]}})}updateSize(e){this.scale.set(e.x,e.y,e.z)}update(){this._boundingBox.setFromObject(this);const e=this.margin,t=this._boundingBox.min,i=this._boundingBox.max;this.planes.rightSidePlane.constant=i.x+e,this.planes.leftSidePlane.constant=-t.x+e,this.planes.frontSidePlane.constant=i.y+e,this.planes.backSidePlane.constant=-t.y+e,this.planes.topSidePlane.constant=i.z+e,this.planes.bottomSidePlane.constant=-t.z+e}}const oi=st({None:"None",Translate:"Translate",Rotate:"Rotate",Scale:"Scale"});class hi extends p{constructor(e={}){const t={camera:null,domElement:window,mode:oi.None,objectsToClip:new p,...e};super(),this._handlers={onMouseEnter:this._onMouseEnter.bind(this),onMouseLeave:this._onMouseLeave.bind(this),onMouseDown:this._onMouseDown.bind(this),onMouseMove:this._onMouseMove.bind(this),onMouseWheel:this._onMouseWheel.bind(this),onMouseUp:this._onMouseUp.bind(this),onDblClick:this._onDblClick.bind(this),onTouchStart:this._onTouchStart.bind(this),onTouchEnd:this._onTouchEnd.bind(this),onTouchCancel:this._onTouchCancel.bind(this),onTouchLeave:this._onTouchLeave.bind(this),onTouchMove:this._onTouchMove.bind(this),onKeyDown:this._onKeyDown.bind(this),onKeyUp:this._onKeyUp.bind(this)},this._events={impose:{type:"impose"},dispose:{type:"dispose"},change:{type:"change"},translate:{type:"translate"},rotate:{type:"rotate"},scale:{type:"scale"},mouseEnter:{type:"mouseEnter"},mouseLeave:{type:"mouseLeave"},mouseDown:{type:"mouseDown"},mouseUp:{type:"mouseUp"}},this._objectsToClipBoundingBox=new i,this._objectsToClipSize=new l,this._objectsToClipCenter=new l,this._clippingBox=new ai,this.add(this._clippingBox),this.camera=t.camera,this.domElement=t.domElement,this.mode=t.mode,this.objectsToClip=t.objectsToClip,this.translationSnap=.1,this.scaleSnap=.1,this.rotationSnap=.1,this.matrixAutoUpdate=!1,this.enabled=!1,this.size=1,this._dragging=!1,this._firstPoint=new l,this._secondPoint=new l,this._mouseDisplacement=new l,this._offset=new l,this._raycaster=new T,this._pointerVector=new u,this._directionToMouse=new l,this._cameraPosition=new l,this._cameraDirection=new l,this._worldPosition=new l,this._worldRotation=new I,this._gizmos={Translate:new ni,Scale:new ti};for(let e in this._gizmos)this.add(this._gizmos[e]);this._currentGizmo=null,this._currentHandle=null,this.actionsMap={setMode:{translate:[tt.T.value],rotate:[tt.R.value],scale:[tt.S.value]},translate:{front:[tt.Z.value,tt.UP_ARROW.value],back:[tt.S.value,tt.DOWN_ARROW.value],up:[tt.A.value,tt.PAGE_UP.value],down:[tt.E.value,tt.PAGE_DOWN.value],left:[tt.Q.value,tt.LEFT_ARROW.value],right:[tt.D.value,tt.RIGHT_ARROW.value]},scale:{widthPlus:[tt.LEFT_ARROW.value],widthMinus:[tt.RIGHT_ARROW.value],heightPlus:[tt.PAGE_UP.value],heightMinus:[tt.PAGE_DOWN.value],depthPlus:[tt.UP_ARROW.value],depthMinus:[tt.DOWN_ARROW.value]},rotate:{xAxis:[tt.X.value],yAxis:[tt.Y.value],zAxis:[tt.Z.value]}}}get objectsToClip(){return this._objectsToClip}set objectsToClip(e){if(lt(e))throw new Error("Objects to clip cannot be null ! Expect an instance of Object3D");if(ct(e))throw new Error("Objects to clip cannot be undefined ! Expect an instance of Object3D");if(!(e instanceof p))throw new Error(`Objects to clip cannot be an instance of ${e.constructor.name}. Expect an instance of Object3D.`);this._objectsToClip=e,this.updateClipping()}get camera(){return this._camera}set camera(e){if(lt(e))throw new Error("Camera cannot be null ! Expect an instance of Camera");if(ct(e))throw new Error("Camera cannot be undefined ! Expect an instance of Camera");if(!e.isCamera&&!e.isPerspectiveCamera&&!e.isOrthographicCamera)throw new Error(`Camera cannot be an instance of ${e.constructor.name}. Expect an instance of Camera, PerspectiveCamera, or OrthographicCamera.`);this._camera=e}get domElement(){return this._domElement}set domElement(e){if(lt(e))throw new Error("DomElement cannot be null ! Expect an instance of Window, HTMLDocument, HTMLDivElement or HTMLCanvasElement.");if(ct(e))throw new Error("DomElement cannot be undefined ! Expect an instance of Window, HTMLDocument, HTMLDivElement or HTMLCanvasElement.");if(!(e instanceof Window||e instanceof HTMLDocument||e instanceof HTMLDivElement||e instanceof HTMLCanvasElement))throw new Error(`Target cannot be an instance of ${e.constructor.name}. Expect an instance of Window, HTMLDocument, HTMLDivElement or HTMLCanvasElement.`);this._domElement&&(this._domElement.removeEventListener("mouseenter",this._handlers.onMouseEnter,!1),this._domElement.removeEventListener("mouseleave",this._handlers.onMouseLeave,!1),this.dispose()),this._domElement=e,this._domElement.addEventListener("mouseenter",this._handlers.onMouseEnter,!1),this._domElement.addEventListener("mouseleave",this._handlers.onMouseLeave,!1),this.impose()}get mode(){return this._mode}set mode(e){if(lt(e))throw new Error("Mode cannot be null ! Expect a value from ClippingModes enum.");if(ct(e))throw new Error("Mode cannot be undefined ! Expect a value from ClippingModes enum.");this._mode=e;for(let e in this._gizmos)this._gizmos[e].visible=!1;this._mode===oi.None?this._currentGizmo=null:(this._currentGizmo=this._gizmos[this._mode],this._currentGizmo.visible=!0),this.updateGizmo()}setCamera(e){return this.camera=e,this}setDomElement(e){return this.domElement=e,this}setMode(e){return this.mode=e,this}setObjectsToClip(e){return this.objectsToClip=e,this}impose(){this._domElement.addEventListener("keydown",this._handlers.onKeyDown,!1),this._domElement.addEventListener("keyup",this._handlers.onKeyUp,!1),this._domElement.addEventListener("dblclick",this._handlers.onDblClick,!1),this._domElement.addEventListener("mousedown",this._handlers.onMouseDown,!1),this._domElement.addEventListener("mousemove",this._handlers.onMouseMove,!1),this._domElement.addEventListener("mouseup",this._handlers.onMouseUp,!1),this._domElement.addEventListener("wheel",this._handlers.onMouseWheel,{capture:!0,once:!1,passive:!1}),this._domElement.addEventListener("touchcancel",this._handlers.onTouchCancel,!1),this._domElement.addEventListener("touchend",this._handlers.onTouchEnd,!1),this._domElement.addEventListener("touchleave",this._handlers.onTouchLeave,!1),this._domElement.addEventListener("touchmove",this._handlers.onTouchMove,{capture:!0,once:!1,passive:!1}),this._domElement.addEventListener("touchstart",this._handlers.onTouchStart,{capture:!0,once:!1,passive:!1}),this.dispatchEvent(this._events.impose)}dispose(){this._domElement.removeEventListener("keydown",this._handlers.onKeyDown,!1),this._domElement.removeEventListener("keyup",this._handlers.onKeyUp,!1),this._domElement.removeEventListener("dblclick",this._handlers.onDblClick,!1),this._domElement.removeEventListener("mousedown",this._handlers.onMouseDown,!1),this._domElement.removeEventListener("mousemove",this._handlers.onMouseMove,!1),this._domElement.removeEventListener("mouseup",this._handlers.onMouseUp,!1),this._domElement.removeEventListener("wheel",this._handlers.onMouseWheel,{capture:!0,once:!1,passive:!1}),this._domElement.removeEventListener("touchcancel",this._handlers.onTouchCancel,!1),this._domElement.removeEventListener("touchend",this._handlers.onTouchEnd,!1),this._domElement.removeEventListener("touchleave",this._handlers.onTouchLeave,!1),this._domElement.removeEventListener("touchmove",this._handlers.onTouchMove,{capture:!0,once:!1,passive:!1}),this._domElement.removeEventListener("touchstart",this._handlers.onTouchStart,{capture:!0,once:!1,passive:!1}),this.dispatchEvent(this._events.dispose)}setTranslationSnap(e){this.translationSnap=e}setRotationSnap(e){this.rotationSnap=e}enable(){this.visible=!0,this.enabled=!0,ht(this._objectsToClip)&&(this._objectsToClipBoundingBox.setFromObject(this._objectsToClip),this._objectsToClipBoundingBox.getSize(this._objectsToClipSize),this._objectsToClipSize.divideScalar(2),this.scale.set(this._objectsToClipSize.x,this._objectsToClipSize.y,this._objectsToClipSize.z),this._objectsToClipBoundingBox.getCenter(this._objectsToClipCenter),this.position.set(this._objectsToClipCenter.x,this._objectsToClipCenter.y,this._objectsToClipCenter.z),this.updateMatrix(),this.updateMatrixWorld()),this.updateClipping(),this.updateGizmo()}disable(){this.visible=!1,this.enabled=!1,this.updateClipping()}updateClipping(){ut(this._objectsToClip)||(this._clippingBox.update(),this._clippingBox.applyClippingTo(this.enabled,this._objectsToClip))}updateGizmo(){this.enabled&&this._mode!==oi.None&&(ut(this._currentGizmo)||(this._camera.getWorldPosition(this._cameraPosition),this._camera.getWorldDirection(this._cameraDirection),this._currentGizmo.update(this._cameraPosition,this._cameraDirection)))}_consumeEvent(e){e.cancelable&&e.stopImmediatePropagation()}_onKeyDown(e){if(!this.enabled)return;e.preventDefault();const t=this.actionsMap,i=e.keyCode;if(e.ctrlKey)switch(this._mode){case oi.Translate:t.translate.front.includes(i)?(this._translateZ(this.translationSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.change)):t.translate.back.includes(i)?(this._translateZ(-this.translationSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.change)):t.translate.right.includes(i)?(this._translateX(this.translationSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.change)):t.translate.left.includes(i)?(this._translateX(-this.translationSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.change)):t.translate.up.includes(i)?(this._translateY(this.translationSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.change)):t.translate.down.includes(i)&&(this._translateY(-this.translationSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.change));break;case oi.Rotate:break;case oi.Scale:t.scale.depthPlus.includes(i)?(this._scaleZ(this.scaleSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.change)):t.scale.depthMinus.includes(i)?(this._scaleZ(-this.scaleSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.change)):t.scale.widthPlus.includes(i)?(this._scaleX(this.scaleSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.change)):t.scale.widthMinus.includes(i)?(this._scaleX(-this.scaleSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.change)):t.scale.heightPlus.includes(i)?(this._scaleY(this.scaleSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.change)):t.scale.heightMinus.includes(i)&&(this._scaleY(-this.scaleSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.change))}else t.setMode.translate.includes(i)?(this.setMode(oi.Translate),this.updateClipping(),this._consumeEvent(e)):t.setMode.rotate.includes(i)?(this.setMode(oi.Rotate),this.updateClipping(),this._consumeEvent(e)):t.setMode.scale.includes(i)&&(this.setMode(oi.Scale),this.updateClipping(),this._consumeEvent(e))}_onKeyUp(e){this.enabled&&!e.defaultPrevented&&e.preventDefault()}_onDblClick(e){this.enabled&&this._mode!==oi.None&&e.preventDefault()}_onMouseDown(e){if(!this.enabled)return;if(this._mode===oi.None)return;if(e.button!==it.Left.value)return;if(ut(this._currentHandle))return;e.preventDefault(),this._dragging=!0;const t=this.intersectObjects(e,[this._currentGizmo.intersectPlane]);t&&(this._firstPoint=t.point),this._consumeEvent(e),this.dispatchEvent(this._events.mouseDown)}_onMouseEnter(e){this.enabled&&this._mode!==oi.None&&(e.preventDefault(),this.impose(),e.target.constructor!==HTMLDocument&&this._domElement.focus())}_onMouseLeave(e){this.enabled&&this._mode!==oi.None&&(e.preventDefault(),this._dragging=!1,e.target.constructor!==HTMLDocument&&this._domElement.blur(),this.dispose())}_onMouseMove(e){if(this.enabled&&this._mode!==oi.None)if(e.preventDefault(),!1===this._dragging){const t=this.intersectObjects(e,[this._currentGizmo]);if(t){const i=t.object;this._currentHandle&&i!==this._currentHandle&&(this._currentHandle.highlight(!1),this.dispatchEvent(this._events.mouseLeave)),this._currentHandle=i,this._currentHandle.highlight(!0),this.dispatchEvent(this._events.mouseEnter),this._consumeEvent(e)}else ht(this._currentHandle)&&(this._currentHandle.highlight(!1),this._currentHandle=null,this.dispatchEvent(this._events.mouseLeave))}else{const t=this._currentHandle,i=t.name,r=this.intersectObjects(e,[this._currentGizmo.intersectPlane]);switch(r&&(this._secondPoint=r.point),this._mouseDisplacement.subVectors(this._secondPoint,this._firstPoint),this._firstPoint.copy(this._secondPoint),this._mode){case oi.Translate:"X"===i?this._offset.set(1,0,0):"Y"===i?this._offset.set(0,1,0):"Z"===i?this._offset.set(0,0,1):"XY"===i?this._offset.set(1,1,0):"YZ"===i?this._offset.set(0,1,1):"XZ"===i?this._offset.set(1,0,1):"XYZ"===i&&this._offset.set(1,1,1),this._offset.multiply(this._mouseDisplacement),this._translate(this._offset);break;case oi.Rotate:break;case oi.Scale:if(t.isScaleHandle)this._offset.copy(this._currentHandle.direction).multiply(this._mouseDisplacement);else if(t.isPlaneHandle){const e=this._currentHandle.xDirection.dot(this._mouseDisplacement);e>0?this._offset.setX(Math.abs(this._mouseDisplacement.x)):e<0?this._offset.setX(-Math.abs(this._mouseDisplacement.x)):this._offset.setX(0);const t=this._currentHandle.yDirection.dot(this._mouseDisplacement);t>0?this._offset.setY(Math.abs(this._mouseDisplacement.y)):t<0?this._offset.setY(-Math.abs(this._mouseDisplacement.y)):this._offset.setY(0);const i=this._currentHandle.zDirection.dot(this._mouseDisplacement);i>0?this._offset.setZ(Math.abs(this._mouseDisplacement.z)):i<0?this._offset.setZ(-Math.abs(this._mouseDisplacement.z)):this._offset.setZ(0)}else if(t.isOmnidirectionalHandle){this.getWorldPosition(this._worldPosition),this._directionToMouse.subVectors(this._firstPoint,this._worldPosition);const e=this._directionToMouse.dot(this._mouseDisplacement)>0?this._mouseDisplacement.length():-this._mouseDisplacement.length();this._offset.set(e,e,e)}this._scale(this._offset);break;default:throw new RangeError(`Invalid switch parameter: ${this._mode}`)}this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.change)}}_onMouseUp(e){if(!this.enabled)return;if(this._mode===oi.None)return;if(e.button!==it.Left.value)return;e.preventDefault(),this._dragging=!1,this.dispatchEvent(this._events.mouseUp);const t=this.intersectObjects(e,[this._currentGizmo]);t?(this._currentHandle=t.object,this._currentHandle.highlight(!0),this._consumeEvent(e),this.dispatchEvent(this._events.mouseEnter)):ht(this._currentHandle)&&(this._currentHandle.highlight(!1),this._currentHandle=null,this.dispatchEvent(this._events.mouseLeave)),this.updateGizmo()}_onMouseWheel(e){this.enabled&&e.preventDefault()}_onTouchCancel(e){this.enabled&&e.preventDefault()}_onTouchEnd(e){this.enabled&&e.preventDefault()}_onTouchLeave(e){this.enabled&&e.preventDefault()}_onTouchMove(e){this.enabled&&e.preventDefault()}_onTouchStart(e){this.enabled&&e.preventDefault()}getActiveHandle(e){}intersectObjects(e,t){const i=this._domElement.getBoundingClientRect(),r=(e.clientX-i.left)/i.width*2-1,s=-(e.clientY-i.top)/i.height*2+1;this._pointerVector.set(r,s),this._raycaster.setFromCamera(this._pointerVector,this._camera);const n=this._raycaster.intersectObjects(t,!1);return n[0]?n[0]:null}_translate(e){this.position.add(e),this.updateMatrix()}_translateX(e){this.position.setX(this.position.x+e),this.updateMatrix()}_translateY(e){this.position.setY(this.position.y+e),this.updateMatrix()}_translateZ(e){this.position.setZ(this.position.z+e),this.updateMatrix()}_translateXY(e,t){this.position.setX(this.position.x+e),this.position.setY(this.position.y+t),this.updateMatrix()}_translateXZ(e,t){this.position.setX(this.position.x+e),this.position.setZ(this.position.z+t),this.updateMatrix()}_translateYZ(e,t){this.position.setY(this.position.y+e),this.position.setZ(this.position.z+t),this.updateMatrix()}_translateXYZ(e,t,i){this.position.set(this.position.x+e,this.position.y+t,this.position.z+i),this.updateMatrix()}_rotateX(e){}_rotateY(e){}_rotateZ(e){}_rotateXY(e){}_rotateXZ(e){}_rotateYZ(e){}_rotateXYZ(e){}_scale(e){this.scale.add(e),this.updateMatrix()}_scaleX(e){this.scale.setX(this.scale.x+e),this.updateMatrix()}_scaleY(e){this.scale.setY(this.scale.y+e),this.updateMatrix()}_scaleZ(e){this.scale.setZ(this.scale.z+e),this.updateMatrix()}_scaleXY(e,t){this.scale.setX(this.scale.x+e),this.scale.setY(this.scale.y+t),this.updateMatrix()}_scaleXZ(e,t){this.scale.setX(this.scale.x+e),this.scale.setZ(this.scale.z+t),this.updateMatrix()}_scaleYZ(e,t){this.scale.setY(this.scale.y+e),this.scale.setZ(this.scale.z+t),this.updateMatrix()}_scaleXYZ(e,t,i){this.scale.set(this.scale.x+e,this.scale.y+t,this.scale.z+i),this.updateMatrix()}}
/**
 * @module Managers/CurvesManager
 *
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 *
 * @example Todo
 *
 */class li extends rt{constructor(e={}){super({basePath:"/curves",...e})}convert(e){if(!e)throw new Error("CurvesManager: Unable to convert null or undefined data !");const t=e.type;let i;switch(t){case"ArcCurve":i=new X;break;case"CatmullRomCurve3":i=new Y;break;case"CubicBezierCurve":i=new j;break;case"CubicBezierCurve3":i=new N;break;case"Curve":i=new H;break;case"CurvePath":i=new G;break;case"EllipseCurve":i=new z;break;case"LineCurve":i=new L;break;case"LineCurve3":i=new R;break;case"Path":i=new k;break;case"QuadraticBezierCurve":i=new U;break;case"QuadraticBezierCurve3":i=new C;break;case"SplineCurve":i=new B;break;case"Shape":i=new c;break;default:throw new Error(`TCurvesManager: Unknown curve of type: ${t}`)}return i.fromJSON(e),i}_onJson(e,t,i,r){const s=mt(e)?[e]:e,n={};for(let e,t=0,a=s.length;t<a;t++){e=s[t];try{n[e._id]=this.convert(e)}catch(e){r(e)}i(t/a)}t(n)}}
/**
 * @module Managers/GeometriesManager
 *
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 *
 * @requires {@link TDataBaseManager}
 * @requires '../../../node_modules/three/src/core/Geometry'
 * @requires { BufferGeometry } from 'three'
 * @requires '../../../node_modules/three/src/core/BufferAttribute'
 *
 */const ci=st({Int8Array:0,Uint8Array:1,Uint8ClampedArray:2,Int16Array:3,Uint16Array:4,Int32Array:5,Uint32Array:6,Float32Array:7,Float64Array:8});class di extends rt{constructor(e={}){const t={basePath:"/geometries",projectionSystem:"zBack",globalScale:1,computeNormals:!0,computeBoundingBox:!0,computeBoundingSphere:!0,...e};super(t),this.projectionSystem=t.projectionSystem,this.globalScale=t.globalScale,this.computeNormals=t.computeNormals,this.computeBoundingBox=t.computeBoundingBox,this.computeBoundingSphere=t.computeBoundingSphere}get computeBoundingBox(){return this._computeBoundingBox}set computeBoundingBox(e){if(lt(e))throw new TypeError("Compute bounding box cannot be null ! Expect a boolean.");if(ct(e))throw new TypeError("Compute bounding box cannot be undefined ! Expect a boolean.");if(dt(e))throw new TypeError(`Compute bounding box cannot be an instance of ${e.constructor.name} ! Expect a boolean.`);this._computeBoundingBox=e}get computeBoundingSphere(){return this._computeBoundingSphere}set computeBoundingSphere(e){if(lt(e))throw new TypeError("Compute bounding sphere cannot be null ! Expect a boolean.");if(ct(e))throw new TypeError("Compute bounding sphere cannot be undefined ! Expect a boolean.");if(dt(e))throw new TypeError(`Compute bounding sphere cannot be an instance of ${e.constructor.name} ! Expect a boolean.`);this._computeBoundingSphere=e}get computeNormals(){return this._computeNormals}set computeNormals(e){if(lt(e))throw new TypeError("Compute normals cannot be null ! Expect a boolean.");if(ct(e))throw new TypeError("Compute normals cannot be undefined ! Expect a boolean.");if(dt(e))throw new TypeError(`Compute normals cannot be an instance of ${e.constructor.name} ! Expect a boolean.`);this._computeNormals=e}get projectionSystem(){return this._projectionSystem}set projectionSystem(e){if(lt(e))throw new TypeError("Projection system cannot be null ! Expect a positive number.");if(ct(e))throw new TypeError("Projection system cannot be undefined ! Expect a positive number.");this._projectionSystem=e}get globalScale(){return this._globalScale}set globalScale(e){if(lt(e))throw new TypeError("Global scale cannot be null ! Expect a positive number.");if(ct(e))throw new TypeError("Global scale cannot be undefined ! Expect a positive number.");this._globalScale=e}setComputeBoundingBox(e){return this.computeBoundingBox=e,this}setComputeBoundingShpere(e){return this.computeBoundingSphere=e,this}setComputeNormals(e){return this.computeNormals=e,this}setProjectionSystem(e){return this.projectionSystem=e,this}setGlobalScale(e){return this.globalScale=e,this}_onJson(e,t,i,r){const s=mt(e)?[e]:e,n={};for(let e,t=0,a=s.length;t<a;t++){e=s[t];try{n[e._id]=this.convert(e)}catch(e){r(e)}i(new ProgressEvent("GeometriesManager",{lengthComputable:!0,loaded:t+1,total:a}))}t(n)}convert(e){if(!e)throw new Error("GeometriesManager: Unable to convert null or undefined data !");const t=e.type;if(!t)throw new Error("GeometriesManager: Unable to convert untyped data !");let i=null;if(e.isBufferGeometry||t.includes("BufferGeometry"))i=this._convertJsonToBufferGeometry(e),this._computeNormals&&i.computeVertexNormals();else{if(!e.isGeometry&&!t.includes("Geometry"))throw new Error(`TGeometriesManager: Unable to retrieve geometry of type ${t} !`);i=this._convertJsonToGeometry(e),this._computeNormals&&i.computeFaceNormals()}return this.computeBoundingBox&&(i.boundingBox=null,i.computeBoundingBox()),this.computeBoundingSphere&&(i.boundingSphere=null,i.computeBoundingSphere()),i}_convertJsonToGeometry(e){const t=e.types;let i=null;switch(t){case"BoxGeometry":i=new ue;break;case"CircleGeometry":i=new pe;break;case"CylinderGeometry":i=new de;break;case"ConeGeometry":i=new ce;break;case"EdgesGeometry":i=new v;break;case"DodecahedronGeometry":i=new le;break;case"ExtrudeGeometry":i=new he;break;case"Geometry":i=new oe;break;case"IcosahedronGeometry":i=new ae;break;case"LatheGeometry":i=new ne;break;case"OctahedronGeometry":i=new se;break;case"ParametricGeometry":i=new re;break;case"PlaneGeometry":i=new ie;break;case"PolyhedronGeometry":i=new te;break;case"RingGeometry":i=new ee;break;case"ShapeGeometry":i=new J;break;case"TetrahedronGeometry":i=new Q;break;case"TextGeometry":i=new q;break;case"TorusGeometry":i=new $;break;case"TorusKnotGeometry":i=new K;break;case"TubeGeometry":i=new W;break;case"SphereGeometry":i=new V;break;case"WireframeGeometry":i=new Z;break;default:throw new Error(`TGeometriesManager: Unknown geometry of type: ${t}`)}i.uuid=e.uuid,i.name=e.name,i.type=e.type;for(var r=[],s=void 0,n=0,a=e.vertices.length;n<a;++n)s=e.vertices[n],r.push(new l(s.x,s.y,s.z));i.vertices=r;for(var o=[],h=void 0,c=0,d=e.faces.length;c<d;c++)h=e.faces[c],o.push(new _e(h.a,h.b,h.c,h.normal,h.color,h.materialIndex));i.faces=o,i.morphTargets=[],i.morphNormals=[],i.skinWeights=[],i.skinIndices=[],i.lineDistances=[],i.elementsNeedUpdate=!0,i.verticesNeedUpdate=!0,i.uvsNeedUpdate=!0,i.normalsNeedUpdate=!0,i.colorsNeedUpdate=!0,i.lineDistancesNeedUpdate=!0,i.groupsNeedUpdate=!0}_convertJsonToBufferGeometry(e){const t=e.type;let i=null;switch(t){case"BoxBufferGeometry":i=new S;break;case"BufferGeometry":case"ShapeBufferGeometry":i=new n;break;case"CircleBufferGeometry":i=new Oe;break;case"CylinderBufferGeometry":i=new F;break;case"ConeBufferGeometry":i=new O;break;case"DodecahedronBufferGeometry":i=new Ae;break;case"ExtrudeBufferGeometry":i=new Se;break;case"IcosahedronBufferGeometry":i=new Fe;break;case"LatheBufferGeometry":i=new Me;break;case"OctahedronBufferGeometry":i=new w;break;case"ParametricBufferGeometry":i=new Pe;break;case"PlaneBufferGeometry":i=new A;break;case"PolyhedronBufferGeometry":i=new Ee;break;case"RingBufferGeometry":i=new xe;break;case"TetrahedronBufferGeometry":i=new ve;break;case"TextBufferGeometry":i=new ye;break;case"TorusBufferGeometry":i=new we;break;case"TorusKnotBufferGeometry":i=new be;break;case"TubeBufferGeometry":i=new fe;break;case"SphereBufferGeometry":i=new me;break;case"InstancedBufferGeometry":i=new ge;break;default:throw new Error(`TGeometriesManager: Unknown buffer geometry of type: ${t}`)}i._id=e._id,i.uuid=e.uuid,i.name=e.name;const r=e.index;if(r&&r.array&&r.array.length>0){const e=this.__convertBase64ToArrayBuffer(r.array),t=this.__convertArrayBufferToTypedArray(e);i.index=new a(t,r.itemSize,r.normalized)}const s=e.attributes;if(s){let e={};const t=s.position;if(t){const i=this.__convertBase64ToArrayBuffer(t.array),r=this.__convertArrayBufferToTypedArray(i),s=this.globalScale,n=new Float32Array(r);if("zBack"===this._projectionSystem){let e=null,t=null,i=null;for(let r=0,a=n.length;r<a;r+=3)e=n[r]/s,t=n[r+2]/s,i=-n[r+1]/s,n[r]=e,n[r+1]=t,n[r+2]=i}else for(let e=0,t=n.length;e<t;e++)n[e]/=s;e.position=new a(n,t.itemSize,t.normalized)}const r=s.normal;if(r){const t=this.__convertBase64ToArrayBuffer(r.array),i=this.__convertArrayBufferToTypedArray(t);e.normal=new a(i,r.itemSize,r.normalized)}const n=s.uv;if(n){const t=this.__convertBase64ToArrayBuffer(n.array),i=this.__convertArrayBufferToTypedArray(t);e.uv=new a(i,n.itemSize,n.normalized)}i.attributes=e}return ht(e.groups)&&(i.groups=e.groups),ht(e.boundingBox)&&(i.boundingBox=e.boundingBox),ht(e.boundingSphere)&&(i.boundingSphere=e.boundingSphere),"ShapeBufferGeometry"===t&&(i.shapes=e.shapes.map(e=>(new c).fromJSON(e)),i.curveSegments=e.curveSegments),i}__convertArrayBufferToTypedArray(e){const t=new DataView(e),i=e.byteLength-1,r=t.getUint8(0);let s=null;switch(r){case ci.Int8Array:s=new Int8Array(i/1);for(let e=0,r=1;r<i;e++,r+=1)s[e]=t.getInt8(r);break;case ci.Uint8Array:s=new Uint8Array(i/1);for(let e=0,r=1;r<i;e++,r+=1)s[e]=t.getUint8(r);break;case ci.Uint8ClampedArray:s=new Uint8ClampedArray(i/1);for(let e=0,r=1;r<i;e++,r+=1)s[e]=t.getUint8(r);break;case ci.Int16Array:s=new Int16Array(i/2);for(let e=0,r=1;r<i;e++,r+=2)s[e]=t.getInt16(r);break;case ci.Uint16Array:s=new Uint16Array(i/2);for(let e=0,r=1;r<i;e++,r+=2)s[e]=t.getUint16(r);break;case ci.Int32Array:s=new Int32Array(i/4);for(let e=0,r=1;r<i;e++,r+=4)s[e]=t.getInt32(r);break;case ci.Uint32Array:s=new Uint32Array(i/4);for(let e=0,r=1;r<i;e++,r+=4)s[e]=t.getUint32(r);break;case ci.Float32Array:s=new Float32Array(i/4);for(let e=0,r=1;r<i;e++,r+=4)s[e]=t.getFloat32(r);break;case ci.Float64Array:s=new Float64Array(i/8);for(let e=0,r=1;r<i;e++,r+=8)s[e]=t.getFloat64(r);break;default:throw new RangeError(`Invalid switch parameter: ${r}`)}return s}__convertBase64ToArrayBuffer(e){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=new Uint8Array(256);for(let e=0;e<64;e++)i[t.charCodeAt(e)]=e;const r=e.length;let s=.75*r;"="===e[r-1]&&(s--,"="===e[r-2]&&s--);let n,a,o,h,l=new ArrayBuffer(s),c=new Uint8Array(l);for(let t=0,s=0;t<r;t+=4)n=i[e.charCodeAt(t)],a=i[e.charCodeAt(t+1)],o=i[e.charCodeAt(t+2)],h=i[e.charCodeAt(t+3)],c[s++]=n<<2|a>>4,c[s++]=(15&a)<<4|o>>2,c[s++]=(3&o)<<6|63&h;return l}}
/**
 * @module Managers/TexturesManager
 *
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 */class pi extends rt{constructor(e={}){super({basePath:"/textures",...e})}convert(e){if(!e)throw new Error("TexturesManager: Unable to convert null or undefined data !");const t=e.type;throw new Error(`TTexturesManager: Unknown texture of type: ${t}`)}_onJson(e,t,i,r){const s=mt(e)?[e]:e,n={};for(let e,t=0,a=s.length;t<a;t++){e=s[t];try{n[e._id]=this.convert(e)}catch(e){r(e)}i(t/a)}t(n)}}
/**
 * @module Managers/MaterialsManager
 *
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 *
 * @requires TDataBaseManager
 *
 */const ui=(new Ce).load("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAACXBIWXMAAC4jAAAuIwF4pT92AAAAB3RJTUUH4gkKDRoGpGNegQAAABl0RVh0Q29tbWVudABDcmVhdGVkIHdpdGggR0lNUFeBDhcAAAAMSURBVAjXY/j//z8ABf4C/tzMWecAAAAASUVORK5CYII=");class _i extends rt{constructor(e={}){const t={basePath:"/materials",texturesPath:"/textures",texturesProviderOptions:{},generateMipmap:!1,autoFillTextures:!0,...e};super(t),this.texturesPath=t.texturesPath,this.generateMipmap=t.generateMipmap,this.autoFillTextures=t.autoFillTextures,this.texturesProvider=new De(t.texturesProviderOptions)}get texturesPath(){return this._texturesPath}set texturesPath(e){if(lt(e))throw new TypeError("Textures path cannot be null ! Expect a non empty string.");if(ct(e))throw new TypeError("Textures path cannot be undefined ! Expect a non empty string.");if(ft(e))throw new TypeError(`Textures path cannot be an instance of ${e.constructor.name} ! Expect a non empty string.`);if(bt(e))throw new TypeError("Textures path cannot be empty ! Expect a non empty string.");if(wt(e))throw new TypeError("Textures path cannot contain only whitespace ! Expect a non empty string.");this._texturesPath=e}get texturesProvider(){return this._texturesProvider}set texturesProvider(e){if(lt(e))throw new TypeError("Textures provider cannot be null ! Expect an instance of TextureLoader.");if(ct(e))throw new TypeError("Textures provider cannot be undefined ! Expect an instance of TextureLoader.");if(!(e instanceof pi||e instanceof De))throw new TypeError(`Textures provider cannot be an instance of ${e.constructor.name} ! Expect an instance of TTexturesManager.`);this._texturesProvider=e}get generateMipmap(){return this._generateMipmap}set generateMipmap(e){if(lt(e))throw new TypeError("Generate mipmap cannot be null ! Expect a boolean.");if(ct(e))throw new TypeError("Generate mipmap cannot be undefined ! Expect a boolean.");if(dt(e))throw new TypeError(`Generate mipmap cannot be an instance of ${e.constructor.name} ! Expect a boolean.`);this._generateMipmap=e}get autoFillTextures(){return this._autoFillTextures}set autoFillTextures(e){if(lt(e))throw new TypeError("Global scale cannot be null ! Expect a boolean.");if(ct(e))throw new TypeError("Global scale cannot be undefined ! Expect a positive number.");if(dt(e))throw new TypeError("Global scale cannot be null ! Expect a boolean.");this._autoFillTextures=e}setTexturesPath(e){return this.texturesPath=e,this}setTexturesProvider(e){return this.texturesProvider=e,this}setGenerateMipmap(e){return this.generateMipmap=e,this}setAutoFillTextures(e){return this.autoFillTextures=e,this}_onJson(e,t,i,r){const s=mt(e)?[e]:e,n={};for(let e,t=0,a=s.length;t<a;t++){e=s[t];try{n[e._id]=this.convert(e)}catch(e){r(e)}i(new ProgressEvent("MaterialsManager",{lengthComputable:!0,loaded:t+1,total:a}))}this._autoFillTextures?this.fillTextures(n,t,i,r):t(n)}convert(e){if(!e)throw new Error("MaterialsManager: Unable to convert null or undefined data !");const t=e.type;let i=null;switch(t){case"MeshPhongMaterial":{i=new Ie,this._fillBaseMaterialData(i,e);const t=e.color;ht(t)&&(i.color=this._setColor(t));const r=e.specular;ht(r)&&(i.specular=this._setColor(r));const s=e.shininess;ht(s)&&(i.shininess=s);const n=e.map;ht(n)&&(i.map=n);const a=e.lightMap;ht(a)&&(i.lightMap=a);const o=e.lightMapIntensity;ht(o)&&(i.lightMapIntensity=o);const h=e.aoMap;ht(h)&&(i.aoMap=h);const l=e.aoMapIntensity;ht(l)&&(i.aoMapIntensity=l);const c=e.emissive;ht(c)&&(i.emissive=this._setColor(c));const d=e.emissiveIntensity;ht(d)&&(i.emissiveIntensity=d);const p=e.emissiveMap;ht(p)&&(i.emissiveMap=p);const u=e.bumpMap;ht(u)&&(i.bumpMap=u);const _=e.bumpScale;ht(_)&&(i.bumpScale=_);const g=e.normalMap;ht(g)&&(i.normalMap=g);const m=e.normalScale;ht(m)&&(i.normalScale=this._setVector2(m));const f=e.displacementMap;ht(f)&&(i.displacementMap=f);const b=e.displacementScale;ht(b)&&(i.displacementScale=b);const w=e.displacementBias;ht(w)&&(i.displacementBias=w);const y=e.specularMap;ht(y)&&(i.specularMap=y);const v=e.alphaMap;ht(v)&&(i.alphaMap=v);const x=e.envMap;ht(x)&&(i.envMap=x);const E=e.combine;ht(E)&&(i.combine=E);const P=e.reflectivity;ht(P)&&(i.reflectivity=P);const M=e.refractionRatio;ht(M)&&(i.refractionRatio=M);const F=e.wireframe;ht(F)&&(i.wireframe=F);const S=e.wireframeLinewidth;ht(S)&&(i.wireframeLinewidth=S);const A=e.wireframeLinecap;ht(A)&&(i.wireframeLinecap=A);const O=e.wireframeLinejoin;ht(O)&&(i.wireframeLinejoin=O);const D=e.skinning;ht(D)&&(i.skinning=D);const T=e.morphTargets;ht(T)&&(i.morphTargets=T);const I=e.morphNormals;ht(I)&&(i.morphNormals=I)}break;case"MeshLambertMaterial":{i=new Te,this._fillBaseMaterialData(i,e);const t=e.color;ht(t)&&(i.color=this._setColor(t));const r=e.map;ht(r)&&(i.map=r);const s=e.lightMap;ht(s)&&(i.lightMap=s);const n=e.lightMapIntensity;ht(n)&&(i.lightMapIntensity=n);const a=e.aoMap;ht(a)&&(i.aoMap=a);const o=e.aoMapIntensity;ht(o)&&(i.aoMapIntensity=o);const h=e.emissive;ht(h)&&(i.emissive=this._setColor(h));const l=e.emissiveIntensity;ht(l)&&(i.emissiveIntensity=l);const c=e.emissiveMap;ht(c)&&(i.emissiveMap=c);const d=e.specularMap;ht(d)&&(i.specularMap=d);const p=e.alphaMap;ht(p)&&(i.alphaMap=p);const u=e.envMap;ht(u)&&(i.envMap=u);const _=e.combine;ht(_)&&(i.combine=_);const g=e.reflectivity;ht(g)&&(i.reflectivity=g);const m=e.refractionRatio;ht(m)&&(i.refractionRatio=m);const f=e.wireframe;ht(f)&&(i.wireframe=f);const b=e.wireframeLinewidth;ht(b)&&(i.wireframeLinewidth=b);const w=e.wireframeLinecap;ht(w)&&(i.wireframeLinecap=w);const y=e.wireframeLinejoin;ht(y)&&(i.wireframeLinejoin=y);const v=e.skinning;ht(v)&&(i.skinning=v);const x=e.morphTargets;ht(x)&&(i.morphTargets=x);const E=e.morphNormals;ht(E)&&(i.morphNormals=E)}break;case"LineBasicMaterial":{i=new g,this._fillBaseMaterialData(i,e);const t=e.color;ht(t)&&(i.color=this._setColor(t))}break;case"PointsMaterial":{i=new o,this._fillBaseMaterialData(i,e);const t=e.color;ht(t)&&(i.color=this._setColor(t));const r=e.map;ht(r)&&(i.map=r);const s=e.morphTargets;ht(s)&&(i.morphTargets=s);const n=e.size;ht(n)&&(i.size=n);const a=e.sizeAttenuation;ht(a)&&(i.sizeAttenuation=a)}break;default:throw new Error(`TMaterialsManager: Unmanaged material of type: ${t}`)}return i}_fillBaseMaterialData(e,t){const i=t._id;ht(i)&&yt(i)&&(e._id=i);const r=t.uuid;ht(r)&&yt(r)&&(e.uuid=r);const s=t.name;ht(s)&&yt(s)&&(e.name=s);const n=t.fog;ht(n)&&(e.fog=n);const a=t.lights;ht(a)&&(e.lights=a);const o=t.blending;ht(o)&&(e.blending=o);const h=t.side;ht(h)&&(e.side=h);const l=t.flatShading;ht(l)&&(e.flatShading=l);const c=t.vertexColors;ht(c)&&(e.vertexColors=c);const d=t.opacity;ht(d)&&(e.opacity=d);const p=t.transparent;ht(p)&&(e.transparent=p);const u=t.blendSrc;ht(u)&&(e.blendSrc=u);const _=t.blendDst;ht(_)&&(e.blendDst=_);const g=t.blendEquation;ht(g)&&(e.blendEquation=g);const m=t.blendSrcAlpha;ht(m)&&(e.blendSrcAlpha=m);const f=t.blendDstAlpha;ht(f)&&(e.blendDstAlpha=f);const b=t.blendEquationAlpha;ht(b)&&(e.blendEquationAlpha=b);const w=t.depthFunc;ht(w)&&(e.depthFunc=w);const y=t.depthTest;ht(y)&&(e.depthTest=y);const v=t.depthWrite;ht(v)&&(e.depthWrite=v);const x=t.clippingPlanes;ht(x)&&(e.clippingPlanes=x);const E=t.clipIntersection;ht(E)&&(e.clipIntersection=E);const P=t.clipShadows;ht(P)&&(e.clipShadows=P);const M=t.colorWrite;ht(M)&&(e.colorWrite=M);const F=t.precision;ht(F)&&(e.precision=F);const S=t.polygonOffset;ht(S)&&(e.polygonOffset=S);const A=t.polygonOffsetFactor;ht(A)&&(e.polygonOffsetFactor=A);const O=t.polygonOffsetUnits;ht(O)&&(e.polygonOffsetUnits=O);const D=t.dithering;ht(D)&&(e.dithering=D);const T=t.alphaTest;ht(T)&&(e.alphaTest=T);const I=t.premultipliedAlpha;ht(I)&&(e.premultipliedAlpha=I);const B=t.overdraw;ht(B)&&(e.overdraw=B);const C=t.visible;ht(C)&&(e.visible=C);const U=t.userData;ht(U)&&(e.userData=U);const k=t.needsUpdate;ht(k)&&(e.needsUpdate=k)}_setVector2(e){const t=e.x,i=e.y;if(ut(t)||ut(i))throw new Error("MaterialsManager: Unable to convert null or undefined vector 2 !");return new u(t,i)}_setColor(e){const t=e.r,i=e.g,r=e.b;if(ut(t)||ut(i)||ut(r))throw new Error("MaterialsManager: Unable to convert null or undefined color !");return new Be(t,i,r)}fillTextures(e,t){const i=this._retrieveTexturesOf(e);for(let t in e){const r=e[t],s=i[t];for(let e in s)r[e]=s[e]}t(e)}_retrieveTexturesOf(e){const t=["map","lightMap","aoMap","emissiveMap","bumpMap","normalMap","displacementMap","specularMap","alphaMap","envMap"],i={},r={};for(let s in e){const n=e[s];let a={};for(let e=0,i=t.length;e<i;e++){let i=t[e];const s=n[i];if(ht(s)&&yt(s)&&vt(s)){const e=`${this._texturesPath}/${s}`,t=r[e];if(ht(t))a[i]=t;else{const t=this._texturesProvider.load(e,()=>{},()=>{},()=>{t.image||(t.image=ui,t.needsUpdate=!0)});t.name=s,this._generateMipmap||(t.generateMipmaps=!1,t.magFilter=Ue,t.minFilter=Ue),r[e]=t,a[i]=t}}}i[s]=a}return i}}
/**
 * @module Managers/ObjectsManager
 *
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 *
 */class gi extends rt{constructor(e={}){const t={basePath:"/objects",geometriesProviderOptions:{},materialsProviderOptions:{},projectionSystem:"zBack",globalScale:1,autoFillObjects3D:!0,...e};super(t),this.projectionSystem=t.projectionSystem,this.globalScale=t.globalScale,this.autoFillObjects3D=t.autoFillObjects3D,this.geometriesProvider=new di(t.geometriesProviderOptions),this.materialsProvider=new _i(t.materialsProviderOptions)}get geometriesProvider(){return this._geometriesProvider}set geometriesProvider(e){if(lt(e))throw new TypeError("Geometries provider cannot be null ! Expect an instance of GeometriesManager.");if(ct(e))throw new TypeError("Geometries provider cannot be undefined ! Expect an instance of GeometriesManager.");if(!(e instanceof di))throw new TypeError(`Geometries provider cannot be an instance of ${e.constructor.name} ! Expect an instance of TGeometriesManager.`);this._geometriesProvider=e}get materialsProvider(){return this._materialsProvider}set materialsProvider(e){if(lt(e))throw new TypeError("Materials provider cannot be null ! Expect an instance of MaterialsManager.");if(ct(e))throw new TypeError("Materials provider cannot be undefined ! Expect an instance of MaterialsManager.");if(!(e instanceof _i))throw new TypeError(`Materials provider cannot be an instance of ${e.constructor.name} ! Expect an instance of TMaterialsManager.`);this._materialsProvider=e}get projectionSystem(){return this._projectionSystem}set projectionSystem(e){if(lt(e))throw new TypeError("Projection system cannot be null ! Expect a positive number.");if(ct(e))throw new TypeError("Projection system cannot be undefined ! Expect a positive number.");this._projectionSystem=e}get globalScale(){return this._globalScale}set globalScale(e){if(lt(e))throw new TypeError("Global scale cannot be null ! Expect a positive number.");if(ct(e))throw new TypeError("Global scale cannot be undefined ! Expect a positive number.");this._globalScale=e}get autoFillObjects3D(){return this._autoFillObjects3D}set autoFillObjects3D(e){if(lt(e))throw new TypeError("Global scale cannot be null ! Expect a boolean.");if(ct(e))throw new TypeError("Global scale cannot be undefined ! Expect a positive number.");if(dt(e))throw new TypeError("Global scale cannot be null ! Expect a boolean.");this._autoFillObjects3D=e}setGeometriesProvider(e){return this.geometriesProvider=e,this}setMaterialsProvider(e){return this.materialsProvider=e,this}setProjectionSystem(e){return this.projectionSystem=e,this}setGlobalScale(e){return this.globalScale=e,this}setAutoFillObjects3D(e){return this.autoFillObjects3D=e,this}_onJson(e,t,i,r){const s={};for(let t,n=0,a=e.length;n<a;n++){t=e[n];try{s[t._id]=this.convert(t)}catch(e){r(e)}i(new ProgressEvent("ObjectsManager",{lengthComputable:!0,loaded:n+1,total:a}))}this._autoFillObjects3D?this.fillObjects3D(s,t,i,r):t(s)}_onArrayBuffer(e,t,i,r){}_onBlob(e,t,i,r){}_onText(e,t,i,r){}convert(e){if(!e)throw new Error("ObjectsManager: Unable to convert null or undefined data !");const t=e.type;let i=null;switch(t){case"Object3D":i=new p,this._fillBaseObjectsData(i,e);break;case"Scene":i=new We,this._fillBaseObjectsData(i,e),ht(e.background)&&Number.isInteger(e.background)&&(i.background=new Be(e.background)),ht(e.fog)&&("Fog"===e.fog.type?i.fog=new Ke(e.fog.color,e.fog.near,e.fog.far):"FogExp2"===e.fog.type&&(i.fog=new $e(e.fog.color,e.fog.density))),i.overrideMaterial=e.overrideMaterial,i.autoUpdate=e.autoUpdate;break;case"PerspectiveCamera":i=new Ve,this._fillBaseObjectsData(i,e),i.fov=e.fov,i.aspect=e.aspect,i.near=e.near,i.far=e.far,ht(e.focus)&&(i.focus=e.focus),ht(e.zoom)&&(i.zoom=e.zoom),ht(e.filmGauge)&&(i.filmGauge=e.filmGauge),ht(e.filmOffset)&&(i.filmOffset=e.filmOffset),ht(e.view)&&(i.view=Object.assign({},e.view));break;case"OrthographicCamera":i=new Ze(e.left,e.right,e.top,e.bottom,e.near,e.far),this._fillBaseObjectsData(i,e);break;case"AmbientLight":i=new Xe(e.color,e.intensity),this._fillBaseObjectsData(i,e);break;case"DirectionalLight":i=new Ye(e.color,e.intensity),this._fillBaseObjectsData(i,e);break;case"PointLight":i=new je(e.color,e.intensity,e.distance,e.decay),this._fillBaseObjectsData(i,e);break;case"RectAreaLight":i=new Ne(e.color,e.intensity,e.width,e.height),this._fillBaseObjectsData(i,e);break;case"SpotLight":i=new He(e.color,e.intensity,e.distance,e.angle,e.penumbra,e.decay),this._fillBaseObjectsData(i,e);break;case"HemisphereLight":i=new Ge(e.color,e.groundColor,e.intensity),this._fillBaseObjectsData(i,e);break;case"SkinnedMesh":i=new ze,this._fillBaseObjectsData(i,e),i.geometry=e.geometry,i.material=e.material,i.drawMode=e.drawMode,i.bindMode=e.bindMode,i.bindMatrix=e.bindMatrix,i.bindMatrixInverse=e.bindMatrixInverse;break;case"Mesh":i=new b,this._fillBaseObjectsData(i,e),i.geometry=e.geometry,i.material=e.material,i.drawMode=e.drawMode;break;case"LOD":i=new Le,this._fillBaseObjectsData(i,e),i.levels=e.levels;break;case"Line":i=new P,this._fillBaseObjectsData(i,e),i.geometry=e.geometry,i.material=e.material,i.drawMode=e.drawMode;break;case"LineLoop":i=new Re,this._fillBaseObjectsData(i,e),i.geometry=e.geometry,i.material=e.material,i.drawMode=e.drawMode;break;case"LineSegments":i=new x,this._fillBaseObjectsData(i,e),i.geometry=e.geometry,i.material=e.material,i.drawMode=e.drawMode;break;case"Points":i=new h,this._fillBaseObjectsData(i,e),i.geometry=e.geometry,i.material=e.material,i.drawMode=e.drawMode;break;case"Sprite":i=new ke,this._fillBaseObjectsData(i,e),i.material=e.material;break;case"Group":i=new s,this._fillBaseObjectsData(i,e);break;default:throw new Error(`TObjectsManager: Unknown object of type: ${t}`)}return i}_fillBaseObjectsData(e,t){e._id=t._id,ht(t.uuid)&&(e.uuid=t.uuid),ht(t.name)&&(e.name=t.name),ht(t.parent)&&(e.parent=t.parent),xt(t.children)&&(e.children=t.children),ht(t.up)&&(e.up.x=t.up.x,e.up.y=t.up.y,e.up.z=t.up.z),ht(t.position)&&("zBack"===this._projectionSystem?(e.position.x=t.position.x/this._globalScale,e.position.y=t.position.z/this._globalScale,e.position.z=-t.position.y/this._globalScale):(e.position.x=t.position.x/this._globalScale,e.position.y=t.position.y/this._globalScale,e.position.z=t.position.z/this._globalScale)),ht(t.rotation)&&("zBack"===this._projectionSystem?(e.rotation.x=t.rotation.x,e.rotation.y=t.rotation.z,e.rotation.z=-t.rotation.y,e.rotation.order=t.rotation.order):(e.rotation.x=t.rotation.x,e.rotation.y=t.rotation.y,e.rotation.z=t.rotation.z,e.rotation.order=t.rotation.order)),ht(t.quaternion)&&("zBack"===this._projectionSystem?(e.quaternion.x=t.quaternion.x,e.quaternion.y=t.quaternion.z,e.quaternion.z=-t.quaternion.y,e.quaternion.w=t.quaternion.w):(e.quaternion.x=t.quaternion.x,e.quaternion.y=t.quaternion.y,e.quaternion.z=t.quaternion.z,e.quaternion.w=t.quaternion.w)),ht(t.scale)&&(0!==t.scale.x&&0!==t.scale.y&&0!==t.scale.z?(e.scale.x=t.scale.x,e.scale.y=t.scale.y,e.scale.z=t.scale.z):this.logger.warn("Try to assign null scale !")),ht(t.modelViewMatrix)&&xt(t.modelViewMatrix)&&e.modelViewMatrix.fromArray(t.modelViewMatrix),ht(t.normalMatrix)&&xt(t.normalMatrix)&&e.normalMatrix.fromArray(t.normalMatrix),ht(t.matrix)&&xt(t.matrix)&&e.matrix.fromArray(t.matrix),ht(t.matrixWorld)&&xt(t.matrixWorld)&&e.matrixWorld.fromArray(t.matrixWorld),ht(t.matrixAutoUpdate)&&(e.matrixAutoUpdate=t.matrixAutoUpdate),ht(t.matrixWorldNeedsUpdate)&&(e.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate),ht(t.layers)&&(e.layers.mask=t.layers),ht(t.visible)&&(e.visible=t.visible),ht(t.castShadow)&&(e.castShadow=t.castShadow),ht(t.receiveShadow)&&(e.receiveShadow=t.receiveShadow),ht(t.frustumCulled)&&(e.frustumCulled=t.frustumCulled),ht(t.renderOrder)&&(e.renderOrder=t.renderOrder),ht(t.userData)&&(e.userData=t.userData)}fillObjects3D(e,t,i,r){const s=this,n=[];for(let t in e){const i=e[t];(i.geometry||i.material)&&n.push(e[t])}if(0===n.length)return void t(e);let a,o;function h(){if(a&&o){for(let t in e){const i=e[t];s.applyGeometry(i,a),s.applyMaterials(i,o)}t(e)}}this._retrieveGeometriesOf(n,e=>{a=e,h()},i,r),this._retrieveMaterialsOf(n,e=>{o=e,h()},i,r)}_retrieveGeometriesOf(e,t,i,r){const s=e.map(e=>e.geometry).filter((e,t,i)=>e&&i.indexOf(e)===t);0!==s.length?this._geometriesProvider.read(s,null,t,i,r):t({})}_retrieveMaterialsOf(e,t,i,r){const s=e.map(e=>e.material),n=[].concat.apply([],s).filter((e,t,i)=>e&&i.indexOf(e)===t);0!==n.length?this._materialsProvider.read(n,null,t,i,r):t({})}applyGeometry(e,t){const i=e.geometry;if(!i)return;const r=t[i];r?e.geometry=r:this.logger.error("Unable to retrieve geometry !!!")}applyMaterials(e,t){const i=e.material;if(i)if(Array.isArray(i))if(1===i.length){const r=t[i[0]];if(!r)return this.logger.error("Unable to retrieve material !!!"),null;e.material=r.clone()}else{e.material=[];for(let r=0,s=i.length;r<s;r++){const s=t[i[r]];if(!s)return this.logger.error("Unable to retrieve material !!!"),null;e.material.push(s.clone())}}else if("string"==typeof i){const r=t[i];if(!r)return void this.logger.error("Unable to retrieve material !!!");e.material=r.clone()}else this.logger.error("Invalid material ids, expected string or array of string")}}
/**
 * @module Objects3D/OrbitControlsHelper
 *
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 *
 */class mi extends x{constructor(e={}){const t={radius:2,radials:16,circles:2,divisions:64,innerColor:new Be(4473924),outerColor:new Be(8947848),...e};super(mi._createInternalGeometry(t.radius,t.radials,t.circles,t.divisions,t.innerColor,t.outerColor),mi._createInternalMaterial()),this.matrixAutoUpdate=!1,this._intervalId=void 0}static _createInternalGeometry(e,t,i,r,s,a){const o=[],h=[];let l,c,d,p,u,_,g;for(p=0;p<=t;p++)d=p/t*(2*Math.PI),l=Math.sin(d)*e,c=Math.cos(d)*e,o.push(0,0,0),o.push(l,0,c),g=1&p?s:a,h.push(g.r,g.g,g.b),h.push(g.r,g.g,g.b);for(p=0;p<=i;p++){for(g=1&p?s:a,_=e-e/i*p,u=0;u<r;u++)d=u/r*(2*Math.PI),l=Math.sin(d)*_,c=Math.cos(d)*_,o.push(l,0,c),h.push(g.r,g.g,g.b),d=(u+1)/r*(2*Math.PI),l=Math.sin(d)*_,c=Math.cos(d)*_,o.push(l,0,c),h.push(g.r,g.g,g.b);o.push(-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1,0,0,1),h.push(0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1)}const m=new E(o,3);m.name="TOrbitControlsHelperPositionBufferAttribute";const f=new E(h,3);f.name="TOrbitControlsHelperColorBufferAttribute";const b=new n;return b.setAttribute("position",m),b.setAttribute("color",f),b.name="TOrbitControlsHelperGeometry",b}static _createInternalMaterial(){const e=new g({vertexColors:qe});return e.transparent=!0,e.opacity=0,e.name="TOrbitControlsHelperMaterial",e}startOpacityAnimation(){void 0!==this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this.material.opacity=1}endOpacityAnimation(){this._intervalId=setInterval(function(){this.material.opacity<=0?(this.material.opacity=0,clearInterval(this._intervalId),this._intervalId=void 0):this.material.opacity-=.1}.bind(this),100)}}
/**
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 */class fi extends Xt{constructor(e={}){super({geometry:new we(1,.12,4,12,Math.PI),...e}),this.isTorusHitbox=!0,this.type="TorusHitbox"}}
/**
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 */class bi extends ei{constructor(){super(),this.isRotateGizmo=!0,this.type="RotateGizmo";const e=(e,t,i)=>{const r=new n;let s=[];i=i||1;for(let r=0;r<=64*i;++r)"x"===t&&s.push(0,Math.cos(r/32*Math.PI)*e,Math.sin(r/32*Math.PI)*e),"y"===t&&s.push(Math.cos(r/32*Math.PI)*e,0,Math.sin(r/32*Math.PI)*e),"z"===t&&s.push(Math.sin(r/32*Math.PI)*e,Math.cos(r/32*Math.PI)*e,0);return r.setAttribute("position",new E(s,3)),r};this.handleGizmos={X:[[new P(new e(1,"x",.5),new jt({color:16711680}))],[new b(new w(.04,0),new Yt({color:16711680})),[0,0,.99],null,[3,1,1]]],Y:[[new P(new e(1,"y",.5),new jt({color:65280}))],[new b(new w(.04,0),new Yt({color:65280})),[0,0,.99],null,[3,1,1]]],Z:[[new P(new e(1,"z",.5),new jt({color:255}))],[new b(new w(.04,0),new Yt({color:255})),[.99,0,0],null,[1,3,1]]],E:[[new P(new e(1.25,"z",1),new jt({color:13421568}))]],XYZ:[[new P(new e(1,"z",1),new jt({color:7895160}))]]},this.pickerGizmos={X:[[new fi,[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new fi,[0,0,0],[Math.PI/2,0,0]]],Z:[[new fi,[0,0,0],[0,0,-Math.PI/2]]],E:[[new fi({radius:1.25,tube:.12,radialSegments:2,tubularSegments:24})]],XYZ:[[new fi]]},this._setupHandles(this.handleGizmos)}raycast(e,t){if(e.intersectObject(this.intersectPlane,!0).length>0)for(let i of this.children)i.name!==this.intersectPlane.name&&i.raycast(e,t)}}
/**
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 */class wi extends Xt{constructor(e={}){super({geometry:new S(1,1,1,1,1,1),...e}),this.isBoxHitbox=!0,this.type="BoxHitbox"}}
/**
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 */class yi extends Vt{constructor(e={}){const t={boxColor:1067907,edgesColor:1193046,hitbox:new wi({geometry:new S(1.1,1.1,1.1,1,1,1)}),...e};super(t),this.isOmnidirectionalHandle=!0,this.type="OmnidirectionalHandle";const i=new S(1,1,1,1,1,1);i.name="BoxHandle_Box_Geometry";const r=new Yt({color:t.boxColor,transparent:!1,opacity:1});r.name="BoxHandle_Box_Material";const s=new b(i,r);s.name="BoxHandle_Box",s.matrixAutoUpdate=!1,this.add(s);const n=new v(i);n.name="BoxHandle_Edges_Geometry";const a=new jt({color:t.edgesColor,linewidth:4,transparent:!1,opacity:1});a.name="BoxHandle_Edges_Material";const o=new x(n,a);o.name="BoxHandle_Edges",o.matrixAutoUpdate=!1,this.add(o)}update(e){super.update(e),this.updateMatrix(),this.hitbox.updateMatrix()}}
/**
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 */class vi extends Vt{constructor(e={}){const t={coneColor:1067907,edgesColor:1193046,hitbox:new wi({geometry:new O(1.1,1.1)}),...e};super(t),this.isOmnidirectionalHandle=!0,this.type="OmnidirectionalHandle";const i=new O(1,1);i.name="ConeHandle_Cone_Geometry";const r=new Yt({color:t.coneColor,transparent:!1,opacity:1});r.name="ConeHandle_Cone_Material";const s=new b(i,r);s.name="ConeHandle_Cone",s.matrixAutoUpdate=!0,this.add(s)}update(e){super.update(e),this.updateMatrix(),this.hitbox.updateMatrix()}}
/**
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 */class xi extends ei{constructor(e={}){const t={boxColor:11119017,edgesColor:13882323,...e};super(t),this.isLookAtGizmo=!0,this.type="LookAtGizmo",this.explodeFactor=.25,this.handleGizmos={FACE_RIGHT:new vi({coneColor:14483456}).setPosition(+(4+this.explodeFactor),0,0).setRotationFromAxisAndAngle(new l(0,0,1),ot(90)).setScale(1,4,1),FACE_LEFT:new vi({coneColor:5570560}).setPosition(-(4+this.explodeFactor),0,0).setRotationFromAxisAndAngle(new l(0,0,1),ot(-90)).setScale(1,4,1),FACE_TOP:new vi({coneColor:221}).setPosition(0,+(4+this.explodeFactor),0).setRotationFromAxisAndAngle(new l(1,0,0),ot(180)).setScale(1,4,1),FACE_BOTTOM:new vi({coneColor:85}).setPosition(0,-(4+this.explodeFactor),0).setScale(1,4,1),FACE_FRONT:new vi({coneColor:21760}).setPosition(0,0,+(4+this.explodeFactor)).setRotationFromAxisAndAngle(new l(1,0,0),ot(-90)).setScale(1,4,1),FACE_BACK:new vi({coneColor:56576}).setPosition(0,0,-(4+this.explodeFactor)).setRotationFromAxisAndAngle(new l(1,0,0),ot(90)).setScale(1,4,1),CORNER_TOP_LEFT_FRONT:new yi(t).setPosition(-(2+this.explodeFactor),+(2+this.explodeFactor),+(2+this.explodeFactor)),CORNER_TOP_LEFT_BACK:new yi(t).setPosition(-(2+this.explodeFactor),+(2+this.explodeFactor),-(2+this.explodeFactor)),CORNER_TOP_RIGHT_FRONT:new yi(t).setPosition(+(2+this.explodeFactor),+(2+this.explodeFactor),+(2+this.explodeFactor)),CORNER_TOP_RIGHT_BACK:new yi(t).setPosition(+(2+this.explodeFactor),+(2+this.explodeFactor),-(2+this.explodeFactor)),CORNER_BOTTOM_LEFT_FRONT:new yi(t).setPosition(-(2+this.explodeFactor),-(2+this.explodeFactor),+(2+this.explodeFactor)),CORNER_BOTTOM_LEFT_BACK:new yi(t).setPosition(-(2+this.explodeFactor),-(2+this.explodeFactor),-(2+this.explodeFactor)),CORNER_BOTTOM_RIGHT_FRONT:new yi(t).setPosition(+(2+this.explodeFactor),-(2+this.explodeFactor),+(2+this.explodeFactor)),CORNER_BOTTOM_RIGHT_BACK:new yi(t).setPosition(+(2+this.explodeFactor),-(2+this.explodeFactor),-(2+this.explodeFactor)),EDGE_TOP_FRONT:new yi(t).setPosition(0,+(2+this.explodeFactor),+(2+this.explodeFactor)).setScale(3,1,1),EDGE_TOP_LEFT:new yi(t).setPosition(-(2+this.explodeFactor),+(2+this.explodeFactor),0).setScale(1,1,3),EDGE_TOP_BACK:new yi(t).setPosition(0,+(2+this.explodeFactor),-(2+this.explodeFactor)).setScale(3,1,1),EDGE_TOP_RIGHT:new yi(t).setPosition(+(2+this.explodeFactor),+(2+this.explodeFactor),0).setScale(1,1,3),EDGE_LEFT_FRONT:new yi(t).setPosition(-(2+this.explodeFactor),0,+(2+this.explodeFactor)).setScale(1,3,1),EDGE_LEFT_BACK:new yi(t).setPosition(-(2+this.explodeFactor),0,-(2+this.explodeFactor)).setScale(1,3,1),EDGE_RIGHT_FRONT:new yi(t).setPosition(+(2+this.explodeFactor),0,+(2+this.explodeFactor)).setScale(1,3,1),EDGE_RIGHT_BACK:new yi(t).setPosition(+(2+this.explodeFactor),0,-(2+this.explodeFactor)).setScale(1,3,1),EDGE_BOTTOM_FRONT:new yi(t).setPosition(0,-(2+this.explodeFactor),+(2+this.explodeFactor)).setScale(3,1,1),EDGE_BOTTOM_LEFT:new yi(t).setPosition(-(2+this.explodeFactor),-(2+this.explodeFactor),0).setScale(1,1,3),EDGE_BOTTOM_BACK:new yi(t).setPosition(0,-(2+this.explodeFactor),-(2+this.explodeFactor)).setScale(3,1,1),EDGE_BOTTOM_RIGHT:new yi(t).setPosition(+(2+this.explodeFactor),-(2+this.explodeFactor),0).setScale(1,1,3)},this._setupHandles(this.handleGizmos)}raycast(e,t){if(e.intersectObject(this.intersectPlane,!0).length>0)for(let i of this.children)i.raycast(e,t)}}
/**
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 */class Ei extends Vt{constructor(e={}){super({...e}),this.isRotateHandle=!0,this.type="RotateHandle"}update(e){super.update(e),this.updateMatrix(),this.hitbox.updateMatrix()}}
/**
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 */class Pi extends Xt{constructor(e={}){super({geometry:new me(1,8,6,0,2*Math.PI,0,Math.PI),...e}),this.isSphericalHitbox=!0,this.type="SphericalHitbox"}}
/**
 * @author [Tristan Valcke]{@link https://github.com/Itee}
 * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}
 */class Mi extends b{constructor(e,t={}){super(e,new Yt({color:t.color,transparent:!0,opacity:.55})),this.isHighlightableMesh=!0,this.type="HighlightableMesh"}highlight(e){this.material.highlight(e)}}export{Et as ASCLoader,ei as AbstractGizmo,Vt as AbstractHandle,Xt as AbstractHitbox,It as BitArray,Bt as BitManager,Ht as CameraControlMode,Nt as CameraControls,ai as ClippingBox,hi as ClippingControls,oi as ClippingModes,li as CurvesManager,Qt as CylindricaHitbox,Ft as DBFLoader,di as GeometriesManager,Mi as HighlightableMesh,Ot as LASLoader,xi as LookAtGizmo,ri as LozengeHandle,ii as LozengeHitbox,_i as MaterialsManager,gi as ObjectsManager,Wt as OctahedricalHandle,Zt as OctahedricalHitbox,mi as OrbitControlsHelper,Kt as PlanarHitbox,$t as PlaneHandle,At as PointClasses,bi as RotateGizmo,Ei as RotateHandle,Tt as SHPLoader,ti as ScaleGizmo,Jt as ScaleHandle,Dt as ShapeType,Pi as SphericalHitbox,pi as TexturesManager,fi as TorusHitbox,ni as TranslateGizmo,si as TranslateHandle};
