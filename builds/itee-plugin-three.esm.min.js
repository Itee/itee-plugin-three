import{DefaultLogger as e,Keys as t,Mouse as n,TDataBaseManager as i,ResponseType as s}from"itee-client";import{toEnum as o,degreesToRadians as r}from"itee-utils";import{isNull as a,isUndefined as c,isNotBoolean as h,isEmptyArray as l,isNotDefined as d,isArray as u,isDefined as m,isNotArray as p,isObject as _,isNotString as f,isEmptyString as w,isBlankString as v,isString as b,isNotEmptyString as g,isNotEmptyArray as y}from"itee-validators";import{Vector3 as E,EventDispatcher as x,Object3D as M,Camera as P,Vector2 as A,Spherical as T,Quaternion as D,MOUSE as k,LineSegments as S,EdgesGeometry as C,BoxBufferGeometry as z,LineBasicMaterial as O,Plane as B,Box3 as L,MeshBasicMaterial as G,DoubleSide as j,PlaneBufferGeometry as I,Mesh as U,Line as R,OctahedronBufferGeometry as H,Raycaster as F,Euler as N,TorusBufferGeometry as X,ConeBufferGeometry as Y,BufferGeometry as Z,Float32BufferAttribute as W,CylinderBufferGeometry as q,Scene as V,ArcCurve as $,CatmullRomCurve3 as J,CubicBezierCurve as K,CubicBezierCurve3 as Q,Curve as ee,CurvePath as te,EllipseCurve as ne,LineCurve as ie,LineCurve3 as se,Path as oe,QuadraticBezierCurve as re,QuadraticBezierCurve3 as ae,SplineCurve as ce,Shape as he,SphereBufferGeometry as le,MeshPhongMaterial as de,BoxGeometry as ue,CircleGeometry as me,CylinderGeometry as pe,ConeGeometry as _e,DodecahedronGeometry as fe,ExtrudeGeometry as we,Geometry as ve,IcosahedronGeometry as be,LatheGeometry as ge,OctahedronGeometry as ye,ParametricGeometry as Ee,PlaneGeometry as xe,PolyhedronGeometry as Me,RingGeometry as Pe,ShapeGeometry as Ae,TetrahedronGeometry as Te,TextGeometry as De,TorusGeometry as ke,TorusKnotGeometry as Se,TubeGeometry as Ce,SphereGeometry as ze,WireframeGeometry as Oe,Face3 as Be,CircleBufferGeometry as Le,DodecahedronBufferGeometry as Ge,ExtrudeBufferGeometry as je,IcosahedronBufferGeometry as Ie,LatheBufferGeometry as Ue,ParametricBufferGeometry as Re,PolyhedronBufferGeometry as He,RingBufferGeometry as Fe,TetrahedronBufferGeometry as Ne,TextBufferGeometry as Xe,TorusKnotBufferGeometry as Ye,TubeBufferGeometry as Ze,InstancedBufferGeometry as We,BufferAttribute as qe,ImageLoader as Ve,TextureLoader as $e,MeshLambertMaterial as Je,PointsMaterial as Ke,Color as Qe,LinearFilter as et,Fog as tt,FogExp2 as nt,PerspectiveCamera as it,OrthographicCamera as st,AmbientLight as ot,DirectionalLight as rt,PointLight as at,RectAreaLight as ct,SpotLight as ht,HemisphereLight as lt,SkinnedMesh as dt,LOD as ut,LineLoop as mt,Points as pt,Sprite as _t,Group as ft,VertexColors as wt}from"three-full";const vt=new E(0,0,-1),bt=new E(0,0,1),gt=new E(0,1,0),yt=new E(0,-1,0),Et=new E(1,0,0),xt=new E(-1,0,0),Mt=o({None:0,Rotating:1,Panning:2,Rolling:3,Zooming:4,Moving:5}),Pt=o({FirstPerson:1,Orbit:2,Fly:3,Path:4});class At extends x{constructor(i={}){const s={logger:e,camera:null,target:new M,mode:Pt.Orbit,domElement:window,...i};super(),this._handlers={onMouseEnter:this._onMouseEnter.bind(this),onMouseLeave:this._onMouseLeave.bind(this),onMouseDown:this._onMouseDown.bind(this),onMouseMove:this._onMouseMove.bind(this),onMouseWheel:this._onMouseWheel.bind(this),onMouseUp:this._onMouseUp.bind(this),onDblClick:this._onDblClick.bind(this),onTouchStart:this._onTouchStart.bind(this),onTouchEnd:this._onTouchEnd.bind(this),onTouchCancel:this._onTouchCancel.bind(this),onTouchLeave:this._onTouchLeave.bind(this),onTouchMove:this._onTouchMove.bind(this),onKeyDown:this._onKeyDown.bind(this),onKeyUp:this._onKeyUp.bind(this)},this.logger=s.logger,this.camera=s.camera,this.target=s.target,this.mode=s.mode,this.domElement=s.domElement,this.enabled=!0,this._paths=[],this._trackPath=!1,this._cameraJump=.1,this._currentPathPosition=null,this._currentPathOffset=0,this._currentPathIndex=0,this._currentPath=null,this._maxJump=1,this._lockedTarget=!0,this.previousTouches=[],this.canMove=!0,this.moveSpeed=1,this.canFront=!0,this.frontMinimum=-1/0,this.frontMaximum=-1/0,this.frontMinSpeed=0,this.frontSpeed=1,this.frontMaxSpeed=1/0,this.frontAcceleration=1,this.canBack=!0,this.backMinimum=-1/0,this.backMaximum=-1/0,this.backMinSpeed=0,this.backSpeed=1,this.backMaxSpeed=1/0,this.backAcceleration=1,this.canUp=!0,this.upMinimum=-1/0,this.upMaximum=-1/0,this.upMinSpeed=0,this.upSpeed=1,this.upMaxSpeed=1/0,this.upAcceleration=1,this.canDown=!0,this.downMinimum=-1/0,this.downMaximum=-1/0,this.downMinSpeed=0,this.downSpeed=1,this.downMaxSpeed=1/0,this.downAcceleration=1,this.canLeft=!0,this.leftMinimum=-1/0,this.leftMaximum=-1/0,this.leftMinSpeed=0,this.leftSpeed=1,this.leftMaxSpeed=1/0,this.leftAcceleration=1,this.canRight=!0,this.rightMinimum=-1/0,this.rightMaximum=-1/0,this.rightMinSpeed=0,this.rightSpeed=1,this.rightMaxSpeed=1/0,this.rightAcceleration=1,this.canRotate=!0,this.minPolarAngle=.001,this.maxPolarAngle=Math.PI-.001,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.rotateMinSpeed=0,this.rotateSpeed=1,this.rotateMaxSpeed=1/0,this.rotateAcceleration=1,this.canPan=!0,this.panMinimum=-1/0,this.panMaximum=-1/0,this.panMinSpeed=0,this.panSpeed=.001,this.panMaxSpeed=1/0,this.panAcceleration=1,this.canRoll=!0,this.rollMinimum=-1/0,this.rollMaximum=-1/0,this.rollMinSpeed=0,this.rollSpeed=.1,this.rollMaxSpeed=1/0,this.rollAcceleration=1,this.canZoom=!0,this.zoomMinimum=0,this.zoomMaximum=1/0,this.zoomMinSpeed=0,this.zoomSpeed=.001,this.zoomMaxSpeed=1/0,this.zoomAcceleration=1,this.canLookAt=!0,this.actionsMap={front:[t.Z.value,t.UP_ARROW.value],back:[t.S.value,t.DOWN_ARROW.value],up:[t.A.value,t.PAGE_UP.value],down:[t.E.value,t.PAGE_DOWN.value],left:[t.Q.value,t.LEFT_ARROW.value],right:[t.D.value,t.RIGHT_ARROW.value],rotate:[n.LEFT.value],pan:[n.MIDDLE.value],roll:{left:[t.R.value],right:[t.T.value]},zoom:[n.WHEEL.value],lookAtFront:[t.NUMPAD_2.value],lookAtFrontLeft:[t.NUMPAD_3.value],lookAtFrontRight:[t.NUMPAD_1.value],lookAtBack:[t.NUMPAD_8.value],lookAtBackLeft:[t.NUMPAD_9.value],lookAtBackRight:[t.NUMPAD_7.value],lookAtUp:[t.NUMPAD_5.value],lookAtDown:[t.NUMPAD_0.value],lookAtLeft:[t.NUMPAD_6.value],lookAtRight:[t.NUMPAD_4.value]},this._state=Mt.None}get camera(){return this._camera}set camera(e){if(a(e))throw new Error("Camera cannot be null ! Expect an instance of Camera");if(c(e))throw new Error("Camera cannot be undefined ! Expect an instance of Camera");if(!(e instanceof P))throw new Error(`Camera cannot be an instance of ${e.constructor.name}. Expect an instance of Camera.`);this._camera=e}get target(){return this._target}set target(e){if(a(e))throw new Error("Target cannot be null ! Expect an instance of Object3D.");if(c(e))throw new Error("Target cannot be undefined ! Expect an instance of Object3D.");if(!(e instanceof M))throw new Error(`Target cannot be an instance of ${e.constructor.name}. Expect an instance of Object3D.`);this._target=e}get mode(){return this._mode}set mode(e){if(a(e))throw new Error("Mode cannot be null ! Expect a value from CameraControlMode enum.");if(c(e))throw new Error("Mode cannot be undefined ! Expect a value from CameraControlMode enum.");if(!(e instanceof Pt))throw new Error(`Mode cannot be an instance of ${e.constructor.name}. Expect a value from TCameraControlMode enum.`);this._mode=e,this._trackPath&&this._initPathDisplacement()}get paths(){return this._paths}set paths(e){this._paths=e}get trackPath(){return this._trackPath}set trackPath(e){if(h(e))throw new Error(`Track path cannot be an instance of ${e.constructor.name}. Expect a boolean.`);this._trackPath=e,this._trackPath&&this._initPathDisplacement()}get domElement(){return this._domElement}set domElement(e){if(a(e))throw new Error("DomElement cannot be null ! Expect an instance of HTMLDocument.");if(c(e))throw new Error("DomElement cannot be undefined ! Expect an instance of HTMLDocument.");if(!(e instanceof Window||e instanceof HTMLDocument||e instanceof HTMLDivElement||e instanceof HTMLCanvasElement))throw new Error(`DomElement cannot be an instance of ${e.constructor.name}. Expect an instance of Window, HTMLDocument or HTMLDivElement.`);this._domElement&&(this._domElement.removeEventListener("mouseenter",this._handlers.onMouseEnter,!1),this._domElement.removeEventListener("mouseleave",this._handlers.onMouseLeave,!1),this.dispose()),this._domElement=e,this._domElement.addEventListener("mouseenter",this._handlers.onMouseEnter,!1),this._domElement.addEventListener("mouseleave",this._handlers.onMouseLeave,!1),this.impose()}setCamera(e){return this.camera=e,this}setTarget(e){return this.target=e,this}setMode(e){return this.mode=e,this}setPaths(e){return this.paths=e,this}addPath(e){return this._paths.push(e),this}setTrackPath(e){return this.trackPath=e,this}setDomElement(e){return this.domElement=e,this}impose(){this._domElement.addEventListener("keydown",this._handlers.onKeyDown,!1),this._domElement.addEventListener("keyup",this._handlers.onKeyUp,!1),this._domElement.addEventListener("dblclick",this._handlers.onDblClick,!1),this._domElement.addEventListener("mousedown",this._handlers.onMouseDown,!1),this._domElement.addEventListener("mousemove",this._handlers.onMouseMove,!1),this._domElement.addEventListener("mouseup",this._handlers.onMouseUp,!1),this._domElement.addEventListener("wheel",this._handlers.onMouseWheel,{capture:!0,once:!1,passive:!1}),this._domElement.addEventListener("touchcancel",this._handlers.onTouchCancel,!1),this._domElement.addEventListener("touchend",this._handlers.onTouchEnd,!1),this._domElement.addEventListener("touchleave",this._handlers.onTouchLeave,!1),this._domElement.addEventListener("touchmove",this._handlers.onTouchMove,{capture:!0,once:!1,passive:!1}),this._domElement.addEventListener("touchstart",this._handlers.onTouchStart,{capture:!0,once:!1,passive:!1}),this.dispatchEvent({type:"impose"})}dispose(){this._domElement.removeEventListener("keydown",this._handlers.onKeyDown,!1),this._domElement.removeEventListener("keyup",this._handlers.onKeyUp,!1),this._domElement.removeEventListener("dblclick",this._handlers.onDblClick,!1),this._domElement.removeEventListener("mousedown",this._handlers.onMouseDown,!1),this._domElement.removeEventListener("mousemove",this._handlers.onMouseMove,!1),this._domElement.removeEventListener("mouseup",this._handlers.onMouseUp,!1),this._domElement.removeEventListener("wheel",this._handlers.onMouseWheel,{capture:!0,once:!1,passive:!1}),this._domElement.removeEventListener("touchcancel",this._handlers.onTouchCancel,!1),this._domElement.removeEventListener("touchend",this._handlers.onTouchEnd,!1),this._domElement.removeEventListener("touchleave",this._handlers.onTouchLeave,!1),this._domElement.removeEventListener("touchmove",this._handlers.onTouchMove,{capture:!0,once:!1,passive:!1}),this._domElement.removeEventListener("touchstart",this._handlers.onTouchStart,{capture:!0,once:!1,passive:!1}),this.dispatchEvent({type:"dispose"})}update(){}setCameraPosition(e){return this._camera.position.copy(e),this._camera.lookAt(this._target.position),this}setTargetPosition(e){return this._target.position.copy(e),this._camera.lookAt(this._target.position),this}_consumeEvent(e){e.cancelable&&e.stopImmediatePropagation()}_onKeyDown(e){if(!this.enabled)return;e.preventDefault();const t=this.actionsMap,n=e.keyCode;t.front.includes(n)?(this._front(),this._consumeEvent(e)):t.back.includes(n)?(this._back(),this._consumeEvent(e)):t.up.includes(n)?(this._up(),this._consumeEvent(e)):t.down.includes(n)?(this._down(),this._consumeEvent(e)):t.left.includes(n)?(this._left(),this._consumeEvent(e)):t.right.includes(n)?(this._right(),this._consumeEvent(e)):t.rotate.includes(n)?this._rotate(1):t.pan.includes(n)?(this._pan(1),this._consumeEvent(e)):t.roll.left.includes(n)?(this._roll(1),this._consumeEvent(e)):t.roll.right.includes(n)?(this._roll(-1),this._consumeEvent(e)):t.zoom.includes(n)?(this._zoom(1),this._consumeEvent(e)):t.lookAtFront.includes(n)?(this._lookAt(vt),this._consumeEvent(e)):t.lookAtFrontLeft.includes(n)?(this._lookAt(new E(-1,0,-1).normalize()),this._consumeEvent(e)):t.lookAtFrontRight.includes(n)?(this._lookAt(new E(1,0,-1).normalize()),this._consumeEvent(e)):t.lookAtBack.includes(n)?(this._lookAt(bt),this._consumeEvent(e)):t.lookAtBackLeft.includes(n)?(this._lookAt(new E(-1,0,1).normalize()),this._consumeEvent(e)):t.lookAtBackRight.includes(n)?(this._lookAt(new E(1,0,1).normalize()),this._consumeEvent(e)):t.lookAtUp.includes(n)?(this._lookAt(gt),this._consumeEvent(e)):t.lookAtDown.includes(n)?(this._lookAt(yt),this._consumeEvent(e)):t.lookAtLeft.includes(n)?(this._lookAt(xt),this._consumeEvent(e)):t.lookAtRight.includes(n)&&(this._lookAt(Et),this._consumeEvent(e))}_onKeyUp(e){this.enabled&&e.preventDefault()}_onTouchStart(e){this.enabled&&(e.preventDefault(),this.previousTouches=e.touches)}_onTouchEnd(e){this.enabled&&(e.preventDefault(),this.previousTouches=[],this._state=Mt.None)}_onTouchCancel(e){this.enabled&&(e.preventDefault(),this.previousTouches=[],this._state=Mt.None)}_onTouchLeave(e){this.enabled&&(e.preventDefault(),this.previousTouches=[],this._state=Mt.None)}_onTouchMove(e){if(!this.enabled)return;e.preventDefault();const t=this.previousTouches,n=e.changedTouches,i=t.length,s=n.length;if(2===i&&2===s){const i=new A(t[0].clientX,t[0].clientY),s=new A(t[1].clientX,t[1].clientY),o=i.distanceTo(s),r=(new A).addVectors(i,s).divideScalar(2),a=(new A).subVectors(i,s).normalize(),c=new A(n[0].clientX,n[0].clientY),h=new A(n[1].clientX,n[1].clientY),l=c.distanceTo(h),d=(new A).addVectors(c,h).divideScalar(2),u=(new A).subVectors(i,s).normalize(),m=(new A).subVectors(d,r),p=l-o,_=u.dot(a);this._pan(m),this._zoom(p),this._roll(_),this._consumeEvent(e)}else if(1===i&&1===s){const i=new A(n[0].clientX-t[0].clientX,n[0].clientY-t[0].clientY).divideScalar(10);this._rotate(i),this._consumeEvent(e)}else this.logger.warn("Ignoring inconsistent touches event.");this.previousTouches=n}_onMouseEnter(e){this.enabled&&(e.preventDefault(),this.impose(),e.target.constructor!==HTMLDocument&&this._domElement.focus())}_onMouseLeave(e){this.enabled&&(e.preventDefault(),e.target.constructor!==HTMLDocument&&this._domElement.blur(),this.dispose(),this._state=Mt.None)}_onMouseDown(e){if(!this.enabled)return;e.preventDefault();const t=this.actionsMap,n=e.button;t.front.includes(n)?(this._state=Mt.Moving,this._front(),this._consumeEvent(e)):t.back.includes(n)?(this._state=Mt.Moving,this._back(),this._consumeEvent(e)):t.up.includes(n)?(this._state=Mt.Moving,this._up(),this._consumeEvent(e)):t.down.includes(n)?(this._state=Mt.Moving,this._down(),this._consumeEvent(e)):t.left.includes(n)?(this._state=Mt.Moving,this._left(),this._consumeEvent(e)):t.right.includes(n)?(this._state=Mt.Moving,this._right(),this._consumeEvent(e)):t.rotate.includes(n)?(this._state=Mt.Rotating,this._consumeEvent(e)):t.pan.includes(n)?(this._state=Mt.Panning,this._consumeEvent(e)):t.roll.left.includes(n)?(this._state=Mt.Rolling,this._consumeEvent(e)):t.roll.right.includes(n)?(this._state=Mt.Rolling,this._consumeEvent(e)):t.zoom.includes(n)?(this._state=Mt.Zooming,this._consumeEvent(e)):this._state=Mt.None}_onMouseMove(e){if(!this.enabled||this._state===Mt.None)return;e.preventDefault();const t=this._state,n={x:e.movementX||e.mozMovementX||e.webkitMovementX||0,y:e.movementY||e.mozMovementY||e.webkitMovementY||0};switch(t){case Mt.Moving:break;case Mt.Rotating:this._rotate(n),this._consumeEvent(e);break;case Mt.Panning:this._pan(n),this._consumeEvent(e);break;case Mt.Rolling:this._roll(n),this._consumeEvent(e);break;case Mt.Zooming:this._zoom(n),this._consumeEvent(e);break;default:throw new RangeError(`Unknown state: ${t}`)}}_onMouseWheel(e){if(!this.enabled)return;e.preventDefault();const t=e.wheelDelta||e.deltaY;this._zoom(t),this._consumeEvent(e)}_onMouseUp(e){this.enabled&&(e.preventDefault(),this._state=Mt.None)}_onDblClick(e){this.enabled&&(e.preventDefault(),this.logger.warn("CameraControls: Double click events is not implemented yet, sorry for the disagreement."))}_front(){if(this.canMove&&this.canFront){if("PerspectiveCamera"===this._camera.type){const e=vt.clone().applyQuaternion(this._camera.quaternion),t=this._trackPath?this._getPathDisplacement(e):e.multiplyScalar(this.frontSpeed);this._camera.position.add(t),this._target.position.add(t)}this.dispatchEvent({type:"move"}),this.dispatchEvent({type:"change"})}}_back(){if(this.canMove&&this.canBack){if("PerspectiveCamera"===this._camera.type){const e=bt.clone().applyQuaternion(this._camera.quaternion),t=this._trackPath?this._getPathDisplacement(e):e.multiplyScalar(this.backSpeed);this._camera.position.add(t),this._target.position.add(t)}this.dispatchEvent({type:"move"}),this.dispatchEvent({type:"change"})}}_up(){if(this.canMove&&this.canUp){if("PerspectiveCamera"===this._camera.type){const e=gt.clone().applyQuaternion(this._camera.quaternion).multiplyScalar(this.upSpeed);this._camera.position.add(e),this._target.position.add(e)}this.dispatchEvent({type:"move"}),this.dispatchEvent({type:"change"})}}_down(){if(this.canMove&&this.canDown){if("PerspectiveCamera"===this._camera.type){const e=yt.clone().applyQuaternion(this._camera.quaternion).multiplyScalar(this.downSpeed);this._camera.position.add(e),this._target.position.add(e)}this.dispatchEvent({type:"move"}),this.dispatchEvent({type:"change"})}}_left(){if(this.canMove&&this.canLeft){if("PerspectiveCamera"===this._camera.type){const e=xt.clone().applyQuaternion(this._camera.quaternion).multiplyScalar(this.leftSpeed);this._camera.position.add(e),this._target.position.add(e)}this.dispatchEvent({type:"move"}),this.dispatchEvent({type:"change"})}}_right(){if(this.canMove&&this.canRight){if("PerspectiveCamera"===this._camera.type){const e=Et.clone().applyQuaternion(this._camera.quaternion).multiplyScalar(this.rightSpeed);this._camera.position.add(e),this._target.position.add(e)}this.dispatchEvent({type:"move"}),this.dispatchEvent({type:"change"})}}_rotate(e){if(this.canRotate){if("PerspectiveCamera"===this._camera.type){const t=this._camera.position,n=this._target.position,i=t.distanceTo(n),s=(new E).subVectors(t,n).normalize(),o=this.rotateSpeed;switch(this._mode){case Pt.FirstPerson:const a=e.x,c=e.y,h=new E(-a,c,0).applyQuaternion(this._camera.quaternion).multiplyScalar(o).add(n),l=(new E).subVectors(h,t).normalize(),d=gt.clone().dot(l),u=Et.clone().dot(l),m=.97;if(d<-m||d>m||u<-2||u>2)return;const p=l.multiplyScalar(1).add(t);this.setTargetPosition(p);break;case Pt.Orbit:const _=(new T).setFromVector3(s),f=_.theta+r(-e.x)*o,w=_.phi+r(-e.y)*o;_.theta=Math.max(this.minAzimuthAngle,Math.min(this.maxAzimuthAngle,f)),_.phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,w));const v=(new E).setFromSpherical(_).multiplyScalar(i).add(n);this.setCameraPosition(v);break;default:throw new RangeError(`Unamanaged rotation for camera mode ${this._mode}`)}}this.dispatchEvent({type:"rotate"}),this.dispatchEvent({type:"change"})}}_pan(e){if(this.canPan){if("PerspectiveCamera"===this._camera.type){const t=this._camera.position,n=this._target.position,i=t.distanceTo(n),s=new E(-e.x,e.y,0).applyQuaternion(this._camera.quaternion).multiplyScalar(this.panSpeed*i);this._camera.position.add(s),this._target.position.add(s)}this.dispatchEvent({type:"pan"}),this.dispatchEvent({type:"change"})}}_roll(e){if(this.canRoll){if("PerspectiveCamera"===this._camera.type){const t=this._camera.position,n=this._target.position,i=(new E).subVectors(t,n).normalize(),s=e*this.rollSpeed;this._camera.up.applyAxisAngle(i,s),this._camera.lookAt(n)}this.dispatchEvent({type:"roll"}),this.dispatchEvent({type:"change"})}}_zoom(e){if(this.canZoom){if("PerspectiveCamera"===this._camera.type)switch(this._mode){case Pt.FirstPerson:e>0?this._camera.fov--:this._camera.fov++,this._camera.updateProjectionMatrix();break;case Pt.Orbit:const t=this._camera.position,n=this._target.position,i=t.distanceTo(n),s=vt.clone().applyQuaternion(this._camera.quaternion).multiplyScalar(e*this.zoomSpeed*i);let o=t.clone().add(s);const r=(new E).subVectors(o,t).normalize(),a=(new E).subVectors(t,n).normalize(),c=(new E).subVectors(o,n).normalize(),h=r.dot(a),l=r.dot(c),d=o.distanceToSquared(n);h<0&&(d<this.zoomMinimum*this.zoomMinimum||l>0)&&(o=a.clone().multiplyScalar(this.zoomMinimum).add(n)),this._camera.position.copy(o);break;default:throw new RangeError(`Invalid camera control mode parameter: ${this._mode}`)}this.dispatchEvent({type:"zoom"}),this.dispatchEvent({type:"change"})}}_lookAt(e){if(this.canLookAt){if("PerspectiveCamera"===this._camera.type){const t=e.clone(),n=this._camera.position,i=this._target.position,s=n.distanceTo(i);switch(this.mode){case Pt.FirstPerson:t.y=-t.y;const e=t.multiplyScalar(s).add(n);this.setTargetPosition(e);break;case Pt.Orbit:const o=t.multiplyScalar(s).add(i);this.setCameraPosition(o);break;default:throw new RangeError(`Invalid camera control mode parameter: ${this._mode}`)}}this.dispatchEvent({type:"lookAt"}),this.dispatchEvent({type:"change"})}}_initPathDisplacement(){if(l(this._paths))this.logger.warn("Try to init path displacement without any paths");else switch(d(this._currentPath)&&(this._currentPathIndex=0,this._currentPathOffset=0,this._currentPath=this._paths[0]),this._currentPathPosition=this._currentPath.getPointAt(this._currentPathOffset),this._mode){case Pt.FirstPerson:if(this._lockedTarget){const e=(new E).subVectors(this._currentPathPosition,this.camera.position);this._camera.position.add(e),this._target.position.add(e)}else this.setCameraPosition(this._currentPathPosition);break;case Pt.Orbit:if(this._lockedTarget){const e=(new E).subVectors(this._currentPathPosition,this.target.position);this._camera.position.add(e),this._target.position.add(e)}else this.setTargetPosition(this._currentPathPosition);break;default:throw new RangeError(`Invalid camera control _mode parameter: ${this._mode}`)}}_getPathDisplacement(e){let t=null;const n=this._currentPathPosition,i=this._currentPathOffset+this._cameraJump,s=i<1?i:1,o=this._currentPath.getPointAt(s),r=(new E).subVectors(o,n),a=r.clone().normalize(),c=e.dot(a),h=this._currentPathOffset-this._cameraJump,l=h>0?h:0,d=this._currentPath.getPointAt(l),u=(new E).subVectors(d,n),m=u.clone().normalize(),p=e.dot(m);if(0===c&&p<0){const n=this._getDirectionsMap();let i=void 0,s=void 0,o=-1,r=void 0;n.forEach(t=>{const n=t.index,a=t.startDisplacement;if(a){const t=a.clone().normalize(),c=e.dot(t);c>o&&(i=n,s=a,o=c,r=!0)}const c=t.endDisplacement;if(c){const t=c.clone().normalize(),a=e.dot(t);a>o&&(i=n,s=c,o=a,r=!1)}}),void 0!==i?(this._currentPathIndex=i,this._currentPath=this._paths[this._currentPathIndex],this._currentPathOffset=r?this._cameraJump:1-this._cameraJump,this._currentPathPosition=this._currentPath.getPointAt(this._currentPathOffset),t=s):(this.logger.warn("Reach path end."),t=new E)}else if(c>0&&p<=0)t=r,this._currentPathOffset=s,this._currentPathPosition=o;else if(c<=0&&p>0)t=u,this._currentPathOffset=l,this._currentPathPosition=d;else if(c<0&&0===p){const n=this._getDirectionsMap();let i=void 0,s=void 0,o=-1,r=void 0;n.forEach(t=>{const n=t.index,a=t.startDisplacement;if(a){const t=a.clone().normalize(),c=e.dot(t);c>o&&(i=n,s=a,o=c,r=!0)}const c=t.endDisplacement;if(c){const t=c.clone().normalize(),a=e.dot(t);a>o&&(i=n,s=c,o=a,r=!1)}}),void 0!==i?(this._currentPathIndex=i,this._currentPath=this._paths[this._currentPathIndex],this._currentPathOffset=r?this._cameraJump:1-this._cameraJump,this._currentPathPosition=this._currentPath.getPointAt(this._currentPathOffset),t=s):(this.logger.warn("Reach path start."),t=new E)}else c<0&&p<0||c>0&&p>0?c>p?(t=r,this._currentPathOffset=s,this._currentPathPosition=o):(t=u,this._currentPathOffset=l,this._currentPathPosition=d):(this.logger.warn("Unable to find correct next path position."),t=new E);return t}_getDirectionsMap(){const e=this._currentPathPosition,t=this._currentPathIndex,n=this._cameraJump,i=this._maxJump;return this._paths.reduce((s,o,r)=>{if(r===t)return s;const a=o.getPointAt(0);let c=void 0;e.distanceToSquared(a)<i&&(c=(new E).subVectors(o.getPointAt(n),a));const h=o.getPointAt(1);let l=void 0;return e.distanceToSquared(h)<i&&(l=(new E).subVectors(o.getPointAt(1-n),h)),(c||l)&&s.push({index:r,startDisplacement:c,endDisplacement:l}),s},[])}}const Tt=Math.PI/2,Dt={NONE:-1,ROTATE:0,ZOOM:1,PAN:2},kt=new E(1,0,0),St=new E(0,1,0);function Ct(n={}){const i={camera:null,target:new M,mode:Pt.Orbit,domElement:window,...n},s=this;let o=Dt.NONE;this.camera=i.camera,this.cameraJump=0,this.paths=[],this.pathsMap=new Map,this.currentPath=void 0,this.currentPathIndex=-1,this.currentPathPosition=0,this.domElement=void 0!==domElement?domElement:document,this.forwardControl=this.domElement.children[0].children[0].children[0],this.backwardControl=this.domElement.children[0].children[1].children[0],this.timeoutId=void 0,this.enabled=!1,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=.0025,this.enablePan=!0,this.keyPanSpeed=7,this.verticalOffset=1.5,this.keysCodes={forwardKeys:[t.Z,t.UP_ARROW],backwardKeys:[t.S,t.BOTTOM_ARROW]};let r={x:new D,y:new D};function a(){if(s.currentPathPosition+=s.cameraJump,s.currentPathPosition>1){e.log("reachEnd");var t=s.pathsMap.get(s.currentPathIndex).indexOfNextPath;s.pathsMap.get(t).indexOfNextPath===s.currentPathIndex?s.currentPathPosition=1:s.currentPathPosition=0,s.currentPathIndex=t,s.currentPath=s.paths[t]}s.update(),s.dispatchEvent({type:"move"})}function c(){if(s.currentPathPosition-=s.cameraJump,s.currentPathPosition<0){e.log("reachStart");var t=s.pathsMap.get(s.currentPathIndex).indexOfPreviousPath;s.pathsMap.get(t).indexOfPreviousPath===s.currentPathIndex?s.currentPathPosition=0:s.currentPathPosition=1,s.currentPathIndex=t,s.currentPath=s.paths[t]}s.update(),s.dispatchEvent({type:"move"})}function h(t){if(!1!==s.enabled){var n=s.currentPath.getPointAt(s.currentPathPosition),i=void 0;i=s.currentPathPosition+s.cameraJump>1?s.currentPath.getPointAt(s.currentPathPosition-s.cameraJump).sub(n).normalize().negate():s.currentPath.getPointAt(s.currentPathPosition+s.cameraJump).sub(n).normalize();var o=camera.getWorldDirection().normalize().dot(i);o>0&&s.keysCodes.forwardKeys.includes(t.keyCode)?(t.preventDefault(),a()):o<0&&s.keysCodes.forwardKeys.includes(t.keyCode)?(t.preventDefault(),c()):o>0&&s.keysCodes.backwardKeys.includes(t.keyCode)?(t.preventDefault(),c()):o<0&&s.keysCodes.backwardKeys.includes(t.keyCode)?(t.preventDefault(),a()):e.warn("The key event is not implemented for key code: "+t.keyCode)}}function l(e){!1!==s.enabled&&(s.keysCodes.forwardKeys.includes(e.keyCode)||s.keysCodes.backwardKeys.includes(e.keyCode))&&(e&&e.preventDefault(),s.dispatchEvent({type:"moveEnd"}))}function d(e){!1!==s.enabled&&(e.preventDefault(),!0===s.enableRotate&&e.button===s.mouseButtons.ORBIT?o=Dt.ROTATE:!0===s.enableZoom&&e.button===s.mouseButtons.ZOOM||!0===s.enablePan&&(e.button,s.mouseButtons.PAN))}function u(e){!1!==s.enabled&&(e.preventDefault(),o===Dt.ROTATE&&function(e){var t=e.movementX||e.mozMovementX||e.webkitMovementX||0,n=e.movementY||e.mozMovementY||e.webkitMovementY||0,i=s.orientation;i.y+=t*s.rotateSpeed,i.x+=n*s.rotateSpeed,i.x=Math.max(-Tt,Math.min(Tt,i.x)),s.update(),s.dispatchEvent({type:"rotate"})}(e))}function m(e){!1!==s.enabled&&(e&&e.preventDefault(),o=Dt.NONE,s.dispatchEvent({type:"rotateEnd"}))}this.mouseButtons={ORBIT:k.LEFT,ZOOM:k.MIDDLE,PAN:k.RIGHT},this.orientation={x:0,y:0},this.update=function(){if(!1!==this.enabled){var e=this.currentPath.getPointAt(this.currentPathPosition);this.camera.position.x=e.x,this.camera.position.y=e.y+this.verticalOffset,this.camera.position.z=e.z,r.x.setFromAxisAngle(kt,this.orientation.x),r.y.setFromAxisAngle(St,this.orientation.y),this.camera.quaternion.copy(r.y).multiply(r.x)}},this.dispose=function(){this.domElement.removeEventListener("mousedown",d,!1),this.domElement.removeEventListener("mousemove",u,!1),this.domElement.removeEventListener("mouseup",m,!1),window.removeEventListener("keydown",h,!1),window.removeEventListener("keyup",l,!1)},this.domElement.addEventListener("mousedown",d,!1),this.domElement.addEventListener("mousemove",u,!1),this.domElement.addEventListener("mouseup",m,!1),window.addEventListener("keydown",h,!1),window.addEventListener("keyup",l,!1),this.forwardControl.addEventListener("click",function(e){clearTimeout(s.timeoutId),e.keyCode=t.UP_ARROW,h(e),s.timeoutId=setTimeout(l.bind(s),750)},!1),this.backwardControl.addEventListener("click",function(e){clearTimeout(s.timeoutId),e.keyCode=t.BOTTOM_ARROW,h(e),s.timeoutId=setTimeout(l.bind(s),750)},!1)}Object.assign(Ct.prototype,x.prototype,{get camera(){return this._camera},set camera(e){if(a(e))throw new Error("Camera cannot be null ! Expect an instance of Camera");if(c(e))throw new Error("Camera cannot be undefined ! Expect an instance of Camera");if(!(e instanceof P))throw new Error(`Camera cannot be an instance of ${e.constructor.name}. Expect an instance of Camera.`);this._camera=e},setCamera(e){return this.camera=e,this},setPath(e){this.currentPath=e,this.cameraJump=1/e.getLength()},setPaths(e,t){this.paths=e,this.currentPathIndex=0;for(var n=this.paths[this.currentPathIndex],i=this.paths.length,s=void 0,o=void 0,r=void 0,a=void 0,c=void 0,h=void 0,l=0;l<i;l++){o=(s=this.paths[l]).getPointAt(0),r=s.getPointAt(1),t&&s.name===t&&(n=s,this.currentPathIndex=l);for(var d=1/0,u=1/0,m=void 0,p=void 0,_=0;_<i;_++)l!==_&&(c=(a=this.paths[_]).getPointAt(0),h=a.getPointAt(1),o.distanceTo(c)<d&&(d=o.distanceTo(c),m=_),o.distanceTo(h)<d&&(d=o.distanceTo(h),m=_),r.distanceTo(c)<u&&(u=r.distanceTo(c),p=_),r.distanceTo(h)<u&&(u=r.distanceTo(h),p=_));this.pathsMap.set(l,{indexOfPreviousPath:m,indexOfNextPath:p})}this.setPath(n)},setMouseQuat(e){this.orientation.y=2*Math.asin(e.y),this.orientation.x=0},getCurrentPathPosition(){return this.currentPath.getPointAt(this.currentPathPosition)},getNextPathPosition(){return this.currentPathPosition+this.cameraJump>1?this.currentPath.getPointAt(this.currentPathPosition-this.cameraJump).negate():this.currentPath.getPointAt(this.currentPathPosition+this.cameraJump)},getDistanceFromStart(){return this.currentPathPosition*this.currentPath.getLength()},lookAtPath(){var e=this.getNextPathPosition();e.y=this.camera.position.y,this.camera.lookAt(e),this.setMouseQuat(this.camera.quaternion)},goTo(e){for(var t=void 0,n=void 0,i=void 0,s=void 0,o=void 0,r=void 0,a=void 0,c=1/0,h=0,l=this.paths.length;h<l;h++){n=this.paths[h],t=Math.floor(n.getLength()),i=n.getSpacedPoints(t);for(var d=0;d<t;d++)(a=e.distanceTo(i[d]))<c&&(c=a,r=h,o=n,s=d)}this.setPath(o),this.currentPathIndex=r,this.currentPathPosition=this.cameraJump*s,this.lookAtPath(),this.update(),this.dispatchEvent({type:"moveEnd"}),this.dispatchEvent({type:"rotateEnd"})}});class zt extends Z{constructor(e=new E(0,0,0),t=new E(1,0,0)){super(),this.type="LineGeometry",this.addAttribute("position",new W([e.x,e.y,e.z,t.x,t.y,t.z],3))}}class Ot extends S{constructor(){super(),this.geometry=new C(new z(2,2,2)),this.material=new O({color:16777215}),this.normalPlanes={normalRightSide:new E(-1,0,0),normalLeftSide:new E(1,0,0),normalFrontSide:new E(0,-1,0),normalBackSide:new E(0,1,0),normalTopSide:new E(0,0,-1),normalBottomSide:new E(0,0,1)},this.planes={rightSidePlane:new B(this.normalPlanes.normalRightSide.clone(),0),leftSidePlane:new B(this.normalPlanes.normalLeftSide.clone(),0),frontSidePlane:new B(this.normalPlanes.normalFrontSide.clone(),0),backSidePlane:new B(this.normalPlanes.normalBackSide.clone(),0),topSidePlane:new B(this.normalPlanes.normalTopSide.clone(),0),bottomSidePlane:new B(this.normalPlanes.normalBottomSide.clone(),0)},this._boundingBox=new L}getBoundingSphere(){return this.geometry.computeBoundingSphere(),this.geometry.boundingSphere.applyMatrix4(this.matrixWorld),this.geometry.boundingSphere}setColor(e){this.material.color.set(e)}applyClippingTo(e,t){if(d(t))return;let n=[];for(let e in this.planes)n.push(this.planes[e]);t.traverse(t=>{if(d(t))return;if(d(t.geometry))return;if(d(t.material))return;const i=u(t.material)?t.material:[t.material];for(let t=0,s=i.length;t<s;t++){let s=i[t];s.clippingPlanes||(s.clippingPlanes=[]),s.clippingPlanes=e?n:[]}})}updateSize(e){this.scale.set(e.x,e.y,e.z)}update(){this._boundingBox.setFromObject(this);const e=this._boundingBox.min,t=this._boundingBox.max;this.planes.rightSidePlane.constant=t.x+0,this.planes.leftSidePlane.constant=0-e.x,this.planes.frontSidePlane.constant=t.y+0,this.planes.backSidePlane.constant=0-e.y,this.planes.topSidePlane.constant=t.z+0,this.planes.bottomSidePlane.constant=0-e.z}}class Bt extends G{constructor(e){super(e),this.isHighlightableMaterial=!0,this.depthTest=!1,this.depthWrite=!1,this.fog=!1,this.side=j,this.transparent=!0,this.oldColor=this.color.clone()}highlight(e){if(e){const e=.35,t=this.color.r,n=this.color.g,i=this.color.b,s=Math.min(Math.max(0,t+t*e),1),o=Math.min(Math.max(0,n+n*e),1),r=Math.min(Math.max(0,i+i*e),1);this.color.setRGB(s,o,r)}else this.color.copy(this.oldColor)}}class Lt extends O{constructor(e){super(e),this.isHighlightableMaterial=!0,this.depthTest=!1,this.depthWrite=!1,this.fog=!1,this.transparent=!0,this.linewidth=1,this.oldColor=this.color.clone()}highlight(e){if(e){const e=.35,t=this.color.r,n=this.color.g,i=this.color.b,s=Math.min(Math.max(0,t+t*e),1),o=Math.min(Math.max(0,n+n*e),1),r=Math.min(Math.max(0,i+i*e),1);this.color.setRGB(s,o,r)}else this.color.copy(this.oldColor)}}class Gt extends U{constructor(e={}){const t={geometry:new Z,material:new G({visible:!1,depthTest:!1,depthWrite:!1,fog:!1,side:j}),...e};super(t.geometry,t.material),this.isHitbox=!0,this.type="Hitbox"}}class jt extends Gt{constructor(e={}){const t=new q(.2,0,1,4,1,!1);t.translate(0,.5,0),super({geometry:t,...e}),this.isCylindricaHitbox=!0,this.type="CylindricaHitbox"}}class It extends Gt{constructor(e={}){const t=new Z;t.addAttribute("position",new W([0,0,0,1.1,0,0,1.1,1.1,0,0,1.1,0],3)),t.setIndex([0,1,2,2,3,0]),super({geometry:t,...e}),this.isPlanarHitbox=!0,this.type="PlanarHitbox"}}class Ut extends Gt{constructor(e={}){const t=new W([0,0,0,.85,0,0,1.1,1.1,0,0,.85,0],3),n=new Z;n.addAttribute("position",t),n.setIndex([0,1,2,2,3,0]),super({geometry:n,...e}),this.isPlanarHitbox=!0,this.type="PlanarHitbox"}}class Rt extends Gt{constructor(e={}){super({geometry:new H(1.2,0),...e}),this.isOctahedricalHitbox=!0,this.type="OctahedricalHitbox"}}class Ht extends Gt{constructor(e={}){super({geometry:new X(1,.12,4,12,Math.PI),...e}),this.isTorusHitbox=!0,this.type="TorusHitbox"}}class Ft extends M{constructor(e={}){const t={color:16777215,hitbox:null,...e};super(),this.isHandle=!0,this.type="Handle",this.color=t.color,this.hitbox=t.hitbox,this.baseQuaternion=new D}get color(){return this.line.material.color.clone()}set color(e){if(a(e))throw new Error("Color cannot be null ! Expect an instance of Color.");if(c(e))throw new Error("Color cannot be undefined ! Expect an instance of Color.");this.traverse(t=>{let n=t.material;n&&n.color.setHex(e)})}get hitbox(){return this._hitbox}set hitbox(e){this._hitbox=e,this.add(e)}setColor(e){return this.color=e,this}setHitbox(e){return this.hitbox=e,this}setScale(e,t,n){return this.scale.set(e,t,n),this}setPosition(e,t,n){return this.position.set(e,t,n),this}highlight(e){for(let t=0,n=this.children.length;t<n;t++){const n=this.children[t];if(n.isHitbox)continue;const i=n.material;!c(i)&&i.isHighlightableMaterial&&i.highlight(e)}}raycast(e,t){const n=e.intersectObject(this._hitbox,!1);n.length>0&&t.push({distance:n[0].distance,object:this})}setRotationFromAxisAndAngle(e,t){return this.quaternion.setFromAxisAngle(e,t),this.baseQuaternion.copy(this.quaternion),this}update(e){}}class Nt extends Ft{constructor(e={}){const t={color:16777215,hitbox:new jt,direction:new E(0,1,0),...e};super(t),this.isTranslateHandle=!0,this.type="TranslateHandle";const n=new zt(new E(0,0,0),new E(0,.8,0)),i=new Lt({color:t.color}),s=new R(n,i);this.add(s);const o=new Y(.05,.2,12,1,!1);o.translate(0,.9,0);const r=new Bt({color:t.color}),a=new U(o,r);this.add(a),this.direction=t.direction}get direction(){return this._direction}set direction(e){if(a(e))throw new Error("Direction cannot be null ! Expect an instance of Color.");if(c(e))throw new Error("Direction cannot be undefined ! Expect an instance of Color.");if(!(e instanceof E))throw new Error(`Direction cannot be an instance of ${e.constructor.name}. Expect an instance of Vector3.`);if(this._direction=e,e.y>.99999)this.quaternion.set(0,0,0,1);else if(e.y<-.99999)this.quaternion.set(1,0,0,0);else{const t=new E(e.z,0,-e.x).normalize(),n=Math.acos(e.y);this.quaternion.setFromAxisAngle(t,n)}}update(e){super.update(e),this._direction.dot(e)>=0&&this.flipDirection()}setDirection(e){return this.direction=e,this}flipDirection(){this.direction=this._direction.negate()}}class Xt extends Ft{constructor(e={}){const t={color:16777215,hitbox:new jt,direction:new E(0,1,0),...e};super(t),this.isScaleHandle=!0,this.type="ScaleHandle";const n=new zt(new E(0,0,0),new E(0,.88,0)),i=new Lt({color:t.color}),s=new R(n,i);this.add(s);const o=new z(.12,.12,.12);o.translate(0,.94,0);const r=new Bt({color:t.color}),a=new U(o,r);this.add(a),this.direction=t.direction}get direction(){return this._direction}set direction(e){if(a(e))throw new Error("Direction cannot be null ! Expect an instance of Color.");if(c(e))throw new Error("Direction cannot be undefined ! Expect an instance of Color.");if(!(e instanceof E))throw new Error(`Direction cannot be an instance of ${e.constructor.name}. Expect an instance of Vector3.`);if(this._direction=e,e.y>.99999)this.quaternion.set(0,0,0,1);else if(e.y<-.99999)this.quaternion.set(1,0,0,0);else{const t=new E(e.z,0,-e.x).normalize(),n=Math.acos(e.y);this.quaternion.setFromAxisAngle(t,n)}}update(e){super.update(e),this._direction.dot(e)>=0&&this.flipDirection()}setDirection(e){return this.direction=e,this}flipDirection(){this.direction=this._direction.negate()}}class Yt extends Ft{constructor(e={}){const t={color:16777215,hitbox:new It,direction:new E(0,1,0),...e};super(t),this.isPlaneHandle=!0,this.type="PlaneHandle";const n=new Z;n.addAttribute("position",new W([.75,1,0,1,1,0,1,.75,0],3));const i=new Lt({color:t.color}),s=new R(n,i);this.add(s);const o=new Z;o.addAttribute("position",new W([.1,.1,0,1,.1,0,1,1,0,.1,1,0],3)),o.setIndex([0,1,2,2,3,0]);const r=new Bt({color:t.color,transparent:!0,opacity:.35}),a=new U(o,r);this.add(a),this.xAxis=new E(1,0,0),this.yAxis=new E(0,1,0),this.zAxis=new E(0,0,1),this.xDirection=new E(t.direction.x,0,0),this.yDirection=new E(0,t.direction.y,0),this.zDirection=new E(0,0,t.direction.z),this.direction=t.direction}get direction(){return this._direction}set direction(e){if(a(e))throw new Error("Direction cannot be null ! Expect an instance of Color.");if(c(e))throw new Error("Direction cannot be undefined ! Expect an instance of Color.");if(!(e instanceof E))throw new Error(`Direction cannot be an instance of ${e.constructor.name}. Expect an instance of Vector3.`);this._direction=e}update(e){super.update(e);const t=new E(this._direction.x,0,0),n=new E(0,this._direction.y,0),i=new E(0,0,this._direction.z),s=t.dot(e),o=n.dot(e),a=i.dot(e);this.quaternion.copy(this.baseQuaternion),s>0&&o>0&&0===a?(this.rotateOnAxis(this.zAxis,r(180)),this.xDirection.setX(-1),this.yDirection.setY(-1),this.zDirection.setZ(0)):s>0&&o<0&&0===a?(this.rotateOnAxis(this.zAxis,r(90)),this.xDirection.setX(-1),this.yDirection.setY(1),this.zDirection.setZ(0)):s<0&&o>0&&0===a?(this.rotateOnAxis(this.zAxis,r(270)),this.xDirection.setX(1),this.yDirection.setY(-1),this.zDirection.setZ(0)):s<0&&o<0&&0===a?(this.rotateOnAxis(this.zAxis,r(0)),this.xDirection.setX(1),this.yDirection.setY(1),this.zDirection.setZ(0)):s>0&&0===o&&a>0?(this.rotateOnAxis(this.zAxis,r(180)),this.xDirection.setX(-1),this.yDirection.setY(0),this.zDirection.setZ(-1)):s>0&&0===o&&a<0?(this.rotateOnAxis(this.zAxis,r(90)),this.xDirection.setX(-1),this.yDirection.setY(0),this.zDirection.setZ(1)):s<0&&0===o&&a>0?(this.rotateOnAxis(this.zAxis,r(270)),this.xDirection.setX(1),this.yDirection.setY(0),this.zDirection.setZ(-1)):s<0&&0===o&&a<0?(this.rotateOnAxis(this.zAxis,r(0)),this.xDirection.setX(1),this.yDirection.setY(0),this.zDirection.setZ(1)):0===s&&o>0&&a>0?(this.rotateOnAxis(this.zAxis,r(180)),this.xDirection.setX(0),this.yDirection.setY(-1),this.zDirection.setZ(-1)):0===s&&o>0&&a<0?(this.rotateOnAxis(this.zAxis,r(270)),this.xDirection.setX(0),this.yDirection.setY(-1),this.zDirection.setZ(1)):0===s&&o<0&&a>0?(this.rotateOnAxis(this.zAxis,r(90)),this.xDirection.setX(0),this.yDirection.setY(1),this.zDirection.setZ(-1)):0===s&&o<0&&a<0&&(this.rotateOnAxis(this.zAxis,r(0)),this.xDirection.setX(0),this.yDirection.setY(1),this.zDirection.setZ(1))}setDirection(e){return this.direction=e,this}flipXDirection(){this.xDirection.setX(-this.xDirection.x)}flipYDirection(){this.yDirection.setY(-this.yDirection.y)}flipZDirection(){this.zDirection.setZ(-this.zDirection.z)}}class Zt extends Ft{constructor(e={}){const t={color:16777215,hitbox:new Ut,direction:new E(1,1,0),...e};super(t),this.isPlaneHandle=!0,this.type="PlaneHandle";const n=new Z;n.addAttribute("position",new W([.1,.75,0,1,1,0,.75,.1,0],3));const i=new Lt({color:t.color}),s=new R(n,i);this.add(s);const o=new Z;o.addAttribute("position",new W([.1,.1,0,.75,.1,0,1,1,0,.1,.75,0],3)),o.setIndex([0,1,2,2,3,0]);const r=new Bt({color:t.color,transparent:!0,opacity:.35}),a=new U(o,r);this.add(a),this.direction=t.direction,this.xDirection=new E(t.direction.x,0,0),this.yDirection=new E(0,t.direction.y,0),this.zDirection=new E(0,0,t.direction.z),this.xAxis=new E(1,0,0),this.yAxis=new E(0,1,0),this.zAxis=new E(0,0,1)}get direction(){return this._direction}set direction(e){if(a(e))throw new Error("Direction cannot be null ! Expect an instance of Color.");if(c(e))throw new Error("Direction cannot be undefined ! Expect an instance of Color.");if(!(e instanceof E))throw new Error(`Direction cannot be an instance of ${e.constructor.name}. Expect an instance of Vector3.`);this._direction=e}update(e){super.update(e);const t=this.xDirection.dot(e),n=this.yDirection.dot(e),i=this.zDirection.dot(e);this.quaternion.copy(this.baseQuaternion),t>0&&n>0&&0===i?this.rotateOnAxis(this.zAxis,r(180)):t>0&&n<0&&0===i?this.rotateOnAxis(this.zAxis,r(90)):t<0&&n>0&&0===i?this.rotateOnAxis(this.zAxis,r(270)):t<0&&n<0&&0===i?this.rotateOnAxis(this.zAxis,r(0)):t>0&&0===n&&i>0?this.rotateOnAxis(this.zAxis,r(180)):t>0&&0===n&&i<0?this.rotateOnAxis(this.zAxis,r(90)):t<0&&0===n&&i>0?this.rotateOnAxis(this.zAxis,r(270)):t<0&&0===n&&i<0?this.rotateOnAxis(this.zAxis,r(0)):0===t&&n>0&&i>0?this.rotateOnAxis(this.zAxis,r(180)):0===t&&n>0&&i<0?this.rotateOnAxis(this.zAxis,r(270)):0===t&&n<0&&i>0?this.rotateOnAxis(this.zAxis,r(90)):0===t&&n<0&&i<0&&this.rotateOnAxis(this.zAxis,r(0))}setDirection(e){return this.direction=e,this}flipXAxis(){const e=this._direction.clone();e.x=-e.x,this.direction=e}flipYAxis(){const e=this._direction.clone();e.y=-e.y,this.direction=e}flipZAxis(){const e=this._direction.clone();e.z=-e.z,this.direction=e}}class Wt extends Ft{constructor(e={}){const t={color:16777215,hitbox:new Rt,...e};super(t),this.isOmnidirectionalHandle=!0,this.type="OmnidirectionalHandle";const n=new H(1,0),i=new Bt({color:t.color,transparent:!0,opacity:.55}),s=new U(n,i);this.add(s);const o=new C(n),r=new Lt({color:t.color,linewidth:4}),a=new S(o,r);this.add(a)}update(e){super.update(e)}}class qt extends M{constructor(){super(),this.isGizmo=!0,this.type="AbstractGizmo"}init(){this.handles=new M,this.add(this.handles);const e=new I(50,50,2,2),t=new G({side:j,visible:!1});this.intersectPlane=new U(e,t),this.add(this.intersectPlane);((e,t)=>{for(let n in e){const i=e[n];if(p(i))i.name=n,i.renderOrder=1/0,t.add(i);else for(let s=i.length;s--;){const i=e[n][s][0],o=e[n][s][1],r=e[n][s][2],a=e[n][s][3],c=e[n][s][4];i.name=n,i.tag=c,i.renderOrder=1/0,o&&i.position.set(o[0],o[1],o[2]),r&&i.rotation.set(r[0],r[1],r[2]),a&&i.scale.set(a[0],a[1],a[2]),i.updateMatrix();const h=i.geometry.clone();h.applyMatrix(i.matrix),i.geometry=h,i.position.set(0,0,0),i.rotation.set(0,0,0),i.scale.set(1,1,1),t.add(i)}}})(this.handleGizmos,this.handles)}highlight(e){for(let e in this.handleGizmos)this.handleGizmos[e].highlight(!1);const t=this.handleGizmos[e];t&&t.highlight(!0)}update(e,t){this.traverse(e=>{e.isHandle&&e.update(t)}),this.updateIntersectPlane(e)}updateIntersectPlane(e){this.intersectPlane.lookAt(e)}}class Vt extends qt{constructor(){super(),this.isTranslateGizmo=!0,this.type="TranslateGizmo",this.handleGizmos={X:new Nt({color:11141120,direction:new E(1,0,0)}),Y:new Nt({color:43520,direction:new E(0,1,0)}),Z:new Nt({color:170,direction:new E(0,0,1)}),XY:new Zt({color:11184640,direction:new E(1,1,0)}).setScale(.33,.33,1),YZ:new Zt({color:43690,direction:new E(0,1,1)}).setScale(.33,.33,1).setRotationFromAxisAndAngle(new E(0,1,0),r(-90)),XZ:new Zt({color:11141290,direction:new E(1,0,1)}).setScale(.33,.33,1).setRotationFromAxisAndAngle(new E(1,0,0),r(90)),XYZ:new Wt({color:11184810}).setScale(.15,.15,.15)},this.init()}}class $t extends qt{constructor(){super(),this.isRotateGizmo=!0,this.type="RotateGizmo";const e=(e,t,n)=>{const i=new Z;let s=[];n=n||1;for(let i=0;i<=64*n;++i)"x"===t&&s.push(0,Math.cos(i/32*Math.PI)*e,Math.sin(i/32*Math.PI)*e),"y"===t&&s.push(Math.cos(i/32*Math.PI)*e,0,Math.sin(i/32*Math.PI)*e),"z"===t&&s.push(Math.sin(i/32*Math.PI)*e,Math.cos(i/32*Math.PI)*e,0);return i.addAttribute("position",new W(s,3)),i};this.handleGizmos={X:[[new R(new e(1,"x",.5),new Lt({color:16711680}))],[new U(new H(.04,0),new Bt({color:16711680})),[0,0,.99],null,[3,1,1]]],Y:[[new R(new e(1,"y",.5),new Lt({color:65280}))],[new U(new H(.04,0),new Bt({color:65280})),[0,0,.99],null,[3,1,1]]],Z:[[new R(new e(1,"z",.5),new Lt({color:255}))],[new U(new H(.04,0),new Bt({color:255})),[.99,0,0],null,[1,3,1]]],E:[[new R(new e(1.25,"z",1),new Lt({color:13421568}))]],XYZ:[[new R(new e(1,"z",1),new Lt({color:7895160}))]]},this.pickerGizmos={X:[[new Ht,[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new Ht,[0,0,0],[Math.PI/2,0,0]]],Z:[[new Ht,[0,0,0],[0,0,-Math.PI/2]]],E:[[new Ht({radius:1.25,tube:.12,radialSegments:2,tubularSegments:24})]],XYZ:[[new Ht]]},this.init()}}class Jt extends qt{constructor(){super(),this.isScaleGizmo=!0,this.type="ScaleGizmo",this.handleGizmos={XYZ:new Wt({color:11184810}).setScale(.15,.15,.15),XY:new Yt({color:11184640,direction:new E(1,1,0)}).setScale(.33,.33,1),YZ:new Yt({color:43690,direction:new E(0,1,1)}).setScale(.33,.33,1).setRotationFromAxisAndAngle(new E(0,1,0),r(-90)),XZ:new Yt({color:11141290,direction:new E(1,0,1)}).setScale(.33,.33,1).setRotationFromAxisAndAngle(new E(1,0,0),r(90)),X:new Xt({color:11141120,direction:new E(1,0,0)}),Y:new Xt({color:43520,direction:new E(0,1,0)}),Z:new Xt({color:170,direction:new E(0,0,1)})},this.init()}}const Kt=o({None:0,Translate:1,Rotate:2,Scale:3});class Qt extends M{constructor(e={}){const n={camera:null,domElement:window,mode:Kt.None,objectsToClip:new M,...e};super(),this._handlers={onMouseEnter:this._onMouseEnter.bind(this),onMouseLeave:this._onMouseLeave.bind(this),onMouseDown:this._onMouseDown.bind(this),onMouseMove:this._onMouseMove.bind(this),onMouseWheel:this._onMouseWheel.bind(this),onMouseUp:this._onMouseUp.bind(this),onDblClick:this._onDblClick.bind(this),onTouchStart:this._onTouchStart.bind(this),onTouchEnd:this._onTouchEnd.bind(this),onTouchCancel:this._onTouchCancel.bind(this),onTouchLeave:this._onTouchLeave.bind(this),onTouchMove:this._onTouchMove.bind(this),onKeyDown:this._onKeyDown.bind(this),onKeyUp:this._onKeyUp.bind(this)},this._objectsToClipBoundingBox=new L,this._clippingBox=new Ot,this.add(this._clippingBox),this.camera=n.camera,this.domElement=n.domElement,this.mode=n.mode,this.objectsToClip=n.objectsToClip,this.translationSnap=.1,this.scaleSnap=.1,this.rotationSnap=.1,this.enabled=!1,this.size=1,this._dragging=!1,this._firstPoint=new E,this._secondPoint=new E,this._mouseDisplacement=new E,this._offset=new E,this._raycaster=new F,this._pointerVector=new A,this._directionToMouse=new E,this._cameraPosition=new E,this._cameraDirection=new E,this._worldPosition=new E,this._worldRotation=new N,this._gizmos={Translate:new Vt,Scale:new Jt};for(let e in this._gizmos)this.add(this._gizmos[e]);this._currentGizmo=null,this._currentHandle=null,this._events={change:{type:"change"},mouseEnter:{type:"mouseEnter"},mouseLeave:{type:"mouseLeave"},mouseDown:{type:"mouseDown"},mouseUp:{type:"mouseUp"},objectChange:{type:"objectChange"}},this.actionsMap={setMode:{translate:[t.T.value],rotate:[t.R.value],scale:[t.S.value]},translate:{front:[t.Z.value,t.UP_ARROW.value],back:[t.S.value,t.DOWN_ARROW.value],up:[t.A.value,t.PAGE_UP.value],down:[t.E.value,t.PAGE_DOWN.value],left:[t.Q.value,t.LEFT_ARROW.value],right:[t.D.value,t.RIGHT_ARROW.value]},scale:{widthPlus:[t.LEFT_ARROW.value],widthMinus:[t.RIGHT_ARROW.value],heightPlus:[t.PAGE_UP.value],heightMinus:[t.PAGE_DOWN.value],depthPlus:[t.UP_ARROW.value],depthMinus:[t.DOWN_ARROW.value]},rotate:{xAxis:[t.X.value],yAxis:[t.Y.value],zAxis:[t.Z.value]}}}get objectsToClip(){return this._objectsToClip}set objectsToClip(e){if(a(e))throw new Error("Objects to clip cannot be null ! Expect an instance of Object3D");if(c(e))throw new Error("Objects to clip cannot be undefined ! Expect an instance of Object3D");if(!(e instanceof M))throw new Error(`Objects to clip cannot be an instance of ${e.constructor.name}. Expect an instance of Object3D.`);this._objectsToClip=e;const t=new E;this._objectsToClipBoundingBox.makeEmpty().expandByObject(e).getSize(t);const n=Math.round(t.x)||50,i=Math.round(t.y)||22,s=Math.round(t.z)||70;this.scale.set(n,i,s),this._clippingBox.update()}get camera(){return this._camera}set camera(e){if(a(e))throw new Error("Camera cannot be null ! Expect an instance of Camera");if(c(e))throw new Error("Camera cannot be undefined ! Expect an instance of Camera");if(!(e instanceof P))throw new Error(`Camera cannot be an instance of ${e.constructor.name}. Expect an instance of Camera.`);this._camera=e}get domElement(){return this._domElement}set domElement(e){if(a(e))throw new Error("DomElement cannot be null ! Expect an instance of Window, HTMLDocument, HTMLDivElement or HTMLCanvasElement.");if(c(e))throw new Error("DomElement cannot be undefined ! Expect an instance of Window, HTMLDocument, HTMLDivElement or HTMLCanvasElement.");if(!(e instanceof Window||e instanceof HTMLDocument||e instanceof HTMLDivElement||e instanceof HTMLCanvasElement))throw new Error(`Target cannot be an instance of ${e.constructor.name}. Expect an instance of Window, HTMLDocument, HTMLDivElement or HTMLCanvasElement.`);this._domElement&&(this._domElement.removeEventListener("mouseenter",this._handlers.onMouseEnter,!1),this._domElement.removeEventListener("mouseleave",this._handlers.onMouseLeave,!1),this.dispose()),this._domElement=e,this._domElement.addEventListener("mouseenter",this._handlers.onMouseEnter,!1),this._domElement.addEventListener("mouseleave",this._handlers.onMouseLeave,!1),this.impose()}get mode(){return this._mode}set mode(e){if(a(e))throw new Error("Mode cannot be null ! Expect a value from ClippingModes enum.");if(c(e))throw new Error("Mode cannot be undefined ! Expect a value from ClippingModes enum.");if(!(e instanceof Kt))throw new Error(`Mode cannot be an instance of ${e.constructor.name}. Expect a value from TClippingModes enum.`);this._mode=e;for(let e in this._gizmos)this._gizmos[e].visible=!1;this._mode===Kt.None?this._currentGizmo=null:(this._currentGizmo=this._gizmos[this._mode.name],this._currentGizmo.visible=!0)}setCamera(e){return this.camera=e,this}setDomElement(e){return this.domElement=e,this}setMode(e){return this.mode=e,this}setObjectsToClip(e){return this.objectsToClip=e,this}impose(){this._domElement.addEventListener("keydown",this._handlers.onKeyDown,!1),this._domElement.addEventListener("keyup",this._handlers.onKeyUp,!1),this._domElement.addEventListener("dblclick",this._handlers.onDblClick,!1),this._domElement.addEventListener("mousedown",this._handlers.onMouseDown,!1),this._domElement.addEventListener("mousemove",this._handlers.onMouseMove,!1),this._domElement.addEventListener("mouseup",this._handlers.onMouseUp,!1),this._domElement.addEventListener("wheel",this._handlers.onMouseWheel,{capture:!0,once:!1,passive:!1}),this._domElement.addEventListener("touchcancel",this._handlers.onTouchCancel,!1),this._domElement.addEventListener("touchend",this._handlers.onTouchEnd,!1),this._domElement.addEventListener("touchleave",this._handlers.onTouchLeave,!1),this._domElement.addEventListener("touchmove",this._handlers.onTouchMove,{capture:!0,once:!1,passive:!1}),this._domElement.addEventListener("touchstart",this._handlers.onTouchStart,{capture:!0,once:!1,passive:!1}),this.dispatchEvent({type:"impose"})}dispose(){this._domElement.removeEventListener("keydown",this._handlers.onKeyDown,!1),this._domElement.removeEventListener("keyup",this._handlers.onKeyUp,!1),this._domElement.removeEventListener("dblclick",this._handlers.onDblClick,!1),this._domElement.removeEventListener("mousedown",this._handlers.onMouseDown,!1),this._domElement.removeEventListener("mousemove",this._handlers.onMouseMove,!1),this._domElement.removeEventListener("mouseup",this._handlers.onMouseUp,!1),this._domElement.removeEventListener("wheel",this._handlers.onMouseWheel,{capture:!0,once:!1,passive:!1}),this._domElement.removeEventListener("touchcancel",this._handlers.onTouchCancel,!1),this._domElement.removeEventListener("touchend",this._handlers.onTouchEnd,!1),this._domElement.removeEventListener("touchleave",this._handlers.onTouchLeave,!1),this._domElement.removeEventListener("touchmove",this._handlers.onTouchMove,{capture:!0,once:!1,passive:!1}),this._domElement.removeEventListener("touchstart",this._handlers.onTouchStart,{capture:!0,once:!1,passive:!1}),this.dispatchEvent({type:"dispose"})}setTranslationSnap(e){this.translationSnap=e}setRotationSnap(e){this.rotationSnap=e}enable(){this.visible=!0,this.enabled=!0,this.updateClipping()}disable(){this.visible=!1,this.enabled=!1,this.updateClipping()}updateClipping(){d(this._objectsToClip)||(this._clippingBox.update(),this._clippingBox.applyClippingTo(this.enabled,this._objectsToClip))}update(){this.enabled&&this._mode!==Kt.None&&(d(this._currentGizmo)||(this._camera.getWorldPosition(this._cameraPosition),this._camera.getWorldDirection(this._cameraDirection),this._currentGizmo.update(this._cameraPosition,this._cameraDirection)))}_consumeEvent(e){e.cancelable&&e.stopImmediatePropagation()}_onKeyDown(e){if(!this.enabled)return;e.preventDefault();const t=this.actionsMap,n=e.keyCode,i=e.altKey,s=e.ctrlKey,o=e.metaKey,r=e.shiftKey;if(i);else if(s)switch(this._mode){case Kt.Translate:t.translate.front.includes(n)?(this._translateZ(this.translationSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.objectChange)):t.translate.back.includes(n)?(this._translateZ(-this.translationSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.objectChange)):t.translate.right.includes(n)?(this._translateX(this.translationSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.objectChange)):t.translate.left.includes(n)?(this._translateX(-this.translationSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.objectChange)):t.translate.up.includes(n)?(this._translateY(this.translationSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.objectChange)):t.translate.down.includes(n)&&(this._translateY(-this.translationSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.objectChange));break;case Kt.Rotate:break;case Kt.Scale:t.scale.depthPlus.includes(n)?(this._scaleZ(this.scaleSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.objectChange)):t.scale.depthMinus.includes(n)?(this._scaleZ(-this.scaleSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.objectChange)):t.scale.widthPlus.includes(n)?(this._scaleX(this.scaleSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.objectChange)):t.scale.widthMinus.includes(n)?(this._scaleX(-this.scaleSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.objectChange)):t.scale.heightPlus.includes(n)?(this._scaleY(this.scaleSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.objectChange)):t.scale.heightMinus.includes(n)&&(this._scaleY(-this.scaleSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.objectChange))}else o||r||(t.setMode.translate.includes(n)?(this.setMode(Kt.Translate),this.updateClipping(),this._consumeEvent(e)):t.setMode.rotate.includes(n)?(this.setMode(Kt.Rotate),this.updateClipping(),this._consumeEvent(e)):t.setMode.scale.includes(n)&&(this.setMode(Kt.Scale),this.updateClipping(),this._consumeEvent(e)))}_onKeyUp(e){this.enabled&&!e.defaultPrevented&&e.preventDefault()}_onDblClick(e){this.enabled&&this._mode!==Kt.None&&e.preventDefault()}_onMouseDown(e){if(!this.enabled)return;if(this._mode===Kt.None)return;if(e.button!==n.LEFT.value)return;if(d(this._currentHandle))return;e.preventDefault(),this._dragging=!0;const t=this.intersectObjects(e,[this._currentGizmo.intersectPlane]);t&&(this._firstPoint=t.point),this._consumeEvent(e),this.dispatchEvent(this._events.mouseDown)}_onMouseEnter(e){this.enabled&&this._mode!==Kt.None&&(e.preventDefault(),this.impose(),e.target.constructor!==HTMLDocument&&this._domElement.focus())}_onMouseLeave(e){this.enabled&&this._mode!==Kt.None&&(e.preventDefault(),this._dragging=!1,e.target.constructor!==HTMLDocument&&this._domElement.blur(),this.dispose())}_onMouseMove(e){if(this.enabled&&this._mode!==Kt.None)if(e.preventDefault(),!1===this._dragging){const t=this.intersectObjects(e,this._currentGizmo.handles.children);if(t){const n=t.object;this._currentHandle&&n!==this._currentHandle&&(this._currentHandle.highlight(!1),this.dispatchEvent(this._events.mouseLeave)),this._currentHandle=n,this._currentHandle.highlight(!0),this.dispatchEvent(this._events.mouseEnter),this._consumeEvent(e)}else m(this._currentHandle)&&(this._currentHandle.highlight(!1),this._currentHandle=null,this.dispatchEvent(this._events.mouseLeave))}else{const t=this._currentHandle,n=t.name,i=this.intersectObjects(e,[this._currentGizmo.intersectPlane]);switch(i&&(this._secondPoint=i.point),this._mouseDisplacement.subVectors(this._secondPoint,this._firstPoint),this._firstPoint.copy(this._secondPoint),this._mode){case Kt.Translate:"X"===n?this._offset.set(1,0,0):"Y"===n?this._offset.set(0,1,0):"Z"===n?this._offset.set(0,0,1):"XY"===n?this._offset.set(1,1,0):"YZ"===n?this._offset.set(0,1,1):"XZ"===n?this._offset.set(1,0,1):"XYZ"===n&&this._offset.set(1,1,1),this._offset.multiply(this._mouseDisplacement),this._translate(this._offset);break;case Kt.Rotate:t.isRotateHandle||t.isPlaneHandle||t.isOmnidirectionalHandle;break;case Kt.Scale:if(t.isScaleHandle)this._offset.copy(this._currentHandle.direction).multiply(this._mouseDisplacement);else if(t.isPlaneHandle){const e=this._currentHandle.xDirection.dot(this._mouseDisplacement);e>0?this._offset.setX(Math.abs(this._mouseDisplacement.x)):e<0?this._offset.setX(-Math.abs(this._mouseDisplacement.x)):this._offset.setX(0);const t=this._currentHandle.yDirection.dot(this._mouseDisplacement);t>0?this._offset.setY(Math.abs(this._mouseDisplacement.y)):t<0?this._offset.setY(-Math.abs(this._mouseDisplacement.y)):this._offset.setY(0);const n=this._currentHandle.zDirection.dot(this._mouseDisplacement);n>0?this._offset.setZ(Math.abs(this._mouseDisplacement.z)):n<0?this._offset.setZ(-Math.abs(this._mouseDisplacement.z)):this._offset.setZ(0)}else if(t.isOmnidirectionalHandle){this.getWorldPosition(this._worldPosition),this._directionToMouse.subVectors(this._firstPoint,this._worldPosition);const e=this._directionToMouse.dot(this._mouseDisplacement)>0?this._mouseDisplacement.length():-this._mouseDisplacement.length();this._offset.set(e,e,e)}this._scale(this._offset);break;default:throw new RangeError(`Invalid switch parameter: ${this._mode}`)}this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.objectChange)}}_onMouseUp(e){if(!this.enabled)return;if(this._mode===Kt.None)return;if(event.button!==n.LEFT.value)return;e.preventDefault(),this._consumeEvent(e),this._dragging=!1,this.dispatchEvent(this._events.mouseUp);const t=this.intersectObjects(e,this._currentGizmo.handles.children);if(t){const n=t.object;this._currentHandle=n,this._currentHandle.highlight(!0),this._consumeEvent(e),this.dispatchEvent(this._events.mouseEnter)}else m(this._currentHandle)&&(this._currentHandle.highlight(!1),this._currentHandle=null,this.dispatchEvent(this._events.mouseLeave))}_onMouseWheel(e){this.enabled&&e.preventDefault()}_onTouchCancel(e){this.enabled&&e.preventDefault()}_onTouchEnd(e){this.enabled&&e.preventDefault()}_onTouchLeave(e){this.enabled&&e.preventDefault()}_onTouchMove(e){this.enabled&&e.preventDefault()}_onTouchStart(e){this.enabled&&e.preventDefault()}getActiveHandle(e){}intersectObjects(e,t){const n=this._domElement.getBoundingClientRect(),i=(e.clientX-n.left)/n.width*2-1,s=-(e.clientY-n.top)/n.height*2+1;this._pointerVector.set(i,s),this._raycaster.setFromCamera(this._pointerVector,this._camera);const o=this._raycaster.intersectObjects(t,!1);return o[0]?o[0]:null}_translate(e){this.position.add(e)}_translateX(e){this.position.setX(this.position.x+e)}_translateY(e){this.position.setY(this.position.y+e)}_translateZ(e){this.position.setZ(this.position.z+e)}_translateXY(e,t){this.position.setX(this.position.x+e),this.position.setY(this.position.y+t)}_translateXZ(e,t){this.position.setX(this.position.x+e),this.position.setZ(this.position.z+t)}_translateYZ(e,t){this.position.setY(this.position.y+e),this.position.setZ(this.position.z+t)}_translateXYZ(e,t,n){this.position.set(this.position.x+e,this.position.y+t,this.position.z+n)}_rotateX(e){}_rotateY(e){}_rotateZ(e){}_rotateXY(e){}_rotateXZ(e){}_rotateYZ(e){}_rotateXYZ(e){}_scale(e){this.scale.add(e)}_scaleX(e){this.scale.setX(this.scale.x+e)}_scaleY(e){this.scale.setY(this.scale.y+e)}_scaleZ(e){this.scale.setZ(this.scale.z+e)}_scaleXY(e,t){this.scale.setX(this.scale.x+e),this.scale.setY(this.scale.y+t)}_scaleXZ(e,t){this.scale.setX(this.scale.x+e),this.scale.setZ(this.scale.z+t)}_scaleYZ(e,t){this.scale.setY(this.scale.y+e),this.scale.setZ(this.scale.z+t)}_scaleXYZ(e,t,n){this.scale.set(this.scale.x+e,this.scale.y+t,this.scale.z+n)}}function en(){i.call(this),this.basePath="/buffergeometries"}function tn(){i.call(this),this.basePath="/curves"}en.prototype=Object.assign(Object.create(i.prototype),{constructor:en,convert(e,t){let n=void 0;switch(e.type){case"Scene":n=new V;break;default:n=new M}return n}}),Object.defineProperties(en.prototype,{_onJson:{value:function(e,t,n,i){const s=_(e)?[e]:e,o={};let r=void 0;for(let e=0,t=s.length,a=void 0;e<t;e++)a=s[e],(r=this.convert(a,i))&&(o[a._id]=r),n(e/t);t(o)}}}),tn.prototype=Object.assign(Object.create(i.prototype),{constructor:tn,convert(e){if(!e)throw new Error("CurvesManager: Unable to convert null or undefined data !");const t=e.type;let n=void 0;switch(t){case"ArcCurve":n=new $;break;case"CatmullRomCurve3":n=new J;break;case"CubicBezierCurve":n=new K;break;case"CubicBezierCurve3":n=new Q;break;case"Curve":n=new ee;break;case"CurvePath":n=new te;break;case"EllipseCurve":n=new ne;break;case"LineCurve":n=new ie;break;case"LineCurve3":n=new se;break;case"Path":n=new oe;break;case"QuadraticBezierCurve":n=new re;break;case"QuadraticBezierCurve3":n=new ae;break;case"SplineCurve":n=new ce;break;case"Shape":n=new he;break;default:throw new Error(`TCurvesManager: Unknown curve of type: ${t}`)}return n.fromJSON(e),n}}),Object.defineProperties(tn.prototype,{_onJson:{value:function(e,t,n,i){const s=_(e)?[e]:e,o={};for(let e=0,t=s.length,r=void 0;e<t;e++){r=s[e];try{o[r._id]=this.convert(r)}catch(e){i(e)}n(e/t)}t(o)}}});class nn extends i{constructor(t={}){super({basePath:"/",responseType:s.Json,bunchSize:500,requestAggregationTime:200,requestsConcurrency:6,logger:e,...t})}_onJson(e,t,n,i){const s=_(e)?[e]:e,o={};for(let e=0,t=s.length,r=void 0;e<t;e++){r=s[e];try{o[r.id]=this.convert(r)}catch(e){i(e)}n(new ProgressEvent("FilairesManager",{lengthComputable:!0,loaded:e+1,total:t}))}t(o)}convert(e){if(!e)throw new Error("FilairesManager: Unable to convert null or undefined data !");const t=e.type;let n=null;if(d(t))throw new Error("TFilaireManager.convert() : data type must be defined !!!");switch(t){case"NaissanceVoute":n=this._parseFilaire(e,8868096);break;case"Radier":n=this._parseFilaire(e,35247);break;case"Intrados":n=this._parseFilaire(e,12648628);break;case"Br":case"Bp":case"Src":n=this._parsePoint(e,65280);break;default:throw new Error(`TFilaireManager: Unknown object of type: ${t}`)}return n}_parseFilaire(e,t){const n=JSON.parse(e.geojson).coordinates.reduce((e,t)=>e.concat(t),[]);if(d(n))throw new Error(`TFilaireManager._parseFilaire() : ${e.type} geometry doesn't contains coordinates !!!`);const i=new O({color:t}),s=new Z;s.addAttribute("position",new W(n,3));let o=new R(s,i);return d(e.type)?o.name="".concat(e.id):o.name="".concat(e.type,"_").concat(e.numero_bloc,"_").concat(e.id),o}_parsePoint(e,t){const n=JSON.parse(e.geojson).coordinates.reduce((e,t)=>e.concat(t),[]);if(d(n))throw new Error("FilairesManager._parsePoint() : ".concat(e.type," geometry doesn't contains coordinates !!!"));let i=new le(parseFloat(e.attribut),50,50,0,2*Math.PI,0,2*Math.PI);i.computeVertexNormals();let s=new de({color:t}),o=new U(i,s);return o.position.set(n[0],n[1],n[2]),d(e.type)?o.name="".concat(e.id):o.name="".concat(e.type,"_").concat(e.numero_bloc,"_").concat(e.id),o}}const sn={Int8Array:0,Uint8Array:1,Uint8ClampedArray:2,Int16Array:3,Uint16Array:4,Int32Array:5,Uint32Array:6,Float32Array:7,Float64Array:8};class on extends i{constructor(e={}){const t={basePath:"/geometries",projectionSystem:"zBack",globalScale:1,computeNormals:!0,computeBoundingBox:!0,computeBoundingSphere:!0,...e};super(t),this.projectionSystem=t.projectionSystem,this.globalScale=t.globalScale,this.computeNormals=t.computeNormals,this.computeBoundingBox=t.computeBoundingBox,this.computeBoundingSphere=t.computeBoundingSphere}get computeBoundingBox(){return this._computeBoundingBox}set computeBoundingBox(e){if(a(e))throw new TypeError("Compute bounding box cannot be null ! Expect a boolean.");if(c(e))throw new TypeError("Compute bounding box cannot be undefined ! Expect a boolean.");if(h(e))throw new TypeError(`Compute bounding box cannot be an instance of ${e.constructor.name} ! Expect a boolean.`);this._computeBoundingBox=e}get computeBoundingSphere(){return this._computeBoundingSphere}set computeBoundingSphere(e){if(a(e))throw new TypeError("Compute bounding sphere cannot be null ! Expect a boolean.");if(c(e))throw new TypeError("Compute bounding sphere cannot be undefined ! Expect a boolean.");if(h(e))throw new TypeError(`Compute bounding sphere cannot be an instance of ${e.constructor.name} ! Expect a boolean.`);this._computeBoundingSphere=e}get computeNormals(){return this._computeNormals}set computeNormals(e){if(a(e))throw new TypeError("Compute normals cannot be null ! Expect a boolean.");if(c(e))throw new TypeError("Compute normals cannot be undefined ! Expect a boolean.");if(h(e))throw new TypeError(`Compute normals cannot be an instance of ${e.constructor.name} ! Expect a boolean.`);this._computeNormals=e}get projectionSystem(){return this._projectionSystem}set projectionSystem(e){if(a(e))throw new TypeError("Projection system cannot be null ! Expect a positive number.");if(c(e))throw new TypeError("Projection system cannot be undefined ! Expect a positive number.");this._projectionSystem=e}get globalScale(){return this._globalScale}set globalScale(e){if(a(e))throw new TypeError("Global scale cannot be null ! Expect a positive number.");if(c(e))throw new TypeError("Global scale cannot be undefined ! Expect a positive number.");this._globalScale=e}setComputeBoundingBox(e){return this.computeBoundingBox=e,this}setComputeBoundingShpere(e){return this.computeBoundingSphere=e,this}setComputeNormals(e){return this.computeNormals=e,this}setProjectionSystem(e){return this.projectionSystem=e,this}setGlobalScale(e){return this.globalScale=e,this}_onJson(e,t,n,i){const s=_(e)?[e]:e,o={};for(let e=0,t=s.length,r=void 0;e<t;e++){r=s[e];try{o[r._id]=this.convert(r)}catch(e){i(e)}n(new ProgressEvent("GeometriesManager",{lengthComputable:!0,loaded:e+1,total:t}))}t(o)}convert(e){if(!e)throw new Error("GeometriesManager: Unable to convert null or undefined data !");const t=e.type;if(!t)throw new Error("GeometriesManager: Unable to convert untyped data !");let n=null;if(e.isBufferGeometry||t.includes("BufferGeometry"))n=this._convertJsonToBufferGeometry(e),this._computeNormals&&n.computeVertexNormals();else{if(!e.isGeometry&&!t.includes("Geometry"))throw new Error(`TGeometriesManager: Unable to retrieve geometry of type ${t} !`);n=this._convertJsonToGeometry(e),this._computeNormals&&n.computeFaceNormals()}return this.computeBoundingBox&&(n.boundingBox=null,n.computeBoundingBox()),this.computeBoundingSphere&&(n.boundingSphere=null,n.computeBoundingSphere()),n}_convertJsonToGeometry(e){const t=e.types;let n=null;switch(t){case"BoxGeometry":n=new ue;break;case"CircleGeometry":n=new me;break;case"CylinderGeometry":n=new pe;break;case"ConeGeometry":n=new _e;break;case"EdgesGeometry":n=new C;break;case"DodecahedronGeometry":n=new fe;break;case"ExtrudeGeometry":n=new we;break;case"Geometry":n=new ve;break;case"IcosahedronGeometry":n=new be;break;case"LatheGeometry":n=new ge;break;case"OctahedronGeometry":n=new ye;break;case"ParametricGeometry":n=new Ee;break;case"PlaneGeometry":n=new xe;break;case"PolyhedronGeometry":n=new Me;break;case"RingGeometry":n=new Pe;break;case"ShapeGeometry":n=new Ae;break;case"TetrahedronGeometry":n=new Te;break;case"TextGeometry":n=new De;break;case"TorusGeometry":n=new ke;break;case"TorusKnotGeometry":n=new Se;break;case"TubeGeometry":n=new Ce;break;case"SphereGeometry":n=new ze;break;case"WireframeGeometry":n=new Oe;break;default:throw new Error(`TGeometriesManager: Unknown geometry of type: ${t}`)}n.uuid=e.uuid,n.name=e.name,n.type=e.type;for(var i=[],s=void 0,o=0,r=e.vertices.length;o<r;++o)s=e.vertices[o],i.push(new E(s.x,s.y,s.z));n.vertices=i;for(var a=[],c=void 0,h=0,l=e.faces.length;h<l;h++)c=e.faces[h],a.push(new Be(c.a,c.b,c.c,c.normal,c.color,c.materialIndex));n.faces=a,n.morphTargets=[],n.morphNormals=[],n.skinWeights=[],n.skinIndices=[],n.lineDistances=[],n.elementsNeedUpdate=!0,n.verticesNeedUpdate=!0,n.uvsNeedUpdate=!0,n.normalsNeedUpdate=!0,n.colorsNeedUpdate=!0,n.lineDistancesNeedUpdate=!0,n.groupsNeedUpdate=!0}_convertJsonToBufferGeometry(e){const t=e.type;let n=null;switch(t){case"BoxBufferGeometry":n=new z;break;case"BufferGeometry":n=new Z;break;case"CircleBufferGeometry":n=new Le;break;case"CylinderBufferGeometry":n=new q;break;case"ConeBufferGeometry":n=new Y;break;case"DodecahedronBufferGeometry":n=new Ge;break;case"ExtrudeBufferGeometry":n=new je;break;case"IcosahedronBufferGeometry":n=new Ie;break;case"LatheBufferGeometry":n=new Ue;break;case"OctahedronBufferGeometry":n=new H;break;case"ParametricBufferGeometry":n=new Re;break;case"PlaneBufferGeometry":n=new I;break;case"PolyhedronBufferGeometry":n=new He;break;case"RingBufferGeometry":n=new Fe;break;case"ShapeBufferGeometry":n=new Z;break;case"TetrahedronBufferGeometry":n=new Ne;break;case"TextBufferGeometry":n=new Xe;break;case"TorusBufferGeometry":n=new X;break;case"TorusKnotBufferGeometry":n=new Ye;break;case"TubeBufferGeometry":n=new Ze;break;case"SphereBufferGeometry":n=new le;break;case"InstancedBufferGeometry":n=new We;break;default:throw new Error(`TGeometriesManager: Unknown buffer geometry of type: ${t}`)}n._id=e._id,n.uuid=e.uuid,n.name=e.name;const i=e.index;if(i&&i.array&&i.array.length>0){const e=this.__convertBase64ToArrayBuffer(i.array),t=this.__convertArrayBufferToTypedArray(e);n.index=new qe(t,i.itemSize,i.normalized)}const s=e.attributes;if(s){let e={};const t=s.position;if(t){const n=this.__convertBase64ToArrayBuffer(t.array),i=this.__convertArrayBufferToTypedArray(n),s=this.globalScale,o=new Float32Array(i);if("zBack"===this._projectionSystem){let e=null,t=null,n=null;for(let i=0,r=o.length;i<r;i+=3)e=o[i]/s,t=o[i+2]/s,n=-o[i+1]/s,o[i]=e,o[i+1]=t,o[i+2]=n}else for(let e=0,t=o.length;e<t;e++)o[e]/=s;e.position=new qe(o,t.itemSize,t.normalized)}const i=s.normal;if(i){const t=this.__convertBase64ToArrayBuffer(i.array),n=this.__convertArrayBufferToTypedArray(t);e.normal=new qe(n,i.itemSize,i.normalized)}const o=s.uv;if(o){const t=this.__convertBase64ToArrayBuffer(o.array),n=this.__convertArrayBufferToTypedArray(t);e.uv=new qe(n,o.itemSize,o.normalized)}n.attributes=e}return m(e.groups)&&(n.groups=e.groups),m(e.boundingBox)&&(n.boundingBox=e.boundingBox),m(e.boundingSphere)&&(n.boundingSphere=e.boundingSphere),"ShapeBufferGeometry"===t&&(n.shapes=e.shapes.map(e=>(new he).fromJSON(e)),n.curveSegments=e.curveSegments),n}__convertArrayBufferToTypedArray(e){const t=new DataView(e),n=e.byteLength-1,i=t.getUint8(0);let s=null;switch(i){case sn.Int8Array:s=new Int8Array(n/1);for(let e=0,i=1;i<n;e++,i+=1)s[e]=t.getInt8(i);break;case sn.Uint8Array:s=new Uint8Array(n/1);for(let e=0,i=1;i<n;e++,i+=1)s[e]=t.getUint8(i);break;case sn.Uint8ClampedArray:s=new Uint8ClampedArray(n/1);for(let e=0,i=1;i<n;e++,i+=1)s[e]=t.getUint8(i);break;case sn.Int16Array:s=new Int16Array(n/2);for(let e=0,i=1;i<n;e++,i+=2)s[e]=t.getInt16(i);break;case sn.Uint16Array:s=new Uint16Array(n/2);for(let e=0,i=1;i<n;e++,i+=2)s[e]=t.getUint16(i);break;case sn.Int32Array:s=new Int32Array(n/4);for(let e=0,i=1;i<n;e++,i+=4)s[e]=t.getInt32(i);break;case sn.Uint32Array:s=new Uint32Array(n/4);for(let e=0,i=1;i<n;e++,i+=4)s[e]=t.getUint32(i);break;case sn.Float32Array:s=new Float32Array(n/4);for(let e=0,i=1;i<n;e++,i+=4)s[e]=t.getFloat32(i);break;case sn.Float64Array:s=new Float64Array(n/8);for(let e=0,i=1;i<n;e++,i+=8)s[e]=t.getFloat64(i);break;default:throw new RangeError(`Invalid switch parameter: ${i}`)}return s}__convertBase64ToArrayBuffer(e){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n=new Uint8Array(256);for(let e=0;e<t.length;e++)n[t.charCodeAt(e)]=e;const i=e.length;let s=.75*i;"="===e[i-1]&&(s--,"="===e[i-2]&&s--);let o=new ArrayBuffer(s),r=new Uint8Array(o),a=void 0,c=void 0,h=void 0,l=void 0;for(let t=0,s=0;t<i;t+=4)a=n[e.charCodeAt(t)],c=n[e.charCodeAt(t+1)],h=n[e.charCodeAt(t+2)],l=n[e.charCodeAt(t+3)],r[s++]=a<<2|c>>4,r[s++]=(15&c)<<4|h>>2,r[s++]=(3&h)<<6|63&l;return o}}function rn(){i.call(this),this.basePath="/textures"}rn.prototype=Object.assign(Object.create(i.prototype),{constructor:rn,convert(e){if(!e)throw new Error("TexturesManager: Unable to convert null or undefined data !");const t=e.type;throw new Error(`TTexturesManager: Unknown texture of type: ${t}`)}}),Object.defineProperties(rn.prototype,{_onJson:{value:function(e,t,n,i){const s=_(e)?[e]:e,o={};for(let e=0,t=s.length,r=void 0;e<t;e++){r=s[e];try{o[r._id]=this.convert(r)}catch(e){i(e)}n(e/t)}t(o)}}});const an=(new Ve).load("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAACXBIWXMAAC4jAAAuIwF4pT92AAAAB3RJTUUH4gkKDRoGpGNegQAAABl0RVh0Q29tbWVudABDcmVhdGVkIHdpdGggR0lNUFeBDhcAAAAMSURBVAjXY/j//z8ABf4C/tzMWecAAAAASUVORK5CYII=");class cn extends i{constructor(e={}){const t={basePath:"/materials",texturesPath:"/textures",texturesProvider:new $e,generateMipmap:!1,autoFillTextures:!0,...e};super(t),this.texturesPath=t.texturesPath,this.texturesProvider=t.texturesProvider,this.generateMipmap=t.generateMipmap,this.autoFillTextures=t.autoFillTextures}get texturesPath(){return this._texturesPath}set texturesPath(e){if(a(e))throw new TypeError("Textures path cannot be null ! Expect a non empty string.");if(c(e))throw new TypeError("Textures path cannot be undefined ! Expect a non empty string.");if(f(e))throw new TypeError(`Textures path cannot be an instance of ${e.constructor.name} ! Expect a non empty string.`);if(w(e))throw new TypeError("Textures path cannot be empty ! Expect a non empty string.");if(v(e))throw new TypeError("Textures path cannot contain only whitespace ! Expect a non empty string.");this._texturesPath=e}get texturesProvider(){return this._texturesProvider}set texturesProvider(e){if(a(e))throw new TypeError("Textures provider cannot be null ! Expect an instance of TextureLoader.");if(c(e))throw new TypeError("Textures provider cannot be undefined ! Expect an instance of TextureLoader.");if(!(e instanceof rn||e instanceof $e))throw new TypeError(`Textures provider cannot be an instance of ${e.constructor.name} ! Expect an instance of TTexturesManager.`);this._texturesProvider=e}get generateMipmap(){return this._generateMipmap}set generateMipmap(e){if(a(e))throw new TypeError("Generate mipmap cannot be null ! Expect a boolean.");if(c(e))throw new TypeError("Generate mipmap cannot be undefined ! Expect a boolean.");if(h(e))throw new TypeError(`Generate mipmap cannot be an instance of ${e.constructor.name} ! Expect a boolean.`);this._generateMipmap=e}get autoFillTextures(){return this._autoFillTextures}set autoFillTextures(e){if(a(e))throw new TypeError("Global scale cannot be null ! Expect a boolean.");if(c(e))throw new TypeError("Global scale cannot be undefined ! Expect a positive number.");if(h(e))throw new TypeError("Global scale cannot be null ! Expect a boolean.");this._autoFillTextures=e}setTexturesPath(e){return this.texturesPath=e,this}setTexturesProvider(e){return this.texturesProvider=e,this}setGenerateMipmap(e){return this.generateMipmap=e,this}setAutoFillTextures(e){return this.autoFillTextures=e,this}_onJson(e,t,n,i){const s=_(e)?[e]:e,o={};for(let e=0,t=s.length,r=void 0;e<t;e++){r=s[e];try{o[r._id]=this.convert(r)}catch(e){i(e)}n(new ProgressEvent("MaterialsManager",{lengthComputable:!0,loaded:e+1,total:t}))}this._autoFillTextures?this.fillTextures(o,t,n,i):t(o)}convert(e){if(!e)throw new Error("MaterialsManager: Unable to convert null or undefined data !");const t=e.type;let n=null;switch(t){case"MeshPhongMaterial":{n=new de,this._fillBaseMaterialData(n,e);const t=e.color;m(t)&&(n.color=this._setColor(t));const i=e.specular;m(i)&&(n.specular=this._setColor(i));const s=e.shininess;m(s)&&(n.shininess=s);const o=e.map;m(o)&&(n.map=o);const r=e.lightMap;m(r)&&(n.lightMap=r);const a=e.lightMapIntensity;m(a)&&(n.lightMapIntensity=a);const c=e.aoMap;m(c)&&(n.aoMap=c);const h=e.aoMapIntensity;m(h)&&(n.aoMapIntensity=h);const l=e.emissive;m(l)&&(n.emissive=this._setColor(l));const d=e.emissiveIntensity;m(d)&&(n.emissiveIntensity=d);const u=e.emissiveMap;m(u)&&(n.emissiveMap=u);const p=e.bumpMap;m(p)&&(n.bumpMap=p);const _=e.bumpScale;m(_)&&(n.bumpScale=_);const f=e.normalMap;m(f)&&(n.normalMap=f);const w=e.normalScale;m(w)&&(n.normalScale=this._setVector2(w));const v=e.displacementMap;m(v)&&(n.displacementMap=v);const b=e.displacementScale;m(b)&&(n.displacementScale=b);const g=e.displacementBias;m(g)&&(n.displacementBias=g);const y=e.specularMap;m(y)&&(n.specularMap=y);const E=e.alphaMap;m(E)&&(n.alphaMap=E);const x=e.envMap;m(x)&&(n.envMap=x);const M=e.combine;m(M)&&(n.combine=M);const P=e.reflectivity;m(P)&&(n.reflectivity=P);const A=e.refractionRatio;m(A)&&(n.refractionRatio=A);const T=e.wireframe;m(T)&&(n.wireframe=T);const D=e.wireframeLinewidth;m(D)&&(n.wireframeLinewidth=D);const k=e.wireframeLinecap;m(k)&&(n.wireframeLinecap=k);const S=e.wireframeLinejoin;m(S)&&(n.wireframeLinejoin=S);const C=e.skinning;m(C)&&(n.skinning=C);const z=e.morphTargets;m(z)&&(n.morphTargets=z);const O=e.morphNormals;m(O)&&(n.morphNormals=O);break}case"MeshLambertMaterial":{n=new Je,this._fillBaseMaterialData(n,e);const t=e.color;m(t)&&(n.color=this._setColor(t));const i=e.map;m(i)&&(n.map=i);const s=e.lightMap;m(s)&&(n.lightMap=s);const o=e.lightMapIntensity;m(o)&&(n.lightMapIntensity=o);const r=e.aoMap;m(r)&&(n.aoMap=r);const a=e.aoMapIntensity;m(a)&&(n.aoMapIntensity=a);const c=e.emissive;m(c)&&(n.emissive=this._setColor(c));const h=e.emissiveIntensity;m(h)&&(n.emissiveIntensity=h);const l=e.emissiveMap;m(l)&&(n.emissiveMap=l);const d=e.specularMap;m(d)&&(n.specularMap=d);const u=e.alphaMap;m(u)&&(n.alphaMap=u);const p=e.envMap;m(p)&&(n.envMap=p);const _=e.combine;m(_)&&(n.combine=_);const f=e.reflectivity;m(f)&&(n.reflectivity=f);const w=e.refractionRatio;m(w)&&(n.refractionRatio=w);const v=e.wireframe;m(v)&&(n.wireframe=v);const b=e.wireframeLinewidth;m(b)&&(n.wireframeLinewidth=b);const g=e.wireframeLinecap;m(g)&&(n.wireframeLinecap=g);const y=e.wireframeLinejoin;m(y)&&(n.wireframeLinejoin=y);const E=e.skinning;m(E)&&(n.skinning=E);const x=e.morphTargets;m(x)&&(n.morphTargets=x);const M=e.morphNormals;m(M)&&(n.morphNormals=M);break}case"LineBasicMaterial":{n=new O,this._fillBaseMaterialData(n,e);const t=e.color;m(t)&&(n.color=this._setColor(t));break}case"PointsMaterial":{n=new Ke,this._fillBaseMaterialData(n,e);const t=e.color;m(t)&&(n.color=this._setColor(t));const i=e.map;m(i)&&(n.map=i);const s=e.morphTargets;m(s)&&(n.morphTargets=s);const o=e.size;m(o)&&(n.size=o);const r=e.sizeAttenuation;m(r)&&(n.sizeAttenuation=r);break}default:throw new Error(`TMaterialsManager: Unmanaged material of type: ${t}`)}return n}_fillBaseMaterialData(e,t){const n=t._id;m(n)&&b(n)&&(e._id=n);const i=t.uuid;m(i)&&b(i)&&(e.uuid=i);const s=t.name;m(s)&&b(s)&&(e.name=s);const o=t.fog;m(o)&&(e.fog=o);const r=t.lights;m(r)&&(e.lights=r);const a=t.blending;m(a)&&(e.blending=a);const c=t.side;m(c)&&(e.side=c);const h=t.flatShading;m(h)&&(e.flatShading=h);const l=t.vertexColors;m(l)&&(e.vertexColors=l);const d=t.opacity;m(d)&&(e.opacity=d);const u=t.transparent;m(u)&&(e.transparent=u);const p=t.blendSrc;m(p)&&(e.blendSrc=p);const _=t.blendDst;m(_)&&(e.blendDst=_);const f=t.blendEquation;m(f)&&(e.blendEquation=f);const w=t.blendSrcAlpha;m(w)&&(e.blendSrcAlpha=w);const v=t.blendDstAlpha;m(v)&&(e.blendDstAlpha=v);const g=t.blendEquationAlpha;m(g)&&(e.blendEquationAlpha=g);const y=t.depthFunc;m(y)&&(e.depthFunc=y);const E=t.depthTest;m(E)&&(e.depthTest=E);const x=t.depthWrite;m(x)&&(e.depthWrite=x);const M=t.clippingPlanes;m(M)&&(e.clippingPlanes=M);const P=t.clipIntersection;m(P)&&(e.clipIntersection=P);const A=t.clipShadows;m(A)&&(e.clipShadows=A);const T=t.colorWrite;m(T)&&(e.colorWrite=T);const D=t.precision;m(D)&&(e.precision=D);const k=t.polygonOffset;m(k)&&(e.polygonOffset=k);const S=t.polygonOffsetFactor;m(S)&&(e.polygonOffsetFactor=S);const C=t.polygonOffsetUnits;m(C)&&(e.polygonOffsetUnits=C);const z=t.dithering;m(z)&&(e.dithering=z);const O=t.alphaTest;m(O)&&(e.alphaTest=O);const B=t.premultipliedAlpha;m(B)&&(e.premultipliedAlpha=B);const L=t.overdraw;m(L)&&(e.overdraw=L);const G=t.visible;m(G)&&(e.visible=G);const j=t.userData;m(j)&&(e.userData=j);const I=t.needsUpdate;m(I)&&(e.needsUpdate=I)}_setVector2(e){const t=e.x,n=e.y;if(d(t)||d(n))throw new Error("MaterialsManager: Unable to convert null or undefined vector 2 !");return new A(t,n)}_setColor(e){const t=e.r,n=e.g,i=e.b;if(d(t)||d(n)||d(i))throw new Error("MaterialsManager: Unable to convert null or undefined color !");return new Qe(t,n,i)}fillTextures(e,t,n,i){const s=this._retrieveTexturesOf(e);for(let t in e){const n=e[t],i=s[t];for(let e in i)n[e]=i[e]}t(e)}_retrieveTexturesOf(e){const t=["map","lightMap","aoMap","emissiveMap","bumpMap","normalMap","displacementMap","specularMap","alphaMap","envMap"],n={},i={};for(let s in e){const o=e[s];let r={};for(let e=0,n=t.length;e<n;e++){let n=t[e];const s=o[n];if(m(s)&&b(s)&&g(s)){const e=`${this._texturesPath}/${s}`,t=i[e];if(m(t))r[n]=t;else{const t=this._texturesProvider.load(e,()=>{},()=>{},()=>{t.image||(t.image=an,t.needsUpdate=!0)});t.name=s,this._generateMipmap||(t.generateMipmaps=!1,t.magFilter=et,t.minFilter=et),i[e]=t,r[n]=t}}}n[s]=r}return n}}class hn extends i{constructor(e={}){const t={basePath:"/objects",geometriesProvider:new on,materialsProvider:new cn,projectionSystem:"zBack",globalScale:1,autoFillObjects3D:!0,...e};super(t),this.geometriesProvider=t.geometriesProvider,this.materialsProvider=t.materialsProvider,this.projectionSystem=t.projectionSystem,this.globalScale=t.globalScale,this.autoFillObjects3D=t.autoFillObjects3D}get geometriesProvider(){return this._geometriesProvider}set geometriesProvider(e){if(a(e))throw new TypeError("Geometries provider cannot be null ! Expect an instance of GeometriesManager.");if(c(e))throw new TypeError("Geometries provider cannot be undefined ! Expect an instance of GeometriesManager.");if(!(e instanceof on))throw new TypeError(`Geometries provider cannot be an instance of ${e.constructor.name} ! Expect an instance of TGeometriesManager.`);this._geometriesProvider=e}get materialsProvider(){return this._materialsProvider}set materialsProvider(e){if(a(e))throw new TypeError("Materials provider cannot be null ! Expect an instance of MaterialsManager.");if(c(e))throw new TypeError("Materials provider cannot be undefined ! Expect an instance of MaterialsManager.");if(!(e instanceof cn))throw new TypeError(`Materials provider cannot be an instance of ${e.constructor.name} ! Expect an instance of TMaterialsManager.`);this._materialsProvider=e}get projectionSystem(){return this._projectionSystem}set projectionSystem(e){if(a(e))throw new TypeError("Projection system cannot be null ! Expect a positive number.");if(c(e))throw new TypeError("Projection system cannot be undefined ! Expect a positive number.");this._projectionSystem=e}get globalScale(){return this._globalScale}set globalScale(e){if(a(e))throw new TypeError("Global scale cannot be null ! Expect a positive number.");if(c(e))throw new TypeError("Global scale cannot be undefined ! Expect a positive number.");this._globalScale=e}get autoFillObjects3D(){return this._autoFillObjects3D}set autoFillObjects3D(e){if(a(e))throw new TypeError("Global scale cannot be null ! Expect a boolean.");if(c(e))throw new TypeError("Global scale cannot be undefined ! Expect a positive number.");if(h(e))throw new TypeError("Global scale cannot be null ! Expect a boolean.");this._autoFillObjects3D=e}setGeometriesProvider(e){return this.geometriesProvider=e,this}setMaterialsProvider(e){return this.materialsProvider=e,this}setProjectionSystem(e){return this.projectionSystem=e,this}setGlobalScale(e){return this.globalScale=e,this}setAutoFillObjects3D(e){return this.autoFillObjects3D=e,this}_onJson(e,t,n,i){const s={};for(let t=0,o=e.length,r=void 0;t<o;t++){r=e[t];try{s[r._id]=this.convert(r)}catch(e){i(e)}n(new ProgressEvent("ObjectsManager",{lengthComputable:!0,loaded:t+1,total:o}))}this._autoFillObjects3D?this.fillObjects3D(s,t,n,i):t(s)}_onArrayBuffer(e,t,n,i){}_onBlob(e,t,n,i){}_onText(e,t,n,i){}convert(e){if(!e)throw new Error("ObjectsManager: Unable to convert null or undefined data !");const t=e.type;let n=null;switch(t){case"Object3D":n=new M,this._fillBaseObjectsData(n,e);break;case"Scene":n=new V,this._fillBaseObjectsData(n,e),m(e.background)&&Number.isInteger(e.background)&&(n.background=new Qe(e.background)),m(e.fog)&&("Fog"===e.fog.type?n.fog=new tt(e.fog.color,e.fog.near,e.fog.far):"FogExp2"===e.fog.type&&(n.fog=new nt(e.fog.color,e.fog.density))),n.overrideMaterial=e.overrideMaterial,n.autoUpdate=e.autoUpdate;break;case"PerspectiveCamera":n=new it,this._fillBaseObjectsData(n,e),n.fov=e.fov,n.aspect=e.aspect,n.near=e.near,n.far=e.far,m(e.focus)&&(n.focus=e.focus),m(e.zoom)&&(n.zoom=e.zoom),m(e.filmGauge)&&(n.filmGauge=e.filmGauge),m(e.filmOffset)&&(n.filmOffset=e.filmOffset),m(e.view)&&(n.view=Object.assign({},e.view));break;case"OrthographicCamera":n=new st(e.left,e.right,e.top,e.bottom,e.near,e.far),this._fillBaseObjectsData(n,e);break;case"AmbientLight":n=new ot(e.color,e.intensity),this._fillBaseObjectsData(n,e);break;case"DirectionalLight":n=new rt(e.color,e.intensity),this._fillBaseObjectsData(n,e);break;case"PointLight":n=new at(e.color,e.intensity,e.distance,e.decay),this._fillBaseObjectsData(n,e);break;case"RectAreaLight":n=new ct(e.color,e.intensity,e.width,e.height),this._fillBaseObjectsData(n,e);break;case"SpotLight":n=new ht(e.color,e.intensity,e.distance,e.angle,e.penumbra,e.decay),this._fillBaseObjectsData(n,e);break;case"HemisphereLight":n=new lt(e.color,e.groundColor,e.intensity),this._fillBaseObjectsData(n,e);break;case"SkinnedMesh":n=new dt,this._fillBaseObjectsData(n,e),n.geometry=e.geometry,n.material=e.material,n.drawMode=e.drawMode,n.bindMode=e.bindMode,n.bindMatrix=e.bindMatrix,n.bindMatrixInverse=e.bindMatrixInverse;break;case"Mesh":n=new U,this._fillBaseObjectsData(n,e),n.geometry=e.geometry,n.material=e.material,n.drawMode=e.drawMode;break;case"LOD":n=new ut,this._fillBaseObjectsData(n,e),n.levels=e.levels;break;case"Line":n=new R,this._fillBaseObjectsData(n,e),n.geometry=e.geometry,n.material=e.material,n.drawMode=e.drawMode;break;case"LineLoop":n=new mt,this._fillBaseObjectsData(n,e),n.geometry=e.geometry,n.material=e.material,n.drawMode=e.drawMode;break;case"LineSegments":n=new S,this._fillBaseObjectsData(n,e),n.geometry=e.geometry,n.material=e.material,n.drawMode=e.drawMode;break;case"Points":n=new pt,this._fillBaseObjectsData(n,e),n.geometry=e.geometry,n.material=e.material,n.drawMode=e.drawMode;break;case"Sprite":n=new _t,this._fillBaseObjectsData(n,e),n.material=e.material;break;case"Group":n=new ft,this._fillBaseObjectsData(n,e);break;default:throw new Error(`TObjectsManager: Unknown object of type: ${t}`)}return n}_fillBaseObjectsData(e,t){e._id=t._id,m(t.uuid)&&(e.uuid=t.uuid),m(t.name)&&(e.name=t.name),m(t.parent)&&(e.parent=t.parent),y(t.children)&&(e.children=t.children),m(t.up)&&(e.up.x=t.up.x,e.up.y=t.up.y,e.up.z=t.up.z),m(t.position)&&("zBack"===this._projectionSystem?(e.position.x=t.position.x/this._globalScale,e.position.y=t.position.z/this._globalScale,e.position.z=-t.position.y/this._globalScale):(e.position.x=t.position.x/this._globalScale,e.position.y=t.position.y/this._globalScale,e.position.z=t.position.z/this._globalScale)),m(t.rotation)&&("zBack"===this._projectionSystem?(e.rotation.x=t.rotation.x,e.rotation.y=t.rotation.z,e.rotation.z=-t.rotation.y,e.rotation.order=t.rotation.order):(e.rotation.x=t.rotation.x,e.rotation.y=t.rotation.y,e.rotation.z=t.rotation.z,e.rotation.order=t.rotation.order)),m(t.quaternion)&&("zBack"===this._projectionSystem?(e.quaternion.x=t.quaternion.x,e.quaternion.y=t.quaternion.z,e.quaternion.z=-t.quaternion.y,e.quaternion.w=t.quaternion.w):(e.quaternion.x=t.quaternion.x,e.quaternion.y=t.quaternion.y,e.quaternion.z=t.quaternion.z,e.quaternion.w=t.quaternion.w)),m(t.scale)&&(0!==t.scale.x&&0!==t.scale.y&&0!==t.scale.z?(e.scale.x=t.scale.x,e.scale.y=t.scale.y,e.scale.z=t.scale.z):console.warn("Try to assign null scale !")),m(t.modelViewMatrix)&&y(t.modelViewMatrix)&&e.modelViewMatrix.fromArray(t.modelViewMatrix),m(t.normalMatrix)&&y(t.normalMatrix)&&e.normalMatrix.fromArray(t.normalMatrix),m(t.matrix)&&y(t.matrix)&&e.matrix.fromArray(t.matrix),m(t.matrixWorld)&&y(t.matrixWorld)&&e.matrixWorld.fromArray(t.matrixWorld),m(t.matrixAutoUpdate)&&(e.matrixAutoUpdate=t.matrixAutoUpdate),m(t.matrixWorldNeedsUpdate)&&(e.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate),m(t.layers)&&(e.layers.mask=t.layers),m(t.visible)&&(e.visible=t.visible),m(t.castShadow)&&(e.castShadow=t.castShadow),m(t.receiveShadow)&&(e.receiveShadow=t.receiveShadow),m(t.frustumCulled)&&(e.frustumCulled=t.frustumCulled),m(t.renderOrder)&&(e.renderOrder=t.renderOrder),m(t.userData)&&(e.userData=t.userData)}fillObjects3D(e,t,n,i){const s=this,o=[];for(let t in e){const n=e[t];(n.geometry||n.material)&&o.push(e[t])}if(0===o.length)return void t(e);let r=void 0;this._retrieveGeometriesOf(o,e=>{r=e,c()},n,i);let a=void 0;function c(){if(r&&a){for(let t in e){const n=e[t];s.applyGeometry(n,r),s.applyMaterials(n,a)}t(e)}}this._retrieveMaterialsOf(o,e=>{a=e,c()},n,i)}_retrieveGeometriesOf(e,t,n,i){const s=e.map(e=>e.geometry).filter((e,t,n)=>e&&n.indexOf(e)===t);0!==s.length?this._geometriesProvider.read(s,null,t,n,i):t({})}_retrieveMaterialsOf(e,t,n,i){const s=e.map(e=>e.material),o=[].concat.apply([],s).filter((e,t,n)=>e&&n.indexOf(e)===t);0!==o.length?this._materialsProvider.read(o,null,t,n,i):t({})}applyGeometry(e,t){const n=e.geometry;if(!n)return;const i=t[n];i?e.geometry=i:console.error("Unable to retrieve geometry !!!")}applyMaterials(e,t){const n=e.material;if(n)if(Array.isArray(n))if(1===n.length){const i=t[n[0]];if(!i)return console.error("Unable to retrieve material !!!"),null;e.material=i.clone()}else{e.material=[];for(let i=0,s=n.length;i<s;i++){const s=t[n[i]];if(!s)return console.error("Unable to retrieve material !!!"),null;e.material.push(s.clone())}}else if("string"==typeof n){const i=t[n];if(!i)return void console.error("Unable to retrieve material !!!");e.material=i.clone()}else console.error("Invalid material ids, expected string or array of string")}}class ln extends S{static _createInternalGeometry(e,t,n,i,s,o){const r=[],a=[];let c,h,l,d,u,m,p;for(d=0;d<=t;d++)l=d/t*(2*Math.PI),c=Math.sin(l)*e,h=Math.cos(l)*e,r.push(0,0,0),r.push(c,0,h),p=1&d?s:o,a.push(p.r,p.g,p.b),a.push(p.r,p.g,p.b);for(d=0;d<=n;d++){for(p=1&d?s:o,m=e-e/n*d,u=0;u<i;u++)l=u/i*(2*Math.PI),c=Math.sin(l)*m,h=Math.cos(l)*m,r.push(c,0,h),a.push(p.r,p.g,p.b),l=(u+1)/i*(2*Math.PI),c=Math.sin(l)*m,h=Math.cos(l)*m,r.push(c,0,h),a.push(p.r,p.g,p.b);r.push(-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1,0,0,1),a.push(1,0,0,1,.6,0,0,1,0,.6,1,0,0,0,1,0,.6,1)}const _=new W(r,3);_.name="TOrbitControlsHelperPositionBufferAttribute";const f=new W(a,3);f.name="TOrbitControlsHelperColorBufferAttribute";const w=new Z;return w.addAttribute("position",_),w.addAttribute("color",f),w.name="TOrbitControlsHelperGeometry",w}static _createInternalMaterial(){const e=new O({vertexColors:wt});return e.transparent=!0,e.opacity=0,e.name="TOrbitControlsHelperMaterial",e}constructor(e={}){const t={radius:2,radials:16,circles:2,divisions:64,innerColor:new Qe(4473924),outerColor:new Qe(8947848),...e};super(ln._createInternalGeometry(t.radius,t.radials,t.circles,t.divisions,t.innerColor,t.outerColor),ln._createInternalMaterial()),this._intervalId=void 0}startOpacityAnimation(){void 0!==this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this.material.opacity=1}endOpacityAnimation(){this._intervalId=setInterval(function(){this.material.opacity<=0?(this.material.opacity=0,clearInterval(this._intervalId),this._intervalId=void 0):this.material.opacity-=.1}.bind(this),100)}}export{qt as AbstractGizmo,en as BufferGeometriesManager,Pt as CameraControlMode,At as CameraControls,Ct as CameraPathController,Ot as ClippingBox,Qt as ClippingControls,Kt as ClippingModes,tn as CurvesManager,nn as FilairesManager,on as GeometriesManager,Lt as HighlightableLineMaterial,Bt as HighlightableMaterial,cn as MaterialsManager,hn as ObjectsManager,ln as OrbitControlsHelper,$t as RotateGizmo,Jt as ScaleGizmo,rn as TexturesManager,Vt as TranslateGizmo};
//# sourceMappingURL=itee-plugin-three.esm.min.js.map
