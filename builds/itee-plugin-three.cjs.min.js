"use strict";var iteeDatabase=require("itee-database"),iteeClient=require("itee-client"),threeFull=require("three-full"),iteeValidators=require("itee-validators"),bson=require("bson");const DBFVersion=Object.freeze({FoxPro:48,FoxPro_Autoincrement:49,dBASE_II:2,FoxPro_Var:50,dBASE_III_plus:3,dBASE_III_plus_memo:131,dBASE_IV_SQL_table:67,dBASE_IV_SQL_system:99,dBASE_IV_memo:139,dBASE_IV_memo_SQL_table:203,FoxBase:251,dBase_v_7:4,FoxPro_2_x:245,HiPerSix_memo:229}),DataType=Object.freeze({Binary:"B",Character:"C",Date:"D",Numeric:"N",Logical:"L",Memo:"M",Timestamp:"@",Long:"I",Autoincrement:"+",Float:"F",Double:"O",OLE:"G"});function DBFLoader(e=threeFull.DefaultLoadingManager,t=iteeClient.DefaultLogger){this.manager=e,this.logger=t,this.reader=new iteeClient.TBinaryReader}Object.assign(DBFLoader,{Terminator:13,DeletedRecord:26,YearOffset:1900}),Object.assign(DBFLoader.prototype,{load(e,t,r,a){const i=this,n=new threeFull.FileLoader(i.manager);n.setResponseType("arraybuffer"),n.load(e,e=>{t(i.parse(e))},r,a)},parse(e){this.reader.setEndianess(iteeClient.Endianness.Big).setBuffer(e);const t=this.reader.getInt8();if(!this._isValidVersion(t))return this.logger.error(`DBFLoader: Invalid version number: ${t}`),null;const r=this._parseHeader(t);return{header:r,datas:this._parseDatas(t,r)}},_isValidVersion:e=>Object.values(DBFVersion).includes(e),_parseHeader(e){let t={};switch(e){case DBFVersion.FoxPro:case DBFVersion.FoxPro_Autoincrement:case DBFVersion.FoxPro_Var:case DBFVersion.dBASE_II:t=this._parseHeaderV2();break;case DBFVersion.dBASE_III_plus:case DBFVersion.dBASE_III_plus_memo:case DBFVersion.dBASE_IV_memo:case DBFVersion.dBASE_IV_memo_SQL_table:case DBFVersion.dBASE_IV_SQL_system:case DBFVersion.dBASE_IV_SQL_table:t=this._parseHeaderV3();break;case DBFVersion.dBase_v_7:case DBFVersion.FoxPro_2_x:case DBFVersion.HiPerSix_memo:t=this._parseHeaderV4();break;default:throw new RangeError(`Invalid version parameter: ${e}`,"DBFLoader")}return this.reader.getUint8()!==DBFLoader.Terminator&&this.logger.error("DBFLoader: Invalid terminator after field descriptors !!!"),t},_parseHeaderV2(){const e=this.reader.getInt16(),t=this.reader.getInt8()+DBFLoader.YearOffset,r=this.reader.getInt8(),a=this.reader.getInt8(),i=this.reader.getInt16();let n=[],s=void 0,o=void 0,l=void 0,d=void 0,h=void 0;for(let t=0;t<e;t++)s=this.reader.getString(11),o=this.reader.getChar(),l=this.reader.getUint8(),d=this.reader.getInt16(),h=this.reader.getInt8(),n.push({name:s,type:o,length:l,memoryAddress:d,decimalCount:h});return{numberOfRecords:e,year:t,month:r,day:a,lengthOfEachRecords:i,fields:n}},_parseHeaderV2_5(){const e=this.reader.getInt8()+DBFLoader.YearOffset,t=this.reader.getInt8(),r=this.reader.getInt8();this.reader.setEndianess(iteeClient.Endianness.Little);const a=this.reader.getInt32(),i=this.reader.getInt16(),n=this.reader.getInt16();this.reader.setEndianess(iteeClient.Endianness.Big),this.reader.skipOffsetOf(20);let s=[],o=void 0,l=void 0,d=void 0,h=void 0,c=void 0,p=void 0,u=void 0;for(let e=0;e<a;e++)o=this.reader.getString(11),l=this.reader.getChar(),h=this.reader.getInt32(),d=this.reader.getUint8(),c=this.reader.getUint8(),this.reader.skipOffsetOf(2),p=this.reader.getInt8(),this.reader.skipOffsetOf(2),u=this.reader.getInt8(),this.reader.skipOffsetOf(1),s.push({name:o,type:l,length:d,memoryAddress:h,decimalCount:c,workAreaId:p,MDXFlag:u});return{year:e,month:t,day:r,numberOfRecords:a,numberOfByteInHeader:i,numberOfByteInRecord:n,fields:s}},_parseHeaderV3(){const e=this.reader.getInt8()+DBFLoader.YearOffset,t=this.reader.getInt8(),r=this.reader.getInt8();this.reader.setEndianess(iteeClient.Endianness.Little);const a=this.reader.getInt32(),i=this.reader.getInt16(),n=this.reader.getInt16();this.reader.setEndianess(iteeClient.Endianness.Big),this.reader.skipOffsetOf(2);const s=this.reader.getInt8(),o=this.reader.getInt8();this.reader.skipOffsetOf(12);const l=this.reader.getInt8(),d=this.reader.getInt8();this.reader.skipOffsetOf(2);let h=[],c=void 0,p=void 0,u=void 0,f=void 0,g=void 0,y=void 0;for(;this.reader.getOffset()<i-1;)c=this.reader.getString(11),p=this.reader.getChar(),this.reader.skipOffsetOf(4),u=this.reader.getUint8(),f=this.reader.getUint8(),this.reader.skipOffsetOf(2),g=this.reader.getInt8(),this.reader.skipOffsetOf(10),y=this.reader.getInt8(),h.push({name:c,type:p,length:u,decimalCount:f,workAreaId:g,MDXFieldFlag:y});return{year:e,month:t,day:r,numberOfRecords:a,numberOfByteInHeader:i,numberOfByteInRecord:n,incompleteTransactionFlag:s,encryptionFlag:o,MDXFlag:l,languageDriverId:d,fields:h}},_parseHeaderV4(){const e=this.reader.getInt8()+DBFLoader.YearOffset,t=this.reader.getInt8(),r=this.reader.getInt8();this.reader.setEndianess(iteeClient.Endianness.Little);const a=this.reader.getInt32(),i=this.reader.getInt16(),n=this.reader.getInt16();this.reader.setEndianess(iteeClient.Endianness.Big),this.reader.skipOffsetOf(2);const s=this.reader.getInt8(),o=this.reader.getInt8();this.reader.skipOffsetOf(12);const l=this.reader.getInt8(),d=this.reader.getInt8();this.reader.skipOffsetOf(2);const h=this.reader.getString(32);this.reader.skipOffsetOf(4);let c=[],p=void 0,u=void 0,f=void 0,g=void 0,y=void 0,m=void 0;for(let e=0;e<a;e++)p=this.reader.getString(32),u=this.reader.getChar(),f=this.reader.getUint8(),g=this.reader.getUint8(),this.reader.skipOffsetOf(2),y=this.reader.getInt8(),this.reader.skipOffsetOf(2),m=this.reader.getInt32(),this.reader.skipOffsetOf(4),c.push({name:p,type:u,length:f,decimalCount:g,MDXFieldFlag:y,nextAutoincrementValue:m});return{year:e,month:t,day:r,numberOfRecords:a,numberOfByteInHeader:i,numberOfByteInRecord:n,incompleteTransactionFlag:s,encryptionFlag:o,MDXFlag:l,languageDriverId:d,languageDriverName:h,fields:c}},_parseDatas(e,t){const r=t.numberOfRecords,a=t.fields;let i=void 0;e===DBFVersion.dBase_v_7&&(i=this._parseFieldProperties());let n=[],s=void 0,o=void 0;for(let e=0;e<r;e++){(s={}).deleted=this.reader.getUInt8()===DBFLoader.DeletedRecord;for(let e=0,t=a.length;e<t;e++)switch((o=a[e]).type){case DataType.Binary:const t=this.reader.getString(o.length);s[o.name]=parseInt(t);break;case DataType.Numeric:const r=this.reader.getString(o.length);s[o.name]=parseInt(r);break;case DataType.Character:case DataType.Date:s[o.name]=this.reader.getString(o.length);break;case DataType.Logical:const i=this.reader.getChar().toLowerCase();s[o.name]="t"===i||"y"===i||"f"!==i&&"n"!==i&&null;break;case DataType.Memo:s[o.name]=this.reader.getString(o.length);break;case DataType.Timestamp:break;case DataType.Long:case DataType.Autoincrement:s[o.name]=this.reader.getInt32();break;case DataType.Float:const n=this.reader.getString(o.length);s[o.name]=parseInt(n);break;case DataType.Double:s[o.name]=this.reader.getDouble();break;case DataType.OLE:s[o.name]=this.reader.getString(o.length);break;default:throw new RangeError(`Invalid data type parameter: ${o.type}`,"_parseDatas")}n.push(s)}return n},_parseFieldProperties(){const e=this.reader.getInt16(),t=this.reader.getInt16(),r=this.reader.getInt16(),a=this.reader.getInt16(),i=this.reader.getInt16(),n=this.reader.getInt16(),s=this.reader.getInt16(),o=this.reader.getInt16();let l=[];for(let t=0;t<e;t++)l.push(this._getStandardProperties());let d=[];for(let e=0;e<r;e++)d.push(this._getCustomProperties());let h=[];for(let e=0;e<i;e++)h.push(this._getReferentialIntegrityProperties());return{numberOfStandardProperties:e,startOfStandardPropertiesDescriptor:t,numberOfCustomProperties:r,startOfCustomPropertiesDescriptor:a,numberOfReferentialIntegrityProperties:i,startOfReferentialIntegrityDescriptor:n,startOfData:s,sizeOfPropertiesStructure:o,standardProperties:l,customProperties:d,referentialIntegrityProperties:h}},_getStandardProperties(){const e=this.reader.getInt16(),t=this.reader.getInt16(),r=this.reader.getInt8(),a=this.reader.getInt8(),i=this.reader.getInt8();return this.reader.skipOffsetOf(4),{generationalNumber:e,tableFieldOffset:t,propertyDescribed:r,type:a,isConstraint:i,offsetFromStart:this.reader.getInt16(),widthOfDatabaseField:this.reader.getInt16()}},_getCustomProperties(){const e=this.reader.getInt16(),t=this.reader.getInt16(),r=this.reader.getInt8();return this.reader.skipOffsetOf(1),{generationalNumber:e,tableFieldOffset:t,type:r,offsetFromStartOfName:this.reader.getInt16(),lengthOfName:this.reader.getInt16(),offsetFromStartOfData:this.reader.getInt16(),lengthOfData:this.reader.getInt16()}},_getReferentialIntegrityProperties(){return{databaseState:this.reader.getInt8(),sequentialNumberRule:this.reader.getInt16(),offsetOfTheRIRuleName:this.reader.getInt16(),sizeOfTheRIRuleName:this.reader.getInt16(),offsetOfNameOfForeignTable:this.reader.getInt16(),sizeOfNameOfForeignTable:this.reader.getInt16(),stateBehaviour:this.reader.getInt8(),numberOfFieldsInLinkingKey:this.reader.getInt16(),offsetOfLocalTableTagName:this.reader.getInt16(),sizeOfTheLocalTableTagName:this.reader.getInt16(),offsetOfForeignTableTagName:this.reader.getInt16(),sizeOfTheForeignTableTagName:this.reader.getInt16()}}});class DbfToThree extends iteeDatabase.TAbstractFileConverter{constructor(){super(iteeDatabase.TAbstractFileConverter.DumpType.ArrayBuffer)}_convert(e,t,r,a,i){super._convert(e,t,r,a,i);try{r((new DBFLoader).parse(e))}catch(e){i(e)}}}class JsonToThree extends iteeDatabase.TAbstractFileConverter{constructor(){super(iteeDatabase.TAbstractFileConverter.DumpType.JSON)}_convert(e,t,r,a,i){super._convert(e,t,r,a,i);try{r((new threeFull.ObjectLoader).parse(e))}catch(e){i(e)}}}class MtlToThree extends iteeDatabase.TAbstractFileConverter{constructor(){super(iteeDatabase.TAbstractFileConverter.DumpType.String)}_convert(e,t,r,a,i){super._convert(e,t,r,a,i);try{r((new threeFull.MTLLoader).parse(e))}catch(e){i(e)}}}class Obj2ToThree extends iteeDatabase.TAbstractFileConverter{constructor(){super(iteeDatabase.TAbstractFileConverter.DumpType.String)}_convert(e,t,r,a,i){super._convert(e,t,r,a,i);try{r((new threeFull.OBJLoader2).parse(e))}catch(e){i(e)}}}const ShapeType=Object.freeze({NullShape:0,Point:1,Polyline:3,Polygon:5,MultiPoint:8,PointZ:11,PolyLineZ:13,PolygonZ:15,MultiPointZ:18,PointM:21,PolylineM:23,PolygonM:25,MultiPointM:28,MultiPatch:31});function ringClockwise(e){if((t=e.length)<4)return!1;for(var t,r=0,a=e[t-1][1]*e[0][0]-e[t-1][0]*e[0][1];++r<t;)a+=e[r-1][1]*e[r][0]-e[r-1][0]*e[r][1];return a>=0}function ringContainsSome(e,t){for(var r,a=-1,i=t.length;++a<i;)if(r=ringContains(e,t[a]))return r>0;return!1}function ringContains(e,t){for(var r=t[0],a=t[1],i=-1,n=0,s=e.length,o=s-1;n<s;o=n++){var l=e[n],d=l[0],h=l[1],c=e[o],p=c[0],u=c[1];if(segmentContains(l,c,t))return 0;h>a!=u>a&&r<(p-d)*(a-h)/(u-h)+d&&(i=-i)}return i}function segmentContains(e,t,r){var a=r[0]-e[0],i=r[1]-e[1];if(0===a&&0===i)return!0;var n=t[0]-e[0],s=t[1]-e[1];if(0===n&&0===s)return!1;var o=(a*n+i*s)/(n*n+s*s);return!(o<0||o>1)&&(0===o||1===o||o*n===a&&o*s===i)}function SHPLoader(e=threeFull.DefaultLoadingManager,t=iteeClient.DefaultLogger){this.manager=e,this.logger=t,this.globalOffset=new threeFull.Vector3,this.worldAxis={from:"zUp",to:"zForward"},this._reader=new iteeClient.TBinaryReader}Object.assign(SHPLoader,{FileCode:9994,MinFileLength:100,MinVersion:1e3}),Object.assign(SHPLoader.prototype,{load(e,t,r,a){const i=this,n=new threeFull.FileLoader(i.manager);n.setResponseType("arraybuffer"),n.load(e,e=>{t(i.parse(e))},r,a)},parse(e){this._reader.setEndianess(iteeClient.Endianness.Big).setBuffer(e);const t=this._parseHeader();if(t.fileCode!==SHPLoader.FileCode)return this.logger.error("SHPLoader: Invalide Shape file code !"),null;if(t.fileLength<SHPLoader.MinFileLength)return this.logger.error("SHPLoader: Shape file have an incorrect length !"),null;if(!Object.values(ShapeType).includes(t.shapeType))return this.logger.error("SHPLoader: Shape file have an incorrect shape type !"),null;t.version<SHPLoader.MinVersion&&this.logger.warn("SHPLoader: Version of shape file below than 1000 could be incorrectly parsed !");const r=this._parseDatas(t);return this._convertToObjects(r)},_parseHeader(){const e=this._reader.getInt32();this._reader.skipOffsetOf(20);const t=this._reader.getInt32();this._reader.setEndianess(iteeClient.Endianness.Little);const r=this._reader.getInt32(),a=this._reader.getInt32(),i=this._reader.getInt32(),n=this._reader.getInt32();return{fileCode:e,fileLength:t,version:r,shapeType:a,boundingBox:{xMin:i,xMax:this._reader.getInt32(),yMin:n,yMax:this._reader.getInt32(),zMin:this._reader.getInt32(),zMax:this._reader.getInt32(),mMin:this._reader.getInt32(),mMax:this._reader.getInt32()}}},_parseDatas(e){this._reader.skipOffsetTo(100);let t=[],r=void 0,a=void 0,i=void 0;for(;!this._reader.isEndOfFile();)switch(r=this._parseRecordHeader(),a=this._reader.getOffset()+2*r.contentLength,this._reader.setEndianess(iteeClient.Endianness.Little),e.shapeType){case ShapeType.NullShape:this._reader.skipOffsetTo(a);break;case ShapeType.Point:case ShapeType.PointZ:case ShapeType.PointM:for(;this._reader.getOffset()<a;)(i=this._parsePoint())&&t.push(i);break;case ShapeType.Polyline:case ShapeType.PolyLineZ:case ShapeType.PolylineM:for(;this._reader.getOffset()<a;)(i=this._parsePolyLine())&&t.push(i);break;case ShapeType.Polygon:case ShapeType.PolygonZ:case ShapeType.PolygonM:for(;this._reader.getOffset()<a;)(i=this._parsePolyLine())&&t.push(i);break;case ShapeType.MultiPoint:case ShapeType.MultiPointZ:case ShapeType.MultiPointM:for(;this._reader.getOffset()<a;)(i=this._parseMultiPoint())&&t.push(i);break;case ShapeType.MultiPatch:for(;this._reader.getOffset()<a;)(i=this._parseMultiPatch())&&t.push(i);break;default:this.logger.error(`SHPLoader: Invalid switch parameter: ${shapeType}`)}return t},_parseRecordHeader(){return this._reader.setEndianess(iteeClient.Endianness.Big),{recordNumber:this._reader.getInt32(),contentLength:this._reader.getInt32()}},_parsePoint(){const e=this._reader.getInt32();return e===ShapeType.NullShape?null:{shapeType:e,x:this._reader.getFloat64(),y:this._reader.getFloat64()}},_parsePolyLine(){const e=this._reader.getInt32();if(e===ShapeType.NullShape)return null;const t={xMin:this._reader.getFloat64(),yMin:this._reader.getFloat64(),xMax:this._reader.getFloat64(),yMax:this._reader.getFloat64()},r=this._reader.getInt32(),a=this._reader.getInt32(),i=new Array(r);for(let e=0;e<r;e++)i[e]=this._reader.getInt32();const n=new Array(a);for(let e=0;e<a;e++)n[e]={x:this._reader.getFloat64(),y:this._reader.getFloat64()};return{shapeType:e,boundingBox:t,numberOfParts:r,numberOfPoints:a,parts:i,points:n}},_parsePolygon(){const e=this._reader.getInt32();if(e===ShapeType.NullShape)return null;const t={xMin:this._reader.getFloat64(),yMin:this._reader.getFloat64(),xMax:this._reader.getFloat64(),yMax:this._reader.getFloat64()},r=this._reader.getInt32(),a=this._reader.getInt32();let i=new Array(r);for(let e=0;e<r;e++)i[e]=this._reader.getInt32();let n=new Array(a);for(let e=0;e<a;e++)n[e]={x:this._reader.getFloat64(),y:this._reader.getFloat64()};const s=[],o=[];return i.forEach((e,t)=>{const r=n.slice(e,i[t+1]);ringClockwise(r)?s.push(r):o.push(r)}),o.forEach(e=>{s.some(t=>{if(ringContainsSome(t[0],e))return t.push(e),!0})||s.push([e])}),{shapeType:e,boundingBox:t,numberOfParts:r,numberOfPoints:a,parts:i,polygons:s}},_parseMultiPoint(){const e=this._reader.getInt32();if(e===ShapeType.NullShape)return null;const t={xMin:this._reader.getFloat64(),xMax:this._reader.getFloat64(),yMin:this._reader.getFloat64(),yMax:this._reader.getFloat64()},r=this._reader.getInt32(),a=new Array(r);for(let e=0;e<r;e++)a.push([this._reader.getFloat64(),this._reader.getFloat64()]);return{shapeType:e,boundingBox:t,numberOfPoints:r,points:a}},_parseMultiPatch(){const e=this._reader.getInt32();return e===ShapeType.NullShape?null:{shapeType:e}},_convertToObjects(e){let t=[];for(let t=0,i=e.length;t<i;t++){let i=e[t];i.shapeType!==ShapeType.Polygon&&i.shapeType!==ShapeType.PolygonZ&&i.shapeType!==ShapeType.PolygonM||(i.points&&Array.isArray(i.points[0])?r(i.points):a(i.points))}function r(e){for(let t=0,i=e.length;t<i;t++){let i=e[t];i?Array.isArray(i[0])?r(i):a(i):this.logger.log("no array, oups !")}}function a(e){t.push(new threeFull.Shape(e))}return t}});class ShpToThree extends iteeDatabase.TAbstractFileConverter{constructor(){super(iteeDatabase.TAbstractFileConverter.DumpType.ArrayBuffer)}_convert(e,t,r,a,i){super._convert(e,t,r,a,i);try{r((new SHPLoader).parse(e))}catch(e){i(e)}}}class ThreeToMongoDB extends iteeDatabase.TAbstractDataInserter{constructor(e){super(e)}_save(e,t,r,a,i){const n=this,s=t.parentId,o="true"===t.disableRootNode?e.children:Array.isArray(e)?e:[e],l=[],d=o.length;let h=0;0===d&&i("No node to save in database !");let c=0;function p(){const e=o[c];n._parse(e,t=>{if(h++,a({name:e.name,done:h,todo:d}),iteeValidators.isNotDefined(s)||iteeValidators.isNotDefined(t))return void u();"string"==typeof t&&(t=[t]);const r=n._driver.model("Objects3D");r.findOneAndUpdate({_id:s},{$push:{children:t}},(e,a)=>{if(e)return l.push(e),void u();if(!a)return l.push(`Unable to retrieve parent object with the given id: ${s} !!!`),void u();const i=a.id,n=t.length;let o=0;for(let e=0;e<n;e++){let a=t[e];r.findByIdAndUpdate(a,{$set:{parent:i}},(e,t)=>{e&&l.push(e),++o<n||u()})}})},a,i)}function u(){++c<d?p():l.length>0?i(l):r(s)}p()}_parse(e,t,r,a){const i=this,n=e.children.length;let s=[],o=0;n>0?function l(){const d=e.children[o];i._parse(d,h=>{if(s.push(h),r({name:d.name,done:s.length,todo:n}),s.length<n)return o++,void l();i._saveInDataBase(e,s,a,t)},r,a)}():i._saveInDataBase(e,[],a,t)}_parseUserData(e){let t={};for(let r in e)e.hasOwnProperty(r)&&(t[r.replace(/\./g,"")]=e[r]);return t}_saveInDataBase(e,t,r,a){const i=this,n=t.filter(e=>e),s=e.type,o=e.geometry,l=e.material;if("Curve"===s||"ArcCurve"===s||"CatmullRomCurve3"===s||"CubicBezierCurve"===s||"CubicBezierCurve3"===s||"EllipseCurve"===s||"LineCurve"===s||"LineCurve3"===s||"QuadraticBezierCurve"===s||"QuadraticBezierCurve3"===s||"SplineCurve"===s||"CurvePath"===s||"Path"===s||"Shape"===s)i._saveCurveInDatabase(e,n,r,a);else if(o&&l)if(o.isGeometry){if(0===n.length&&(!o.vertices||0===o.vertices.length))return console.error(`Object ${e.name} geometry doesn't contain vertices ! Skip it.`),void a(null);if("Line"===s||"LineLoop"===s||"LineSegments"===s){if(Array.isArray(l)){let t=!1,r=void 0,i=void 0;for(let e=0,a=l.length;e<a;e++)if("LineBasicMaterial"!==(i=(r=l[e]).type)&&"LineDashedMaterial"!==i){t=!0;break}if(t)return console.error(`Object ${e.name} of type ${s}, contain an invalid material of type ${i} ! Skip it.`),void a(null)}else if("LineBasicMaterial"!==l.type&&"LineDashedMaterial"!==l.type)return console.error(`Object ${e.name} of type ${s}, contain an invalid material of type ${l.type} ! Skip it.`),void a(null)}else if("Points"===s)if(Array.isArray(l)){let t=!1,r=void 0,i=void 0;for(let e=0,a=l.length;e<a;e++)if("PointsMaterial"!==(i=(r=l[e]).type)){t=!0;break}if(t)return console.error(`Object ${e.name} of type ${s}, contain an invalid material of type ${i} ! Skip it.`),void a(null)}else if("PointsMaterial"!==l.type)return console.error(`Object ${e.name} of type ${s}, contain an invalid material of type ${l.type} ! Skip it.`),void a(null);i._saveGeometryInDatabase(o,r,t=>{i._saveMaterialInDatabase(l,r,s=>{i._saveObject3DInDatabase(e,n,t,s,r,a)})})}else if(o.isBufferGeometry){if(0===n.length&&(!o.attributes.position||0===o.attributes.position.count))return console.error(`Object ${e.name} geometry doesn't contain vertices ! Skip it.`),void a(null);if("Line"===s||"LineLoop"===s||"LineSegments"===s){if(Array.isArray(l)){let t=!1,r=void 0,i=void 0;for(let e=0,a=l.length;e<a;e++)if("LineBasicMaterial"!==(i=(r=l[e]).type)&&"LineDashedMaterial"!==i){t=!0;break}if(t)return console.error(`Object ${e.name} of type ${s}, contain an invalid material of type ${i} ! Skip it.`),void a(null)}else if("LineBasicMaterial"!==l.type&&"LineDashedMaterial"!==l.type)return console.error(`Object ${e.name} of type ${s}, contain an invalid material of type ${l.type} ! Skip it.`),void a(null)}else if("Points"===s)if(Array.isArray(l)){let t=!1,r=void 0,i=void 0;for(let e=0,a=l.length;e<a;e++)if("PointsMaterial"!==(i=(r=l[e]).type)){t=!0;break}if(t)return console.error(`Object ${e.name} of type ${s}, contain an invalid material of type ${i} ! Skip it.`),void a(null)}else if("PointsMaterial"!==l.type)return console.error(`Object ${e.name} of type ${s}, contain an invalid material of type ${l.type} ! Skip it.`),void a(null);i._saveBufferGeometryInDatabase(o,r,t=>{i._saveMaterialInDatabase(l,r,s=>{i._saveObject3DInDatabase(e,n,t,s,r,a)})})}else console.error(`Object ${e.name} contain an unknown/unmanaged geometry of type ${o.type} ! Skip it.`),a(null);else if(o&&!l)if(o.isGeometry){if(0===n.length&&(!o.vertices||0===o.vertices.length))return console.error(`Mesh ${e.name} geometry doesn't contain vertices ! Skip it.`),void a(null);i._saveGeometryInDatabase(o,r,t=>{i._saveObject3DInDatabase(e,n,t,[],r,a)})}else if(o.isBufferGeometry){if(0===n.length&&(!o.attributes.position||0===o.attributes.position.count))return console.error(`Mesh ${e.name} buffer geometry doesn't contain position attributes ! Skip it.`),void a(null);i._saveBufferGeometryInDatabase(o,r,t=>{i._saveObject3DInDatabase(e,n,t,null,r,a)})}else console.error(`Object ${e.name} contain an unknown/unmanaged geometry of type ${o.type} ! Skip it.`),a(null);else if(!o&&l){if("Sprite"!==s)return console.error(`Missing geometry for object ${e.name} of type ${s}. Only Sprite can contains material without geometry ! Skip it.`),void a(null);if(Array.isArray(l)){let t=!1,r=void 0,i=void 0;for(let e=0,a=l.length;e<a;e++)if("SpriteMaterial"!==(i=(r=l[e]).type)){t=!0;break}if(t)return console.error(`Object ${e.name} of type ${s}, contain an invalid material of type ${i} ! Skip it.`),void a(null)}else if("SpriteMaterial"!==l.type)return console.error(`Object ${e.name} of type ${s}, contain an invalid material of type ${l.type} ! Skip it.`),void a(null);i._saveMaterialInDatabase(l,r,t=>{i._saveObject3DInDatabase(e,n,null,t,r,a)})}else i._saveObject3DInDatabase(e,n,null,null,r,a)}_checkIfObject3DAlreadyExist(e){return null}_getObject3DModel(e,t,r,a){return e.parent=null,e.children=t,e.geometry=r,e.material=a,this._driver.model(e.type)(e)}_saveObject3DInDatabase(e,t,r,a,i,n){const s=this,o=this._checkIfObject3DAlreadyExist(e);o?n(o):this._getObject3DModel(e,t,r,a).save().then(e=>{const r=e.id;t&&t.length>0?function(t,a){const i=e._doc.children,n=i.length;let o=0,l=void 0;const d=[];for(let e=0;e<n;e++){l=i[e],s._driver.model("Objects3D").findByIdAndUpdate(l,{$set:{parent:r}},(e,r)=>{e&&d.push(e),++o<n||h(t,a)})}function h(e,t){d.length>0?e(d):t(r)}}(i,n):n(r)}).catch(i)}_checkIfCurveAlreadyExist(e){return null}_getCurveModel(e){return this._driver.model(e.type)(e)}_saveCurveInDatabase(e,t,r){const a=this._checkIfCurveAlreadyExist(e);a?r(a):this._getCurveModel(e).save().then(e=>{r(e.id)}).catch(t)}_checkIfGeometryAlreadyExist(e){return null}_getGeometryModel(e){return this._driver.model(e.type)(e)}_saveGeometryInDatabase(e,t,r){const a=this._checkIfGeometryAlreadyExist(e);a?r(a):this._getGeometryModel(e).save().then(e=>{r(e.id)}).catch(t)}_checkIfBufferGeometryAlreadyExist(e){return null}_getBufferGeometryModel(e){return this._driver.model(e.type)(e)}_saveBufferGeometryInDatabase(e,t,r){const a=this._checkIfBufferGeometryAlreadyExist(e);a?r(a):this._getBufferGeometryModel(e).save().then(e=>{r(e.id)}).catch(t)}_checkIfMaterialAlreadyExist(e){return null}_getMaterialModel(e,t){return e.texturesIds=t,this._driver.model(e.type)(e)}_saveMaterialInDatabase(e,t,r){const a=this;if(Array.isArray(e)){const i=e.length;let n=new Array(i),s=0,o=void 0;for(let l=0;l<i;l++){o=e[l];const d=this._checkIfMaterialAlreadyExist(o);d?(n[l]=d,++s===i&&r(n)):function(){const e=l;a._getMaterialModel(o).save().then(t=>{n[e]=t.id,++s===i&&r(n)}).catch(t)}()}}else{const a=this._checkIfMaterialAlreadyExist(e);a?r(a):this._getMaterialModel(e).save().then(e=>{r(e.id)}).catch(t)}}_checkIfTextureAlreadyExist(e){return null}_getTextureModel(e){return this._driver.model(e.type)(e)}_saveTextureInDatabase(e,t,r){const a=this._checkIfTextureAlreadyExist(e);a?r(a):this._getTextureModel(e).save().then(e=>{r(e.id)}).catch(t)}}function ColorType(e){class t extends e.SchemaType{constructor(e,t){super(e,t,"Color")}cast(t){if(iteeValidators.isNotDefined(t))throw new e.SchemaType.CastError(`Color: ${t} is null or undefined`);if(iteeValidators.isNotObject(t)&&!t.isColor)throw new e.SchemaType.CastError(`Color: ${t} is not a object or Color instance`);if(!("r"in t))throw new e.SchemaType.CastError(`Color: ${t} does not contain r property`);if(iteeValidators.isNotNumber(t.r))throw new e.SchemaType.CastError(`Color: ${t} expected to be a number`);if(!("g"in t))throw new e.SchemaType.CastError(`Color: ${t} does not contain g property`);if(iteeValidators.isNotNumber(t.g))throw new e.SchemaType.CastError(`Color: ${t} expected to be a number`);if(!("b"in t))throw new e.SchemaType.CastError(`Color: ${t} does not contain b property`);if(iteeValidators.isNotNumber(t.b))throw new e.SchemaType.CastError(`Color: ${t} expected to be a number`);return{r:t.r,g:t.g,b:t.b}}}return t.COLOR_BSON_TYPE=bson.BSON_DATA_OBJECT,e.Schema.Types.Color=t,e}var MongoDBThreePlugin=(new iteeDatabase.TMongoDBPlugin).addType(ColorType).addController(iteeDatabase.TMongooseController).addDescriptor({route:"/objects",controller:{name:"TMongooseController",options:{schemaName:"Objects3D"},can:{create:{on:"put",over:"/(:id)?"},read:{on:"post",over:"/(:id)?"},update:{on:"patch",over:"/(:id)?"},delete:{on:"delete",over:"/(:id)?"}}}}).addDescriptor({route:"/curves",controller:{name:"TMongooseController",options:{schemaName:"Curves"},can:{create:{on:"put",over:"/(:id)?"},read:{on:"post",over:"/(:id)?"},update:{on:"patch",over:"/(:id)?"},delete:{on:"delete",over:"/(:id)?"}}}}).addDescriptor({route:"/geometries",controller:{name:"TMongooseController",options:{schemaName:"Geometries"},can:{create:{on:"put",over:"/(:id)?"},read:{on:"post",over:"/(:id)?"},update:{on:"patch",over:"/(:id)?"},delete:{on:"delete",over:"/(:id)?"}}}}).addDescriptor({route:"/materials",controller:{name:"TMongooseController",options:{schemaName:"Materials"},can:{create:{on:"put",over:"/(:id)?"},read:{on:"post",over:"/(:id)?"},update:{on:"patch",over:"/(:id)?"},delete:{on:"delete",over:"/(:id)?"}}}}).addDescriptor({route:"/textures",controller:{name:"TMongooseController",options:{schemaName:"Textures"},can:{create:{on:"put",over:"/(:id)?"},read:{on:"post",over:"/(:id)?"},update:{on:"patch",over:"/(:id)?"},delete:{on:"delete",over:"/(:id)?"}}}}).addController(iteeDatabase.TAbstractConverterManager).addDescriptor({route:"/uploads",controller:{name:"TAbstractConverterManager",options:{useNext:!0,converters:{JsonToThree:new JsonToThree,ShpToThree:new ShpToThree,DbfToThree:new DbfToThree,MtlToThree:new MtlToThree,ObjToThree:new Obj2ToThree},rules:[{on:".json",use:"JsonToThree"},{on:".shp",use:"ShpToThree"},{on:".dbf",use:"DbfToThree"},{on:[".shp",".dbf"],use:["ShpToThree","DbfToThree"]},{on:".mtl",use:"MtlToThree"},{on:".obj",use:"ObjToThree"},{on:[".mtl",".obj"],use:["MtlToThree","ObjToThree"]}],inserter:ThreeToMongoDB},can:{processFiles:{on:"post",over:"/"}}}});module.exports=MongoDBThreePlugin;
//# sourceMappingURL=itee-plugin-three.cjs.min.js.map
