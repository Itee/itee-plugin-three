this.Itee=this.Itee||{},this.Itee.Plugin=this.Itee.Plugin||{},this.Itee.Plugin.Three=function(e,t,i,n,s){"use strict";class o{constructor(e=i.DefaultLoadingManager,n=t.DefaultLogger){this.manager=e,this.logger=n,this._boundingBox=new i.Box3,this._points=[],this._numberOfPoints=0,this._coloredPoints=!1,this._autoOffset=!1,this._offset={x:0,y:0,z:0},this._positions=null,this._bufferIndex=0,this._positionsC=null,this._bufferIndexC=0,this.wrongPoints=0}load(e,t,n,s,o){const r=new i.FileLoader(this.manager);r.setResponseType("blob"),r.load(e,function(e){const r=new i.Group;this._parse(e,r,t,n,s,o),t(r)}.bind(this),n,s)}setOffset(e){this._offset=e,this._autoOffset=!1}_parse(e,t,i,n,s,o){const r=this,a=o||100,l=new FileReader,h=134217728;let c=0;function d(){if(c>=e.size)return;const t=e.slice(c,c+h,"text/plain");l.readAsText(t)}l.onabort=e=>{this.logger.log("abortEvent:"),this.logger.log(e)},l.onerror=e=>{this.logger.log("errorEvent:"),this.logger.log(e),s&&s(e)},l.onloadstart=e=>{this.logger.log("loadStartEvent:"),this.logger.log(e)},l.onprogress=e=>{this.logger.log("progressEvent:"),this.logger.log(e),n&&n(e)},l.onload=e=>{this.logger.log("loadEvent:"),this.logger.log(e);const t=e.target.result.split("\n"),i=t.length;c-=t[i-1].length;const n=Math.round(100/a);for(let e=0;e<i-1;e++)e%n==0&&r._parseLine(t[e])},l.onloadend=i=>{this.logger.log("loadEndEvent"),this.logger.log(i),(this._points.length>1e6||c+h>=e.size)&&(this._offsetPoints(),this._createSubCloudPoint(t)),c+=h,d()},d()}_parseLine(e){const t=e.split(/\s/g).filter(Boolean),i=t.length;3===i?this._points.push({x:parseFloat(t[0]),y:parseFloat(t[1]),z:parseFloat(t[2])}):4===i?(this._pointsHaveIntensity=!0,this._points.push({x:parseFloat(t[0]),y:parseFloat(t[1]),z:parseFloat(t[2]),i:parseFloat(t[3])})):6===i?(this._pointsHaveColor=!0,this._points.push({x:parseFloat(t[0]),y:parseFloat(t[1]),z:parseFloat(t[2]),r:parseFloat(t[3]),g:parseFloat(t[4]),b:parseFloat(t[5])})):7===i?(this._pointsHaveIntensity=!0,this._pointsHaveColor=!0,this._points.push({x:parseFloat(t[0]),y:parseFloat(t[1]),z:parseFloat(t[2]),i:parseFloat(t[3]),r:parseFloat(t[4]),g:parseFloat(t[5]),b:parseFloat(t[6])})):9===i?(this._pointsHaveColor=!0,this._pointsHaveNormals=!0,this._points.push({x:parseFloat(t[0]),y:parseFloat(t[1]),z:parseFloat(t[2]),r:parseFloat(t[3]),g:parseFloat(t[4]),b:parseFloat(t[5]),nx:parseFloat(t[6]),ny:parseFloat(t[7]),nz:parseFloat(t[8])})):10===i?(this._pointsHaveIntensity=!0,this._pointsHaveColor=!0,this._pointsHaveNormals=!0,this._points.push({x:parseFloat(t[0]),y:parseFloat(t[1]),z:parseFloat(t[2]),i:parseFloat(t[3]),r:parseFloat(t[4]),g:parseFloat(t[5]),b:parseFloat(t[6]),nx:parseFloat(t[7]),ny:parseFloat(t[8]),nz:parseFloat(t[9])})):this.logger.error(`Invalid data line: ${e}`)}_parseLines(e){const t=e[0].split(/\s/g).filter(Boolean).length;3===t?this._parseLinesAsXYZ(e):4===t?this._parseLinesAsXYZI(e):6===t?this._parseLinesAsXYZRGB(e):7===t?this._parseLinesAsXYZIRGB(e):9===t?this._parseLinesAsXYZRGBnXnYnZ(e):10===t?this._parseLinesAsXYZIRGBnXnYnZ(e):this.logger.error(`Invalid data line: ${e}`)}_parseLinesAsXYZ(e){let t=[];for(let i=0,n=e.length;i<n;i++)t=e[i].split(/\s/g).filter(Boolean),this._points.push({x:parseFloat(t[0]),y:parseFloat(t[1]),z:parseFloat(t[2])})}_parseLinesAsXYZI(e){this._pointsHaveIntensity=!0;let t=[];for(let i=0,n=e.length;i<n;i++)t=e[i].split(/\s/g).filter(Boolean),this._points.push({x:parseFloat(t[0]),y:parseFloat(t[1]),z:parseFloat(t[2]),i:parseFloat(t[3])})}_parseLinesAsXYZRGB(e){this._pointsHaveColor=!0;let t=[];for(let i=0,n=e.length;i<n;i++)t=e[i].split(/\s/g).filter(Boolean),this._points.push({x:parseFloat(t[0]),y:parseFloat(t[1]),z:parseFloat(t[2]),r:parseFloat(t[3]),g:parseFloat(t[4]),b:parseFloat(t[5])})}_parseLinesAsXYZnXnYnZ(e){let t=[];for(let i=0,n=e.length;i<n;i++)t=e[i].split(/\s/g).filter(Boolean),this._points.push({x:parseFloat(t[0]),y:parseFloat(t[1]),z:parseFloat(t[2]),nx:parseFloat(t[7]),ny:parseFloat(t[8]),nz:parseFloat(t[9])})}_parseLinesAsXYZIRGB(e){this._pointsHaveIntensity=!0,this._pointsHaveColor=!0;let t=[];for(let i=0,n=e.length;i<n;i++)t=e[i].split(/\s/g).filter(Boolean),this._points.push({x:parseFloat(t[0]),y:parseFloat(t[1]),z:parseFloat(t[2]),i:parseFloat(t[3]),r:parseFloat(t[4]),g:parseFloat(t[5]),b:parseFloat(t[6])})}_parseLinesAsXYZInXnYnZ(e){let t=[];for(let i=0,n=e.length;i<n;i++)t=e[i].split(/\s/g).filter(Boolean),this._points.push({x:parseFloat(t[0]),y:parseFloat(t[1]),z:parseFloat(t[2]),i:parseFloat(t[3]),nx:parseFloat(t[7]),ny:parseFloat(t[8]),nz:parseFloat(t[9])})}_parseLinesAsXYZRGBnXnYnZ(e){this._pointsHaveColor=!0,this._pointsHaveNormals=!0;let t=[];for(let i=0,n=e.length;i<n;i++)t=e[i].split(/\s/g).filter(Boolean),this._points.push({x:parseFloat(t[0]),y:parseFloat(t[1]),z:parseFloat(t[2]),r:parseFloat(t[3]),g:parseFloat(t[4]),b:parseFloat(t[5]),nx:parseFloat(t[6]),ny:parseFloat(t[7]),nz:parseFloat(t[8])})}_parseLinesAsXYZIRGBnXnYnZ(e){this._pointsHaveIntensity=!0,this._pointsHaveColor=!0,this._pointsHaveNormals=!0;let t=[];for(let i=0,n=e.length;i<n;i++)t=e[i].split(/\s/g).filter(Boolean),this._points.push({x:parseFloat(t[0]),y:parseFloat(t[1]),z:parseFloat(t[2]),i:parseFloat(t[3]),r:parseFloat(t[4]),g:parseFloat(t[5]),b:parseFloat(t[6]),nx:parseFloat(t[7]),ny:parseFloat(t[8]),nz:parseFloat(t[9])})}_parseLineB(e){const t=e.split(/\s/g).filter(Boolean),i=t.length,n=this._bufferIndex;3===i&&(this._positions[n]=parseFloat(t[0]),this._positions[n+1]=parseFloat(t[1]),this._positions[n+2]=parseFloat(t[2]),this._bufferIndex+=3)}_parseLineC(e){const t=e.split(/\s/g).filter(Boolean),i=t.length,n=this._bufferIndexC;3===i&&(this._positionsC[n]=Number.parseFloat(t[0]),this._positionsC[n+1]=Number.parseFloat(t[1]),this._positionsC[n+2]=Number.parseFloat(t[2]),this._bufferIndexC+=3)}_offsetPoints(){this._autoOffset&&(this._boundingBox.setFromPoints(this._points),this.setOffset(this._boundingBox.getCenter()));const e=this._offset.x,t=this._offset.y,i=this._offset.z;let n=null;for(let s=0,o=this._points.length;s<o;++s)(n=this._points[s]).x-=e,n.y-=t,n.z-=i}_createCloudPoint(e){const t=this._points.length,n=Math.ceil(t/1e6);let s=null,o=0,r=null;for(let t=0;t<n;++t){o=(s=this._points.splice(0,1e6)).length;const t=new i.BufferGeometry,n=new Float32Array(3*o),a=new Float32Array(3*o);let l=0,h=null;for(let e=0;e<o;++e)h=s[e],n[l]=h.x,n[l+1]=h.y,n[l+2]=h.z,this._pointsHaveColor?(a[l]=h.r/255,a[l+1]=h.g/255,a[l+2]=h.b/255):(a[l]=.1,a[l+1]=.2,a[l+2]=.5),l+=3;t.addAttribute("position",new i.BufferAttribute(n,3)),t.addAttribute("color",new i.BufferAttribute(a,3));const c=new i.PointsMaterial({size:.01,vertexColors:!0});r=new i.Points(t,c),e.children.push(r)}}_createSubCloudPoint(e){const t=this._points.length,n=new i.BufferGeometry,s=new Float32Array(3*t),o=new Float32Array(3*t);let r=0,a=null;for(let e=0;e<t;++e)a=this._points[e],s[r]=a.x,s[r+1]=a.y,s[r+2]=a.z,this._pointsHaveColor?(o[r]=a.r/255,o[r+1]=a.g/255,o[r+2]=a.b/255):(o[r]=.1,o[r+1]=.2,o[r+2]=.5),r+=3;n.addAttribute("position",new i.BufferAttribute(s,3)),n.addAttribute("color",new i.BufferAttribute(o,3));const l=new i.PointsMaterial({size:.005,vertexColors:!0}),h=new i.Points(n,l);h.rotation.x-=Math.PI/2,e.children.push(h),this._points=[]}}const r=Object.freeze({FoxPro:48,FoxPro_Autoincrement:49,dBASE_II:2,FoxPro_Var:50,dBASE_III_plus:3,dBASE_III_plus_memo:131,dBASE_IV_SQL_table:67,dBASE_IV_SQL_system:99,dBASE_IV_memo:139,dBASE_IV_memo_SQL_table:203,FoxBase:251,dBase_v_7:4,FoxPro_2_x:245,HiPerSix_memo:229}),a=Object.freeze({Binary:"B",Character:"C",Date:"D",Numeric:"N",Logical:"L",Memo:"M",Timestamp:"@",Long:"I",Autoincrement:"+",Float:"F",Double:"O",OLE:"G"});function l(e=i.DefaultLoadingManager,n=t.DefaultLogger){this.manager=e,this.logger=n,this.reader=new t.TBinaryReader}function h(e=i.DefaultLoadingManager,n=t.DefaultLogger){this.manager=e,this.logger=n,this.textureLoader=new i.TextureLoader,this.imagesShotData=[]}Object.assign(l,{Terminator:13,DeletedRecord:26,YearOffset:1900}),Object.assign(l.prototype,{load(e,t,n,s){const o=this,r=new i.FileLoader(o.manager);r.setResponseType("arraybuffer"),r.load(e,e=>{t(o.parse(e))},n,s)},parse(e){this.reader.setEndianess(t.Endianness.Big).setBuffer(e);const i=this.reader.getInt8();if(!this._isValidVersion(i))return this.logger.error(`DBFLoader: Invalid version number: ${i}`),null;const n=this._parseHeader(i);return{header:n,datas:this._parseDatas(i,n)}},_isValidVersion:e=>Object.values(r).includes(e),_parseHeader(e){let t={};switch(e){case r.FoxPro:case r.FoxPro_Autoincrement:case r.FoxPro_Var:case r.dBASE_II:t=this._parseHeaderV2();break;case r.dBASE_III_plus:case r.dBASE_III_plus_memo:t=this._parseHeaderV2_5();break;case r.dBASE_IV_memo:case r.dBASE_IV_memo_SQL_table:case r.dBASE_IV_SQL_system:case r.dBASE_IV_SQL_table:t=this._parseHeaderV3();break;case r.dBase_v_7:case r.FoxPro_2_x:case r.HiPerSix_memo:t=this._parseHeaderV4();break;default:throw new RangeError(`Invalid version parameter: ${e}`)}return this.reader.getUint8()!==l.Terminator&&this.logger.error("DBFLoader: Invalid terminator after field descriptors !!!"),t},_parseHeaderV2(){const e=this.reader.getInt16(),t=this.reader.getInt8()+l.YearOffset,i=this.reader.getInt8(),n=this.reader.getInt8(),s=this.reader.getInt16();let o=[],r=void 0,a=void 0,h=void 0,c=void 0,d=void 0;for(let t=0;t<e;t++)r=this.reader.getString(11),a=this.reader.getChar(),h=this.reader.getUint8(),c=this.reader.getInt16(),d=this.reader.getInt8(),o.push({name:r,type:a,length:h,memoryAddress:c,decimalCount:d});return{numberOfRecords:e,year:t,month:i,day:n,lengthOfEachRecords:s,fields:o}},_parseHeaderV2_5(){const e=this.reader.getInt8()+l.YearOffset,i=this.reader.getInt8(),n=this.reader.getInt8();this.reader.setEndianess(t.Endianness.Little);const s=this.reader.getInt32(),o=this.reader.getInt16(),r=this.reader.getInt16();this.reader.setEndianess(t.Endianness.Big),this.reader.skipOffsetOf(20);let a=[],h=void 0,c=void 0,d=void 0,u=void 0,p=void 0,m=void 0,f=void 0;for(let e=0;e<s;e++)h=this.reader.getString(11),c=this.reader.getChar(),u=this.reader.getInt32(),d=this.reader.getUint8(),p=this.reader.getUint8(),this.reader.skipOffsetOf(2),m=this.reader.getInt8(),this.reader.skipOffsetOf(2),f=this.reader.getInt8(),this.reader.skipOffsetOf(1),a.push({name:h,type:c,length:d,memoryAddress:u,decimalCount:p,workAreaId:m,MDXFlag:f});return{year:e,month:i,day:n,numberOfRecords:s,numberOfByteInHeader:o,numberOfByteInRecord:r,fields:a}},_parseHeaderV3(){const e=this.reader.getInt8()+l.YearOffset,i=this.reader.getInt8(),n=this.reader.getInt8();this.reader.setEndianess(t.Endianness.Little);const s=this.reader.getInt32(),o=this.reader.getInt16(),r=this.reader.getInt16();this.reader.setEndianess(t.Endianness.Big),this.reader.skipOffsetOf(2);const a=this.reader.getInt8(),h=this.reader.getInt8();this.reader.skipOffsetOf(12);const c=this.reader.getInt8(),d=this.reader.getInt8();this.reader.skipOffsetOf(2);let u=[],p=void 0,m=void 0,f=void 0,g=void 0,_=void 0,b=void 0;for(;this.reader.getOffset()<o-1;)p=this.reader.getString(11),m=this.reader.getChar(),this.reader.skipOffsetOf(4),f=this.reader.getUint8(),g=this.reader.getUint8(),this.reader.skipOffsetOf(2),_=this.reader.getInt8(),this.reader.skipOffsetOf(10),b=this.reader.getInt8(),u.push({name:p,type:m,length:f,decimalCount:g,workAreaId:_,MDXFieldFlag:b});return{year:e,month:i,day:n,numberOfRecords:s,numberOfByteInHeader:o,numberOfByteInRecord:r,incompleteTransactionFlag:a,encryptionFlag:h,MDXFlag:c,languageDriverId:d,fields:u}},_parseHeaderV4(){const e=this.reader.getInt8()+l.YearOffset,i=this.reader.getInt8(),n=this.reader.getInt8();this.reader.setEndianess(t.Endianness.Little);const s=this.reader.getInt32(),o=this.reader.getInt16(),r=this.reader.getInt16();this.reader.setEndianess(t.Endianness.Big),this.reader.skipOffsetOf(2);const a=this.reader.getInt8(),h=this.reader.getInt8();this.reader.skipOffsetOf(12);const c=this.reader.getInt8(),d=this.reader.getInt8();this.reader.skipOffsetOf(2);const u=this.reader.getString(32);this.reader.skipOffsetOf(4);let p=[],m=void 0,f=void 0,g=void 0,_=void 0,b=void 0,y=void 0;for(let e=0;e<s;e++)m=this.reader.getString(32),f=this.reader.getChar(),g=this.reader.getUint8(),_=this.reader.getUint8(),this.reader.skipOffsetOf(2),b=this.reader.getInt8(),this.reader.skipOffsetOf(2),y=this.reader.getInt32(),this.reader.skipOffsetOf(4),p.push({name:m,type:f,length:g,decimalCount:_,MDXFieldFlag:b,nextAutoincrementValue:y});return{year:e,month:i,day:n,numberOfRecords:s,numberOfByteInHeader:o,numberOfByteInRecord:r,incompleteTransactionFlag:a,encryptionFlag:h,MDXFlag:c,languageDriverId:d,languageDriverName:u,fields:p}},_parseDatas(e,t){const i=t.numberOfRecords,n=t.fields;let s=[],o=null,r=null;for(let e=0;e<i;e++){(o={}).deleted=this.reader.getUint8()===l.DeletedRecord;for(let e=0,t=n.length;e<t;e++)switch((r=n[e]).type){case a.Binary:{const e=this.reader.getString(r.length);o[r.name]=parseInt(e)}break;case a.Numeric:{const e=this.reader.getString(r.length);o[r.name]=parseInt(e)}break;case a.Character:case a.Date:o[r.name]=this.reader.getString(r.length);break;case a.Logical:{const e=this.reader.getChar().toLowerCase();o[r.name]="t"===e||"y"===e||"f"!==e&&"n"!==e&&null}break;case a.Memo:o[r.name]=this.reader.getString(r.length);break;case a.Timestamp:break;case a.Long:case a.Autoincrement:o[r.name]=this.reader.getInt32();break;case a.Float:{const e=this.reader.getString(r.length);o[r.name]=parseInt(e)}break;case a.Double:o[r.name]=this.reader.getFloat64();break;case a.OLE:o[r.name]=this.reader.getString(r.length);break;default:throw new RangeError(`Invalid data type parameter: ${r.type}`)}s.push(o)}return s},_parseFieldProperties(){const e=this.reader.getInt16(),t=this.reader.getInt16(),i=this.reader.getInt16(),n=this.reader.getInt16(),s=this.reader.getInt16(),o=this.reader.getInt16(),r=this.reader.getInt16(),a=this.reader.getInt16();let l=[];for(let t=0;t<e;t++)l.push(this._getStandardProperties());let h=[];for(let e=0;e<i;e++)h.push(this._getCustomProperties());let c=[];for(let e=0;e<s;e++)c.push(this._getReferentialIntegrityProperties());return{numberOfStandardProperties:e,startOfStandardPropertiesDescriptor:t,numberOfCustomProperties:i,startOfCustomPropertiesDescriptor:n,numberOfReferentialIntegrityProperties:s,startOfReferentialIntegrityDescriptor:o,startOfData:r,sizeOfPropertiesStructure:a,standardProperties:l,customProperties:h,referentialIntegrityProperties:c}},_getStandardProperties(){const e=this.reader.getInt16(),t=this.reader.getInt16(),i=this.reader.getInt8(),n=this.reader.getInt8(),s=this.reader.getInt8();return this.reader.skipOffsetOf(4),{generationalNumber:e,tableFieldOffset:t,propertyDescribed:i,type:n,isConstraint:s,offsetFromStart:this.reader.getInt16(),widthOfDatabaseField:this.reader.getInt16()}},_getCustomProperties(){const e=this.reader.getInt16(),t=this.reader.getInt16(),i=this.reader.getInt8();return this.reader.skipOffsetOf(1),{generationalNumber:e,tableFieldOffset:t,type:i,offsetFromStartOfName:this.reader.getInt16(),lengthOfName:this.reader.getInt16(),offsetFromStartOfData:this.reader.getInt16(),lengthOfData:this.reader.getInt16()}},_getReferentialIntegrityProperties(){return{databaseState:this.reader.getInt8(),sequentialNumberRule:this.reader.getInt16(),offsetOfTheRIRuleName:this.reader.getInt16(),sizeOfTheRIRuleName:this.reader.getInt16(),offsetOfNameOfForeignTable:this.reader.getInt16(),sizeOfNameOfForeignTable:this.reader.getInt16(),stateBehaviour:this.reader.getInt8(),numberOfFieldsInLinkingKey:this.reader.getInt16(),offsetOfLocalTableTagName:this.reader.getInt16(),sizeOfTheLocalTableTagName:this.reader.getInt16(),offsetOfForeignTableTagName:this.reader.getInt16(),sizeOfTheForeignTableTagName:this.reader.getInt16()}}}),Object.assign(h.prototype,{constructor:h,load:function(e,t,n,s){const o=e.replace(/[^/]*$/,""),r=new i.FileLoader(this.manager);r.setResponseType("text/plain"),r.load(e,e=>{t(this._parse(e,o))},n,s)},_parse(e,t){let i=null;if(window.DOMParser){i=(new DOMParser).parseFromString(e,"text/xml")}else(i=new window.ActiveXObject("Microsoft.XMLDOM")).async=!1,i.loadXML(e);const n=i.getElementsByTagName("SHOT");let s=null,o=null,r=null,a=null;for(let e=0,t=n.length;e<t;++e)r=(o=(s=n[e]).children[0]).children[0],a=o.children[1],this.imagesShotData.push({imageName:s.attributes.n.value,position:{x:parseFloat(r.attributes.x.value),y:parseFloat(r.attributes.y.value),z:parseFloat(r.attributes.z.value)},rotation:{x:parseFloat(a.attributes.x.value),y:parseFloat(a.attributes.y.value),z:parseFloat(a.attributes.z.value)}});return this._createImagesPacks(t)},_createImagesPacks(e){for(var t=this.imagesShotData,n=new i.Group,s=void 0,o=void 0,r=0,a=t.length;r<a;++r)s=t[r],(o=new i.Mesh(new i.PlaneGeometry(.06528,.04896,1,1),new i.MeshBasicMaterial({color:16777215,side:i.DoubleSide}))).name=s.imageName,o.position.x=s.position.x-600200,o.position.y=s.position.y-131400,o.position.z=s.position.z-60-.34,o.rotation.x=i._Math.degToRad(s.rotation.x),o.rotation.y=i._Math.degToRad(s.rotation.z),o.rotation.z=-i._Math.degToRad(s.rotation.y),o.userData={filePath:e},n.add(o);return n.rotateX(-Math.PI/2),n}});const c=Object.freeze({NullShape:0,Point:1,Polyline:3,Polygon:5,MultiPoint:8,PointZ:11,PolyLineZ:13,PolygonZ:15,MultiPointZ:18,PointM:21,PolylineM:23,PolygonM:25,MultiPointM:28,MultiPatch:31});function d(e,t){let i=t[0],n=t[1],s=-1;for(let o=0,r=e.length,a=r-1;o<r;a=o++){const r=e[o],l=r[0],h=r[1],c=e[a],d=c[0],p=c[1];u(r,c,t)?s=0:h>n!=p>n&&i<(d-l)*(n-h)/(p-h)+l&&(s=-s)}return s}function u(e,t,i){var n=i[0]-e[0],s=i[1]-e[1];if(0===n&&0===s)return!0;var o=t[0]-e[0],r=t[1]-e[1];if(0===o&&0===r)return!1;var a=(n*o+s*r)/(o*o+r*r);return!(a<0||a>1)&&(0===a||1===a||a*o===n&&a*r===s)}function p(e=i.DefaultLoadingManager,n=t.DefaultLogger){this.manager=e,this.logger=n,this.globalOffset=new i.Vector3,this.worldAxis={from:"zUp",to:"zForward"},this._reader=new t.TBinaryReader}function m(e){return e.substring(e.lastIndexOf("/")+1)}function f(e){return e.slice(2+(e.lastIndexOf(".")-1>>>0))}function g(e){const t=function(e){return e.substring(0,e.lastIndexOf("/"))}(e);return e.indexOf("blob")>-1?t:e}function _(e=i.DefaultLoadingManager,n=t.DefaultLogger){this.manager=e,this.logger=n}Object.assign(p,{FileCode:9994,MinFileLength:100,MinVersion:1e3}),Object.assign(p.prototype,{load(e,t,n,s){const o=this,r=new i.FileLoader(o.manager);r.setResponseType("arraybuffer"),r.load(e,e=>{t(o.parse(e))},n,s)},parse(e){this._reader.setEndianess(t.Endianness.Big).setBuffer(e);const i=this._parseHeader();if(i.fileCode!==p.FileCode)return this.logger.error("SHPLoader: Invalide Shape file code !"),null;if(i.fileLength<p.MinFileLength)return this.logger.error("SHPLoader: Shape file have an incorrect length !"),null;if(!Object.values(c).includes(i.shapeType))return this.logger.error("SHPLoader: Shape file have an incorrect shape type !"),null;i.version<p.MinVersion&&this.logger.warn("SHPLoader: Version of shape file below than 1000 could be incorrectly parsed !");const n=this._parseDatas(i);return this._convertToObjects(n)},_parseHeader(){const e=this._reader.getInt32();this._reader.skipOffsetOf(20);const i=this._reader.getInt32();this._reader.setEndianess(t.Endianness.Little);const n=this._reader.getInt32(),s=this._reader.getInt32(),o=this._reader.getInt32(),r=this._reader.getInt32();return{fileCode:e,fileLength:i,version:n,shapeType:s,boundingBox:{xMin:o,xMax:this._reader.getInt32(),yMin:r,yMax:this._reader.getInt32(),zMin:this._reader.getInt32(),zMax:this._reader.getInt32(),mMin:this._reader.getInt32(),mMax:this._reader.getInt32()}}},_parseDatas(e){this._reader.skipOffsetTo(100);let i=[],n=void 0,s=void 0,o=void 0;for(;!this._reader.isEndOfFile();)switch(n=this._parseRecordHeader(),s=this._reader.getOffset()+2*n.contentLength,this._reader.setEndianess(t.Endianness.Little),e.shapeType){case c.NullShape:this._reader.skipOffsetTo(s);break;case c.Point:case c.PointZ:case c.PointM:for(;this._reader.getOffset()<s;)(o=this._parsePoint())&&i.push(o);break;case c.Polyline:case c.PolyLineZ:case c.PolylineM:for(;this._reader.getOffset()<s;)(o=this._parsePolyLine())&&i.push(o);break;case c.Polygon:case c.PolygonZ:case c.PolygonM:for(;this._reader.getOffset()<s;)(o=this._parsePolyLine())&&i.push(o);break;case c.MultiPoint:case c.MultiPointZ:case c.MultiPointM:for(;this._reader.getOffset()<s;)(o=this._parseMultiPoint())&&i.push(o);break;case c.MultiPatch:for(;this._reader.getOffset()<s;)(o=this._parseMultiPatch())&&i.push(o);break;default:this.logger.error(`SHPLoader: Invalid switch parameter: ${e.shapeType}`)}return i},_parseRecordHeader(){return this._reader.setEndianess(t.Endianness.Big),{recordNumber:this._reader.getInt32(),contentLength:this._reader.getInt32()}},_parsePoint(){const e=this._reader.getInt32();return e===c.NullShape?null:{shapeType:e,x:this._reader.getFloat64(),y:this._reader.getFloat64()}},_parsePolyLine(){const e=this._reader.getInt32();if(e===c.NullShape)return null;const t={xMin:this._reader.getFloat64(),yMin:this._reader.getFloat64(),xMax:this._reader.getFloat64(),yMax:this._reader.getFloat64()},i=this._reader.getInt32(),n=this._reader.getInt32(),s=new Array(i);for(let e=0;e<i;e++)s[e]=this._reader.getInt32();const o=new Array(n);for(let e=0;e<n;e++)o[e]={x:this._reader.getFloat64(),y:this._reader.getFloat64()};return{shapeType:e,boundingBox:t,numberOfParts:i,numberOfPoints:n,parts:s,points:o}},_parsePolygon(){const e=this._reader.getInt32();if(e===c.NullShape)return null;const t={xMin:this._reader.getFloat64(),yMin:this._reader.getFloat64(),xMax:this._reader.getFloat64(),yMax:this._reader.getFloat64()},i=this._reader.getInt32(),n=this._reader.getInt32();let s=new Array(i);for(let e=0;e<i;e++)s[e]=this._reader.getInt32();let o=new Array(n);for(let e=0;e<n;e++)o[e]={x:this._reader.getFloat64(),y:this._reader.getFloat64()};const r=[],a=[];return s.forEach((e,t)=>{const i=o.slice(e,s[t+1]);!function(e){if((t=e.length)<4)return!1;for(var t,i=0,n=e[t-1][1]*e[0][0]-e[t-1][0]*e[0][1];++i<t;)n+=e[i-1][1]*e[i][0]-e[i-1][0]*e[i][1];return n>=0}(i)?a.push(i):r.push(i)}),a.forEach(e=>{r.some(t=>{if(function(e,t){let i=0,n=t.length;do{if(d(e,t[i])>0)return!0}while(++i<n);return!1}(t[0],e))return t.push(e),!0})||r.push([e])}),{shapeType:e,boundingBox:t,numberOfParts:i,numberOfPoints:n,parts:s,polygons:r}},_parseMultiPoint(){const e=this._reader.getInt32();if(e===c.NullShape)return null;const t={xMin:this._reader.getFloat64(),xMax:this._reader.getFloat64(),yMin:this._reader.getFloat64(),yMax:this._reader.getFloat64()},i=this._reader.getInt32(),n=new Array(i);for(let e=0;e<i;e++)n.push([this._reader.getFloat64(),this._reader.getFloat64()]);return{shapeType:e,boundingBox:t,numberOfPoints:i,points:n}},_parseMultiPatch(){const e=this._reader.getInt32();return e===c.NullShape?null:{shapeType:e}},_convertToObjects(e){let t=[];for(let t=0,i=e.length;t<i;t++){let i=e[t];i.shapeType!==c.Polygon&&i.shapeType!==c.PolygonZ&&i.shapeType!==c.PolygonM||(i.points&&Array.isArray(i.points[0])?n(i.points):s(i.points))}function n(e){for(let t=0,i=e.length;t<i;t++){let i=e[t];i?Array.isArray(i[0])?n(i):s(i):this.logger.log("no array, oups !")}}function s(e){t.push(new i.Shape(e))}return t}}),Object.assign(_.prototype,{load(e,t,i,n){if(e)if(e instanceof FileList){const s=e.length;this.logger.log(`numberOfFiles: ${s}`);const o=[];let r="",a=null;for(let t=0;t<s;++t)a=e[t],r=`${URL.createObjectURL(a)}/${a.name}`,o.push({url:r});this.load(o,t,i,n)}else if(e instanceof File){const s=`${URL.createObjectURL(e)}/${e.name}`;this.loadSingleFile({url:s},t,i,n)}else if(s.isObject(e))this.loadSingleFile(e,t,i,n);else if(s.isFunction(e))this.load(e(),t,i,n);else if(s.isArray(e))if(2===e.length&&s.isObject(e[0])&&s.isObject(e[1]))this.loadAssociatedFiles(e,t,i,n);else for(let s=0,o=e.length;s<o;s++)this.load(e[s],t,i,n);else s.isString(e)?this.loadSingleFile({url:e},t,i,n):this.logger.error("TUniversalLoader: Invalid files parameter !!!");else this.logger.error("Unable to load null or undefined files !")},loadSingleFile(e,i,n,s){const o=e.url,r=f(m(o));switch(e.url=g(o),r){case t.FileFormat.Asc.value:this._loadAsc(e,i,n,s);break;case t.FileFormat.Dae.value:this._loadDae(e,i,n,s);break;case t.FileFormat.Dbf.value:this._loadDbf(e,i,n,s);break;case t.FileFormat.Fbx.value:this._loadFbx(e,i,n,s);break;case t.FileFormat.Json.value:this._loadJson(e,i,n,s);break;case t.FileFormat.Obj.value:this._loadObj(e,i,n,s);break;case t.FileFormat.Shp.value:this._loadShp(e,i,n,s);break;case t.FileFormat.Stl.value:this._loadStl(e,i,n,s);break;default:throw new RangeError(`Invalid file extension: ${r}. Supported formats are: ${t.FileFormat.toString()}`)}},loadAssociatedFiles(e,i,n,s){const o=e[0],r=o.url,a=f(m(r));o.url=g(r);const l=e[1],h=l.url,c=f(m(h));l.url=g(h),a===t.FileFormat.Mtl.value&&c===t.FileFormat.Obj.value?this._loadObjMtlCouple(l,o,i,n,s):a===t.FileFormat.Obj.value&&c===t.FileFormat.Mtl.value?this._loadObjMtlCouple(o,l,i,n,s):a===t.FileFormat.Shp.value&&c===t.FileFormat.Dbf.value?this._loadShpDbfCouple(o,l,i,n,s):a===t.FileFormat.Dbf.value&&c===t.FileFormat.Shp.value?this._loadShpDbfCouple(l,o,i,n,s):(this.loadSingleFile(e[0],i,n,s),this.loadSingleFile(e[1],i,n,s))},_loadAsc(e,t,i,n){new o(this.manager).load(e.url,t,i,n)},_loadDae(e,t,n,s){new i.ColladaLoader(this.manager).load(e.url,e=>{t(e.scene)},n,s)},_loadDbf(e,t,i,n){new l(this.manager).load(e.url,t,i,n)},_loadFbx(e,t,n,s){new i.FBXLoader(this.manager).load(e.url,i=>{const n=e.position;n&&i.position.set(n.x,n.y,n.z),t(i)},n,s)},_loadJson(e,t,n,s){new i.ObjectLoader(this.manager).load(e.url,t,n,s)},_loadObj(e,t,n,s){new i.OBJLoader(this.manager).load(e.url,t,n,s)},_loadShp(e,t,s,o){new p(this.manager).load(e.url,e=>{const s=new i.Group;for(let t=0,n=e.length;t<n;t++)s.add(new i.Mesh(new i.ShapeBufferGeometry(e[t]),new i.MeshPhongMaterial({color:16777215*Math.random(),side:i.DoubleSide})));s.rotateX(n.degreesToRadians(-90)),t(s)},s,o)},_loadStl(e,t,n,s){new i.STLLoader(this.manager).load(e.url,n=>{const s=new i.MeshPhongMaterial,o=new i.Mesh(n,s),r=e.position;r&&o.position.set(r.x,r.y,r.z),t(o)},n,s)},_loadObjMtlCouple(e,t,n,s,o){const r=new i.MTLLoader(this.manager),a=new i.OBJLoader(this.manager),l=t.texturePath;l&&r.setTexturePath(l),r.load(t.url,t=>{t.preload();for(let e=0,i=t.materials.length;e<i;e++){const i=t.materials[e];i.opacity=1,t.materials[e]=i}a.setMaterials(t),a.load(e.url,n,s,o)},s,o)},_loadShpDbfCouple(e,t,n,s,o){let r=void 0,a=void 0;function h(){if(!r||!a)return;const e=new i.Group;e.name="Locaux";let t=void 0;for(let n=0,s=r.length;n<s;n++){t=new i.Mesh(new i.ShapeBufferGeometry(r[n]),new i.MeshPhongMaterial({color:11596470,side:i.DoubleSide}));const s=a.datas[n].CODE;t.name=s,t.userData.Code=s,e.add(t)}n(e)}new p(this.manager).load(e.url,e=>{r=e,h()},s,o),new l(this.manager).load(t.url,e=>{a=e,h()},s,o)}});const b=new i.Vector3(0,0,-1),y=new i.Vector3(0,0,1),v=new i.Vector3(0,1,0),w=new i.Vector3(0,-1,0),E=new i.Vector3(1,0,0),x=new i.Vector3(-1,0,0),M=n.toEnum({None:0,Rotating:1,Panning:2,Rolling:3,Zooming:4,Moving:5}),D=n.toEnum({FirstPerson:1,Orbit:2,Fly:3,Path:4});const P=Math.PI/2,A={NONE:-1,ROTATE:0,ZOOM:1,PAN:2},T=new i.Vector3(1,0,0),S=new i.Vector3(0,1,0);function O(e={}){const n={camera:null,target:new i.Object3D,mode:D.Orbit,domElement:document,...e},s=this;let o=A.NONE;this.camera=n.camera,this.cameraJump=0,this.paths=[],this.pathsMap=new Map,this.currentPath=void 0,this.currentPathIndex=-1,this.currentPathPosition=0,this.domElement=n.domElement,this.forwardControl=this.domElement.children[0].children[0].children[0],this.backwardControl=this.domElement.children[0].children[1].children[0],this.timeoutId=void 0,this.enabled=!1,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=.0025,this.enablePan=!0,this.keyPanSpeed=7,this.verticalOffset=1.5,this.keysCodes={forwardKeys:[t.Keys.Z,t.Keys.UP_ARROW],backwardKeys:[t.Keys.S,t.Keys.BOTTOM_ARROW]};let r={x:new i.Quaternion,y:new i.Quaternion};function a(){if(s.currentPathPosition+=s.cameraJump,s.currentPathPosition>1){t.DefaultLogger.log("reachEnd");var e=s.pathsMap.get(s.currentPathIndex).indexOfNextPath;s.pathsMap.get(e).indexOfNextPath===s.currentPathIndex?s.currentPathPosition=1:s.currentPathPosition=0,s.currentPathIndex=e,s.currentPath=s.paths[e]}s.update(),s.dispatchEvent({type:"move"})}function l(){if(s.currentPathPosition-=s.cameraJump,s.currentPathPosition<0){t.DefaultLogger.log("reachStart");var e=s.pathsMap.get(s.currentPathIndex).indexOfPreviousPath;s.pathsMap.get(e).indexOfPreviousPath===s.currentPathIndex?s.currentPathPosition=0:s.currentPathPosition=1,s.currentPathIndex=e,s.currentPath=s.paths[e]}s.update(),s.dispatchEvent({type:"move"})}function h(e){if(!1!==s.enabled){var i=s.currentPath.getPointAt(s.currentPathPosition),n=void 0;n=s.currentPathPosition+s.cameraJump>1?s.currentPath.getPointAt(s.currentPathPosition-s.cameraJump).sub(i).normalize().negate():s.currentPath.getPointAt(s.currentPathPosition+s.cameraJump).sub(i).normalize();var o=s.camera.getWorldDirection().normalize().dot(n);o>0&&s.keysCodes.forwardKeys.includes(e.keyCode)?(e.preventDefault(),a()):o<0&&s.keysCodes.forwardKeys.includes(e.keyCode)?(e.preventDefault(),l()):o>0&&s.keysCodes.backwardKeys.includes(e.keyCode)?(e.preventDefault(),l()):o<0&&s.keysCodes.backwardKeys.includes(e.keyCode)?(e.preventDefault(),a()):t.DefaultLogger.warn("The key event is not implemented for key code: "+e.keyCode)}}function c(e){!1!==s.enabled&&(s.keysCodes.forwardKeys.includes(e.keyCode)||s.keysCodes.backwardKeys.includes(e.keyCode))&&(e&&e.preventDefault(),s.dispatchEvent({type:"moveEnd"}))}function d(e){!1!==s.enabled&&(e.preventDefault(),!0===s.enableRotate&&e.button===s.mouseButtons.ORBIT?o=A.ROTATE:!0===s.enableZoom&&e.button===s.mouseButtons.ZOOM||!0===s.enablePan&&(e.button,s.mouseButtons.PAN))}function u(e){!1!==s.enabled&&(e.preventDefault(),o===A.ROTATE&&function(e){var t=e.movementX||e.mozMovementX||e.webkitMovementX||0,i=e.movementY||e.mozMovementY||e.webkitMovementY||0,n=s.orientation;n.y+=t*s.rotateSpeed,n.x+=i*s.rotateSpeed,n.x=Math.max(-P,Math.min(P,n.x)),s.update(),s.dispatchEvent({type:"rotate"})}(e))}function p(e){!1!==s.enabled&&(e&&e.preventDefault(),o=A.NONE,s.dispatchEvent({type:"rotateEnd"}))}this.mouseButtons={ORBIT:i.MOUSE.LEFT,ZOOM:i.MOUSE.MIDDLE,PAN:i.MOUSE.RIGHT},this.orientation={x:0,y:0},this.update=function(){if(!1!==this.enabled){var e=this.currentPath.getPointAt(this.currentPathPosition);this.camera.position.x=e.x,this.camera.position.y=e.y+this.verticalOffset,this.camera.position.z=e.z,r.x.setFromAxisAngle(T,this.orientation.x),r.y.setFromAxisAngle(S,this.orientation.y),this.camera.quaternion.copy(r.y).multiply(r.x)}},this.dispose=function(){this.domElement.removeEventListener("mousedown",d,!1),this.domElement.removeEventListener("mousemove",u,!1),this.domElement.removeEventListener("mouseup",p,!1),window.removeEventListener("keydown",h,!1),window.removeEventListener("keyup",c,!1)},this.domElement.addEventListener("mousedown",d,!1),this.domElement.addEventListener("mousemove",u,!1),this.domElement.addEventListener("mouseup",p,!1),window.addEventListener("keydown",h,!1),window.addEventListener("keyup",c,!1),this.forwardControl.addEventListener("click",(function(e){clearTimeout(s.timeoutId),e.keyCode=t.Keys.UP_ARROW,h(e),s.timeoutId=setTimeout(c.bind(s),750)}),!1),this.backwardControl.addEventListener("click",(function(e){clearTimeout(s.timeoutId),e.keyCode=t.Keys.BOTTOM_ARROW,h(e),s.timeoutId=setTimeout(c.bind(s),750)}),!1)}Object.assign(O.prototype,i.EventDispatcher.prototype,{get camera(){return this._camera},set camera(e){if(s.isNull(e))throw new Error("Camera cannot be null ! Expect an instance of Camera");if(s.isUndefined(e))throw new Error("Camera cannot be undefined ! Expect an instance of Camera");if(!(e instanceof i.Camera))throw new Error(`Camera cannot be an instance of ${e.constructor.name}. Expect an instance of Camera.`);this._camera=e},setCamera(e){return this.camera=e,this},setPath(e){this.currentPath=e,this.cameraJump=1/e.getLength()},setPaths(e,t){this.paths=e,this.currentPathIndex=0;for(var i=this.paths[this.currentPathIndex],n=this.paths.length,s=void 0,o=void 0,r=void 0,a=void 0,l=void 0,h=void 0,c=0;c<n;c++){o=(s=this.paths[c]).getPointAt(0),r=s.getPointAt(1),t&&s.name===t&&(i=s,this.currentPathIndex=c);for(var d=1/0,u=1/0,p=void 0,m=void 0,f=0;f<n;f++)c!==f&&(l=(a=this.paths[f]).getPointAt(0),h=a.getPointAt(1),o.distanceTo(l)<d&&(d=o.distanceTo(l),p=f),o.distanceTo(h)<d&&(d=o.distanceTo(h),p=f),r.distanceTo(l)<u&&(u=r.distanceTo(l),m=f),r.distanceTo(h)<u&&(u=r.distanceTo(h),m=f));this.pathsMap.set(c,{indexOfPreviousPath:p,indexOfNextPath:m})}this.setPath(i)},setMouseQuat(e){this.orientation.y=2*Math.asin(e.y),this.orientation.x=0},getCurrentPathPosition(){return this.currentPath.getPointAt(this.currentPathPosition)},getNextPathPosition(){return this.currentPathPosition+this.cameraJump>1?this.currentPath.getPointAt(this.currentPathPosition-this.cameraJump).negate():this.currentPath.getPointAt(this.currentPathPosition+this.cameraJump)},getDistanceFromStart(){return this.currentPathPosition*this.currentPath.getLength()},lookAtPath(){var e=this.getNextPathPosition();e.y=this.camera.position.y,this.camera.lookAt(e),this.setMouseQuat(this.camera.quaternion)},goTo(e){for(var t=void 0,i=void 0,n=void 0,s=void 0,o=void 0,r=void 0,a=void 0,l=1/0,h=0,c=this.paths.length;h<c;h++){i=this.paths[h],t=Math.floor(i.getLength()),n=i.getSpacedPoints(t);for(var d=0;d<t;d++)(a=e.distanceTo(n[d]))<l&&(l=a,r=h,o=i,s=d)}this.setPath(o),this.currentPathIndex=r,this.currentPathPosition=this.cameraJump*s,this.lookAtPath(),this.update(),this.dispatchEvent({type:"moveEnd"}),this.dispatchEvent({type:"rotateEnd"})}});class B extends i.BufferGeometry{constructor(e=new i.Vector3(0,0,0),t=new i.Vector3(1,0,0)){super(),this.type="LineGeometry",this.addAttribute("position",new i.Float32BufferAttribute([e.x,e.y,e.z,t.x,t.y,t.z],3))}}class C extends i.LineSegments{constructor(){super(),this.geometry=new i.EdgesGeometry(new i.BoxBufferGeometry(2,2,2)),this.material=new i.LineBasicMaterial({color:16777215}),this.normalPlanes={normalRightSide:new i.Vector3(-1,0,0),normalLeftSide:new i.Vector3(1,0,0),normalFrontSide:new i.Vector3(0,-1,0),normalBackSide:new i.Vector3(0,1,0),normalTopSide:new i.Vector3(0,0,-1),normalBottomSide:new i.Vector3(0,0,1)},this.planes={rightSidePlane:new i.Plane(this.normalPlanes.normalRightSide.clone(),0),leftSidePlane:new i.Plane(this.normalPlanes.normalLeftSide.clone(),0),frontSidePlane:new i.Plane(this.normalPlanes.normalFrontSide.clone(),0),backSidePlane:new i.Plane(this.normalPlanes.normalBackSide.clone(),0),topSidePlane:new i.Plane(this.normalPlanes.normalTopSide.clone(),0),bottomSidePlane:new i.Plane(this.normalPlanes.normalBottomSide.clone(),0)},this._boundingBox=new i.Box3}getBoundingSphere(){return this.geometry.computeBoundingSphere(),this.geometry.boundingSphere.applyMatrix4(this.matrixWorld),this.geometry.boundingSphere}setColor(e){this.material.color.set(e)}applyClippingTo(e,t){if(s.isNotDefined(t))return;let i=[];for(let e in this.planes)i.push(this.planes[e]);t.traverse(t=>{if(s.isNotDefined(t))return;if(s.isNotDefined(t.geometry))return;if(s.isNotDefined(t.material))return;const n=s.isArray(t.material)?t.material:[t.material];for(let t=0,s=n.length;t<s;t++){let s=n[t];s.clippingPlanes||(s.clippingPlanes=[]),s.clippingPlanes=e?i:[]}})}updateSize(e){this.scale.set(e.x,e.y,e.z)}update(){this._boundingBox.setFromObject(this);const e=this._boundingBox.min,t=this._boundingBox.max;this.planes.rightSidePlane.constant=t.x+0,this.planes.leftSidePlane.constant=0-e.x,this.planes.frontSidePlane.constant=t.y+0,this.planes.backSidePlane.constant=0-e.y,this.planes.topSidePlane.constant=t.z+0,this.planes.bottomSidePlane.constant=0-e.z}}class k extends i.MeshBasicMaterial{constructor(e){super(e),this.isHighlightableMaterial=!0,this.depthTest=!1,this.depthWrite=!1,this.fog=!1,this.side=i.DoubleSide,this.transparent=!0,this.oldColor=this.color.clone()}highlight(e){if(e){const e=.35,t=this.color.r,i=this.color.g,n=this.color.b,s=Math.min(Math.max(0,t+t*e),1),o=Math.min(Math.max(0,i+i*e),1),r=Math.min(Math.max(0,n+n*e),1);this.color.setRGB(s,o,r)}else this.color.copy(this.oldColor)}}class F extends i.LineBasicMaterial{constructor(e){super(e),this.isHighlightableMaterial=!0,this.depthTest=!1,this.depthWrite=!1,this.fog=!1,this.transparent=!0,this.linewidth=1,this.oldColor=this.color.clone()}highlight(e){if(e){const e=.35,t=this.color.r,i=this.color.g,n=this.color.b,s=Math.min(Math.max(0,t+t*e),1),o=Math.min(Math.max(0,i+i*e),1),r=Math.min(Math.max(0,n+n*e),1);this.color.setRGB(s,o,r)}else this.color.copy(this.oldColor)}}class L extends i.Mesh{constructor(e={}){const t={geometry:new i.BufferGeometry,material:new i.MeshBasicMaterial({visible:!1,depthTest:!1,depthWrite:!1,fog:!1,side:i.DoubleSide}),...e};super(t.geometry,t.material),this.isHitbox=!0,this.type="Hitbox"}}class I extends L{constructor(e={}){const t=new i.CylinderBufferGeometry(.2,0,1,4,1,!1);t.translate(0,.5,0),super({geometry:t,...e}),this.isCylindricaHitbox=!0,this.type="CylindricaHitbox"}}class z extends L{constructor(e={}){const t=new i.BufferGeometry;t.addAttribute("position",new i.Float32BufferAttribute([0,0,0,1.1,0,0,1.1,1.1,0,0,1.1,0],3)),t.setIndex([0,1,2,2,3,0]),super({geometry:t,...e}),this.isPlanarHitbox=!0,this.type="PlanarHitbox"}}class G extends L{constructor(e={}){const t=new i.Float32BufferAttribute([0,0,0,.85,0,0,1.1,1.1,0,0,.85,0],3),n=new i.BufferGeometry;n.addAttribute("position",t),n.setIndex([0,1,2,2,3,0]),super({geometry:n,...e}),this.isPlanarHitbox=!0,this.type="PlanarHitbox"}}class R extends L{constructor(e={}){super({geometry:new i.OctahedronBufferGeometry(1.2,0),...e}),this.isOctahedricalHitbox=!0,this.type="OctahedricalHitbox"}}class N extends L{constructor(e={}){super({geometry:new i.TorusBufferGeometry(1,.12,4,12,Math.PI),...e}),this.isTorusHitbox=!0,this.type="TorusHitbox"}}class j extends i.Object3D{constructor(e={}){const t={color:16777215,hitbox:null,...e};super(),this.isHandle=!0,this.type="Handle",this.color=t.color,this.hitbox=t.hitbox,this.baseQuaternion=new i.Quaternion}get color(){return this.line.material.color.clone()}set color(e){if(s.isNull(e))throw new Error("Color cannot be null ! Expect an instance of Color.");if(s.isUndefined(e))throw new Error("Color cannot be undefined ! Expect an instance of Color.");this.traverse(t=>{let i=t.material;i&&i.color.setHex(e)})}get hitbox(){return this._hitbox}set hitbox(e){this._hitbox=e,this.add(e)}setColor(e){return this.color=e,this}setHitbox(e){return this.hitbox=e,this}setScale(e,t,i){return this.scale.set(e,t,i),this}setPosition(e,t,i){return this.position.set(e,t,i),this}highlight(e){for(let t=0,i=this.children.length;t<i;t++){const i=this.children[t];if(i.isHitbox)continue;const n=i.material;!s.isUndefined(n)&&n.isHighlightableMaterial&&n.highlight(e)}}raycast(e,t){const i=e.intersectObject(this._hitbox,!1);i.length>0&&t.push({distance:i[0].distance,object:this})}setRotationFromAxisAndAngle(e,t){return this.quaternion.setFromAxisAngle(e,t),this.baseQuaternion.copy(this.quaternion),this}update(e){}}class V extends j{constructor(e={}){const t={color:16777215,hitbox:new I,direction:new i.Vector3(0,1,0),...e};super(t),this.isTranslateHandle=!0,this.type="TranslateHandle";const n=new B(new i.Vector3(0,0,0),new i.Vector3(0,.8,0)),s=new F({color:t.color}),o=new i.Line(n,s);this.add(o);const r=new i.ConeBufferGeometry(.05,.2,12,1,!1);r.translate(0,.9,0);const a=new k({color:t.color}),l=new i.Mesh(r,a);this.add(l),this.direction=t.direction}get direction(){return this._direction}set direction(e){if(s.isNull(e))throw new Error("Direction cannot be null ! Expect an instance of Color.");if(s.isUndefined(e))throw new Error("Direction cannot be undefined ! Expect an instance of Color.");if(!(e instanceof i.Vector3))throw new Error(`Direction cannot be an instance of ${e.constructor.name}. Expect an instance of Vector3.`);if(this._direction=e,e.y>.99999)this.quaternion.set(0,0,0,1);else if(e.y<-.99999)this.quaternion.set(1,0,0,0);else{const t=new i.Vector3(e.z,0,-e.x).normalize(),n=Math.acos(e.y);this.quaternion.setFromAxisAngle(t,n)}}update(e){super.update(e),this._direction.dot(e)>=0&&this.flipDirection()}setDirection(e){return this.direction=e,this}flipDirection(){this.direction=this._direction.negate()}}class U extends j{constructor(e={}){const t={color:16777215,hitbox:new I,direction:new i.Vector3(0,1,0),...e};super(t),this.isScaleHandle=!0,this.type="ScaleHandle";const n=new B(new i.Vector3(0,0,0),new i.Vector3(0,.88,0)),s=new F({color:t.color}),o=new i.Line(n,s);this.add(o);const r=new i.BoxBufferGeometry(.12,.12,.12);r.translate(0,.94,0);const a=new k({color:t.color}),l=new i.Mesh(r,a);this.add(l),this.direction=t.direction}get direction(){return this._direction}set direction(e){if(s.isNull(e))throw new Error("Direction cannot be null ! Expect an instance of Color.");if(s.isUndefined(e))throw new Error("Direction cannot be undefined ! Expect an instance of Color.");if(!(e instanceof i.Vector3))throw new Error(`Direction cannot be an instance of ${e.constructor.name}. Expect an instance of Vector3.`);if(this._direction=e,e.y>.99999)this.quaternion.set(0,0,0,1);else if(e.y<-.99999)this.quaternion.set(1,0,0,0);else{const t=new i.Vector3(e.z,0,-e.x).normalize(),n=Math.acos(e.y);this.quaternion.setFromAxisAngle(t,n)}}update(e){super.update(e),this._direction.dot(e)>=0&&this.flipDirection()}setDirection(e){return this.direction=e,this}flipDirection(){this.direction=this._direction.negate()}}class H extends j{constructor(e={}){const t={color:16777215,hitbox:new z,direction:new i.Vector3(0,1,0),...e};super(t),this.isPlaneHandle=!0,this.type="PlaneHandle";const n=new i.BufferGeometry;n.addAttribute("position",new i.Float32BufferAttribute([.75,1,0,1,1,0,1,.75,0],3));const s=new F({color:t.color}),o=new i.Line(n,s);this.add(o);const r=new i.BufferGeometry;r.addAttribute("position",new i.Float32BufferAttribute([.1,.1,0,1,.1,0,1,1,0,.1,1,0],3)),r.setIndex([0,1,2,2,3,0]);const a=new k({color:t.color,transparent:!0,opacity:.35}),l=new i.Mesh(r,a);this.add(l),this.xAxis=new i.Vector3(1,0,0),this.yAxis=new i.Vector3(0,1,0),this.zAxis=new i.Vector3(0,0,1),this.xDirection=new i.Vector3(t.direction.x,0,0),this.yDirection=new i.Vector3(0,t.direction.y,0),this.zDirection=new i.Vector3(0,0,t.direction.z),this.direction=t.direction}get direction(){return this._direction}set direction(e){if(s.isNull(e))throw new Error("Direction cannot be null ! Expect an instance of Color.");if(s.isUndefined(e))throw new Error("Direction cannot be undefined ! Expect an instance of Color.");if(!(e instanceof i.Vector3))throw new Error(`Direction cannot be an instance of ${e.constructor.name}. Expect an instance of Vector3.`);this._direction=e}update(e){super.update(e);const t=new i.Vector3(this._direction.x,0,0),s=new i.Vector3(0,this._direction.y,0),o=new i.Vector3(0,0,this._direction.z),r=t.dot(e),a=s.dot(e),l=o.dot(e);this.quaternion.copy(this.baseQuaternion),r>0&&a>0&&0===l?(this.rotateOnAxis(this.zAxis,n.degreesToRadians(180)),this.xDirection.setX(-1),this.yDirection.setY(-1),this.zDirection.setZ(0)):r>0&&a<0&&0===l?(this.rotateOnAxis(this.zAxis,n.degreesToRadians(90)),this.xDirection.setX(-1),this.yDirection.setY(1),this.zDirection.setZ(0)):r<0&&a>0&&0===l?(this.rotateOnAxis(this.zAxis,n.degreesToRadians(270)),this.xDirection.setX(1),this.yDirection.setY(-1),this.zDirection.setZ(0)):r<0&&a<0&&0===l?(this.rotateOnAxis(this.zAxis,n.degreesToRadians(0)),this.xDirection.setX(1),this.yDirection.setY(1),this.zDirection.setZ(0)):r>0&&0===a&&l>0?(this.rotateOnAxis(this.zAxis,n.degreesToRadians(180)),this.xDirection.setX(-1),this.yDirection.setY(0),this.zDirection.setZ(-1)):r>0&&0===a&&l<0?(this.rotateOnAxis(this.zAxis,n.degreesToRadians(90)),this.xDirection.setX(-1),this.yDirection.setY(0),this.zDirection.setZ(1)):r<0&&0===a&&l>0?(this.rotateOnAxis(this.zAxis,n.degreesToRadians(270)),this.xDirection.setX(1),this.yDirection.setY(0),this.zDirection.setZ(-1)):r<0&&0===a&&l<0?(this.rotateOnAxis(this.zAxis,n.degreesToRadians(0)),this.xDirection.setX(1),this.yDirection.setY(0),this.zDirection.setZ(1)):0===r&&a>0&&l>0?(this.rotateOnAxis(this.zAxis,n.degreesToRadians(180)),this.xDirection.setX(0),this.yDirection.setY(-1),this.zDirection.setZ(-1)):0===r&&a>0&&l<0?(this.rotateOnAxis(this.zAxis,n.degreesToRadians(270)),this.xDirection.setX(0),this.yDirection.setY(-1),this.zDirection.setZ(1)):0===r&&a<0&&l>0?(this.rotateOnAxis(this.zAxis,n.degreesToRadians(90)),this.xDirection.setX(0),this.yDirection.setY(1),this.zDirection.setZ(-1)):0===r&&a<0&&l<0&&(this.rotateOnAxis(this.zAxis,n.degreesToRadians(0)),this.xDirection.setX(0),this.yDirection.setY(1),this.zDirection.setZ(1))}setDirection(e){return this.direction=e,this}flipXDirection(){this.xDirection.setX(-this.xDirection.x)}flipYDirection(){this.yDirection.setY(-this.yDirection.y)}flipZDirection(){this.zDirection.setZ(-this.zDirection.z)}}class X extends j{constructor(e={}){const t={color:16777215,hitbox:new G,direction:new i.Vector3(1,1,0),...e};super(t),this.isPlaneHandle=!0,this.type="PlaneHandle";const n=new i.BufferGeometry;n.addAttribute("position",new i.Float32BufferAttribute([.1,.75,0,1,1,0,.75,.1,0],3));const s=new F({color:t.color}),o=new i.Line(n,s);this.add(o);const r=new i.BufferGeometry;r.addAttribute("position",new i.Float32BufferAttribute([.1,.1,0,.75,.1,0,1,1,0,.1,.75,0],3)),r.setIndex([0,1,2,2,3,0]);const a=new k({color:t.color,transparent:!0,opacity:.35}),l=new i.Mesh(r,a);this.add(l),this.direction=t.direction,this.xDirection=new i.Vector3(t.direction.x,0,0),this.yDirection=new i.Vector3(0,t.direction.y,0),this.zDirection=new i.Vector3(0,0,t.direction.z),this.xAxis=new i.Vector3(1,0,0),this.yAxis=new i.Vector3(0,1,0),this.zAxis=new i.Vector3(0,0,1)}get direction(){return this._direction}set direction(e){if(s.isNull(e))throw new Error("Direction cannot be null ! Expect an instance of Color.");if(s.isUndefined(e))throw new Error("Direction cannot be undefined ! Expect an instance of Color.");if(!(e instanceof i.Vector3))throw new Error(`Direction cannot be an instance of ${e.constructor.name}. Expect an instance of Vector3.`);this._direction=e}update(e){super.update(e);const t=this.xDirection.dot(e),i=this.yDirection.dot(e),s=this.zDirection.dot(e);this.quaternion.copy(this.baseQuaternion),t>0&&i>0&&0===s?this.rotateOnAxis(this.zAxis,n.degreesToRadians(180)):t>0&&i<0&&0===s?this.rotateOnAxis(this.zAxis,n.degreesToRadians(90)):t<0&&i>0&&0===s?this.rotateOnAxis(this.zAxis,n.degreesToRadians(270)):t<0&&i<0&&0===s?this.rotateOnAxis(this.zAxis,n.degreesToRadians(0)):t>0&&0===i&&s>0?this.rotateOnAxis(this.zAxis,n.degreesToRadians(180)):t>0&&0===i&&s<0?this.rotateOnAxis(this.zAxis,n.degreesToRadians(90)):t<0&&0===i&&s>0?this.rotateOnAxis(this.zAxis,n.degreesToRadians(270)):t<0&&0===i&&s<0?this.rotateOnAxis(this.zAxis,n.degreesToRadians(0)):0===t&&i>0&&s>0?this.rotateOnAxis(this.zAxis,n.degreesToRadians(180)):0===t&&i>0&&s<0?this.rotateOnAxis(this.zAxis,n.degreesToRadians(270)):0===t&&i<0&&s>0?this.rotateOnAxis(this.zAxis,n.degreesToRadians(90)):0===t&&i<0&&s<0&&this.rotateOnAxis(this.zAxis,n.degreesToRadians(0))}setDirection(e){return this.direction=e,this}flipXAxis(){const e=this._direction.clone();e.x=-e.x,this.direction=e}flipYAxis(){const e=this._direction.clone();e.y=-e.y,this.direction=e}flipZAxis(){const e=this._direction.clone();e.z=-e.z,this.direction=e}}class Z extends j{constructor(e={}){const t={color:16777215,hitbox:new R,...e};super(t),this.isOmnidirectionalHandle=!0,this.type="OmnidirectionalHandle";const n=new i.OctahedronBufferGeometry(1,0),s=new k({color:t.color,transparent:!0,opacity:.55}),o=new i.Mesh(n,s);this.add(o);const r=new i.EdgesGeometry(n),a=new F({color:t.color,linewidth:4}),l=new i.LineSegments(r,a);this.add(l)}update(e){super.update(e)}}class Y extends i.Object3D{constructor(){super(),this.isGizmo=!0,this.type="AbstractGizmo"}init(){this.handles=new i.Object3D,this.add(this.handles);const e=new i.PlaneBufferGeometry(50,50,2,2),t=new i.MeshBasicMaterial({side:i.DoubleSide,visible:!1});this.intersectPlane=new i.Mesh(e,t),this.add(this.intersectPlane);((e,t)=>{for(let i in e){const n=e[i];if(s.isNotArray(n))n.name=i,n.renderOrder=1/0,t.add(n);else for(let s=n.length;s--;){const n=e[i][s][0],o=e[i][s][1],r=e[i][s][2],a=e[i][s][3],l=e[i][s][4];n.name=i,n.tag=l,n.renderOrder=1/0,o&&n.position.set(o[0],o[1],o[2]),r&&n.rotation.set(r[0],r[1],r[2]),a&&n.scale.set(a[0],a[1],a[2]),n.updateMatrix();const h=n.geometry.clone();h.applyMatrix(n.matrix),n.geometry=h,n.position.set(0,0,0),n.rotation.set(0,0,0),n.scale.set(1,1,1),t.add(n)}}})(this.handleGizmos,this.handles)}highlight(e){for(let e in this.handleGizmos)this.handleGizmos[e].highlight(!1);const t=this.handleGizmos[e];t&&t.highlight(!0)}update(e,t){this.traverse(e=>{e.isHandle&&e.update(t)}),this.updateIntersectPlane(e)}updateIntersectPlane(e){this.intersectPlane.lookAt(e)}}class K extends Y{constructor(){super(),this.isTranslateGizmo=!0,this.type="TranslateGizmo",this.handleGizmos={X:new V({color:11141120,direction:new i.Vector3(1,0,0)}),Y:new V({color:43520,direction:new i.Vector3(0,1,0)}),Z:new V({color:170,direction:new i.Vector3(0,0,1)}),XY:new X({color:11184640,direction:new i.Vector3(1,1,0)}).setScale(.33,.33,1),YZ:new X({color:43690,direction:new i.Vector3(0,1,1)}).setScale(.33,.33,1).setRotationFromAxisAndAngle(new i.Vector3(0,1,0),n.degreesToRadians(-90)),XZ:new X({color:11141290,direction:new i.Vector3(1,0,1)}).setScale(.33,.33,1).setRotationFromAxisAndAngle(new i.Vector3(1,0,0),n.degreesToRadians(90)),XYZ:new Z({color:11184810}).setScale(.15,.15,.15)},this.init()}}class W extends Y{constructor(){super(),this.isScaleGizmo=!0,this.type="ScaleGizmo",this.handleGizmos={XYZ:new Z({color:11184810}).setScale(.15,.15,.15),XY:new H({color:11184640,direction:new i.Vector3(1,1,0)}).setScale(.33,.33,1),YZ:new H({color:43690,direction:new i.Vector3(0,1,1)}).setScale(.33,.33,1).setRotationFromAxisAndAngle(new i.Vector3(0,1,0),n.degreesToRadians(-90)),XZ:new H({color:11141290,direction:new i.Vector3(1,0,1)}).setScale(.33,.33,1).setRotationFromAxisAndAngle(new i.Vector3(1,0,0),n.degreesToRadians(90)),X:new U({color:11141120,direction:new i.Vector3(1,0,0)}),Y:new U({color:43520,direction:new i.Vector3(0,1,0)}),Z:new U({color:170,direction:new i.Vector3(0,0,1)})},this.init()}}const $=n.toEnum({None:"None",Translate:"Translate",Rotate:"Rotate",Scale:"Scale"});function q(){t.TDataBaseManager.call(this),this.basePath="/buffergeometries"}function J(){t.TDataBaseManager.call(this),this.basePath="/curves"}q.prototype=Object.assign(Object.create(t.TDataBaseManager.prototype),{constructor:q,convert(e){let t=null;switch(e.type){case"Scene":t=new i.Scene;break;default:t=new i.Object3D}return t}}),Object.defineProperties(q.prototype,{_onJson:{value:function(e,t,i,n){const o=s.isObject(e)?[e]:e,r={};let a=void 0;for(let e=0,t=o.length,s=void 0;e<t;e++)s=o[e],(a=this.convert(s,n))&&(r[s._id]=a),i(e/t);t(r)}}}),J.prototype=Object.assign(Object.create(t.TDataBaseManager.prototype),{constructor:J,convert(e){if(!e)throw new Error("CurvesManager: Unable to convert null or undefined data !");const t=e.type;let n=void 0;switch(t){case"ArcCurve":n=new i.ArcCurve;break;case"CatmullRomCurve3":n=new i.CatmullRomCurve3;break;case"CubicBezierCurve":n=new i.CubicBezierCurve;break;case"CubicBezierCurve3":n=new i.CubicBezierCurve3;break;case"Curve":n=new i.Curve;break;case"CurvePath":n=new i.CurvePath;break;case"EllipseCurve":n=new i.EllipseCurve;break;case"LineCurve":n=new i.LineCurve;break;case"LineCurve3":n=new i.LineCurve3;break;case"Path":n=new i.Path;break;case"QuadraticBezierCurve":n=new i.QuadraticBezierCurve;break;case"QuadraticBezierCurve3":n=new i.QuadraticBezierCurve3;break;case"SplineCurve":n=new i.SplineCurve;break;case"Shape":n=new i.Shape;break;default:throw new Error(`TCurvesManager: Unknown curve of type: ${t}`)}return n.fromJSON(e),n}}),Object.defineProperties(J.prototype,{_onJson:{value:function(e,t,i,n){const o=s.isObject(e)?[e]:e,r={};for(let e=0,t=o.length,s=void 0;e<t;e++){s=o[e];try{r[s._id]=this.convert(s)}catch(e){n(e)}i(e/t)}t(r)}}});const Q={Int8Array:0,Uint8Array:1,Uint8ClampedArray:2,Int16Array:3,Uint16Array:4,Int32Array:5,Uint32Array:6,Float32Array:7,Float64Array:8};class ee extends t.TDataBaseManager{constructor(e={}){const t={basePath:"/geometries",projectionSystem:"zBack",globalScale:1,computeNormals:!0,computeBoundingBox:!0,computeBoundingSphere:!0,...e};super(t),this.projectionSystem=t.projectionSystem,this.globalScale=t.globalScale,this.computeNormals=t.computeNormals,this.computeBoundingBox=t.computeBoundingBox,this.computeBoundingSphere=t.computeBoundingSphere}get computeBoundingBox(){return this._computeBoundingBox}set computeBoundingBox(e){if(s.isNull(e))throw new TypeError("Compute bounding box cannot be null ! Expect a boolean.");if(s.isUndefined(e))throw new TypeError("Compute bounding box cannot be undefined ! Expect a boolean.");if(s.isNotBoolean(e))throw new TypeError(`Compute bounding box cannot be an instance of ${e.constructor.name} ! Expect a boolean.`);this._computeBoundingBox=e}get computeBoundingSphere(){return this._computeBoundingSphere}set computeBoundingSphere(e){if(s.isNull(e))throw new TypeError("Compute bounding sphere cannot be null ! Expect a boolean.");if(s.isUndefined(e))throw new TypeError("Compute bounding sphere cannot be undefined ! Expect a boolean.");if(s.isNotBoolean(e))throw new TypeError(`Compute bounding sphere cannot be an instance of ${e.constructor.name} ! Expect a boolean.`);this._computeBoundingSphere=e}get computeNormals(){return this._computeNormals}set computeNormals(e){if(s.isNull(e))throw new TypeError("Compute normals cannot be null ! Expect a boolean.");if(s.isUndefined(e))throw new TypeError("Compute normals cannot be undefined ! Expect a boolean.");if(s.isNotBoolean(e))throw new TypeError(`Compute normals cannot be an instance of ${e.constructor.name} ! Expect a boolean.`);this._computeNormals=e}get projectionSystem(){return this._projectionSystem}set projectionSystem(e){if(s.isNull(e))throw new TypeError("Projection system cannot be null ! Expect a positive number.");if(s.isUndefined(e))throw new TypeError("Projection system cannot be undefined ! Expect a positive number.");this._projectionSystem=e}get globalScale(){return this._globalScale}set globalScale(e){if(s.isNull(e))throw new TypeError("Global scale cannot be null ! Expect a positive number.");if(s.isUndefined(e))throw new TypeError("Global scale cannot be undefined ! Expect a positive number.");this._globalScale=e}setComputeBoundingBox(e){return this.computeBoundingBox=e,this}setComputeBoundingShpere(e){return this.computeBoundingSphere=e,this}setComputeNormals(e){return this.computeNormals=e,this}setProjectionSystem(e){return this.projectionSystem=e,this}setGlobalScale(e){return this.globalScale=e,this}_onJson(e,t,i,n){const o=s.isObject(e)?[e]:e,r={};for(let e=0,t=o.length,s=void 0;e<t;e++){s=o[e];try{r[s._id]=this.convert(s)}catch(e){n(e)}i(new ProgressEvent("GeometriesManager",{lengthComputable:!0,loaded:e+1,total:t}))}t(r)}convert(e){if(!e)throw new Error("GeometriesManager: Unable to convert null or undefined data !");const t=e.type;if(!t)throw new Error("GeometriesManager: Unable to convert untyped data !");let i=null;if(e.isBufferGeometry||t.includes("BufferGeometry"))i=this._convertJsonToBufferGeometry(e),this._computeNormals&&i.computeVertexNormals();else{if(!e.isGeometry&&!t.includes("Geometry"))throw new Error(`TGeometriesManager: Unable to retrieve geometry of type ${t} !`);i=this._convertJsonToGeometry(e),this._computeNormals&&i.computeFaceNormals()}return this.computeBoundingBox&&(i.boundingBox=null,i.computeBoundingBox()),this.computeBoundingSphere&&(i.boundingSphere=null,i.computeBoundingSphere()),i}_convertJsonToGeometry(e){const t=e.types;let n=null;switch(t){case"BoxGeometry":n=new i.BoxGeometry;break;case"CircleGeometry":n=new i.CircleGeometry;break;case"CylinderGeometry":n=new i.CylinderGeometry;break;case"ConeGeometry":n=new i.ConeGeometry;break;case"EdgesGeometry":n=new i.EdgesGeometry;break;case"DodecahedronGeometry":n=new i.DodecahedronGeometry;break;case"ExtrudeGeometry":n=new i.ExtrudeGeometry;break;case"Geometry":n=new i.Geometry;break;case"IcosahedronGeometry":n=new i.IcosahedronGeometry;break;case"LatheGeometry":n=new i.LatheGeometry;break;case"OctahedronGeometry":n=new i.OctahedronGeometry;break;case"ParametricGeometry":n=new i.ParametricGeometry;break;case"PlaneGeometry":n=new i.PlaneGeometry;break;case"PolyhedronGeometry":n=new i.PolyhedronGeometry;break;case"RingGeometry":n=new i.RingGeometry;break;case"ShapeGeometry":n=new i.ShapeGeometry;break;case"TetrahedronGeometry":n=new i.TetrahedronGeometry;break;case"TextGeometry":n=new i.TextGeometry;break;case"TorusGeometry":n=new i.TorusGeometry;break;case"TorusKnotGeometry":n=new i.TorusKnotGeometry;break;case"TubeGeometry":n=new i.TubeGeometry;break;case"SphereGeometry":n=new i.SphereGeometry;break;case"WireframeGeometry":n=new i.WireframeGeometry;break;default:throw new Error(`TGeometriesManager: Unknown geometry of type: ${t}`)}n.uuid=e.uuid,n.name=e.name,n.type=e.type;for(var s=[],o=void 0,r=0,a=e.vertices.length;r<a;++r)o=e.vertices[r],s.push(new i.Vector3(o.x,o.y,o.z));n.vertices=s;for(var l=[],h=void 0,c=0,d=e.faces.length;c<d;c++)h=e.faces[c],l.push(new i.Face3(h.a,h.b,h.c,h.normal,h.color,h.materialIndex));n.faces=l,n.morphTargets=[],n.morphNormals=[],n.skinWeights=[],n.skinIndices=[],n.lineDistances=[],n.elementsNeedUpdate=!0,n.verticesNeedUpdate=!0,n.uvsNeedUpdate=!0,n.normalsNeedUpdate=!0,n.colorsNeedUpdate=!0,n.lineDistancesNeedUpdate=!0,n.groupsNeedUpdate=!0}_convertJsonToBufferGeometry(e){const t=e.type;let n=null;switch(t){case"BoxBufferGeometry":n=new i.BoxBufferGeometry;break;case"BufferGeometry":n=new i.BufferGeometry;break;case"CircleBufferGeometry":n=new i.CircleBufferGeometry;break;case"CylinderBufferGeometry":n=new i.CylinderBufferGeometry;break;case"ConeBufferGeometry":n=new i.ConeBufferGeometry;break;case"DodecahedronBufferGeometry":n=new i.DodecahedronBufferGeometry;break;case"ExtrudeBufferGeometry":n=new i.ExtrudeBufferGeometry;break;case"IcosahedronBufferGeometry":n=new i.IcosahedronBufferGeometry;break;case"LatheBufferGeometry":n=new i.LatheBufferGeometry;break;case"OctahedronBufferGeometry":n=new i.OctahedronBufferGeometry;break;case"ParametricBufferGeometry":n=new i.ParametricBufferGeometry;break;case"PlaneBufferGeometry":n=new i.PlaneBufferGeometry;break;case"PolyhedronBufferGeometry":n=new i.PolyhedronBufferGeometry;break;case"RingBufferGeometry":n=new i.RingBufferGeometry;break;case"ShapeBufferGeometry":n=new i.BufferGeometry;break;case"TetrahedronBufferGeometry":n=new i.TetrahedronBufferGeometry;break;case"TextBufferGeometry":n=new i.TextBufferGeometry;break;case"TorusBufferGeometry":n=new i.TorusBufferGeometry;break;case"TorusKnotBufferGeometry":n=new i.TorusKnotBufferGeometry;break;case"TubeBufferGeometry":n=new i.TubeBufferGeometry;break;case"SphereBufferGeometry":n=new i.SphereBufferGeometry;break;case"InstancedBufferGeometry":n=new i.InstancedBufferGeometry;break;default:throw new Error(`TGeometriesManager: Unknown buffer geometry of type: ${t}`)}n._id=e._id,n.uuid=e.uuid,n.name=e.name;const o=e.index;if(o&&o.array&&o.array.length>0){const e=this.__convertBase64ToArrayBuffer(o.array),t=this.__convertArrayBufferToTypedArray(e);n.index=new i.BufferAttribute(t,o.itemSize,o.normalized)}const r=e.attributes;if(r){let e={};const t=r.position;if(t){const n=this.__convertBase64ToArrayBuffer(t.array),s=this.__convertArrayBufferToTypedArray(n),o=this.globalScale,r=new Float32Array(s);if("zBack"===this._projectionSystem){let e=null,t=null,i=null;for(let n=0,s=r.length;n<s;n+=3)e=r[n]/o,t=r[n+2]/o,i=-r[n+1]/o,r[n]=e,r[n+1]=t,r[n+2]=i}else for(let e=0,t=r.length;e<t;e++)r[e]/=o;e.position=new i.BufferAttribute(r,t.itemSize,t.normalized)}const s=r.normal;if(s){const t=this.__convertBase64ToArrayBuffer(s.array),n=this.__convertArrayBufferToTypedArray(t);e.normal=new i.BufferAttribute(n,s.itemSize,s.normalized)}const o=r.uv;if(o){const t=this.__convertBase64ToArrayBuffer(o.array),n=this.__convertArrayBufferToTypedArray(t);e.uv=new i.BufferAttribute(n,o.itemSize,o.normalized)}n.attributes=e}return s.isDefined(e.groups)&&(n.groups=e.groups),s.isDefined(e.boundingBox)&&(n.boundingBox=e.boundingBox),s.isDefined(e.boundingSphere)&&(n.boundingSphere=e.boundingSphere),"ShapeBufferGeometry"===t&&(n.shapes=e.shapes.map(e=>(new i.Shape).fromJSON(e)),n.curveSegments=e.curveSegments),n}__convertArrayBufferToTypedArray(e){const t=new DataView(e),i=e.byteLength-1,n=t.getUint8(0);let s=null;switch(n){case Q.Int8Array:s=new Int8Array(i/1);for(let e=0,n=1;n<i;e++,n+=1)s[e]=t.getInt8(n);break;case Q.Uint8Array:s=new Uint8Array(i/1);for(let e=0,n=1;n<i;e++,n+=1)s[e]=t.getUint8(n);break;case Q.Uint8ClampedArray:s=new Uint8ClampedArray(i/1);for(let e=0,n=1;n<i;e++,n+=1)s[e]=t.getUint8(n);break;case Q.Int16Array:s=new Int16Array(i/2);for(let e=0,n=1;n<i;e++,n+=2)s[e]=t.getInt16(n);break;case Q.Uint16Array:s=new Uint16Array(i/2);for(let e=0,n=1;n<i;e++,n+=2)s[e]=t.getUint16(n);break;case Q.Int32Array:s=new Int32Array(i/4);for(let e=0,n=1;n<i;e++,n+=4)s[e]=t.getInt32(n);break;case Q.Uint32Array:s=new Uint32Array(i/4);for(let e=0,n=1;n<i;e++,n+=4)s[e]=t.getUint32(n);break;case Q.Float32Array:s=new Float32Array(i/4);for(let e=0,n=1;n<i;e++,n+=4)s[e]=t.getFloat32(n);break;case Q.Float64Array:s=new Float64Array(i/8);for(let e=0,n=1;n<i;e++,n+=8)s[e]=t.getFloat64(n);break;default:throw new RangeError(`Invalid switch parameter: ${n}`)}return s}__convertBase64ToArrayBuffer(e){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=new Uint8Array(256);for(let e=0;e<t.length;e++)i[t.charCodeAt(e)]=e;const n=e.length;let s=.75*n;"="===e[n-1]&&(s--,"="===e[n-2]&&s--);let o=new ArrayBuffer(s),r=new Uint8Array(o),a=void 0,l=void 0,h=void 0,c=void 0;for(let t=0,s=0;t<n;t+=4)a=i[e.charCodeAt(t)],l=i[e.charCodeAt(t+1)],h=i[e.charCodeAt(t+2)],c=i[e.charCodeAt(t+3)],r[s++]=a<<2|l>>4,r[s++]=(15&l)<<4|h>>2,r[s++]=(3&h)<<6|63&c;return o}}function te(){t.TDataBaseManager.call(this),this.basePath="/textures"}te.prototype=Object.assign(Object.create(t.TDataBaseManager.prototype),{constructor:te,convert(e){if(!e)throw new Error("TexturesManager: Unable to convert null or undefined data !");const t=e.type;throw new Error(`TTexturesManager: Unknown texture of type: ${t}`)}}),Object.defineProperties(te.prototype,{_onJson:{value:function(e,t,i,n){const o=s.isObject(e)?[e]:e,r={};for(let e=0,t=o.length,s=void 0;e<t;e++){s=o[e];try{r[s._id]=this.convert(s)}catch(e){n(e)}i(e/t)}t(r)}}});const ie=(new i.ImageLoader).load("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAACXBIWXMAAC4jAAAuIwF4pT92AAAAB3RJTUUH4gkKDRoGpGNegQAAABl0RVh0Q29tbWVudABDcmVhdGVkIHdpdGggR0lNUFeBDhcAAAAMSURBVAjXY/j//z8ABf4C/tzMWecAAAAASUVORK5CYII=");class ne extends t.TDataBaseManager{constructor(e={}){const t={basePath:"/materials",texturesPath:"/textures",texturesProvider:new i.TextureLoader,generateMipmap:!1,autoFillTextures:!0,...e};super(t),this.texturesPath=t.texturesPath,this.texturesProvider=t.texturesProvider,this.generateMipmap=t.generateMipmap,this.autoFillTextures=t.autoFillTextures}get texturesPath(){return this._texturesPath}set texturesPath(e){if(s.isNull(e))throw new TypeError("Textures path cannot be null ! Expect a non empty string.");if(s.isUndefined(e))throw new TypeError("Textures path cannot be undefined ! Expect a non empty string.");if(s.isNotString(e))throw new TypeError(`Textures path cannot be an instance of ${e.constructor.name} ! Expect a non empty string.`);if(s.isEmptyString(e))throw new TypeError("Textures path cannot be empty ! Expect a non empty string.");if(s.isBlankString(e))throw new TypeError("Textures path cannot contain only whitespace ! Expect a non empty string.");this._texturesPath=e}get texturesProvider(){return this._texturesProvider}set texturesProvider(e){if(s.isNull(e))throw new TypeError("Textures provider cannot be null ! Expect an instance of TextureLoader.");if(s.isUndefined(e))throw new TypeError("Textures provider cannot be undefined ! Expect an instance of TextureLoader.");if(!(e instanceof te||e instanceof i.TextureLoader))throw new TypeError(`Textures provider cannot be an instance of ${e.constructor.name} ! Expect an instance of TTexturesManager.`);this._texturesProvider=e}get generateMipmap(){return this._generateMipmap}set generateMipmap(e){if(s.isNull(e))throw new TypeError("Generate mipmap cannot be null ! Expect a boolean.");if(s.isUndefined(e))throw new TypeError("Generate mipmap cannot be undefined ! Expect a boolean.");if(s.isNotBoolean(e))throw new TypeError(`Generate mipmap cannot be an instance of ${e.constructor.name} ! Expect a boolean.`);this._generateMipmap=e}get autoFillTextures(){return this._autoFillTextures}set autoFillTextures(e){if(s.isNull(e))throw new TypeError("Global scale cannot be null ! Expect a boolean.");if(s.isUndefined(e))throw new TypeError("Global scale cannot be undefined ! Expect a positive number.");if(s.isNotBoolean(e))throw new TypeError("Global scale cannot be null ! Expect a boolean.");this._autoFillTextures=e}setTexturesPath(e){return this.texturesPath=e,this}setTexturesProvider(e){return this.texturesProvider=e,this}setGenerateMipmap(e){return this.generateMipmap=e,this}setAutoFillTextures(e){return this.autoFillTextures=e,this}_onJson(e,t,i,n){const o=s.isObject(e)?[e]:e,r={};for(let e=0,t=o.length,s=void 0;e<t;e++){s=o[e];try{r[s._id]=this.convert(s)}catch(e){n(e)}i(new ProgressEvent("MaterialsManager",{lengthComputable:!0,loaded:e+1,total:t}))}this._autoFillTextures?this.fillTextures(r,t,i,n):t(r)}convert(e){if(!e)throw new Error("MaterialsManager: Unable to convert null or undefined data !");const t=e.type;let n=null;switch(t){case"MeshPhongMaterial":{n=new i.MeshPhongMaterial,this._fillBaseMaterialData(n,e);const t=e.color;s.isDefined(t)&&(n.color=this._setColor(t));const o=e.specular;s.isDefined(o)&&(n.specular=this._setColor(o));const r=e.shininess;s.isDefined(r)&&(n.shininess=r);const a=e.map;s.isDefined(a)&&(n.map=a);const l=e.lightMap;s.isDefined(l)&&(n.lightMap=l);const h=e.lightMapIntensity;s.isDefined(h)&&(n.lightMapIntensity=h);const c=e.aoMap;s.isDefined(c)&&(n.aoMap=c);const d=e.aoMapIntensity;s.isDefined(d)&&(n.aoMapIntensity=d);const u=e.emissive;s.isDefined(u)&&(n.emissive=this._setColor(u));const p=e.emissiveIntensity;s.isDefined(p)&&(n.emissiveIntensity=p);const m=e.emissiveMap;s.isDefined(m)&&(n.emissiveMap=m);const f=e.bumpMap;s.isDefined(f)&&(n.bumpMap=f);const g=e.bumpScale;s.isDefined(g)&&(n.bumpScale=g);const _=e.normalMap;s.isDefined(_)&&(n.normalMap=_);const b=e.normalScale;s.isDefined(b)&&(n.normalScale=this._setVector2(b));const y=e.displacementMap;s.isDefined(y)&&(n.displacementMap=y);const v=e.displacementScale;s.isDefined(v)&&(n.displacementScale=v);const w=e.displacementBias;s.isDefined(w)&&(n.displacementBias=w);const E=e.specularMap;s.isDefined(E)&&(n.specularMap=E);const x=e.alphaMap;s.isDefined(x)&&(n.alphaMap=x);const M=e.envMap;s.isDefined(M)&&(n.envMap=M);const D=e.combine;s.isDefined(D)&&(n.combine=D);const P=e.reflectivity;s.isDefined(P)&&(n.reflectivity=P);const A=e.refractionRatio;s.isDefined(A)&&(n.refractionRatio=A);const T=e.wireframe;s.isDefined(T)&&(n.wireframe=T);const S=e.wireframeLinewidth;s.isDefined(S)&&(n.wireframeLinewidth=S);const O=e.wireframeLinecap;s.isDefined(O)&&(n.wireframeLinecap=O);const B=e.wireframeLinejoin;s.isDefined(B)&&(n.wireframeLinejoin=B);const C=e.skinning;s.isDefined(C)&&(n.skinning=C);const k=e.morphTargets;s.isDefined(k)&&(n.morphTargets=k);const F=e.morphNormals;s.isDefined(F)&&(n.morphNormals=F)}break;case"MeshLambertMaterial":{n=new i.MeshLambertMaterial,this._fillBaseMaterialData(n,e);const t=e.color;s.isDefined(t)&&(n.color=this._setColor(t));const o=e.map;s.isDefined(o)&&(n.map=o);const r=e.lightMap;s.isDefined(r)&&(n.lightMap=r);const a=e.lightMapIntensity;s.isDefined(a)&&(n.lightMapIntensity=a);const l=e.aoMap;s.isDefined(l)&&(n.aoMap=l);const h=e.aoMapIntensity;s.isDefined(h)&&(n.aoMapIntensity=h);const c=e.emissive;s.isDefined(c)&&(n.emissive=this._setColor(c));const d=e.emissiveIntensity;s.isDefined(d)&&(n.emissiveIntensity=d);const u=e.emissiveMap;s.isDefined(u)&&(n.emissiveMap=u);const p=e.specularMap;s.isDefined(p)&&(n.specularMap=p);const m=e.alphaMap;s.isDefined(m)&&(n.alphaMap=m);const f=e.envMap;s.isDefined(f)&&(n.envMap=f);const g=e.combine;s.isDefined(g)&&(n.combine=g);const _=e.reflectivity;s.isDefined(_)&&(n.reflectivity=_);const b=e.refractionRatio;s.isDefined(b)&&(n.refractionRatio=b);const y=e.wireframe;s.isDefined(y)&&(n.wireframe=y);const v=e.wireframeLinewidth;s.isDefined(v)&&(n.wireframeLinewidth=v);const w=e.wireframeLinecap;s.isDefined(w)&&(n.wireframeLinecap=w);const E=e.wireframeLinejoin;s.isDefined(E)&&(n.wireframeLinejoin=E);const x=e.skinning;s.isDefined(x)&&(n.skinning=x);const M=e.morphTargets;s.isDefined(M)&&(n.morphTargets=M);const D=e.morphNormals;s.isDefined(D)&&(n.morphNormals=D)}break;case"LineBasicMaterial":{n=new i.LineBasicMaterial,this._fillBaseMaterialData(n,e);const t=e.color;s.isDefined(t)&&(n.color=this._setColor(t))}break;case"PointsMaterial":{n=new i.PointsMaterial,this._fillBaseMaterialData(n,e);const t=e.color;s.isDefined(t)&&(n.color=this._setColor(t));const o=e.map;s.isDefined(o)&&(n.map=o);const r=e.morphTargets;s.isDefined(r)&&(n.morphTargets=r);const a=e.size;s.isDefined(a)&&(n.size=a);const l=e.sizeAttenuation;s.isDefined(l)&&(n.sizeAttenuation=l)}break;default:throw new Error(`TMaterialsManager: Unmanaged material of type: ${t}`)}return n}_fillBaseMaterialData(e,t){const i=t._id;s.isDefined(i)&&s.isString(i)&&(e._id=i);const n=t.uuid;s.isDefined(n)&&s.isString(n)&&(e.uuid=n);const o=t.name;s.isDefined(o)&&s.isString(o)&&(e.name=o);const r=t.fog;s.isDefined(r)&&(e.fog=r);const a=t.lights;s.isDefined(a)&&(e.lights=a);const l=t.blending;s.isDefined(l)&&(e.blending=l);const h=t.side;s.isDefined(h)&&(e.side=h);const c=t.flatShading;s.isDefined(c)&&(e.flatShading=c);const d=t.vertexColors;s.isDefined(d)&&(e.vertexColors=d);const u=t.opacity;s.isDefined(u)&&(e.opacity=u);const p=t.transparent;s.isDefined(p)&&(e.transparent=p);const m=t.blendSrc;s.isDefined(m)&&(e.blendSrc=m);const f=t.blendDst;s.isDefined(f)&&(e.blendDst=f);const g=t.blendEquation;s.isDefined(g)&&(e.blendEquation=g);const _=t.blendSrcAlpha;s.isDefined(_)&&(e.blendSrcAlpha=_);const b=t.blendDstAlpha;s.isDefined(b)&&(e.blendDstAlpha=b);const y=t.blendEquationAlpha;s.isDefined(y)&&(e.blendEquationAlpha=y);const v=t.depthFunc;s.isDefined(v)&&(e.depthFunc=v);const w=t.depthTest;s.isDefined(w)&&(e.depthTest=w);const E=t.depthWrite;s.isDefined(E)&&(e.depthWrite=E);const x=t.clippingPlanes;s.isDefined(x)&&(e.clippingPlanes=x);const M=t.clipIntersection;s.isDefined(M)&&(e.clipIntersection=M);const D=t.clipShadows;s.isDefined(D)&&(e.clipShadows=D);const P=t.colorWrite;s.isDefined(P)&&(e.colorWrite=P);const A=t.precision;s.isDefined(A)&&(e.precision=A);const T=t.polygonOffset;s.isDefined(T)&&(e.polygonOffset=T);const S=t.polygonOffsetFactor;s.isDefined(S)&&(e.polygonOffsetFactor=S);const O=t.polygonOffsetUnits;s.isDefined(O)&&(e.polygonOffsetUnits=O);const B=t.dithering;s.isDefined(B)&&(e.dithering=B);const C=t.alphaTest;s.isDefined(C)&&(e.alphaTest=C);const k=t.premultipliedAlpha;s.isDefined(k)&&(e.premultipliedAlpha=k);const F=t.overdraw;s.isDefined(F)&&(e.overdraw=F);const L=t.visible;s.isDefined(L)&&(e.visible=L);const I=t.userData;s.isDefined(I)&&(e.userData=I);const z=t.needsUpdate;s.isDefined(z)&&(e.needsUpdate=z)}_setVector2(e){const t=e.x,n=e.y;if(s.isNotDefined(t)||s.isNotDefined(n))throw new Error("MaterialsManager: Unable to convert null or undefined vector 2 !");return new i.Vector2(t,n)}_setColor(e){const t=e.r,n=e.g,o=e.b;if(s.isNotDefined(t)||s.isNotDefined(n)||s.isNotDefined(o))throw new Error("MaterialsManager: Unable to convert null or undefined color !");return new i.Color(t,n,o)}fillTextures(e,t){const i=this._retrieveTexturesOf(e);for(let t in e){const n=e[t],s=i[t];for(let e in s)n[e]=s[e]}t(e)}_retrieveTexturesOf(e){const t=["map","lightMap","aoMap","emissiveMap","bumpMap","normalMap","displacementMap","specularMap","alphaMap","envMap"],n={},o={};for(let r in e){const a=e[r];let l={};for(let e=0,n=t.length;e<n;e++){let n=t[e];const r=a[n];if(s.isDefined(r)&&s.isString(r)&&s.isNotEmptyString(r)){const e=`${this._texturesPath}/${r}`,t=o[e];if(s.isDefined(t))l[n]=t;else{const t=this._texturesProvider.load(e,()=>{},()=>{},()=>{t.image||(t.image=ie,t.needsUpdate=!0)});t.name=r,this._generateMipmap||(t.generateMipmaps=!1,t.magFilter=i.LinearFilter,t.minFilter=i.LinearFilter),o[e]=t,l[n]=t}}}n[r]=l}return n}}class se extends i.LineSegments{static _createInternalGeometry(e,t,n,s,o,r){const a=[],l=[];let h,c,d,u,p,m,f;for(u=0;u<=t;u++)d=u/t*(2*Math.PI),h=Math.sin(d)*e,c=Math.cos(d)*e,a.push(0,0,0),a.push(h,0,c),f=1&u?o:r,l.push(f.r,f.g,f.b),l.push(f.r,f.g,f.b);for(u=0;u<=n;u++){for(f=1&u?o:r,m=e-e/n*u,p=0;p<s;p++)d=p/s*(2*Math.PI),h=Math.sin(d)*m,c=Math.cos(d)*m,a.push(h,0,c),l.push(f.r,f.g,f.b),d=(p+1)/s*(2*Math.PI),h=Math.sin(d)*m,c=Math.cos(d)*m,a.push(h,0,c),l.push(f.r,f.g,f.b);a.push(-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1,0,0,1),l.push(1,0,0,1,.6,0,0,1,0,.6,1,0,0,0,1,0,.6,1)}const g=new i.Float32BufferAttribute(a,3);g.name="TOrbitControlsHelperPositionBufferAttribute";const _=new i.Float32BufferAttribute(l,3);_.name="TOrbitControlsHelperColorBufferAttribute";const b=new i.BufferGeometry;return b.addAttribute("position",g),b.addAttribute("color",_),b.name="TOrbitControlsHelperGeometry",b}static _createInternalMaterial(){const e=new i.LineBasicMaterial({vertexColors:i.VertexColors});return e.transparent=!0,e.opacity=0,e.name="TOrbitControlsHelperMaterial",e}constructor(e={}){const t={radius:2,radials:16,circles:2,divisions:64,innerColor:new i.Color(4473924),outerColor:new i.Color(8947848),...e};super(se._createInternalGeometry(t.radius,t.radials,t.circles,t.divisions,t.innerColor,t.outerColor),se._createInternalMaterial()),this._intervalId=void 0}startOpacityAnimation(){void 0!==this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this.material.opacity=1}endOpacityAnimation(){this._intervalId=setInterval(function(){this.material.opacity<=0?(this.material.opacity=0,clearInterval(this._intervalId),this._intervalId=void 0):this.material.opacity-=.1}.bind(this),100)}}return e.ASCLoader=o,e.AbstractGizmo=Y,e.AbstractHandle=j,e.AbstractHitbox=L,e.BufferGeometriesManager=q,e.CameraControlMode=D,e.CameraControls=class extends i.EventDispatcher{constructor(e={}){const n={logger:t.DefaultLogger,camera:null,target:new i.Object3D,mode:D.Orbit,domElement:window,...e};super(),this._handlers={onMouseEnter:this._onMouseEnter.bind(this),onMouseLeave:this._onMouseLeave.bind(this),onMouseDown:this._onMouseDown.bind(this),onMouseMove:this._onMouseMove.bind(this),onMouseWheel:this._onMouseWheel.bind(this),onMouseUp:this._onMouseUp.bind(this),onDblClick:this._onDblClick.bind(this),onTouchStart:this._onTouchStart.bind(this),onTouchEnd:this._onTouchEnd.bind(this),onTouchCancel:this._onTouchCancel.bind(this),onTouchLeave:this._onTouchLeave.bind(this),onTouchMove:this._onTouchMove.bind(this),onKeyDown:this._onKeyDown.bind(this),onKeyUp:this._onKeyUp.bind(this)},this.logger=n.logger,this.camera=n.camera,this.target=n.target,this.mode=n.mode,this.domElement=n.domElement,this.enabled=!0,this._paths=[],this._trackPath=!1,this._cameraJump=.1,this._currentPathPosition=null,this._currentPathOffset=0,this._currentPathIndex=0,this._currentPath=null,this._maxJump=1,this._lockedTarget=!0,this.previousTouches=[],this.canMove=!0,this.moveSpeed=1,this.canFront=!0,this.frontMinimum=-1/0,this.frontMaximum=-1/0,this.frontMinSpeed=0,this.frontSpeed=1,this.frontMaxSpeed=1/0,this.frontAcceleration=1,this.canBack=!0,this.backMinimum=-1/0,this.backMaximum=-1/0,this.backMinSpeed=0,this.backSpeed=1,this.backMaxSpeed=1/0,this.backAcceleration=1,this.canUp=!0,this.upMinimum=-1/0,this.upMaximum=-1/0,this.upMinSpeed=0,this.upSpeed=1,this.upMaxSpeed=1/0,this.upAcceleration=1,this.canDown=!0,this.downMinimum=-1/0,this.downMaximum=-1/0,this.downMinSpeed=0,this.downSpeed=1,this.downMaxSpeed=1/0,this.downAcceleration=1,this.canLeft=!0,this.leftMinimum=-1/0,this.leftMaximum=-1/0,this.leftMinSpeed=0,this.leftSpeed=1,this.leftMaxSpeed=1/0,this.leftAcceleration=1,this.canRight=!0,this.rightMinimum=-1/0,this.rightMaximum=-1/0,this.rightMinSpeed=0,this.rightSpeed=1,this.rightMaxSpeed=1/0,this.rightAcceleration=1,this.canRotate=!0,this.minPolarAngle=.001,this.maxPolarAngle=Math.PI-.001,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.rotateMinSpeed=0,this.rotateSpeed=1,this.rotateMaxSpeed=1/0,this.rotateAcceleration=1,this.canPan=!0,this.panMinimum=-1/0,this.panMaximum=-1/0,this.panMinSpeed=0,this.panSpeed=.001,this.panMaxSpeed=1/0,this.panAcceleration=1,this.canRoll=!0,this.rollMinimum=-1/0,this.rollMaximum=-1/0,this.rollMinSpeed=0,this.rollSpeed=.1,this.rollMaxSpeed=1/0,this.rollAcceleration=1,this.canZoom=!0,this.zoomMinimum=0,this.zoomMaximum=1/0,this.zoomMinSpeed=0,this.zoomSpeed=.001,this.zoomMaxSpeed=1/0,this.zoomAcceleration=1,this.canLookAt=!0,this.actionsMap={front:[t.Keys.Z.value,t.Keys.UP_ARROW.value],back:[t.Keys.S.value,t.Keys.DOWN_ARROW.value],up:[t.Keys.A.value,t.Keys.PAGE_UP.value],down:[t.Keys.E.value,t.Keys.PAGE_DOWN.value],left:[t.Keys.Q.value,t.Keys.LEFT_ARROW.value],right:[t.Keys.D.value,t.Keys.RIGHT_ARROW.value],rotate:[t.Mouse.LEFT.value],pan:[t.Mouse.MIDDLE.value],roll:{left:[t.Keys.R.value],right:[t.Keys.T.value]},zoom:[t.Mouse.WHEEL.value],lookAtFront:[t.Keys.NUMPAD_2.value],lookAtFrontLeft:[t.Keys.NUMPAD_3.value],lookAtFrontRight:[t.Keys.NUMPAD_1.value],lookAtBack:[t.Keys.NUMPAD_8.value],lookAtBackLeft:[t.Keys.NUMPAD_9.value],lookAtBackRight:[t.Keys.NUMPAD_7.value],lookAtUp:[t.Keys.NUMPAD_5.value],lookAtDown:[t.Keys.NUMPAD_0.value],lookAtLeft:[t.Keys.NUMPAD_6.value],lookAtRight:[t.Keys.NUMPAD_4.value]},this._state=M.None}get camera(){return this._camera}set camera(e){if(s.isNull(e))throw new Error("Camera cannot be null ! Expect an instance of Camera");if(s.isUndefined(e))throw new Error("Camera cannot be undefined ! Expect an instance of Camera");if(!(e instanceof i.Camera))throw new Error(`Camera cannot be an instance of ${e.constructor.name}. Expect an instance of Camera.`);this._camera=e}get target(){return this._target}set target(e){if(s.isNull(e))throw new Error("Target cannot be null ! Expect an instance of Object3D.");if(s.isUndefined(e))throw new Error("Target cannot be undefined ! Expect an instance of Object3D.");if(!(e instanceof i.Object3D))throw new Error(`Target cannot be an instance of ${e.constructor.name}. Expect an instance of Object3D.`);this._target=e}get mode(){return this._mode}set mode(e){if(s.isNull(e))throw new Error("Mode cannot be null ! Expect a value from CameraControlMode enum.");if(s.isUndefined(e))throw new Error("Mode cannot be undefined ! Expect a value from CameraControlMode enum.");this._mode=e,this._trackPath&&this._initPathDisplacement()}get paths(){return this._paths}set paths(e){this._paths=e}get trackPath(){return this._trackPath}set trackPath(e){if(s.isNotBoolean(e))throw new Error(`Track path cannot be an instance of ${e.constructor.name}. Expect a boolean.`);this._trackPath=e,this._trackPath&&this._initPathDisplacement()}get domElement(){return this._domElement}set domElement(e){if(s.isNull(e))throw new Error("DomElement cannot be null ! Expect an instance of HTMLDocument.");if(s.isUndefined(e))throw new Error("DomElement cannot be undefined ! Expect an instance of HTMLDocument.");if(!(e instanceof Window||e instanceof HTMLDocument||e instanceof HTMLDivElement||e instanceof HTMLCanvasElement))throw new Error(`DomElement cannot be an instance of ${e.constructor.name}. Expect an instance of Window, HTMLDocument or HTMLDivElement.`);this._domElement&&(this._domElement.removeEventListener("mouseenter",this._handlers.onMouseEnter,!1),this._domElement.removeEventListener("mouseleave",this._handlers.onMouseLeave,!1),this.dispose()),this._domElement=e,this._domElement.addEventListener("mouseenter",this._handlers.onMouseEnter,!1),this._domElement.addEventListener("mouseleave",this._handlers.onMouseLeave,!1),this.impose()}setCamera(e){return this.camera=e,this}setTarget(e){return this.target=e,this}setMode(e){return this.mode=e,this}setPaths(e){return this.paths=e,this}addPath(e){return this._paths.push(e),this}setTrackPath(e){return this.trackPath=e,this}setDomElement(e){return this.domElement=e,this}impose(){this._domElement.addEventListener("keydown",this._handlers.onKeyDown,!1),this._domElement.addEventListener("keyup",this._handlers.onKeyUp,!1),this._domElement.addEventListener("dblclick",this._handlers.onDblClick,!1),this._domElement.addEventListener("mousedown",this._handlers.onMouseDown,!1),this._domElement.addEventListener("mousemove",this._handlers.onMouseMove,!1),this._domElement.addEventListener("mouseup",this._handlers.onMouseUp,!1),this._domElement.addEventListener("wheel",this._handlers.onMouseWheel,{capture:!0,once:!1,passive:!1}),this._domElement.addEventListener("touchcancel",this._handlers.onTouchCancel,!1),this._domElement.addEventListener("touchend",this._handlers.onTouchEnd,!1),this._domElement.addEventListener("touchleave",this._handlers.onTouchLeave,!1),this._domElement.addEventListener("touchmove",this._handlers.onTouchMove,{capture:!0,once:!1,passive:!1}),this._domElement.addEventListener("touchstart",this._handlers.onTouchStart,{capture:!0,once:!1,passive:!1}),this.dispatchEvent({type:"impose"})}dispose(){this._domElement.removeEventListener("keydown",this._handlers.onKeyDown,!1),this._domElement.removeEventListener("keyup",this._handlers.onKeyUp,!1),this._domElement.removeEventListener("dblclick",this._handlers.onDblClick,!1),this._domElement.removeEventListener("mousedown",this._handlers.onMouseDown,!1),this._domElement.removeEventListener("mousemove",this._handlers.onMouseMove,!1),this._domElement.removeEventListener("mouseup",this._handlers.onMouseUp,!1),this._domElement.removeEventListener("wheel",this._handlers.onMouseWheel,{capture:!0,once:!1,passive:!1}),this._domElement.removeEventListener("touchcancel",this._handlers.onTouchCancel,!1),this._domElement.removeEventListener("touchend",this._handlers.onTouchEnd,!1),this._domElement.removeEventListener("touchleave",this._handlers.onTouchLeave,!1),this._domElement.removeEventListener("touchmove",this._handlers.onTouchMove,{capture:!0,once:!1,passive:!1}),this._domElement.removeEventListener("touchstart",this._handlers.onTouchStart,{capture:!0,once:!1,passive:!1}),this.dispatchEvent({type:"dispose"})}update(){}setCameraPosition(e){return this._camera.position.copy(e),this._camera.lookAt(this._target.position),this}setTargetPosition(e){return this._target.position.copy(e),this._camera.lookAt(this._target.position),this}_consumeEvent(e){e.cancelable&&e.stopImmediatePropagation()}_onKeyDown(e){if(!this.enabled)return;e.preventDefault();const t=this.actionsMap,n=e.keyCode;t.front.includes(n)?(this._front(),this._consumeEvent(e)):t.back.includes(n)?(this._back(),this._consumeEvent(e)):t.up.includes(n)?(this._up(),this._consumeEvent(e)):t.down.includes(n)?(this._down(),this._consumeEvent(e)):t.left.includes(n)?(this._left(),this._consumeEvent(e)):t.right.includes(n)?(this._right(),this._consumeEvent(e)):t.rotate.includes(n)?this._rotate(1):t.pan.includes(n)?(this._pan(1),this._consumeEvent(e)):t.roll.left.includes(n)?(this._roll(1),this._consumeEvent(e)):t.roll.right.includes(n)?(this._roll(-1),this._consumeEvent(e)):t.zoom.includes(n)?(this._zoom(1),this._consumeEvent(e)):t.lookAtFront.includes(n)?(this._lookAt(b),this._consumeEvent(e)):t.lookAtFrontLeft.includes(n)?(this._lookAt(new i.Vector3(-1,0,-1).normalize()),this._consumeEvent(e)):t.lookAtFrontRight.includes(n)?(this._lookAt(new i.Vector3(1,0,-1).normalize()),this._consumeEvent(e)):t.lookAtBack.includes(n)?(this._lookAt(y),this._consumeEvent(e)):t.lookAtBackLeft.includes(n)?(this._lookAt(new i.Vector3(-1,0,1).normalize()),this._consumeEvent(e)):t.lookAtBackRight.includes(n)?(this._lookAt(new i.Vector3(1,0,1).normalize()),this._consumeEvent(e)):t.lookAtUp.includes(n)?(this._lookAt(v),this._consumeEvent(e)):t.lookAtDown.includes(n)?(this._lookAt(w),this._consumeEvent(e)):t.lookAtLeft.includes(n)?(this._lookAt(x),this._consumeEvent(e)):t.lookAtRight.includes(n)&&(this._lookAt(E),this._consumeEvent(e))}_onKeyUp(e){this.enabled&&e.preventDefault()}_onTouchStart(e){this.enabled&&(e.preventDefault(),this.previousTouches=e.touches)}_onTouchEnd(e){this.enabled&&(e.preventDefault(),this.previousTouches=[],this._state=M.None)}_onTouchCancel(e){this.enabled&&(e.preventDefault(),this.previousTouches=[],this._state=M.None)}_onTouchLeave(e){this.enabled&&(e.preventDefault(),this.previousTouches=[],this._state=M.None)}_onTouchMove(e){if(!this.enabled)return;e.preventDefault();const t=this.previousTouches,n=e.changedTouches,s=t.length,o=n.length;if(2===s&&2===o){const s=new i.Vector2(t[0].clientX,t[0].clientY),o=new i.Vector2(t[1].clientX,t[1].clientY),r=s.distanceTo(o),a=(new i.Vector2).addVectors(s,o).divideScalar(2),l=(new i.Vector2).subVectors(s,o).normalize(),h=new i.Vector2(n[0].clientX,n[0].clientY),c=new i.Vector2(n[1].clientX,n[1].clientY),d=h.distanceTo(c),u=(new i.Vector2).addVectors(h,c).divideScalar(2),p=(new i.Vector2).subVectors(s,o).normalize(),m=(new i.Vector2).subVectors(u,a),f=d-r,g=p.dot(l);this._pan(m),this._zoom(f),this._roll(g),this._consumeEvent(e)}else if(1===s&&1===o){const s=new i.Vector2(n[0].clientX-t[0].clientX,n[0].clientY-t[0].clientY).divideScalar(10);this._rotate(s),this._consumeEvent(e)}else this.logger.warn("Ignoring inconsistent touches event.");this.previousTouches=n}_onMouseEnter(e){this.enabled&&(e.preventDefault(),this.impose(),e.target.constructor!==HTMLDocument&&this._domElement.focus())}_onMouseLeave(e){this.enabled&&(e.preventDefault(),e.target.constructor!==HTMLDocument&&this._domElement.blur(),this.dispose(),this._state=M.None)}_onMouseDown(e){if(!this.enabled)return;e.preventDefault();const t=this.actionsMap,i=e.button;t.front.includes(i)?(this._state=M.Moving,this._front(),this._consumeEvent(e)):t.back.includes(i)?(this._state=M.Moving,this._back(),this._consumeEvent(e)):t.up.includes(i)?(this._state=M.Moving,this._up(),this._consumeEvent(e)):t.down.includes(i)?(this._state=M.Moving,this._down(),this._consumeEvent(e)):t.left.includes(i)?(this._state=M.Moving,this._left(),this._consumeEvent(e)):t.right.includes(i)?(this._state=M.Moving,this._right(),this._consumeEvent(e)):t.rotate.includes(i)?(this._state=M.Rotating,this._consumeEvent(e)):t.pan.includes(i)?(this._state=M.Panning,this._consumeEvent(e)):t.roll.left.includes(i)?(this._state=M.Rolling,this._consumeEvent(e)):t.roll.right.includes(i)?(this._state=M.Rolling,this._consumeEvent(e)):t.zoom.includes(i)?(this._state=M.Zooming,this._consumeEvent(e)):this._state=M.None}_onMouseMove(e){if(!this.enabled||this._state===M.None)return;e.preventDefault();const t=this._state,i={x:e.movementX||e.mozMovementX||e.webkitMovementX||0,y:e.movementY||e.mozMovementY||e.webkitMovementY||0};switch(t){case M.Moving:break;case M.Rotating:this._rotate(i),this._consumeEvent(e);break;case M.Panning:this._pan(i),this._consumeEvent(e);break;case M.Rolling:this._roll(i),this._consumeEvent(e);break;case M.Zooming:this._zoom(i),this._consumeEvent(e);break;default:throw new RangeError(`Unknown state: ${t}`)}}_onMouseWheel(e){if(!this.enabled)return;e.preventDefault();const t=e.wheelDelta||e.deltaY;this._zoom(t),this._consumeEvent(e)}_onMouseUp(e){this.enabled&&(e.preventDefault(),this._state=M.None)}_onDblClick(e){this.enabled&&(e.preventDefault(),this.logger.warn("CameraControls: Double click events is not implemented yet, sorry for the disagreement."))}_front(){if(this.canMove&&this.canFront){if("PerspectiveCamera"===this._camera.type){const e=b.clone().applyQuaternion(this._camera.quaternion),t=this._trackPath?this._getPathDisplacement(e):e.multiplyScalar(this.frontSpeed);this._camera.position.add(t),this._target.position.add(t)}this.dispatchEvent({type:"move"}),this.dispatchEvent({type:"change"})}}_back(){if(this.canMove&&this.canBack){if("PerspectiveCamera"===this._camera.type){const e=y.clone().applyQuaternion(this._camera.quaternion),t=this._trackPath?this._getPathDisplacement(e):e.multiplyScalar(this.backSpeed);this._camera.position.add(t),this._target.position.add(t)}this.dispatchEvent({type:"move"}),this.dispatchEvent({type:"change"})}}_up(){if(this.canMove&&this.canUp){if("PerspectiveCamera"===this._camera.type){const e=v.clone().applyQuaternion(this._camera.quaternion).multiplyScalar(this.upSpeed);this._camera.position.add(e),this._target.position.add(e)}this.dispatchEvent({type:"move"}),this.dispatchEvent({type:"change"})}}_down(){if(this.canMove&&this.canDown){if("PerspectiveCamera"===this._camera.type){const e=w.clone().applyQuaternion(this._camera.quaternion).multiplyScalar(this.downSpeed);this._camera.position.add(e),this._target.position.add(e)}this.dispatchEvent({type:"move"}),this.dispatchEvent({type:"change"})}}_left(){if(this.canMove&&this.canLeft){if("PerspectiveCamera"===this._camera.type){const e=x.clone().applyQuaternion(this._camera.quaternion).multiplyScalar(this.leftSpeed);this._camera.position.add(e),this._target.position.add(e)}this.dispatchEvent({type:"move"}),this.dispatchEvent({type:"change"})}}_right(){if(this.canMove&&this.canRight){if("PerspectiveCamera"===this._camera.type){const e=E.clone().applyQuaternion(this._camera.quaternion).multiplyScalar(this.rightSpeed);this._camera.position.add(e),this._target.position.add(e)}this.dispatchEvent({type:"move"}),this.dispatchEvent({type:"change"})}}_rotate(e){if(this.canRotate){if("PerspectiveCamera"===this._camera.type){const t=this._camera.position,s=this._target.position,o=t.distanceTo(s),r=(new i.Vector3).subVectors(t,s).normalize(),a=this.rotateSpeed;switch(this._mode){case D.FirstPerson:{const n=e.x,o=e.y,r=new i.Vector3(-n,o,0).applyQuaternion(this._camera.quaternion).multiplyScalar(a).add(s),l=(new i.Vector3).subVectors(r,t).normalize(),h=v.clone().dot(l),c=E.clone().dot(l),d=.97;if(h<-d||h>d||c<-2||c>2)return;const u=l.multiplyScalar(1).add(t);this.setTargetPosition(u)}break;case D.Orbit:{const t=(new i.Spherical).setFromVector3(r),l=t.theta+n.degreesToRadians(-e.x)*a,h=t.phi+n.degreesToRadians(-e.y)*a;t.theta=Math.max(this.minAzimuthAngle,Math.min(this.maxAzimuthAngle,l)),t.phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,h));const c=(new i.Vector3).setFromSpherical(t).multiplyScalar(o).add(s);this.setCameraPosition(c)}break;default:throw new RangeError(`Unamanaged rotation for camera mode ${this._mode}`)}}this.dispatchEvent({type:"rotate"}),this.dispatchEvent({type:"change"})}}_pan(e){if(this.canPan){if("PerspectiveCamera"===this._camera.type){const t=this._camera.position,n=this._target.position,s=t.distanceTo(n),o=new i.Vector3(-e.x,e.y,0).applyQuaternion(this._camera.quaternion).multiplyScalar(this.panSpeed*s);this._camera.position.add(o),this._target.position.add(o)}this.dispatchEvent({type:"pan"}),this.dispatchEvent({type:"change"})}}_roll(e){if(this.canRoll){if("PerspectiveCamera"===this._camera.type){const t=this._camera.position,n=this._target.position,s=(new i.Vector3).subVectors(t,n).normalize(),o=e*this.rollSpeed;this._camera.up.applyAxisAngle(s,o),this._camera.lookAt(n)}this.dispatchEvent({type:"roll"}),this.dispatchEvent({type:"change"})}}_zoom(e){if(this.canZoom){if("PerspectiveCamera"===this._camera.type)switch(this._mode){case D.FirstPerson:e>0?this._camera.fov--:this._camera.fov++,this._camera.updateProjectionMatrix();break;case D.Orbit:{const t=this._camera.position,n=this._target.position,s=t.distanceTo(n),o=b.clone().applyQuaternion(this._camera.quaternion).multiplyScalar(e*this.zoomSpeed*s);let r=t.clone().add(o);const a=(new i.Vector3).subVectors(r,t).normalize(),l=(new i.Vector3).subVectors(t,n).normalize(),h=(new i.Vector3).subVectors(r,n).normalize(),c=a.dot(l),d=a.dot(h),u=r.distanceToSquared(n);c<0&&(u<this.zoomMinimum*this.zoomMinimum||d>0)&&(r=l.clone().multiplyScalar(this.zoomMinimum).add(n)),this._camera.position.copy(r)}break;default:throw new RangeError(`Invalid camera control mode parameter: ${this._mode}`)}this.dispatchEvent({type:"zoom"}),this.dispatchEvent({type:"change"})}}_lookAt(e){if(this.canLookAt){if("PerspectiveCamera"===this._camera.type){const t=e.clone(),i=this._camera.position,n=this._target.position,s=i.distanceTo(n);switch(this.mode){case D.FirstPerson:{t.y=-t.y;const e=t.multiplyScalar(s).add(i);this.setTargetPosition(e)}break;case D.Orbit:{const e=t.multiplyScalar(s).add(n);this.setCameraPosition(e)}break;default:throw new RangeError(`Invalid camera control mode parameter: ${this._mode}`)}}this.dispatchEvent({type:"lookAt"}),this.dispatchEvent({type:"change"})}}_initPathDisplacement(){if(s.isEmptyArray(this._paths))this.logger.warn("Try to init path displacement without any paths");else switch(s.isNotDefined(this._currentPath)&&(this._currentPathIndex=0,this._currentPathOffset=0,this._currentPath=this._paths[0]),this._currentPathPosition=this._currentPath.getPointAt(this._currentPathOffset),this._mode){case D.FirstPerson:if(this._lockedTarget){const e=(new i.Vector3).subVectors(this._currentPathPosition,this.camera.position);this._camera.position.add(e),this._target.position.add(e)}else this.setCameraPosition(this._currentPathPosition);break;case D.Orbit:if(this._lockedTarget){const e=(new i.Vector3).subVectors(this._currentPathPosition,this.target.position);this._camera.position.add(e),this._target.position.add(e)}else this.setTargetPosition(this._currentPathPosition);break;default:throw new RangeError(`Invalid camera control _mode parameter: ${this._mode}`)}}_getPathDisplacement(e){let t=null;const n=this._currentPathPosition,s=this._currentPathOffset+this._cameraJump,o=s<1?s:1,r=this._currentPath.getPointAt(o),a=(new i.Vector3).subVectors(r,n),l=a.clone().normalize(),h=e.dot(l),c=this._currentPathOffset-this._cameraJump,d=c>0?c:0,u=this._currentPath.getPointAt(d),p=(new i.Vector3).subVectors(u,n),m=p.clone().normalize(),f=e.dot(m);if(0===h&&f<0){const n=this._getDirectionsMap();let s=void 0,o=void 0,r=-1,a=void 0;n.forEach(t=>{const i=t.index,n=t.startDisplacement;if(n){const t=n.clone().normalize(),l=e.dot(t);l>r&&(s=i,o=n,r=l,a=!0)}const l=t.endDisplacement;if(l){const t=l.clone().normalize(),n=e.dot(t);n>r&&(s=i,o=l,r=n,a=!1)}}),void 0!==s?(this._currentPathIndex=s,this._currentPath=this._paths[this._currentPathIndex],this._currentPathOffset=a?this._cameraJump:1-this._cameraJump,this._currentPathPosition=this._currentPath.getPointAt(this._currentPathOffset),t=o):(this.logger.warn("Reach path end."),t=new i.Vector3)}else if(h>0&&f<=0)t=a,this._currentPathOffset=o,this._currentPathPosition=r;else if(h<=0&&f>0)t=p,this._currentPathOffset=d,this._currentPathPosition=u;else if(h<0&&0===f){const n=this._getDirectionsMap();let s=void 0,o=void 0,r=-1,a=void 0;n.forEach(t=>{const i=t.index,n=t.startDisplacement;if(n){const t=n.clone().normalize(),l=e.dot(t);l>r&&(s=i,o=n,r=l,a=!0)}const l=t.endDisplacement;if(l){const t=l.clone().normalize(),n=e.dot(t);n>r&&(s=i,o=l,r=n,a=!1)}}),void 0!==s?(this._currentPathIndex=s,this._currentPath=this._paths[this._currentPathIndex],this._currentPathOffset=a?this._cameraJump:1-this._cameraJump,this._currentPathPosition=this._currentPath.getPointAt(this._currentPathOffset),t=o):(this.logger.warn("Reach path start."),t=new i.Vector3)}else h<0&&f<0||h>0&&f>0?h>f?(t=a,this._currentPathOffset=o,this._currentPathPosition=r):(t=p,this._currentPathOffset=d,this._currentPathPosition=u):(this.logger.warn("Unable to find correct next path position."),t=new i.Vector3);return t}_getDirectionsMap(){const e=this._currentPathPosition,t=this._currentPathIndex,n=this._cameraJump,s=this._maxJump;return this._paths.reduce((o,r,a)=>{if(a===t)return o;const l=r.getPointAt(0);let h=void 0;e.distanceToSquared(l)<s&&(h=(new i.Vector3).subVectors(r.getPointAt(n),l));const c=r.getPointAt(1);let d=void 0;return e.distanceToSquared(c)<s&&(d=(new i.Vector3).subVectors(r.getPointAt(1-n),c)),(h||d)&&o.push({index:a,startDisplacement:h,endDisplacement:d}),o},[])}},e.CameraPathController=O,e.ClippingBox=C,e.ClippingControls=class extends i.Object3D{constructor(e={}){const n={camera:null,domElement:window,mode:$.None,objectsToClip:new i.Object3D,...e};super(),this._handlers={onMouseEnter:this._onMouseEnter.bind(this),onMouseLeave:this._onMouseLeave.bind(this),onMouseDown:this._onMouseDown.bind(this),onMouseMove:this._onMouseMove.bind(this),onMouseWheel:this._onMouseWheel.bind(this),onMouseUp:this._onMouseUp.bind(this),onDblClick:this._onDblClick.bind(this),onTouchStart:this._onTouchStart.bind(this),onTouchEnd:this._onTouchEnd.bind(this),onTouchCancel:this._onTouchCancel.bind(this),onTouchLeave:this._onTouchLeave.bind(this),onTouchMove:this._onTouchMove.bind(this),onKeyDown:this._onKeyDown.bind(this),onKeyUp:this._onKeyUp.bind(this)},this._objectsToClipBoundingBox=new i.Box3,this._clippingBox=new C,this.add(this._clippingBox),this.camera=n.camera,this.domElement=n.domElement,this.mode=n.mode,this.objectsToClip=n.objectsToClip,this.translationSnap=.1,this.scaleSnap=.1,this.rotationSnap=.1,this.enabled=!1,this.size=1,this._dragging=!1,this._firstPoint=new i.Vector3,this._secondPoint=new i.Vector3,this._mouseDisplacement=new i.Vector3,this._offset=new i.Vector3,this._raycaster=new i.Raycaster,this._pointerVector=new i.Vector2,this._directionToMouse=new i.Vector3,this._cameraPosition=new i.Vector3,this._cameraDirection=new i.Vector3,this._worldPosition=new i.Vector3,this._worldRotation=new i.Euler,this._gizmos={Translate:new K,Scale:new W};for(let e in this._gizmos)this.add(this._gizmos[e]);this._currentGizmo=null,this._currentHandle=null,this._events={change:{type:"change"},mouseEnter:{type:"mouseEnter"},mouseLeave:{type:"mouseLeave"},mouseDown:{type:"mouseDown"},mouseUp:{type:"mouseUp"},objectChange:{type:"objectChange"}},this.actionsMap={setMode:{translate:[t.Keys.T.value],rotate:[t.Keys.R.value],scale:[t.Keys.S.value]},translate:{front:[t.Keys.Z.value,t.Keys.UP_ARROW.value],back:[t.Keys.S.value,t.Keys.DOWN_ARROW.value],up:[t.Keys.A.value,t.Keys.PAGE_UP.value],down:[t.Keys.E.value,t.Keys.PAGE_DOWN.value],left:[t.Keys.Q.value,t.Keys.LEFT_ARROW.value],right:[t.Keys.D.value,t.Keys.RIGHT_ARROW.value]},scale:{widthPlus:[t.Keys.LEFT_ARROW.value],widthMinus:[t.Keys.RIGHT_ARROW.value],heightPlus:[t.Keys.PAGE_UP.value],heightMinus:[t.Keys.PAGE_DOWN.value],depthPlus:[t.Keys.UP_ARROW.value],depthMinus:[t.Keys.DOWN_ARROW.value]},rotate:{xAxis:[t.Keys.X.value],yAxis:[t.Keys.Y.value],zAxis:[t.Keys.Z.value]}}}get objectsToClip(){return this._objectsToClip}set objectsToClip(e){if(s.isNull(e))throw new Error("Objects to clip cannot be null ! Expect an instance of Object3D");if(s.isUndefined(e))throw new Error("Objects to clip cannot be undefined ! Expect an instance of Object3D");if(!(e instanceof i.Object3D))throw new Error(`Objects to clip cannot be an instance of ${e.constructor.name}. Expect an instance of Object3D.`);this._objectsToClip=e;const t=new i.Vector3;this._objectsToClipBoundingBox.makeEmpty().expandByObject(e).getSize(t);const n=Math.round(t.x)||50,o=Math.round(t.y)||22,r=Math.round(t.z)||70;this.scale.set(n,o,r),this._clippingBox.update()}get camera(){return this._camera}set camera(e){if(s.isNull(e))throw new Error("Camera cannot be null ! Expect an instance of Camera");if(s.isUndefined(e))throw new Error("Camera cannot be undefined ! Expect an instance of Camera");if(!(e instanceof i.Camera))throw new Error(`Camera cannot be an instance of ${e.constructor.name}. Expect an instance of Camera.`);this._camera=e}get domElement(){return this._domElement}set domElement(e){if(s.isNull(e))throw new Error("DomElement cannot be null ! Expect an instance of Window, HTMLDocument, HTMLDivElement or HTMLCanvasElement.");if(s.isUndefined(e))throw new Error("DomElement cannot be undefined ! Expect an instance of Window, HTMLDocument, HTMLDivElement or HTMLCanvasElement.");if(!(e instanceof Window||e instanceof HTMLDocument||e instanceof HTMLDivElement||e instanceof HTMLCanvasElement))throw new Error(`Target cannot be an instance of ${e.constructor.name}. Expect an instance of Window, HTMLDocument, HTMLDivElement or HTMLCanvasElement.`);this._domElement&&(this._domElement.removeEventListener("mouseenter",this._handlers.onMouseEnter,!1),this._domElement.removeEventListener("mouseleave",this._handlers.onMouseLeave,!1),this.dispose()),this._domElement=e,this._domElement.addEventListener("mouseenter",this._handlers.onMouseEnter,!1),this._domElement.addEventListener("mouseleave",this._handlers.onMouseLeave,!1),this.impose()}get mode(){return this._mode}set mode(e){if(s.isNull(e))throw new Error("Mode cannot be null ! Expect a value from ClippingModes enum.");if(s.isUndefined(e))throw new Error("Mode cannot be undefined ! Expect a value from ClippingModes enum.");this._mode=e;for(let e in this._gizmos)this._gizmos[e].visible=!1;this._mode===$.None?this._currentGizmo=null:(this._currentGizmo=this._gizmos[this._mode],this._currentGizmo.visible=!0)}setCamera(e){return this.camera=e,this}setDomElement(e){return this.domElement=e,this}setMode(e){return this.mode=e,this}setObjectsToClip(e){return this.objectsToClip=e,this}impose(){this._domElement.addEventListener("keydown",this._handlers.onKeyDown,!1),this._domElement.addEventListener("keyup",this._handlers.onKeyUp,!1),this._domElement.addEventListener("dblclick",this._handlers.onDblClick,!1),this._domElement.addEventListener("mousedown",this._handlers.onMouseDown,!1),this._domElement.addEventListener("mousemove",this._handlers.onMouseMove,!1),this._domElement.addEventListener("mouseup",this._handlers.onMouseUp,!1),this._domElement.addEventListener("wheel",this._handlers.onMouseWheel,{capture:!0,once:!1,passive:!1}),this._domElement.addEventListener("touchcancel",this._handlers.onTouchCancel,!1),this._domElement.addEventListener("touchend",this._handlers.onTouchEnd,!1),this._domElement.addEventListener("touchleave",this._handlers.onTouchLeave,!1),this._domElement.addEventListener("touchmove",this._handlers.onTouchMove,{capture:!0,once:!1,passive:!1}),this._domElement.addEventListener("touchstart",this._handlers.onTouchStart,{capture:!0,once:!1,passive:!1}),this.dispatchEvent({type:"impose"})}dispose(){this._domElement.removeEventListener("keydown",this._handlers.onKeyDown,!1),this._domElement.removeEventListener("keyup",this._handlers.onKeyUp,!1),this._domElement.removeEventListener("dblclick",this._handlers.onDblClick,!1),this._domElement.removeEventListener("mousedown",this._handlers.onMouseDown,!1),this._domElement.removeEventListener("mousemove",this._handlers.onMouseMove,!1),this._domElement.removeEventListener("mouseup",this._handlers.onMouseUp,!1),this._domElement.removeEventListener("wheel",this._handlers.onMouseWheel,{capture:!0,once:!1,passive:!1}),this._domElement.removeEventListener("touchcancel",this._handlers.onTouchCancel,!1),this._domElement.removeEventListener("touchend",this._handlers.onTouchEnd,!1),this._domElement.removeEventListener("touchleave",this._handlers.onTouchLeave,!1),this._domElement.removeEventListener("touchmove",this._handlers.onTouchMove,{capture:!0,once:!1,passive:!1}),this._domElement.removeEventListener("touchstart",this._handlers.onTouchStart,{capture:!0,once:!1,passive:!1}),this.dispatchEvent({type:"dispose"})}setTranslationSnap(e){this.translationSnap=e}setRotationSnap(e){this.rotationSnap=e}enable(){this.visible=!0,this.enabled=!0,this.updateClipping()}disable(){this.visible=!1,this.enabled=!1,this.updateClipping()}updateClipping(){s.isNotDefined(this._objectsToClip)||(this._clippingBox.update(),this._clippingBox.applyClippingTo(this.enabled,this._objectsToClip))}update(){this.enabled&&this._mode!==$.None&&(s.isNotDefined(this._currentGizmo)||(this._camera.getWorldPosition(this._cameraPosition),this._camera.getWorldDirection(this._cameraDirection),this._currentGizmo.update(this._cameraPosition,this._cameraDirection)))}_consumeEvent(e){e.cancelable&&e.stopImmediatePropagation()}_onKeyDown(e){if(!this.enabled)return;e.preventDefault();const t=this.actionsMap,i=e.keyCode;if(e.ctrlKey)switch(this._mode){case $.Translate:t.translate.front.includes(i)?(this._translateZ(this.translationSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.objectChange)):t.translate.back.includes(i)?(this._translateZ(-this.translationSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.objectChange)):t.translate.right.includes(i)?(this._translateX(this.translationSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.objectChange)):t.translate.left.includes(i)?(this._translateX(-this.translationSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.objectChange)):t.translate.up.includes(i)?(this._translateY(this.translationSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.objectChange)):t.translate.down.includes(i)&&(this._translateY(-this.translationSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.objectChange));break;case $.Rotate:break;case $.Scale:t.scale.depthPlus.includes(i)?(this._scaleZ(this.scaleSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.objectChange)):t.scale.depthMinus.includes(i)?(this._scaleZ(-this.scaleSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.objectChange)):t.scale.widthPlus.includes(i)?(this._scaleX(this.scaleSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.objectChange)):t.scale.widthMinus.includes(i)?(this._scaleX(-this.scaleSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.objectChange)):t.scale.heightPlus.includes(i)?(this._scaleY(this.scaleSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.objectChange)):t.scale.heightMinus.includes(i)&&(this._scaleY(-this.scaleSnap),this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.objectChange))}else t.setMode.translate.includes(i)?(this.setMode($.Translate),this.updateClipping(),this._consumeEvent(e)):t.setMode.rotate.includes(i)?(this.setMode($.Rotate),this.updateClipping(),this._consumeEvent(e)):t.setMode.scale.includes(i)&&(this.setMode($.Scale),this.updateClipping(),this._consumeEvent(e))}_onKeyUp(e){this.enabled&&!e.defaultPrevented&&e.preventDefault()}_onDblClick(e){this.enabled&&this._mode!==$.None&&e.preventDefault()}_onMouseDown(e){if(!this.enabled)return;if(this._mode===$.None)return;if(e.button!==t.Mouse.LEFT.value)return;if(s.isNotDefined(this._currentHandle))return;e.preventDefault(),this._dragging=!0;const i=this.intersectObjects(e,[this._currentGizmo.intersectPlane]);i&&(this._firstPoint=i.point),this._consumeEvent(e),this.dispatchEvent(this._events.mouseDown)}_onMouseEnter(e){this.enabled&&this._mode!==$.None&&(e.preventDefault(),this.impose(),e.target.constructor!==HTMLDocument&&this._domElement.focus())}_onMouseLeave(e){this.enabled&&this._mode!==$.None&&(e.preventDefault(),this._dragging=!1,e.target.constructor!==HTMLDocument&&this._domElement.blur(),this.dispose())}_onMouseMove(e){if(this.enabled&&this._mode!==$.None)if(e.preventDefault(),!1===this._dragging){const t=this.intersectObjects(e,this._currentGizmo.handles.children);if(t){const i=t.object;this._currentHandle&&i!==this._currentHandle&&(this._currentHandle.highlight(!1),this.dispatchEvent(this._events.mouseLeave)),this._currentHandle=i,this._currentHandle.highlight(!0),this.dispatchEvent(this._events.mouseEnter),this._consumeEvent(e)}else s.isDefined(this._currentHandle)&&(this._currentHandle.highlight(!1),this._currentHandle=null,this.dispatchEvent(this._events.mouseLeave))}else{const t=this._currentHandle,i=t.name,n=this.intersectObjects(e,[this._currentGizmo.intersectPlane]);switch(n&&(this._secondPoint=n.point),this._mouseDisplacement.subVectors(this._secondPoint,this._firstPoint),this._firstPoint.copy(this._secondPoint),this._mode){case $.Translate:"X"===i?this._offset.set(1,0,0):"Y"===i?this._offset.set(0,1,0):"Z"===i?this._offset.set(0,0,1):"XY"===i?this._offset.set(1,1,0):"YZ"===i?this._offset.set(0,1,1):"XZ"===i?this._offset.set(1,0,1):"XYZ"===i&&this._offset.set(1,1,1),this._offset.multiply(this._mouseDisplacement),this._translate(this._offset);break;case $.Rotate:break;case $.Scale:if(t.isScaleHandle)this._offset.copy(this._currentHandle.direction).multiply(this._mouseDisplacement);else if(t.isPlaneHandle){const e=this._currentHandle.xDirection.dot(this._mouseDisplacement);e>0?this._offset.setX(Math.abs(this._mouseDisplacement.x)):e<0?this._offset.setX(-Math.abs(this._mouseDisplacement.x)):this._offset.setX(0);const t=this._currentHandle.yDirection.dot(this._mouseDisplacement);t>0?this._offset.setY(Math.abs(this._mouseDisplacement.y)):t<0?this._offset.setY(-Math.abs(this._mouseDisplacement.y)):this._offset.setY(0);const i=this._currentHandle.zDirection.dot(this._mouseDisplacement);i>0?this._offset.setZ(Math.abs(this._mouseDisplacement.z)):i<0?this._offset.setZ(-Math.abs(this._mouseDisplacement.z)):this._offset.setZ(0)}else if(t.isOmnidirectionalHandle){this.getWorldPosition(this._worldPosition),this._directionToMouse.subVectors(this._firstPoint,this._worldPosition);const e=this._directionToMouse.dot(this._mouseDisplacement)>0?this._mouseDisplacement.length():-this._mouseDisplacement.length();this._offset.set(e,e,e)}this._scale(this._offset);break;default:throw new RangeError(`Invalid switch parameter: ${this._mode}`)}this.updateClipping(),this._consumeEvent(e),this.dispatchEvent(this._events.objectChange)}}_onMouseUp(e){if(!this.enabled)return;if(this._mode===$.None)return;if(event.button!==t.Mouse.LEFT.value)return;e.preventDefault(),this._consumeEvent(e),this._dragging=!1,this.dispatchEvent(this._events.mouseUp);const i=this.intersectObjects(e,this._currentGizmo.handles.children);if(i){const t=i.object;this._currentHandle=t,this._currentHandle.highlight(!0),this._consumeEvent(e),this.dispatchEvent(this._events.mouseEnter)}else s.isDefined(this._currentHandle)&&(this._currentHandle.highlight(!1),this._currentHandle=null,this.dispatchEvent(this._events.mouseLeave))}_onMouseWheel(e){this.enabled&&e.preventDefault()}_onTouchCancel(e){this.enabled&&e.preventDefault()}_onTouchEnd(e){this.enabled&&e.preventDefault()}_onTouchLeave(e){this.enabled&&e.preventDefault()}_onTouchMove(e){this.enabled&&e.preventDefault()}_onTouchStart(e){this.enabled&&e.preventDefault()}getActiveHandle(e){}intersectObjects(e,t){const i=this._domElement.getBoundingClientRect(),n=(e.clientX-i.left)/i.width*2-1,s=-(e.clientY-i.top)/i.height*2+1;this._pointerVector.set(n,s),this._raycaster.setFromCamera(this._pointerVector,this._camera);const o=this._raycaster.intersectObjects(t,!1);return o[0]?o[0]:null}_translate(e){this.position.add(e)}_translateX(e){this.position.setX(this.position.x+e)}_translateY(e){this.position.setY(this.position.y+e)}_translateZ(e){this.position.setZ(this.position.z+e)}_translateXY(e,t){this.position.setX(this.position.x+e),this.position.setY(this.position.y+t)}_translateXZ(e,t){this.position.setX(this.position.x+e),this.position.setZ(this.position.z+t)}_translateYZ(e,t){this.position.setY(this.position.y+e),this.position.setZ(this.position.z+t)}_translateXYZ(e,t,i){this.position.set(this.position.x+e,this.position.y+t,this.position.z+i)}_rotateX(e){}_rotateY(e){}_rotateZ(e){}_rotateXY(e){}_rotateXZ(e){}_rotateYZ(e){}_rotateXYZ(e){}_scale(e){this.scale.add(e)}_scaleX(e){this.scale.setX(this.scale.x+e)}_scaleY(e){this.scale.setY(this.scale.y+e)}_scaleZ(e){this.scale.setZ(this.scale.z+e)}_scaleXY(e,t){this.scale.setX(this.scale.x+e),this.scale.setY(this.scale.y+t)}_scaleXZ(e,t){this.scale.setX(this.scale.x+e),this.scale.setZ(this.scale.z+t)}_scaleYZ(e,t){this.scale.setY(this.scale.y+e),this.scale.setZ(this.scale.z+t)}_scaleXYZ(e,t,i){this.scale.set(this.scale.x+e,this.scale.y+t,this.scale.z+i)}},e.ClippingModes=$,e.CurvesManager=J,e.CylindricaHitbox=I,e.DBFLoader=l,e.FilairesManager=class extends t.TDataBaseManager{constructor(e={}){super({basePath:"/",responseType:t.ResponseType.Json,bunchSize:500,requestAggregationTime:200,requestsConcurrency:6,logger:t.DefaultLogger,...e})}_onJson(e,t,i,n){const o=s.isObject(e)?[e]:e,r={};for(let e=0,t=o.length,s=void 0;e<t;e++){s=o[e];try{r[s.id]=this.convert(s)}catch(e){n(e)}i(new ProgressEvent("FilairesManager",{lengthComputable:!0,loaded:e+1,total:t}))}t(r)}convert(e){if(!e)throw new Error("FilairesManager: Unable to convert null or undefined data !");const t=e.type;let i=null;if(s.isNotDefined(t))throw new Error("TFilaireManager.convert() : data type must be defined !!!");switch(t){case"NaissanceVoute":i=this._parseFilaire(e,8868096);break;case"Radier":i=this._parseFilaire(e,35247);break;case"Intrados":i=this._parseFilaire(e,12648628);break;case"Br":case"Bp":case"Src":i=this._parsePoint(e,65280);break;default:throw new Error(`TFilaireManager: Unknown object of type: ${t}`)}return i}_parseFilaire(e,t){const n=JSON.parse(e.geojson).coordinates.reduce((e,t)=>e.concat(t),[]);if(s.isNotDefined(n))throw new Error(`TFilaireManager._parseFilaire() : ${e.type} geometry doesn't contains coordinates !!!`);const o=new i.LineBasicMaterial({color:t}),r=new i.BufferGeometry;r.addAttribute("position",new i.Float32BufferAttribute(n,3));let a=new i.Line(r,o);return s.isNotDefined(e.type)?a.name="".concat(e.id):a.name="".concat(e.type,"_").concat(e.numero_bloc,"_").concat(e.id),a}_parsePoint(e,t){const n=JSON.parse(e.geojson).coordinates.reduce((e,t)=>e.concat(t),[]);if(s.isNotDefined(n))throw new Error("FilairesManager._parsePoint() : ".concat(e.type," geometry doesn't contains coordinates !!!"));let o=new i.SphereBufferGeometry(parseFloat(e.attribut),50,50,0,2*Math.PI,0,2*Math.PI);o.computeVertexNormals();let r=new i.MeshPhongMaterial({color:t}),a=new i.Mesh(o,r);return a.position.set(n[0],n[1],n[2]),s.isNotDefined(e.type)?a.name="".concat(e.id):a.name="".concat(e.type,"_").concat(e.numero_bloc,"_").concat(e.id),a}},e.GeometriesManager=ee,e.HighlightableLineMaterial=F,e.HighlightableMaterial=k,e.LozengeHandle=X,e.LozengeHitbox=G,e.MaterialsManager=ne,e.ObjectsManager=class extends t.TDataBaseManager{constructor(e={}){const t={basePath:"/objects",geometriesProvider:new ee,materialsProvider:new ne,projectionSystem:"zBack",globalScale:1,autoFillObjects3D:!0,...e};super(t),this.geometriesProvider=t.geometriesProvider,this.materialsProvider=t.materialsProvider,this.projectionSystem=t.projectionSystem,this.globalScale=t.globalScale,this.autoFillObjects3D=t.autoFillObjects3D}get geometriesProvider(){return this._geometriesProvider}set geometriesProvider(e){if(s.isNull(e))throw new TypeError("Geometries provider cannot be null ! Expect an instance of GeometriesManager.");if(s.isUndefined(e))throw new TypeError("Geometries provider cannot be undefined ! Expect an instance of GeometriesManager.");if(!(e instanceof ee))throw new TypeError(`Geometries provider cannot be an instance of ${e.constructor.name} ! Expect an instance of TGeometriesManager.`);this._geometriesProvider=e}get materialsProvider(){return this._materialsProvider}set materialsProvider(e){if(s.isNull(e))throw new TypeError("Materials provider cannot be null ! Expect an instance of MaterialsManager.");if(s.isUndefined(e))throw new TypeError("Materials provider cannot be undefined ! Expect an instance of MaterialsManager.");if(!(e instanceof ne))throw new TypeError(`Materials provider cannot be an instance of ${e.constructor.name} ! Expect an instance of TMaterialsManager.`);this._materialsProvider=e}get projectionSystem(){return this._projectionSystem}set projectionSystem(e){if(s.isNull(e))throw new TypeError("Projection system cannot be null ! Expect a positive number.");if(s.isUndefined(e))throw new TypeError("Projection system cannot be undefined ! Expect a positive number.");this._projectionSystem=e}get globalScale(){return this._globalScale}set globalScale(e){if(s.isNull(e))throw new TypeError("Global scale cannot be null ! Expect a positive number.");if(s.isUndefined(e))throw new TypeError("Global scale cannot be undefined ! Expect a positive number.");this._globalScale=e}get autoFillObjects3D(){return this._autoFillObjects3D}set autoFillObjects3D(e){if(s.isNull(e))throw new TypeError("Global scale cannot be null ! Expect a boolean.");if(s.isUndefined(e))throw new TypeError("Global scale cannot be undefined ! Expect a positive number.");if(s.isNotBoolean(e))throw new TypeError("Global scale cannot be null ! Expect a boolean.");this._autoFillObjects3D=e}setGeometriesProvider(e){return this.geometriesProvider=e,this}setMaterialsProvider(e){return this.materialsProvider=e,this}setProjectionSystem(e){return this.projectionSystem=e,this}setGlobalScale(e){return this.globalScale=e,this}setAutoFillObjects3D(e){return this.autoFillObjects3D=e,this}_onJson(e,t,i,n){const s={};for(let t=0,o=e.length,r=void 0;t<o;t++){r=e[t];try{s[r._id]=this.convert(r)}catch(e){n(e)}i(new ProgressEvent("ObjectsManager",{lengthComputable:!0,loaded:t+1,total:o}))}this._autoFillObjects3D?this.fillObjects3D(s,t,i,n):t(s)}_onArrayBuffer(e,t,i,n){}_onBlob(e,t,i,n){}_onText(e,t,i,n){}convert(e){if(!e)throw new Error("ObjectsManager: Unable to convert null or undefined data !");const t=e.type;let n=null;switch(t){case"Object3D":n=new i.Object3D,this._fillBaseObjectsData(n,e);break;case"Scene":n=new i.Scene,this._fillBaseObjectsData(n,e),s.isDefined(e.background)&&Number.isInteger(e.background)&&(n.background=new i.Color(e.background)),s.isDefined(e.fog)&&("Fog"===e.fog.type?n.fog=new i.Fog(e.fog.color,e.fog.near,e.fog.far):"FogExp2"===e.fog.type&&(n.fog=new i.FogExp2(e.fog.color,e.fog.density))),n.overrideMaterial=e.overrideMaterial,n.autoUpdate=e.autoUpdate;break;case"PerspectiveCamera":n=new i.PerspectiveCamera,this._fillBaseObjectsData(n,e),n.fov=e.fov,n.aspect=e.aspect,n.near=e.near,n.far=e.far,s.isDefined(e.focus)&&(n.focus=e.focus),s.isDefined(e.zoom)&&(n.zoom=e.zoom),s.isDefined(e.filmGauge)&&(n.filmGauge=e.filmGauge),s.isDefined(e.filmOffset)&&(n.filmOffset=e.filmOffset),s.isDefined(e.view)&&(n.view=Object.assign({},e.view));break;case"OrthographicCamera":n=new i.OrthographicCamera(e.left,e.right,e.top,e.bottom,e.near,e.far),this._fillBaseObjectsData(n,e);break;case"AmbientLight":n=new i.AmbientLight(e.color,e.intensity),this._fillBaseObjectsData(n,e);break;case"DirectionalLight":n=new i.DirectionalLight(e.color,e.intensity),this._fillBaseObjectsData(n,e);break;case"PointLight":n=new i.PointLight(e.color,e.intensity,e.distance,e.decay),this._fillBaseObjectsData(n,e);break;case"RectAreaLight":n=new i.RectAreaLight(e.color,e.intensity,e.width,e.height),this._fillBaseObjectsData(n,e);break;case"SpotLight":n=new i.SpotLight(e.color,e.intensity,e.distance,e.angle,e.penumbra,e.decay),this._fillBaseObjectsData(n,e);break;case"HemisphereLight":n=new i.HemisphereLight(e.color,e.groundColor,e.intensity),this._fillBaseObjectsData(n,e);break;case"SkinnedMesh":n=new i.SkinnedMesh,this._fillBaseObjectsData(n,e),n.geometry=e.geometry,n.material=e.material,n.drawMode=e.drawMode,n.bindMode=e.bindMode,n.bindMatrix=e.bindMatrix,n.bindMatrixInverse=e.bindMatrixInverse;break;case"Mesh":n=new i.Mesh,this._fillBaseObjectsData(n,e),n.geometry=e.geometry,n.material=e.material,n.drawMode=e.drawMode;break;case"LOD":n=new i.LOD,this._fillBaseObjectsData(n,e),n.levels=e.levels;break;case"Line":n=new i.Line,this._fillBaseObjectsData(n,e),n.geometry=e.geometry,n.material=e.material,n.drawMode=e.drawMode;break;case"LineLoop":n=new i.LineLoop,this._fillBaseObjectsData(n,e),n.geometry=e.geometry,n.material=e.material,n.drawMode=e.drawMode;break;case"LineSegments":n=new i.LineSegments,this._fillBaseObjectsData(n,e),n.geometry=e.geometry,n.material=e.material,n.drawMode=e.drawMode;break;case"Points":n=new i.Points,this._fillBaseObjectsData(n,e),n.geometry=e.geometry,n.material=e.material,n.drawMode=e.drawMode;break;case"Sprite":n=new i.Sprite,this._fillBaseObjectsData(n,e),n.material=e.material;break;case"Group":n=new i.Group,this._fillBaseObjectsData(n,e);break;default:throw new Error(`TObjectsManager: Unknown object of type: ${t}`)}return n}_fillBaseObjectsData(e,t){e._id=t._id,s.isDefined(t.uuid)&&(e.uuid=t.uuid),s.isDefined(t.name)&&(e.name=t.name),s.isDefined(t.parent)&&(e.parent=t.parent),s.isNotEmptyArray(t.children)&&(e.children=t.children),s.isDefined(t.up)&&(e.up.x=t.up.x,e.up.y=t.up.y,e.up.z=t.up.z),s.isDefined(t.position)&&("zBack"===this._projectionSystem?(e.position.x=t.position.x/this._globalScale,e.position.y=t.position.z/this._globalScale,e.position.z=-t.position.y/this._globalScale):(e.position.x=t.position.x/this._globalScale,e.position.y=t.position.y/this._globalScale,e.position.z=t.position.z/this._globalScale)),s.isDefined(t.rotation)&&("zBack"===this._projectionSystem?(e.rotation.x=t.rotation.x,e.rotation.y=t.rotation.z,e.rotation.z=-t.rotation.y,e.rotation.order=t.rotation.order):(e.rotation.x=t.rotation.x,e.rotation.y=t.rotation.y,e.rotation.z=t.rotation.z,e.rotation.order=t.rotation.order)),s.isDefined(t.quaternion)&&("zBack"===this._projectionSystem?(e.quaternion.x=t.quaternion.x,e.quaternion.y=t.quaternion.z,e.quaternion.z=-t.quaternion.y,e.quaternion.w=t.quaternion.w):(e.quaternion.x=t.quaternion.x,e.quaternion.y=t.quaternion.y,e.quaternion.z=t.quaternion.z,e.quaternion.w=t.quaternion.w)),s.isDefined(t.scale)&&(0!==t.scale.x&&0!==t.scale.y&&0!==t.scale.z?(e.scale.x=t.scale.x,e.scale.y=t.scale.y,e.scale.z=t.scale.z):console.warn("Try to assign null scale !")),s.isDefined(t.modelViewMatrix)&&s.isNotEmptyArray(t.modelViewMatrix)&&e.modelViewMatrix.fromArray(t.modelViewMatrix),s.isDefined(t.normalMatrix)&&s.isNotEmptyArray(t.normalMatrix)&&e.normalMatrix.fromArray(t.normalMatrix),s.isDefined(t.matrix)&&s.isNotEmptyArray(t.matrix)&&e.matrix.fromArray(t.matrix),s.isDefined(t.matrixWorld)&&s.isNotEmptyArray(t.matrixWorld)&&e.matrixWorld.fromArray(t.matrixWorld),s.isDefined(t.matrixAutoUpdate)&&(e.matrixAutoUpdate=t.matrixAutoUpdate),s.isDefined(t.matrixWorldNeedsUpdate)&&(e.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate),s.isDefined(t.layers)&&(e.layers.mask=t.layers),s.isDefined(t.visible)&&(e.visible=t.visible),s.isDefined(t.castShadow)&&(e.castShadow=t.castShadow),s.isDefined(t.receiveShadow)&&(e.receiveShadow=t.receiveShadow),s.isDefined(t.frustumCulled)&&(e.frustumCulled=t.frustumCulled),s.isDefined(t.renderOrder)&&(e.renderOrder=t.renderOrder),s.isDefined(t.userData)&&(e.userData=t.userData)}fillObjects3D(e,t,i,n){const s=this,o=[];for(let t in e){const i=e[t];(i.geometry||i.material)&&o.push(e[t])}if(0===o.length)return void t(e);let r=void 0;this._retrieveGeometriesOf(o,e=>{r=e,l()},i,n);let a=void 0;function l(){if(r&&a){for(let t in e){const i=e[t];s.applyGeometry(i,r),s.applyMaterials(i,a)}t(e)}}this._retrieveMaterialsOf(o,e=>{a=e,l()},i,n)}_retrieveGeometriesOf(e,t,i,n){const s=e.map(e=>e.geometry).filter((e,t,i)=>e&&i.indexOf(e)===t);0!==s.length?this._geometriesProvider.read(s,null,t,i,n):t({})}_retrieveMaterialsOf(e,t,i,n){const s=e.map(e=>e.material),o=[].concat.apply([],s).filter((e,t,i)=>e&&i.indexOf(e)===t);0!==o.length?this._materialsProvider.read(o,null,t,i,n):t({})}applyGeometry(e,t){const i=e.geometry;if(!i)return;const n=t[i];n?e.geometry=n:console.error("Unable to retrieve geometry !!!")}applyMaterials(e,t){const i=e.material;if(i)if(Array.isArray(i))if(1===i.length){const n=t[i[0]];if(!n)return console.error("Unable to retrieve material !!!"),null;e.material=n.clone()}else{e.material=[];for(let n=0,s=i.length;n<s;n++){const s=t[i[n]];if(!s)return console.error("Unable to retrieve material !!!"),null;e.material.push(s.clone())}}else if("string"==typeof i){const n=t[i];if(!n)return void console.error("Unable to retrieve material !!!");e.material=n.clone()}else console.error("Invalid material ids, expected string or array of string")}},e.OctahedricalHandle=Z,e.OctahedricalHitbox=R,e.OrbitControlsHelper=se,e.PlanarHitbox=z,e.PlaneHandle=H,e.RZMLLoader=h,e.RotateGizmo=class extends Y{constructor(){super(),this.isRotateGizmo=!0,this.type="RotateGizmo";const e=(e,t,n)=>{const s=new i.BufferGeometry;let o=[];n=n||1;for(let i=0;i<=64*n;++i)"x"===t&&o.push(0,Math.cos(i/32*Math.PI)*e,Math.sin(i/32*Math.PI)*e),"y"===t&&o.push(Math.cos(i/32*Math.PI)*e,0,Math.sin(i/32*Math.PI)*e),"z"===t&&o.push(Math.sin(i/32*Math.PI)*e,Math.cos(i/32*Math.PI)*e,0);return s.addAttribute("position",new i.Float32BufferAttribute(o,3)),s};this.handleGizmos={X:[[new i.Line(new e(1,"x",.5),new F({color:16711680}))],[new i.Mesh(new i.OctahedronBufferGeometry(.04,0),new k({color:16711680})),[0,0,.99],null,[3,1,1]]],Y:[[new i.Line(new e(1,"y",.5),new F({color:65280}))],[new i.Mesh(new i.OctahedronBufferGeometry(.04,0),new k({color:65280})),[0,0,.99],null,[3,1,1]]],Z:[[new i.Line(new e(1,"z",.5),new F({color:255}))],[new i.Mesh(new i.OctahedronBufferGeometry(.04,0),new k({color:255})),[.99,0,0],null,[1,3,1]]],E:[[new i.Line(new e(1.25,"z",1),new F({color:13421568}))]],XYZ:[[new i.Line(new e(1,"z",1),new F({color:7895160}))]]},this.pickerGizmos={X:[[new N,[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new N,[0,0,0],[Math.PI/2,0,0]]],Z:[[new N,[0,0,0],[0,0,-Math.PI/2]]],E:[[new N({radius:1.25,tube:.12,radialSegments:2,tubularSegments:24})]],XYZ:[[new N]]},this.init()}},e.RotateHandle=class extends j{constructor(e={}){super({...e}),this.isRotateHandle=!0,this.type="RotateHandle"}update(e){super.update(e)}},e.SHPLoader=p,e.ScaleGizmo=W,e.ScaleHandle=U,e.ShapeType=c,e.SphericalHitbox=class extends L{constructor(e={}){super({geometry:new i.SphereBufferGeometry(1,8,6,0,2*Math.PI,0,Math.PI),...e}),this.isSphericalHitbox=!0,this.type="SphericalHitbox"}},e.TexturesManager=te,e.TorusHitbox=N,e.TranslateGizmo=K,e.TranslateHandle=V,e.UniversalLoader=_,e}({},Itee.Client,Three,Itee.Utils,Itee.Validators);
//# sourceMappingURL=itee-plugin-three.iife.min.js.map
